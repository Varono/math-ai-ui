<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="format-detection" content="telephone=no" />
  <title>Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI â€“ Î”Ï. ÎœÎ±ÏÎ¯Î½Î¿Ï‚ Î•Ï…ÏƒÏ„Î±Î¸Î¯Î¿Ï…</title>

  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --border:#e5e7eb;
      --shadow:0 10px 25px rgba(0,0,0,.06);
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --soft:#eef2ff;
      --danger:#dc2626;
      --ok:#16a34a;
      --chip:#f3f4f6;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 18px 10px;
    }
    .title{
      font-size:22px;
      font-weight:800;
      letter-spacing:-.2px;
    }
    .subtitle{
      margin-top:6px;
      color:var(--muted);
      font-size:13.5px;
      line-height:1.25;
    }

    .wrap{padding:0 18px 18px}
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .85fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:18px;
      letter-spacing:-.2px;
    }
    .muted{color:var(--muted); font-size:13px}
    .mono{font-family:var(--mono)}

    textarea, input[type="text"], select{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:92px; resize:vertical}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row.space{justify-content:space-between}
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid transparent;
      border-radius:999px;
      padding:9px 14px;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      background:var(--chip);
      color:var(--text);
    }
    .btn:hover{filter:brightness(.98)}
    .btn.primary{background:var(--primary); color:#fff}
    .btn.primary:hover{background:var(--primary2)}
    .btn.ghost{background:#fff; border-color:var(--border)}
    .btn.danger{background:#fee2e2; color:#7f1d1d; border-color:#fecaca}
    .btn.ok{background:#dcfce7; color:#14532d; border-color:#bbf7d0}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .pill{
      display:inline-flex;
      gap:8px;
      padding:4px;
      background:var(--soft);
      border-radius:999px;
      border:1px solid #dbeafe;
    }
    .pill button{
      border:0;
      padding:8px 12px;
      border-radius:999px;
      background:transparent;
      cursor:pointer;
      font-weight:800;
      color:#1e40af;
    }
    .pill button.active{
      background:#1d4ed8;
      color:#fff;
      box-shadow:0 6px 14px rgba(29,78,216,.18);
    }

    .preview{
      margin-top:10px;
      border:1px dashed #cbd5e1;
      border-radius:12px;
      padding:10px 12px;
      background:#fafcff;
      min-height:54px;
    }
    .divider{height:1px; background:var(--border); margin:12px 0}

    .kbd{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#eef2ff;
    }
    .kbd .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
    .kbd .tab{
      border-radius:999px;
      padding:6px 12px;
      font-weight:800;
      background:#fff;
      border:1px solid var(--border);
      cursor:pointer;
      font-size:13px;
    }
    .kbd .tab.active{background:#111827; color:#fff; border-color:#111827}
    .kbd .keys{display:flex; gap:8px; flex-wrap:wrap}
    .key{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      min-width:42px;
      text-align:center;
      user-select:none;
    }
    .key:hover{filter:brightness(.98)}
    .rightSmall{font-size:12px;color:var(--muted)}
    .statusLine{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fafafa;
      color:var(--muted);
      font-size:13px;
    }

    /* tools (matrix/series/stats/exam beta) */
    .tools{
      margin-top:16px;
    }
    .tool-tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tool-tab{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      font-weight:900;
      color:#111827;
    }
    .tool-tab.active{background:#111827;color:#fff;border-color:#111827}
    .tool-panel{display:none}
    .tool-panel.active{display:block}
    .mini-card{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:12px;
    }
    .mini-title{font-weight:900; margin-bottom:6px}
    .inline-inputs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 680px){
      .inline-inputs{grid-template-columns: 1fr;}
    }
    .result-box{
      white-space:pre-wrap;
      background:#0b1020;
      color:#e5e7eb;
      border-radius:12px;
      padding:12px;
      border:1px solid rgba(255,255,255,.06);
      min-height:96px;
      overflow:auto;
    }

    /* modal canvas */
    .modal{
      position:fixed; inset:0; display:none;
      background:rgba(0,0,0,.35);
      align-items:center; justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal.open{display:flex}
    .modalBox{
      width:min(980px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background:#f9fafb;
    }
    .modalHead .t{font-weight:900}
    .canvasWrap{padding:12px}
    canvas{
      width:100%;
      height:420px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      touch-action:none;
    }
    .footnote{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
    }
  </style>
</head>

<body>
<header>
  <div class="title">Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI</div>
  <div class="subtitle">
    Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÏŒÏ‚: Î”Ï. ÎœÎ±ÏÎ¯Î½Î¿Ï‚ Î•Ï…ÏƒÏ„Î±Î¸Î¯Î¿Ï… â€“ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏŒÏ‚ (MSc) Î¼Îµ PhD ÏƒÏ„Î± Î Î±Î¹Î´Î±Î³Ï‰Î³Î¹ÎºÎ¬ / Î“Î½Ï‰ÏƒÏ„Î¹ÎºÎ® Î¨Ï…Ï‡Î¿Î»Î¿Î³Î¯Î±<br>
    Î¤Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Î±Ï…Ï„ÏŒ Î­Ï‡ÎµÎ¹ Î±Î½Î±Ï€Ï„Ï…Ï‡Î¸ÎµÎ¯ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ Î³Î¹Î± ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿ÏÏ‚ ÏƒÎºÎ¿Ï€Î¿ÏÏ‚.
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h2>ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® Î­ÎºÏ†ÏÎ±ÏƒÎ·</h2>
      <textarea id="mathInput" placeholder="Ï€.Ï‡.  âˆ« x/(x+1) dx, ..."></textarea>

      <div class="preview" id="mathPreview" aria-live="polite">
        <span class="muted">Î— Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ ÎµÎ´Ï ÎºÎ±Î¸ÏÏ‚ Î³ÏÎ¬Ï†ÎµÎ¹Ï‚...</span>
      </div>

      <div class="divider"></div>

      <h2>Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±</h2>
      <textarea id="textInput" placeholder="Î¡ÏÏ„Î± ÎµÎ´Ï Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ (ÎºÎ±Î¹ Î³Î¹Î± Î Î¯Î½Î±ÎºÎµÏ‚/Î£ÎµÎ¹ÏÎ­Ï‚/Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®)."></textarea>

      <div class="row" style="margin-top:10px">
        <div class="muted"><b>Î•Ï€Î¯Ï€ÎµÎ´Î¿ Î»ÏÏƒÎ·Ï‚:</b></div>
        <div class="pill" role="tablist" aria-label="Î•Ï€Î¯Ï€ÎµÎ´Î¿ Î»ÏÏƒÎ·Ï‚">
          <button id="lvlLyceum" class="active" type="button">Î›ÏÎºÎµÎ¹Î¿</button>
          <button id="lvlUni" type="button">Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="askBtn" class="btn primary" type="button">Î¡ÏÏ„Î± Ï„Î¿ AI</button>
        <button id="clearMath" class="btn ghost" type="button">ğŸ’ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ®</button>
        <button id="clearText" class="btn ghost" type="button">ğŸ’ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
      </div>

      <div class="rightSmall" style="margin-top:6px">
        Endpoint: <span class="mono">/ask</span> (JSON) & <span class="mono">/check-image</span> (FormData).
      </div>

      <!-- Keyboard -->
      <div class="kbd" aria-label="Math keyboard">
        <div class="tabs">
          <button class="tab active" data-k="num" type="button">123</button>
          <button class="tab" data-k="fx" type="button">f(x)</button>
          <button class="tab" data-k="abc" type="button">ABC</button>
          <button class="tab" data-k="greek" type="button">Î·Î¼</button>
        </div>
        <div class="keys" id="kbdKeys"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2>ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î»ÏÏƒÎ·Ï‚ Î±Ï€ÏŒ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</h2>

      <div class="row">
        <input id="imgFile" type="file" accept="image/*" />
      </div>

      <div class="preview" id="imgPreview">
        <span class="muted">ğŸ–¼ Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚</span>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="imgCheckBtn" class="btn primary" type="button">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚</button>
        <button id="imgRemoveBtn" class="btn ghost" type="button">Î‘Ï†Î±Î¯ÏÎµÏƒÎ·</button>
      </div>

      <div class="muted" style="margin-top:8px">
        Î— Î¯Î´Î¹Î± Î»ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î± ÎºÎ±Î¹ Ï„Î¿ Î¯Î´Î¹Î¿ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ Î¸Î± ÏƒÏ„Î±Î»Î¿ÏÎ½ Î¼Î±Î¶Î¯ Î¼Îµ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±.
      </div>

      <div class="divider"></div>

      <button id="openCanvasBtn" class="btn" type="button" style="background:#111827;color:#fff">
        âœï¸ Î†Î½Î¿Î¹Î¾Îµ Î Î¯Î½Î±ÎºÎ± Î“ÏÎ±Ï†Î®Ï‚ (stylus)
      </button>
      <div class="muted" style="margin-top:8px">Î“ÏÎ¬Ï†ÎµÎ¹Ï‚ Î¼Îµ Ï€Î­Î½Î± ÎºÎ±Î¹ Ï€ÎµÏÎ½Î¬Ï‚ ÏƒÏ„Î± Ï€ÎµÎ´Î¯Î±.</div>
    </div>
  </div>

  <!-- TOOLS -->
  <div class="card tools" style="margin-top:16px">
    <h2>Î•ÏÎ³Î±Î»ÎµÎ¯Î±</h2>
    <div class="muted">ÎŒ,Ï„Î¹ Ï†Ï„Î¹Î¬Ï‡Î½ÎµÎ¹Ï‚ ÎµÎ´Ï Î¼Ï€Î±Î¯Î½ÎµÎ¹ ÏƒÎ±Î½ context ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±.</div>

    <div class="divider"></div>

    <div class="tool-tabs">
      <button class="tool-tab active" data-tool="matrix" type="button">Î Î¯Î½Î±ÎºÎµÏ‚</button>
      <button class="tool-tab" data-tool="series" type="button">Î£ÎµÎ¹ÏÎ­Ï‚</button>
      <button class="tool-tab" data-tool="stats" type="button">Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®</button>
      <button class="tool-tab" id="tool-exam-tab" data-tool="exam" type="button" style="display:none">Î”Î¹Î±Î³ÏÎ½Î¹ÏƒÎ¼Î± (beta)</button>
    </div>

    <!-- Panels -->
    <div class="tool-panel active" id="tool-matrix">
      <div class="mini-card">
        <div class="mini-title">Î Î¯Î½Î±ÎºÎµÏ‚</div>
        <div class="muted">ÎœÎ¿ÏÏ†Î®: 1,2;3,4 (ÏƒÎµÎ¹ÏÎ­Ï‚ Î¼Îµ ; ÎºÎ±Î¹ ÏƒÏ„Î®Î»ÎµÏ‚ Î¼Îµ ,)</div>
        <textarea id="matrixInput" placeholder="Ï€.Ï‡. 1,2;3,4"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="matrixToText" type="button">Î’Î¬Î»Îµ Ï„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±</button>
          <button class="btn ghost" id="matrixClear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
          <button class="btn ghost" id="matrixSendToText" type="button">Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
        </div>
        <div class="divider"></div>
        <div class="muted">Tip: Î²Î¬Î»Îµ Ï€ÏÏÏ„Î± Ï„Î¿Î½ Î‘, Î¼ÎµÏ„Î¬ Ï€Î¬Ï„Î± Ï„Î¹Ï‚ ÎµÎ½Ï„Î¿Î»Î­Ï‚ Î´ÎµÎ¾Î¹Î¬.</div>
      </div>
    </div>

    <div class="tool-panel" id="tool-series">
      <div class="mini-card">
        <div class="mini-title">Î£ÎµÎ¹ÏÎ­Ï‚</div>
        <div class="muted">Î“ÏÎ¬ÏˆÎµ Ï€.Ï‡. Î£ (1/n^2), Î® Î³ÎµÎ½Î¹ÎºÏŒ ÏŒÏÎ¿, Î® ÎºÏÎ¹Ï„Î®ÏÎ¹Î¿ ÏƒÏÎ³ÎºÎ»Î¹ÏƒÎ·Ï‚.</div>
        <textarea id="seriesInput" placeholder="Ï€.Ï‡. Î£ 1/n^2, n=1..âˆ"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn ghost" id="seriesSendToText" type="button">Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
          <button class="btn ghost" id="seriesClear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
        </div>
      </div>
    </div>

    <div class="tool-panel" id="tool-stats">
      <div class="mini-card">
        <div class="mini-title">Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®</div>
        <div class="muted">Î“ÏÎ¬ÏˆÎµ Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½/ÎµÏÏÏ„Î·Î¼Î± (Ï€.Ï‡. t-test, ANOVA, Ï‡Â²).</div>
        <textarea id="statsInput" placeholder="Ï€.Ï‡. ÎˆÏ‡Ï‰ 2 Î¿Î¼Î¬Î´ÎµÏ‚, n=..., Î¼Î­ÏƒÎ¿Î¹ ÏŒÏÎ¿Î¹..., Î¸Î­Î»Ï‰ t-test..."></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn ghost" id="statsSendToText" type="button">Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
          <button class="btn ghost" id="statsClear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
        </div>
      </div>
    </div>

    <!-- EXAM BETA -->
    <div class="tool-panel" id="tool-exam">
      <div class="mini-card">
        <div class="mini-title">Î”Î¹Î±Î³ÏÎ½Î¹ÏƒÎ¼Î± (beta)</div>
        <div class="muted">
          Î‘Ï…Ï„ÏŒ ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î¼Îµ <b>?beta=1</b>. Î¤ÏÎ±Î²Î¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ Ï„Î¿Î½ server: <span class="mono">/v2/content/*</span>
        </div>

        <div class="divider"></div>

        <div class="inline-inputs">
          <div>
            <div class="muted"><b>Î¤Î¬Î¾Î·</b></div>
            <select id="exam-grade">
              <option value="">â€” Ï†ÏŒÏÏ„Ï‰ÏƒÎ·â€¦</option>
            </select>
          </div>
          <div>
            <div class="muted"><b>Î£Ï„ÏŒÏ‡Î¿Ï‚</b></div>
            <select id="exam-target">
              <option value="final">Î¤ÎµÎ»Î¹ÎºÎ­Ï‚</option>
              <option value="pancyprian">Î Î±Î³ÎºÏÏ€ÏÎ¹ÎµÏ‚</option>
              <option value="quiz">Î¤ÎµÏƒÏ„ / ÎšÎ¿Ï…Î¯Î¶</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="exam-load" type="button">Î¦ÏŒÏÏ„Ï‰ÏƒÎµ Î´ÎµÎ´Î¿Î¼Î­Î½Î±</button>
          <button class="btn ghost" id="exam-to-text" type="button" disabled>Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
          <span class="muted" id="exam-status"></span>
        </div>

        <div class="divider"></div>

        <div class="result-box mono" id="exam-preview">Î ÎµÏÎ¹Î¼Î­Î½Ï‰ Ï†ÏŒÏÏ„Ï‰ÏƒÎ·â€¦</div>

        <div class="muted" style="margin-top:10px">
          Tip: ÎœÎµÏ„Î¬ Ï€Î¬Ï„Î± <b>Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</b> ÎºÎ±Î¹ Î­Ï€ÎµÎ¹Ï„Î± <b>Î¡ÏÏ„Î± Ï„Î¿ AI</b>.
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Answer -->
    <h2>Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· AI</h2>
    <div class="preview" id="answerBox">
      <span class="muted">Î ÎµÏÎ¹Î¼Î­Î½Ï‰ Ï„Î·Î½ Ï€ÏÏÏ„Î· ÏƒÎ¿Ï… ÎµÏÏÏ„Î·ÏƒÎ·â€¦</span>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="saveTxtBtn" class="btn ghost" type="button">â¬‡ .txt</button>
      <button id="printBtn" class="btn primary" type="button">ğŸ–¨ Print</button>
      <span class="muted" id="savedStatus"></span>
    </div>

    <div class="footnote">
      <b>Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ® ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·:</b><br>
      Î¤Î¿ Ï€Î±ÏÏŒÎ½ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Ï€ÏÎ¿Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ <b>Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬</b> Î³Î¹Î± ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿ÏÏ‚ ÏƒÎºÎ¿Ï€Î¿ÏÏ‚.
    </div>
  </div>
</div>

<!-- Stylus Modal -->
<div class="modal" id="canvasModal" aria-hidden="true">
  <div class="modalBox">
    <div class="modalHead">
      <div class="t">Î Î¯Î½Î±ÎºÎ±Ï‚ Î“ÏÎ±Ï†Î®Ï‚ (stylus)</div>
      <div class="row">
        <button class="btn ghost" id="canvasClear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
        <button class="btn ok" id="canvasUseAsImage" type="button">Î§ÏÎ®ÏƒÎ· Ï‰Ï‚ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</button>
        <button class="btn danger" id="canvasClose" type="button">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>
    </div>
    <div class="canvasWrap">
      <canvas id="inkCanvas"></canvas>
      <div class="muted" style="margin-top:10px">
        Î“ÏÎ¬ÏˆÎµ Î¼Îµ stylus/Ï€Î¿Î½Ï„Î¯ÎºÎ¹. Î Î¬Ï„Î± <b>Î§ÏÎ®ÏƒÎ· Ï‰Ï‚ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</b> Î³Î¹Î± Î½Î± ÏƒÏ„Î±Î»ÎµÎ¯ ÏƒÏ„Î¿ <span class="mono">/check-image</span>.
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const BASE_URL = "https://math-ai-server.onrender.com"; // server (Render)

/* ===================== HELPERS ===================== */
const $ = (id) => document.getElementById(id);
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

function escHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function setAnswer(htmlOrText){
  const box = $("answerBox");
  box.innerHTML = `<div>${htmlOrText}</div>`;
}

function appendToTextContext(block){
  const t = $("textInput");
  const prev = t.value.trim();
  t.value = prev ? (prev + "\n\n" + block) : block;
  localStorage.setItem("textInput", t.value);
}

function getLevel(){
  return $("lvlLyceum").classList.contains("active") ? "lyceum" : "uni";
}

/* ===================== MATH PREVIEW ===================== */
function renderMathPreview(){
  const val = $("mathInput").value.trim();
  const box = $("mathPreview");
  if(!val){
    box.innerHTML = `<span class="muted">Î— Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ ÎµÎ´Ï ÎºÎ±Î¸ÏÏ‚ Î³ÏÎ¬Ï†ÎµÎ¹Ï‚...</span>`;
    return;
  }
  // try to render with MathJax using \\( ... \\) to allow latex-like input
  box.innerHTML = `<span class="mono">\\(${escHtml(val)}\\)</span>`;
  if(window.MathJax && window.MathJax.typesetPromise){
    MathJax.typesetPromise([box]).catch(()=>{});
  }
}

/* ===================== KEYBOARD ===================== */
const KB = {
  num: ["x","y","z","Ï€","e","7","8","9","Ã—","Ã·","xÂ²","xâ¿","a/b","âˆš","â¿âˆš","4","5","6","+","âˆ’","1","2","3","0","â‰¤","â‰¥","<",">","=","ÎºÎµÎ½ÏŒ"],
  fx: ["f(x)","g(x)","f'(x)","âˆ«","âˆ«_a^b","d/dx","lim","âˆ","Î£","Î ","ln","log","e^x","|x|","( )","[ ]","{ }"],
  abc: ["a","b","c","n","k","t","Î¸","Î±","Î²","Î³","Î´","Î»","Î¼","Ïƒ","Ï†","Ï‰","sin","cos","tan","cot"],
  greek: ["Î·Î¼","ÏƒÏ…Î½","ÎµÏ†","ÏƒÏ†","Ï„Î¿Î¾Î·Î¼","Ï„Î¿Î¾ÏƒÏ…Î½","Ï„Î¿Î¾ÎµÏ†","ln","Î»Î¿Î³","Ï€","Î¸","Î”","âˆ‡"]
};

let activeKb = "num";

function setKb(tab){
  activeKb = tab;
  document.querySelectorAll(".kbd .tab").forEach(b=>{
    b.classList.toggle("active", b.dataset.k === tab);
  });
  const keys = KB[tab] || [];
  const wrap = $("kbdKeys");
  wrap.innerHTML = keys.map(k => `<div class="key" data-k="${escHtml(k)}">${escHtml(k)}</div>`).join("");
  wrap.querySelectorAll(".key").forEach(el=>{
    el.addEventListener("click", ()=>{
      const v = el.getAttribute("data-k");
      insertAtCursor($("mathInput"), v === "ÎºÎµÎ½ÏŒ" ? " " : v);
      renderMathPreview();
      localStorage.setItem("mathInput", $("mathInput").value);
    });
  });
}

function insertAtCursor(textarea, text){
  const start = textarea.selectionStart ?? textarea.value.length;
  const end = textarea.selectionEnd ?? textarea.value.length;
  const before = textarea.value.slice(0, start);
  const after = textarea.value.slice(end);
  textarea.value = before + text + after;
  const pos = start + text.length;
  textarea.setSelectionRange(pos, pos);
  textarea.focus();
}

/* ===================== ASK AI ===================== */
async function askAI(){
  const math = $("mathInput").value.trim();
  const text = $("textInput").value.trim();

  if(!math && !text){
    setAnswer(`<span class="muted">Î“ÏÎ¬ÏˆÎµ Î¼Î¹Î± Î¼Î±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® Î­ÎºÏ†ÏÎ±ÏƒÎ· Î®/ÎºÎ±Î¹ Î¼Î¹Î± Î»ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±.</span>`);
    return;
  }

  $("askBtn").disabled = true;
  setAnswer(`<span class="muted">â³ Î ÎµÏÎ¹Î¼Î­Î½Ï‰ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·â€¦</span>`);

  // Compose prompt: keep both fields
  const level = getLevel();
  const prompt =
    (math ? `ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® Î­ÎºÏ†ÏÎ±ÏƒÎ·:\n${math}\n\n` : "") +
    (text ? `Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±:\n${text}\n\n` : "") +
    `Î•Ï€Î¯Ï€ÎµÎ´Î¿: ${level === "lyceum" ? "Î›ÏÎºÎµÎ¹Î¿" : "Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿"}`;

  try{
    const res = await fetch(`${BASE_URL}/ask`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({prompt})
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data?.detail || `${res.status} ${res.statusText}`);
    // show answer as plain text
    setAnswer(`<div style="white-space:pre-wrap">${escHtml(data.answer || "")}</div>`);
    $("savedStatus").textContent = `Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ: ${new Date().toLocaleString()}`;
  }catch(e){
    setAnswer(`<div style="white-space:pre-wrap">âŒ Î£Ï†Î¬Î»Î¼Î±: ${escHtml(String(e))}</div>`);
  }finally{
    $("askBtn").disabled = false;
  }
}

/* ===================== IMAGE CHECK ===================== */
let selectedImageFile = null;

function renderImagePreview(fileOrDataUrl){
  const box = $("imgPreview");
  if(!fileOrDataUrl){
    box.innerHTML = `<span class="muted">ğŸ–¼ Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚</span>`;
    return;
  }
  if(typeof fileOrDataUrl === "string"){
    box.innerHTML = `<img src="${fileOrDataUrl}" style="max-width:100%;border-radius:12px;display:block" />`;
    return;
  }
  const url = URL.createObjectURL(fileOrDataUrl);
  box.innerHTML = `<img src="${url}" style="max-width:100%;border-radius:12px;display:block" />`;
}

async function checkImage(){
  if(!selectedImageFile){
    setAnswer(`<span class="muted">Î’Î¬Î»Îµ Ï€ÏÏÏ„Î± Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î± Î® Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ± Î³ÏÎ±Ï†Î®Ï‚.</span>`);
    return;
  }

  $("imgCheckBtn").disabled = true;
  setAnswer(`<span class="muted">â³ Î‘Î½Î±Î»ÏÏ‰ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±â€¦</span>`);

  const form = new FormData();
  form.append("image", selectedImageFile);
  form.append("question", $("textInput").value.trim());
  form.append("level", getLevel() === "lyceum" ? "lyceum" : "uni");

  try{
    const res = await fetch(`${BASE_URL}/check-image`, { method:"POST", body: form });
    const data = await res.json();
    if(!res.ok) throw new Error(data?.detail || `${res.status} ${res.statusText}`);
    setAnswer(`<div style="white-space:pre-wrap">${escHtml(data.answer || "")}</div>`);
    $("savedStatus").textContent = `Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ: ${new Date().toLocaleString()}`;
  }catch(e){
    setAnswer(`<div style="white-space:pre-wrap">âŒ Î£Ï†Î¬Î»Î¼Î±: ${escHtml(String(e))}</div>`);
  }finally{
    $("imgCheckBtn").disabled = false;
  }
}

/* ===================== TOOLS TABS ===================== */
const toolPanels = {
  matrix: $("tool-matrix"),
  series: $("tool-series"),
  stats: $("tool-stats"),
  exam: $("tool-exam")
};

function setTool(tool){
  document.querySelectorAll(".tool-tab").forEach(b=>{
    b.classList.toggle("active", b.dataset.tool === tool);
  });
  Object.keys(toolPanels).forEach(k=>{
    toolPanels[k].classList.toggle("active", k === tool);
  });
}

/* ===================== EXPORT / PRINT ===================== */
function downloadTxt(){
  const text = $("answerBox").innerText || "";
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "apantisi_ai.txt";
  a.click();
  URL.revokeObjectURL(a.href);
}

function printAnswer(){
  const content = $("answerBox").innerText || "";
  const w = window.open("", "_blank");
  w.document.write(`
    <html><head><title>Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· AI</title>
    <meta charset="utf-8">
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto; padding:20px;}
      pre{white-space:pre-wrap; font-size:14px; line-height:1.35;}
    </style></head>
    <body><h2>Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· AI</h2><pre>${escHtml(content)}</pre></body></html>
  `);
  w.document.close();
  w.focus();
  w.print();
  w.close();
}

/* ===================== BETA + CONTENT V2 ===================== */
const params = new URLSearchParams(location.search);
const IS_BETA = params.get("beta") === "1";

const toolExamTab = $("tool-exam-tab");
const examGradeSel = $("exam-grade");
const examTargetSel = $("exam-target");
const examLoadBtn = $("exam-load");
const examToTextBtn = $("exam-to-text");
const examStatus = $("exam-status");
const examPreview = $("exam-preview");
let examLoaded = null; // { gradeKey, manifest, syllabus, indicators, bank }

function setExamStatus(t=""){ if(examStatus) examStatus.textContent = t; }

async function fetchJson(url){
  const res = await fetch(url, { method:"GET" });
  const data = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(data?.detail || `${res.status} ${res.statusText}`);
  return data;
}

async function initBetaContent(){
  if(!IS_BETA) return;

  // show beta tab
  toolExamTab.style.display = "inline-flex";

  try{
    setExamStatus("Î¦Î¿ÏÏ„ÏÎ½Ï‰ manifestâ€¦");
    const manifest = await fetchJson(`${BASE_URL}/v2/content/manifest`);
    const grades = manifest.grades || [];

    examGradeSel.innerHTML =
      `<option value="">â€” ÎµÏ€Î¯Î»ÎµÎ¾Îµ â€”</option>` +
      grades.map(g => `<option value="${g.key}">${g.title || g.key}</option>`).join("");

    examPreview.textContent = "âœ… Manifest loaded.\nÎ•Ï€Î¯Î»ÎµÎ¾Îµ Ï„Î¬Î¾Î· ÎºÎ±Î¹ Ï€Î¬Ï„Î± â€œÎ¦ÏŒÏÏ„Ï‰ÏƒÎµ Î´ÎµÎ´Î¿Î¼Î­Î½Î±â€.";
    setExamStatus("OK");
  }catch(e){
    examPreview.textContent = "âŒ Î”ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ± Î½Î± Ï†Î¿ÏÏ„ÏÏƒÏ‰ /v2/content/manifest.\n" + String(e);
    setExamStatus("Î£Ï†Î¬Î»Î¼Î± manifest");
  }
}

async function loadExamData(){
  const gradeKey = (examGradeSel.value || "").trim();
  if(!gradeKey){
    examPreview.textContent = "Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï€ÏÏÏ„Î± Ï„Î¬Î¾Î·.";
    return;
  }

  try{
    setExamStatus("Î¦Î¿ÏÏ„ÏÎ½Ï‰ Î´ÎµÎ´Î¿Î¼Î­Î½Î±â€¦");
    examPreview.textContent = "â³ loadingâ€¦";

    const [syllabus, indicators, bank] = await Promise.all([
      fetchJson(`${BASE_URL}/v2/content/syllabus?grade=${encodeURIComponent(gradeKey)}`),
      fetchJson(`${BASE_URL}/v2/content/indicators?grade=${encodeURIComponent(gradeKey)}`),
      fetchJson(`${BASE_URL}/v2/content/bank?grade=${encodeURIComponent(gradeKey)}`)
    ]);

    const topicsCount = (syllabus.topics || []).length;
    const bankCount = Array.isArray(bank) ? bank.length : ((bank.items || []).length);
    const siCount = (indicators.success_indicators || []).length;
    const aiCount = (indicators.adequacy_indicators || []).length;

    examLoaded = { gradeKey, syllabus, indicators, bank };

    examPreview.textContent =
      `âœ… Loaded for ${gradeKey}\n` +
      `Topics (syllabus): ${topicsCount}\n` +
      `Success indicators: ${siCount}\n` +
      `Adequacy indicators: ${aiCount}\n` +
      `Question bank items: ${bankCount}\n\n` +
      `Î£Ï„ÏŒÏ‡Î¿Ï‚: ${examTargetSel.value}\n` +
      `Î Î¬Ï„Î± â€œÎ£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®â€ Î³Î¹Î± Î½Î± ÏƒÏ„Î·Î¸ÎµÎ¯ prompt.`;

    examToTextBtn.disabled = false;
    setExamStatus("OK");
  }catch(e){
    examLoaded = null;
    examToTextBtn.disabled = true;
    setExamStatus("Î£Ï†Î¬Î»Î¼Î±");
    examPreview.textContent = "âŒ Î ÏÏŒÎ²Î»Î·Î¼Î± ÏƒÏ„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ·.\n" + String(e);
  }
}

function buildExamPrompt(){
  if(!examLoaded) return "";

  const target = examTargetSel.value || "final";
  const gradeKey = examLoaded.gradeKey;
  const syllabus = examLoaded.syllabus || {};
  const indicators = examLoaded.indicators || {};
  const bank = examLoaded.bank || [];

  // safe summaries (ÏŒÏ‡Î¹ Ï„ÎµÏÎ¬ÏƒÏ„Î¹Î± context)
  const topics = (syllabus.topics || []).map(t => ({
    id: t.id, title: t.title, examined: t.examined
  }));

  const success = (indicators.success_indicators || []).slice(0, 20);
  const adequacy = (indicators.adequacy_indicators || []).slice(0, 20);

  // bank: Î¼ÏŒÎ½Î¿ ids/tags (ÏŒÏ‡Î¹ ÏŒÎ»Î¿ Ï„Î¿ prompt)
  const bankSample = (Array.isArray(bank) ? bank : (bank.items || []))
    .slice(0, 40)
    .map(q => ({
      id: q.id,
      topic_id: q.topic_id ?? null,
      subtopic_id: q.subtopic_id ?? null,
      difficulty: q.difficulty ?? null,
      points: q.points ?? null,
      type: q.type ?? null
    }));

  return (
`=== Î”Î™Î‘Î“Î©ÎÎ™Î£ÎœÎ‘ (BETA) ===
Î¤Î¬Î¾Î·: ${gradeKey}
Î£Ï„ÏŒÏ‡Î¿Ï‚: ${target}

Î¦Ï„Î¹Î¬Î¾Îµ Î­Î½Î± ÎµÎ¾ÎµÏ„Î±ÏƒÏ„Î¹ÎºÏŒ Î´Î¿ÎºÎ¯Î¼Î¹Î¿/Î´Î¹Î±Î³ÏÎ½Î¹ÏƒÎ¼Î± Î¼Îµ ÎºÏ…Ï€ÏÎ¹Î±ÎºÏŒ ÏƒÏ„Ï…Î» (Î“â€™ Î›Ï…ÎºÎµÎ¯Î¿Ï…).
ÎÎ± Î³ÏÎ¬ÏˆÎµÎ¹Ï‚:
- Î˜Î­Î¼Î±Ï„Î±/ÎµÏÏ‰Ï„Î®Î¼Î±Ï„Î± Î¼Îµ ÏƒÎ±Ï†Î® ÎµÎºÏ†ÏÎ½Î·ÏƒÎ·
- ÎœÎ¿Î½Î¬Î´ÎµÏ‚ Î±Î½Î¬ ÎµÏÏÏ„Î·Î¼Î± (Ï€ÏÎ¿Ï‚ Ï„Î¿ Ï€Î±ÏÏŒÎ½ Î²Î¬Î»Îµ Î»Î¿Î³Î¹ÎºÎ­Ï‚ Î¼Î¿Î½Î¬Î´ÎµÏ‚)
- Î•Î½Î´ÎµÎ¹ÎºÏ„Î¹ÎºÎ­Ï‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚/Î»ÏÏƒÎµÎ¹Ï‚ (ÏƒÏÎ½Ï„Î¿Î¼Î±, Î²Î®Î¼Î±-Î²Î®Î¼Î±)

Î ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼Î¿Î¯:
- ÎœÎ—Î Î²Î¬Î»ÎµÎ¹Ï‚ ÎµÎºÏ„ÏŒÏ‚ ÏÎ»Î·Ï‚.
- ÎÎ± ÎºÎ±Î»ÏÏ€Ï„ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 2 Î²Î±ÏƒÎ¹ÎºÎ­Ï‚ ÎµÎ½ÏŒÏ„Î·Ï„ÎµÏ‚ (ÏŒÏ€Î¿Ï… Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½).
- ÎÎ± Î±Ï€Î¿Ï†ÎµÏÎ³ÎµÎ¹Ï‚ Ï…Ï€ÎµÏÎ²Î¿Î»Î¹ÎºÎ¬ Ï€Î±Î½ÎµÏ€Î¹ÏƒÏ„Î·Î¼Î¹Î±ÎºÎ­Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ­Ï‚.

SYLLABUS TOPICS (summary):
${JSON.stringify(topics, null, 2)}

INDICATORS (success - sample):
${JSON.stringify(success, null, 2)}

INDICATORS (adequacy - sample):
${JSON.stringify(adequacy, null, 2)}

QUESTION BANK (metadata sample):
${JSON.stringify(bankSample, null, 2)}
`);
}

/* ===================== STYLUS CANVAS ===================== */
let ink = { drawing:false, lastX:0, lastY:0 };
function openCanvas(){
  $("canvasModal").classList.add("open");
  $("canvasModal").setAttribute("aria-hidden","false");
  fitCanvas();
}
function closeCanvas(){
  $("canvasModal").classList.remove("open");
  $("canvasModal").setAttribute("aria-hidden","true");
}
function fitCanvas(){
  const c = $("inkCanvas");
  const rect = c.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  c.width = Math.floor(rect.width * dpr);
  c.height = Math.floor(rect.height * dpr);
  const ctx = c.getContext("2d");
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.lineWidth = 3;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#111827";
}
function canvasPos(evt){
  const c = $("inkCanvas");
  const r = c.getBoundingClientRect();
  const x = (evt.clientX - r.left);
  const y = (evt.clientY - r.top);
  return {x,y};
}
function canvasDown(evt){
  evt.preventDefault();
  const p = canvasPos(evt);
  ink.drawing = true;
  ink.lastX = p.x; ink.lastY = p.y;
}
function canvasMove(evt){
  if(!ink.drawing) return;
  evt.preventDefault();
  const c = $("inkCanvas");
  const ctx = c.getContext("2d");
  const p = canvasPos(evt);
  ctx.beginPath();
  ctx.moveTo(ink.lastX, ink.lastY);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
  ink.lastX = p.x; ink.lastY = p.y;
}
function canvasUp(evt){
  evt.preventDefault();
  ink.drawing = false;
}
function canvasClear(){
  const c = $("inkCanvas");
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
}
function canvasToFile(){
  const c = $("inkCanvas");
  return new Promise((resolve)=>{
    c.toBlob((blob)=>{
      if(!blob) return resolve(null);
      const file = new File([blob], "stylus.png", {type:"image/png"});
      resolve(file);
    }, "image/png");
  });
}

/* ===================== INIT ===================== */
(function init(){
  // restore
  $("mathInput").value = localStorage.getItem("mathInput") || "";
  $("textInput").value = localStorage.getItem("textInput") || "";
  renderMathPreview();

  // math input listeners
  $("mathInput").addEventListener("input", ()=>{
    localStorage.setItem("mathInput", $("mathInput").value);
    renderMathPreview();
  });
  $("textInput").addEventListener("input", ()=>{
    localStorage.setItem("textInput", $("textInput").value);
  });

  // level
  $("lvlLyceum").addEventListener("click", ()=>{
    $("lvlLyceum").classList.add("active");
    $("lvlUni").classList.remove("active");
  });
  $("lvlUni").addEventListener("click", ()=>{
    $("lvlUni").classList.add("active");
    $("lvlLyceum").classList.remove("active");
  });

  // buttons
  $("askBtn").addEventListener("click", askAI);
  $("clearMath").addEventListener("click", ()=>{
    $("mathInput").value = "";
    localStorage.setItem("mathInput","");
    renderMathPreview();
  });
  $("clearText").addEventListener("click", ()=>{
    $("textInput").value = "";
    localStorage.setItem("textInput","");
  });

  // keyboard
  document.querySelectorAll(".kbd .tab").forEach(b=>{
    b.addEventListener("click", ()=> setKb(b.dataset.k));
  });
  setKb("num");

  // image input
  $("imgFile").addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    selectedImageFile = f || null;
    renderImagePreview(selectedImageFile);
  });
  $("imgRemoveBtn").addEventListener("click", ()=>{
    $("imgFile").value = "";
    selectedImageFile = null;
    renderImagePreview(null);
  });
  $("imgCheckBtn").addEventListener("click", checkImage);

  // tools tabs
  document.querySelectorAll(".tool-tab").forEach(b=>{
    b.addEventListener("click", ()=> setTool(b.dataset.tool));
  });

  // matrix tool
  $("matrixClear").addEventListener("click", ()=> $("matrixInput").value = "");
  $("matrixSendToText").addEventListener("click", ()=>{
    const v = $("matrixInput").value.trim();
    if(!v) return;
    appendToTextContext("Î Î™ÎÎ‘ÎšÎ‘Î£ A (Î¼Î¿ÏÏ†Î®): " + v);
    $("textInput").focus();
  });
  $("matrixToText").addEventListener("click", ()=>{
    const v = $("matrixInput").value.trim();
    if(!v) return;
    appendToTextContext("Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ± A = [" + v + "] ÎºÎ±Î¹ Î»ÏÏƒÎµ Ï„Î¿ ÎµÏÏÏ„Î·Î¼Î±.");
    $("textInput").focus();
  });

  // series/stats
  $("seriesClear").addEventListener("click", ()=> $("seriesInput").value = "");
  $("seriesSendToText").addEventListener("click", ()=>{
    const v = $("seriesInput").value.trim();
    if(!v) return;
    appendToTextContext("Î£Î•Î™Î¡Î•Î£:\n" + v);
    $("textInput").focus();
  });
  $("statsClear").addEventListener("click", ()=> $("statsInput").value = "");
  $("statsSendToText").addEventListener("click", ()=>{
    const v = $("statsInput").value.trim();
    if(!v) return;
    appendToTextContext("Î£Î¤Î‘Î¤Î™Î£Î¤Î™ÎšÎ—:\n" + v);
    $("textInput").focus();
  });

  // export/print
  $("saveTxtBtn").addEventListener("click", downloadTxt);
  $("printBtn").addEventListener("click", printAnswer);

  // stylus modal
  $("openCanvasBtn").addEventListener("click", openCanvas);
  $("canvasClose").addEventListener("click", closeCanvas);
  $("canvasClear").addEventListener("click", canvasClear);
  $("canvasUseAsImage").addEventListener("click", async ()=>{
    const f = await canvasToFile();
    if(!f) return;
    selectedImageFile = f;
    renderImagePreview(selectedImageFile);
    closeCanvas();
    setAnswer(`<span class="muted">âœ… ÎŸ Ï€Î¯Î½Î±ÎºÎ±Ï‚ Î³ÏÎ±Ï†Î®Ï‚ Î­Î³Î¹Î½Îµ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±. Î Î¬Ï„Î± â€œÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚â€.</span>`);
  });

  const c = $("inkCanvas");
  // pointer events for stylus/mouse/touch
  c.addEventListener("pointerdown", canvasDown);
  c.addEventListener("pointermove", canvasMove);
  c.addEventListener("pointerup", canvasUp);
  c.addEventListener("pointercancel", canvasUp);
  window.addEventListener("resize", ()=> {
    if($("canvasModal").classList.contains("open")) fitCanvas();
  });

  // beta
  if(examLoadBtn) examLoadBtn.addEventListener("click", loadExamData);
  if(examToTextBtn) examToTextBtn.addEventListener("click", ()=>{
    const block = buildExamPrompt();
    if(!block) return;
    appendToTextContext(block);
    $("textInput").focus();
  });

  initBetaContent();
})();
</script>
</body>
</html>
