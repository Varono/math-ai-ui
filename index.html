<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect fill='%232563eb' width='32' height='32' rx='6'/%3E%3Ctext x='16' y='22' font-size='18' font-family='sans-serif' fill='white' text-anchor='middle'%3EM%3C/text%3E%3C/svg%3E" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="format-detection" content="telephone=no" />
  <title>Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI â€“ Î”Ï. ÎœÎ±ÏÎ¯Î½Î¿Ï‚ Î•Ï…ÏƒÏ„Î±Î¸Î¯Î¿Ï…</title>

  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:#f5f7fb;color:#111827;font-size:14px}
    main{width:100%;max-width:none;margin:0;padding:12px}

    h1{margin:4px 0 2px 0;font-size:1.2rem}
    .subtitle{margin:0 0 6px 0;font-size:.8rem;color:#4b5563}
    .edu-note-small{font-size:.75rem;color:#6b7280;margin-bottom:8px}

    .top-grid{display:grid;gap:10px}
    @media(min-width:980px){ .top-grid{grid-template-columns:1.35fr .65fr} }

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 8px 20px rgba(15,23,42,.05);padding:10px;margin-bottom:10px}
    label{font-weight:800;font-size:.9rem}
    .muted{color:#64748b;font-size:.78rem}

    textarea,input[type="text"],input[type="number"]{
      width:100%;padding:8px 10px;border-radius:10px;border:1px solid #d1d5db;
      font-family:"JetBrains Mono",ui-monospace,monospace;font-size:.9rem
    }
    textarea{min-height:70px}
    textarea:focus,input:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.12);outline:none}
    @media(max-width:650px){ textarea,input[type="text"],input[type="number"]{font-size:16px} }

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}

    .btn{border:0;border-radius:999px;padding:6px 10px;font-weight:800;cursor:pointer;font-size:.8rem;touch-action:manipulation;white-space:nowrap}
    .btn.primary{background:#2563eb;color:#fff}
    .btn.ghost{background:#eef2ff;color:#1e3a8a}
    .btn.dark{background:#111827;color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .divider{height:1px;background:#e5e7eb;margin:10px 0}

    #math-preview-box{margin-top:6px;border-radius:10px;border:1px dashed #cbd5e1;padding:6px 8px;background:#f9fafb;min-height:34px;font-size:.9rem;color:#0f172a}
    #math-preview-placeholder{color:#94a3b8;font-size:.75rem}

    .level-btn.active{background:#2563eb;color:#fff}

    .kbd{background:#eef2ff;border:1px solid #e5e7eb;border-radius:14px;padding:8px;margin-top:10px}
    .tabs{display:flex;gap:4px;flex-wrap:wrap}
    .tab{border:0;border-radius:999px;padding:4px 10px;background:#e5e7eb;cursor:pointer;font-weight:800;font-size:.75rem;touch-action:manipulation}
    .tab.active{background:#2563eb;color:#fff}
    .keys{margin-top:6px}
    .key{
      border:0;border-radius:9px;padding:6px 8px;background:#fff;margin:2px;cursor:pointer;
      font-family:"JetBrains Mono",ui-monospace,monospace;font-size:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.12);
      touch-action:manipulation
    }
    #keyboard-rows .key{font-size:18px}

    .imgwrap{display:grid;gap:8px;margin-top:6px}
    .preview{width:100%;max-height:280px;object-fit:contain;border-radius:12px;border:1px dashed #cbd5e1;background:#fff}

    .answer{
      white-space:pre-wrap;border:1px solid #e5e7eb;border-radius:12px;padding:10px;min-height:80px;background:#fafafa;font-size:.9rem;
      word-break: normal; overflow-wrap: anywhere;
    }
    #answer-card{scroll-margin-top:14px}

    .continue-box{margin-top:10px;border-top:1px solid #e5e7eb;padding-top:10px;display:none}
    .continue-q{font-weight:900;font-size:.85rem;margin-bottom:6px;color:#0f172a}

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:14px;z-index:9999;
      background:rgba(17,24,39,.92);color:#fff;padding:10px 14px;border-radius:999px;
      box-shadow:0 12px 28px rgba(0,0,0,.22);display:none;align-items:center;gap:10px;
      max-width:92vw;font-size:.85rem;backdrop-filter: blur(6px);
    }
    .toast .toast-btn{
      border:0;background:#2563eb;color:#fff;font-weight:900;border-radius:999px;padding:8px 12px;
      cursor:pointer;touch-action:manipulation;white-space:nowrap;
    }

    .tools-header{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap}
    .tools-header > div{display:flex;flex-direction:column;gap:8px}
    .tool-tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tool-tab{border:0;border-radius:999px;padding:8px 14px;background:#e5e7eb;cursor:pointer;font-weight:900;font-size:.82rem;touch-action:manipulation}
    .tool-tab.active{background:#111827;color:#fff}
    .tool-panel{display:none;margin-top:10px}
    .tool-panel.active{display:block}

    .geogebra-section{margin-top:10px}
    .geogebra-panel{display:flex;flex-direction:column;gap:8px}
    .geogebra-bar{
      display:flex;align-items:center;justify-content:flex-start;gap:10px;flex-wrap:wrap;
      padding:8px 10px;border:1px solid #e5e7eb;border-radius:12px;background:#fafafa
    }
    .geogebra-title{font-weight:950;color:#0f172a}
    .geogebra-fullbleed{
      width:100vw;
      margin-left:-12px;
      margin-right:0;
    }
    .geogebra-canvas{
      width:100%;height:calc(100vh - 190px);min-height:740px;
      border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#fff
    }
    .card .geogebra-canvas{
      height:500px;min-height:500px;
    }
    .geogebra-canvas.is-hidden{display:none}
    .geogebra-open-btn.active{background:#dc2626;color:#fff}

    /* GeoGebra AI Assistant */
    .ggb-ai-assistant{
      background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);
      border:1px solid #7dd3fc;
      border-radius:14px;
      padding:14px;
      margin-top:10px;
    }
    .ggb-ai-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .ggb-ai-icon{font-size:1.4rem}
    .ggb-ai-title{font-weight:700;color:#0369a1;font-size:1rem}
    .ggb-ai-badge{font-size:0.75rem;padding:2px 8px;border-radius:6px;background:#0ea5e9;color:#fff;margin-left:auto}
    .file-protocol-warn{margin-top:10px;padding:10px 14px;background:#fef3c7;border:1px solid #f59e0b;border-radius:10px;font-size:0.9rem;color:#92400e}
    .file-protocol-warn.is-hidden{display:none}
    .file-protocol-warn code{background:#fde68a;padding:2px 6px;border-radius:4px;font-size:0.85em}
    .ggb-ai-input-row{display:flex;gap:8px}
    .ggb-ai-input-row input{
      flex:1;
      padding:10px 14px;
      border:1px solid #bae6fd;
      border-radius:10px;
      font-size:0.95rem;
      background:#fff;
    }
    .ggb-ai-input-row input:focus{outline:none;border-color:#0ea5e9;box-shadow:0 0 0 3px rgba(14,165,233,0.15)}
    .ggb-ai-buttons{display:flex;gap:10px;margin-top:10px}
    .ggb-ai-buttons .btn{flex:1;padding:12px;font-size:0.95rem}
    .ggb-ai-response{
      margin-top:12px;
      background:#fff;
      border:1px solid #e0e7ff;
      border-radius:12px;
      padding:12px;
    }
    .ggb-ai-response.is-hidden{display:none}
    .ggb-ai-explanation{
      font-size:0.92rem;
      line-height:1.6;
      color:#1e293b;
      white-space:pre-wrap;
    }
    .ggb-ai-commands-wrap{margin-top:12px}
    .ggb-ai-commands-title{font-weight:700;font-size:0.85rem;color:#475569;margin-bottom:6px}
    .ggb-ai-commands{
      background:#1e293b;
      color:#22d3ee;
      font-family:"JetBrains Mono",ui-monospace,monospace;
      font-size:0.85rem;
      padding:10px 12px;
      border-radius:8px;
      white-space:pre-wrap;
    }
    .ggb-ai-notes{
      margin-top:10px;
      font-size:0.85rem;
      color:#64748b;
      font-style:italic;
    }
    .ggb-ai-loading{
      margin-top:10px;
      color:#0369a1;
      font-size:0.9rem;
    }
    .ggb-ai-loading.is-hidden{display:none}

    /* Î§ÏÎ®ÏƒÎ· Î´ÏÎ¿Î¼Î­Î± */
    .ggb-cursor-help{
      margin-top:10px;
      border:1px solid #e2e8f0;
      border-radius:12px;
      overflow:hidden;
      background:#f8fafc;
    }
    .ggb-cursor-toggle{
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      background:transparent;
      border:none;
      cursor:pointer;
      font-size:0.95rem;
      color:#334155;
      text-align:left;
    }
    .ggb-cursor-toggle:hover{background:#f1f5f9}
    .ggb-cursor-icon{font-size:1.2rem}
    .ggb-cursor-chevron{
      margin-left:auto;
      font-size:0.75rem;
      color:#64748b;
      transition:transform 0.2s;
    }
    .ggb-cursor-toggle[aria-expanded="true"] .ggb-cursor-chevron{transform:rotate(180deg)}
    .ggb-cursor-content{
      padding:0 14px 14px;
      border-top:1px solid #e2e8f0;
    }
    .ggb-cursor-content.is-hidden{display:none}
    .ggb-cursor-list{
      margin:12px 0 0;
      padding-left:1.2rem;
      line-height:1.7;
      color:#475569;
      font-size:0.9rem;
    }
    .ggb-cursor-list li{margin-bottom:6px}
    .ggb-cursor-list code{
      background:#e2e8f0;
      padding:2px 6px;
      border-radius:4px;
      font-size:0.85em;
    }
    .ggb-cursor-tip{
      margin:10px 0 0;
      font-size:0.85rem;
      color:#64748b;
      font-style:italic;
    }
    .ggb-help-section{margin-bottom:12px}
    .ggb-help-title{
      font-weight:700;
      font-size:0.9rem;
      color:#334155;
      margin-bottom:6px;
      border-bottom:1px solid #e2e8f0;
      padding-bottom:4px;
    }

    .mini-card{border:1px solid #e5e7eb;border-radius:14px;padding:10px;background:#fafafa;height:100%}
    .mini-title{font-weight:950;font-size:.86rem;margin-bottom:8px;color:#0f172a}
    .result-box{border:1px dashed #cbd5e1;border-radius:12px;padding:8px 10px;background:#fff;min-height:52px}
    .mono{font-family:"JetBrains Mono",ui-monospace,monospace}

    .matrix-wide{display:grid;gap:10px}
    @media(min-width:1100px){ .matrix-wide{grid-template-columns:1fr 1fr 1.25fr} }
    @media(min-width:820px) and (max-width:1099px){ .matrix-wide{grid-template-columns:1fr 1fr} }

    .two-col{display:grid;gap:10px}
    @media(min-width:920px){ .two-col{grid-template-columns:1.1fr .9fr} }

    .inline-inputs{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:end}

    .stats-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
    .stats-tab{border:0;border-radius:999px;padding:6px 12px;background:#e5e7eb;cursor:pointer;font-weight:900;font-size:.8rem;touch-action:manipulation}
    .stats-tab.active{background:#2563eb;color:#fff}
    .sequences-subpanel{display:none}
    .sequences-subpanel.active{display:block}
    .stats-subpanel{display:none}
    .stats-subpanel.active{display:block}
    .variables-grid{border-collapse:collapse; font-size:0.82rem}
    .variables-grid th,.variables-grid td{border:1px solid #e5e7eb; padding:4px 6px}
    .variables-grid th{background:#f1f5f9}
    .variables-grid .grid-index{background:#f8fafc; color:#64748b; font-weight:600; text-align:center; min-width:2rem; user-select:none}
    .variables-grid input{width:100%; min-width:48px; border:0; padding:2px 4px; background:transparent}
    .variables-grid input:focus{outline:1px solid #2563eb}

    @media(max-width:650px){
      .btn{padding:10px 14px;font-size:14px}
      .tool-tab{padding:10px 14px}
      .tab{padding:8px 12px}
      .key{padding:10px 10px}
      .toast{font-size:14px}
      .toast .toast-btn{padding:10px 14px}
    }

    .footer-note{font-size:.78rem;color:#4b5563;line-height:1.4}

    /* ===== Answer actions (RESTORED) ===== */
    .answer-actions{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .answer-actions .btn{padding:8px 12px;font-size:.8rem}
    .answer-actions .pill{
      font-size:.75rem; color:#64748b;
      border:1px solid #e5e7eb; background:#fff; padding:6px 10px; border-radius:999px;
    }

    /* Bigger + red thinking/status */
    .status-thinking{
      color:#dc2626 !important;
      font-weight:950;
      font-size:.92rem;
    }

    /* ===== Ink Modal ===== */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      z-index:10000;
      padding:12px;
      overflow:auto;
    }
    .modal-backdrop.show{display:block;}
    .modal{
      width:min(1200px, 96vw);
      margin:24px auto;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:18px;
      box-shadow:0 20px 50px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;background:#0f172a;color:#fff;
    }
    .modal-title{font-weight:950; font-size:.92rem;}
    .modal-close{
      border:0;background:rgba(255,255,255,.14);color:#fff;border-radius:999px;
      padding:8px 12px;cursor:pointer;font-weight:900;
    }
    .modal-body{padding:10px 12px;}

    .ink-controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:8px 10px;border:1px solid #e5e7eb;border-radius:14px;background:#fafafa;margin:8px 0 10px 0;
    }
    .ink-controls label{font-weight:900;font-size:.78rem;margin-right:6px}
    .ink-controls .ctrl{display:flex;align-items:center;gap:8px}
    .ink-controls input[type="range"]{width:170px}
    .ink-controls input[type="color"]{width:42px;height:30px;padding:0;border:0;background:transparent;cursor:pointer}
    .ink-controls .val{font-family:"JetBrains Mono",ui-monospace,monospace;font-size:.78rem;color:#334155;min-width:38px;text-align:left}

    .ink-split{display:grid;gap:12px;margin-top:10px}
    @media(min-width:980px){ .ink-split{ grid-template-columns:1fr 1fr; } }

    .ink-pane{
      border:1px solid #e5e7eb;
      border-radius:16px;
      background:#fafafa;
      padding:10px;
    }
    .ink-pane-title{
      font-weight:950;
      font-size:.88rem;
      color:#0f172a;
      margin-bottom:8px;
      display:flex; align-items:center; gap:8px;
    }

    .ink-wrap{
      border:1px dashed #cbd5e1;border-radius:14px;background:#fff;
      height:min(52vh, 520px);width:100%;overflow:hidden;position:relative;
      touch-action:none;
    }
    canvas.ink-canvas{
      width:100%;height:100%;display:block;background:#fff;
      cursor:crosshair;user-select:none;-webkit-user-select:none;touch-action:none;
    }

    .ink-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px}
    .ink-tip{font-size:.78rem;color:#475569;margin-top:8px}

    #ink-transfer-status{
      margin-top:8px;
      font-weight:950;
      font-size:1rem;
      color:#dc2626;
    }

    .part-head{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
    .part-title{font-weight:950}
    .small{font-size:.78rem;color:#64748b}
    .inline3{display:grid;gap:8px;grid-template-columns:1fr 1fr 1fr;align-items:end}
    @media(max-width:760px){ .inline3{grid-template-columns:1fr} }

    .qpoints{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .qpoints input{width:92px}

    .badge{display:inline-block;border:1px solid #e5e7eb;background:#fafafa;border-radius:999px;padding:6px 10px;font-weight:900;font-size:.75rem}
    .bloom-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .tag{display:inline-block;background:#111827;color:#fff;border-radius:999px;padding:5px 10px;font-weight:900;font-size:.72rem}

    @media print{
      .toast, .kbd, .tool-tabs, .tools-header, .tool-panel, #open-ink-btn,
      #image-input, #check-image-btn, #remove-img-btn, #continue-box,
      .answer-actions, #status, .edu-note-small, .subtitle { display:none !important; }
      body{background:#fff}
      main{padding:0}
      .card{box-shadow:none;border:0;border-radius:0;margin:0;padding:0}
      #ai-answer{border:0;background:#fff;padding:0}
    }
  </style>
</head>

<body>
<main>
  <h1>Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI</h1>
  <p class="subtitle">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÏŒÏ‚: Î”Ï. ÎœÎ±ÏÎ¯Î½Î¿Ï‚ Î•Ï…ÏƒÏ„Î±Î¸Î¯Î¿Ï… â€“ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏŒÏ‚ (MSc) Î¼Îµ PhD ÏƒÏ„Î± Î Î±Î¹Î´Î±Î³Ï‰Î³Î¹ÎºÎ¬ / Î“Î½Ï‰ÏƒÏ„Î¹ÎºÎ® Î¨Ï…Ï‡Î¿Î»Î¿Î³Î¯Î±</p>
  <p class="edu-note-small">Î¤Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Î±Ï…Ï„ÏŒ Î­Ï‡ÎµÎ¹ Î±Î½Î±Ï€Ï„Ï…Ï‡Î¸ÎµÎ¯ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ Î³Î¹Î± ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿ÏÏ‚ ÏƒÎºÎ¿Ï€Î¿ÏÏ‚.</p>

  <!-- ===== TOP INPUTS ===== -->
  <div class="top-grid">
    <div class="card">
      <label for="math-input">ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® Î­ÎºÏ†ÏÎ±ÏƒÎ·</label>
      <textarea id="math-input" placeholder="Ï€.Ï‡. âˆ« x/(x+1) dx, ..."></textarea>

      <div id="math-preview-box">
        <span id="math-preview-placeholder">Î— Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ ÎµÎ´Ï ÎºÎ±Î¸ÏÏ‚ Î³ÏÎ¬Ï†ÎµÎ¹Ï‚â€¦</span>
        <div id="math-preview"></div>
      </div>

      <div style="margin-top:10px">
        <label for="text-input">Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±</label>
        <textarea id="text-input" placeholder="Î¡ÏÏ„Î± ÎµÎ´Ï Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ (ÎºÎ±Î¹ Î³Î¹Î± Î Î¯Î½Î±ÎºÎµÏ‚/Î£ÎµÎ¹ÏÎ­Ï‚/Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®)."></textarea>

        <div class="row" style="margin-top:4px">
          <span class="muted"><b>Î•Ï€Î¯Ï€ÎµÎ´Î¿ Î»ÏÏƒÎ·Ï‚:</b></span>
          <button class="btn ghost level-btn active" data-level="lyceum" type="button">Î›ÏÎºÎµÎ¹Î¿</button>
          <button class="btn ghost level-btn" data-level="university" type="button">Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿</button>
        </div>

        <div class="row">
          <button class="btn primary" id="ask-btn" type="button">Î¡ÏÏ„Î± Ï„Î¿ AI</button>

          <!-- âœ… 2 separate clear buttons -->
          <button class="btn ghost" id="clear-math-btn" type="button">ğŸ§¼ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ®</button>
          <button class="btn ghost" id="clear-text-btn" type="button">ğŸ§¼ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ Î›ÎµÎºÏ„Î¹ÎºÎ®</button>

          <span class="muted" id="status"></span>
        </div>

        <div class="muted">Endpoint: <b>/ask</b> (JSON) & <b>/check-image</b> (FormData).</div>
      </div>

      <div class="kbd">
        <div class="tabs">
          <button class="tab active" data-layout="num" type="button">123</button>
          <button class="tab" data-layout="func" type="button">f(x)</button>
          <button class="tab" data-layout="abc" type="button">ABC</button>
          <button class="tab" data-layout="sym" type="button">#&Â¬</button>
        </div>
        <div id="keyboard-rows" class="keys"></div>
      </div>
    </div>

    <div class="card">
      <label>ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î»ÏÏƒÎ·Ï‚ Î±Ï€ÏŒ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</label>
      <div class="imgwrap">
        <input type="file" id="image-input" accept="image/*">
        <img id="img-preview" class="preview" alt="Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚" />
      </div>
      <div class="row">
        <button class="btn primary" id="check-image-btn" disabled type="button">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚</button>
        <button class="btn ghost" id="remove-img-btn" disabled type="button">Î‘Ï†Î±Î¯ÏÎµÏƒÎ·</button>
      </div>
      <div class="muted">Î— Î¯Î´Î¹Î± Î»ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î± ÎºÎ±Î¹ Ï„Î¿ Î¯Î´Î¹Î¿ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ Î¸Î± ÏƒÏ„Î±Î»Î¿ÏÎ½ Î¼Î±Î¶Î¯ Î¼Îµ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±.</div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn dark" id="open-ink-btn" type="button">âœï¸ Î†Î½Î¿Î¹Î¾Îµ Î Î¯Î½Î±ÎºÎ± Î“ÏÎ±Ï†Î®Ï‚ (stylus)</button>
        <span class="muted">Î“ÏÎ¬Ï†ÎµÎ¹Ï‚ Î¼Îµ Ï€Î­Î½Î± ÎºÎ±Î¹ Ï€ÎµÏÎ½Î¬Ï‚ ÏƒÏ„Î± Ï€ÎµÎ´Î¯Î±.</span>
      </div>
    </div>
  </div>

  <!-- ===== TOOLS ===== -->
  <div class="card">
    <!-- ===== GEOGEBRA ===== -->
    <div class="geogebra-section" style="margin-top:0">
      <div class="geogebra-panel">
        <div class="geogebra-bar">
          <div class="row" style="gap:12px;align-items:center">
            <button class="btn dark geogebra-open-btn" id="geogebra-open-btn" type="button">GeoGebra</button>
            <label class="row" style="gap:8px;align-items:center">
              <input type="checkbox" id="geogebra-axes-toggle" checked />
              <span class="muted"><b>Î†Î¾Î¿Î½ÎµÏ‚</b></span>
            </label>
            <label class="row" style="gap:8px;align-items:center">
              <input type="checkbox" id="geogebra-grid-toggle" checked />
              <span class="muted"><b>Î Î»Î­Î³Î¼Î±</b></span>
            </label>
          </div>
        </div>
        <div id="file-protocol-warn" class="file-protocol-warn is-hidden" role="alert">
          âš ï¸ Î‘Î½Î¿Î¹Î³Î¼Î­Î½Î¿ Ï‰Ï‚ <code>file://</code> â€” Î¿Î¹ ÎºÎ»Î®ÏƒÎµÎ¹Ï‚ ÏƒÏ„Î¿ API Î¼Ï€Î»Î¿ÎºÎ¬ÏÎ¿Ï…Î½ (Â«Failed to fetchÂ»). Î¤ÏÎ­Î¾Îµ <code>serve-ui.bat</code> ÎºÎ±Î¹ Î¬Î½Î¿Î¹Î¾Îµ <strong>http://localhost:8080</strong>.
        </div>
        <!-- GeoGebra AI Assistant -->
        <div class="ggb-ai-assistant">
          <div class="ggb-ai-header">
            <span class="ggb-ai-icon">ğŸ¤–</span>
            <span class="ggb-ai-title">GeoGebra AI Î’Î¿Î·Î¸ÏŒÏ‚</span>
            <span class="ggb-ai-badge" id="ggb-backend-badge">â€”</span>
          </div>
          <div class="ggb-ai-input-row">
            <input type="text" id="ggb-ai-prompt" placeholder="Ï€.Ï‡. Ï„ÏÎ¯Î³Ï‰Î½Î¿ 3,4,5 | applet Ï€Î±ÏÎ±Î²Î¿Î»Î®Ï‚ Î¼Îµ slider | animation ÏƒÎ·Î¼ÎµÎ¯Î¿Ï… ÏƒÎµ ÎºÏÎºÎ»Î¿" />
          </div>
          <div class="ggb-ai-buttons">
            <button class="btn primary" id="ggb-ai-help-btn" type="button">ğŸ’¡ Î’Î¿Î®Î¸Î·ÏƒÎ­ Î¼Îµ</button>
            <button class="btn primary" id="ggb-ai-create-btn" type="button">ğŸ”¨ Î¦Ï„Î¹Î¬Î¾' Ï„Î¿!</button>
          </div>
          <div id="ggb-ai-response" class="ggb-ai-response is-hidden">
            <div class="ggb-ai-explanation" id="ggb-ai-explanation"></div>
            <div class="ggb-ai-commands-wrap" id="ggb-ai-commands-wrap">
              <div class="ggb-ai-commands-title">Î•Î½Ï„Î¿Î»Î­Ï‚ GeoGebra:</div>
              <div class="ggb-ai-commands" id="ggb-ai-commands"></div>
            </div>
            <div class="row" style="gap:8px;margin-top:10px" id="ggb-ai-action-btns">
              <button class="btn primary" id="ggb-ai-execute-btn" type="button">â–¶ Î•ÎºÏ„Î­Î»ÎµÏƒÎµ ÏƒÏ„Î¿ GeoGebra</button>
              <button class="btn ghost" id="ggb-ai-clear-btn" type="button">ğŸ—‘ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
            <div class="ggb-ai-notes" id="ggb-ai-notes"></div>
          </div>
          <div id="ggb-ai-loading" class="ggb-ai-loading is-hidden">
            <span>â³ Î£ÎºÎ­Ï†Ï„Î¿Î¼Î±Î¹...</span>
          </div>
        </div>
        <!-- Î§ÏÎ®ÏƒÎ· Î´ÏÎ¿Î¼Î­Î± -->
        <div class="ggb-cursor-help">
          <button class="ggb-cursor-toggle" id="ggb-cursor-toggle" type="button" aria-expanded="false">
            <span class="ggb-cursor-icon">ğŸ“–</span>
            <span>ÎŸÎ´Î·Î³ÏŒÏ‚ GeoGebra & Applets</span>
            <span class="ggb-cursor-chevron">â–¼</span>
          </button>
          <div id="ggb-cursor-content" class="ggb-cursor-content is-hidden">
            <div class="ggb-help-section">
              <div class="ggb-help-title">Î’Î±ÏƒÎ¹ÎºÎ® Ï‡ÏÎ®ÏƒÎ·</div>
              <ul class="ggb-cursor-list">
                <li><b>Î•Ï€Î¹Î»Î¿Î³Î® ÎµÏÎ³Î±Î»ÎµÎ¯Î¿Ï…:</b> ÎšÎ»Î¹Îº ÏƒÏ„Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Î±Ï€ÏŒ Ï„Î· Î¼Ï€Î¬ÏÎ± (ÏƒÎ·Î¼ÎµÎ¯Î¿, ÎµÏ…Î¸ÎµÎ¯Î±, ÎºÏÎºÎ»Î¿Ï‚ Îº.Î¬.).</li>
                <li><b>Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ· ÏƒÎ·Î¼ÎµÎ¯Î¿Ï…:</b> ÎšÎ»Î¹Îº ÏƒÏ„Î¿ Î³ÏÎ¬Ï†Î·Î¼Î± Î® ÏƒÏ„Î¿ Ï€ÎµÎ´Î¯Î¿ ÎµÎ¹ÏƒÏŒÎ´Î¿Ï… (ÎºÎ¬Ï„Ï‰) Î³Î¹Î± ÏƒÏ…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½ÎµÏ‚.</li>
                <li><b>ÎœÎµÏ„Î±ÎºÎ¯Î½Î·ÏƒÎ·:</b> Î•Ï€Î¹Î»Î¿Î³Î® (Î²Î­Î»Î¿Ï‚), Î¼ÎµÏ„Î¬ ÏƒÏÏÏƒÎ¹Î¼Î¿ Î¼Îµ Ï„Î¿ Ï€Î¿Î½Ï„Î¯ÎºÎ¹.</li>
                <li><b>Î–Î¿Ï…Î¼ / Î¼ÎµÏ„Î±Ï„ÏŒÏ€Î¹ÏƒÎ·:</b> Scroll Î³Î¹Î± Î¶Î¿Ï…Î¼, Alt+ÏƒÏÏÏƒÎ¹Î¼Î¿ Î³Î¹Î± Ï€Î»Î¿Î®Î³Î·ÏƒÎ·.</li>
                <li><b>Î”ÎµÎ¾Î¯ ÎºÎ»Î¹Îº:</b> ÎœÎµÎ½Î¿Ï (ÎºÏÏÏˆÎ¹Î¼Î¿, Î´Î¹Î±Î³ÏÎ±Ï†Î®, Î¹Î´Î¹ÏŒÏ„Î·Ï„ÎµÏ‚).</li>
              </ul>
            </div>
            <div class="ggb-help-section">
              <div class="ggb-help-title">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Applets (Î•Ï†Î±ÏÎ¼Î¿Î³Î¯Î´Î¹Î±)</div>
              <ul class="ggb-cursor-list">
                <li><b>Slider:</b> <code>a=Slider(0,10,0.1)</code> - Î”ÏÎ¿Î¼Î­Î±Ï‚ Î³Î¹Î± Î´Ï…Î½Î±Î¼Î¹ÎºÎ­Ï‚ Ï„Î¹Î¼Î­Ï‚.</li>
                <li><b>Î”Ï…Î½Î±Î¼Î¹ÎºÎ® ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·:</b> <code>f(x)=a*x^2</code> - Î‘Î»Î»Î¬Î¶ÎµÎ¹ Î¼Îµ Ï„Î¿ slider.</li>
                <li><b>ÎšÎµÎ¯Î¼ÎµÎ½Î¿:</b> <code>Text("Î•Î¼Î²Î±Î´ÏŒÎ½ = "+Area(poly))</code> - Î”Ï…Î½Î±Î¼Î¹ÎºÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿.</li>
                <li><b>Animation:</b> Î”ÎµÎ¾Î¯ ÎºÎ»Î¹Îº slider â†’ Animation On, Î® <code>StartAnimation(a)</code>.</li>
                <li><b>ÎšÎ¿Ï…Î¼Ï€Î¯:</b> <code>Button("Reset","A=(0,0)")</code> - Î•ÎºÏ„ÎµÎ»ÎµÎ¯ ÎµÎ½Ï„Î¿Î»Î®.</li>
                <li><b>Checkbox:</b> <code>Checkbox("Î•Î¼Ï†Î¬Î½Î¹ÏƒÎµ")</code> - Î“Î¹Î± ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·/Î±Ï€ÏŒÎºÏÏ…ÏˆÎ·.</li>
              </ul>
            </div>
            <p class="ggb-cursor-tip">ğŸ’¡ Î¡ÏÏ„Î± Ï„Î¿Î½ AI: Â«Ï†Ï„Î¹Î¬Î¾Îµ applet Ï€Î±ÏÎ±Î²Î¿Î»Î®Ï‚ Î¼Îµ sliderÂ» Î® Â«Ï€ÏÏ‚ Ï†Ï„Î¹Î¬Ï‡Î½Ï‰ animationÂ».</p>
          </div>
        </div>
        <div id="geogebra-container" class="geogebra-canvas is-hidden"></div>
      </div>
    </div>

    <div class="tools-header">
      <div>
        <div class="tool-tabs" id="tool-tabs">
          <button class="tool-tab active" data-tool="matrix" type="button">Î Î¯Î½Î±ÎºÎµÏ‚</button>
          <button class="tool-tab" data-tool="sequences" type="button">Î‘ÎºÎ¿Î»Î¿Ï…Î¸Î¯ÎµÏ‚</button>
          <button class="tool-tab" data-tool="stats" type="button">Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®</button>
        </div>
      </div>
    </div>

    <!-- ===== MATRICES ===== -->
    <div class="tool-panel active" id="tool-matrix">
      <!-- (Î¯Î´Î¹Î¿ ÏŒÏ€Ï‰Ï‚ Ï€ÏÎ¹Î½) -->
      <div class="matrix-wide">
        <div class="mini-card">
          <div class="mini-title">Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Ï€Î¯Î½Î±ÎºÎ±</div>
          <div class="muted">ÎœÎ¿ÏÏ†Î®: <span class="mono">1,2;3,4</span></div>
          <textarea id="matrix-raw" placeholder="Ï€.Ï‡. 1,2;3,4" style="margin-top:8px"></textarea>
          <div class="row">
            <button class="btn primary" id="matrix-insert-btn" type="button">Î’Î¬Î»Îµ Ï„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±</button>
            <button class="btn ghost" id="matrix-clear-btn" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            <button class="btn ghost" id="matrix-to-text-btn" type="button">Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
          </div>
        </div>

        <div class="mini-card">
          <div class="mini-title">Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·</div>
          <div id="matrix-preview" class="result-box"></div>
          <div class="muted" style="margin-top:8px">Tip: Î²Î¬Î»Îµ Ï€ÏÏÏ„Î± Ï„Î¿Î½ A, Î¼ÎµÏ„Î¬ Ï€Î¬Ï„Î± Ï„Î¹Ï‚ ÎµÎ½Ï„Î¿Î»Î­Ï‚ Î´ÎµÎ¾Î¹Î¬.</div>
        </div>

        <div class="mini-card">
          <div class="mini-title">Î•Î½Ï„Î¿Î»Î­Ï‚ (Î¼Ï€Î±Î¯Î½Î¿Ï…Î½ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®)</div>

          <div class="mini-title" style="margin-top:6px">Î ÏÎ¬Î¾ÎµÎ¹Ï‚</div>
          <div class="row">
            <button class="btn ghost" id="matrix-det-btn" type="button">det(A)</button>
            <button class="btn ghost" id="matrix-inv-btn" type="button">A^{-1}</button>
            <button class="btn ghost" id="matrix-solve-btn" type="button">Ax=b</button>
          </div>

          <div class="divider"></div>

          <div class="mini-title">Î™Î´Î¹Î¿Ï„Î¹Î¼Î­Ï‚ / Î”Î¹Î±Î³Ï‰Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ·</div>
          <div class="row">
            <button class="btn ghost" id="eigvals-btn" type="button">Î™Î´Î¹Î¿Ï„Î¹Î¼Î­Ï‚</button>
            <button class="btn ghost" id="eigvecs-btn" type="button">Î™Î´Î¹Î¿Î´Î¹Î±Î½ÏÏƒÎ¼Î±Ï„Î±</button>
            <button class="btn ghost" id="diag-btn" type="button">Î”Î¹Î±Î³Ï‰Î½Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹;</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="pd-btn" type="button">P, D</button>
            <button class="btn ghost" id="verify-pdp-btn" type="button">A=PDP^{-1}</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="an-btn" type="button">A^n</button>
            <button class="btn ghost" id="eA-btn" type="button">e^A</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="dynsys-btn" type="button">Î”Ï…Î½Î±Î¼Î¹ÎºÏŒ</button>
            <button class="btn ghost" id="ode-btn" type="button">Î”.Î•.</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== SEQUENCES ===== -->
    <div class="tool-panel" id="tool-sequences">
      <div class="stats-tabs" style="margin-bottom:15px">
        <button class="stats-tab active" data-sequences-type="arithmetic" type="button">Î‘ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÎ® Î ÏÏŒÎ¿Î´Î¿Ï‚</button>
        <button class="stats-tab" data-sequences-type="geometric" type="button">Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¹ÎºÎ® Î ÏÏŒÎ¿Î´Î¿Ï‚</button>
      </div>

      <!-- Î‘ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÎ® Î ÏÏŒÎ¿Î´Î¿Ï‚ -->
      <div class="sequences-subpanel active" id="sequences-arithmetic">
        <div class="two-col">
          <div class="mini-card">
            <div class="mini-title">Î‘ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÎ® Î ÏÏŒÎ¿Î´Î¿Ï‚ (Î‘.Î .)</div>
            <div class="muted" style="margin-top:4px; font-size:0.8rem">aâ‚™ = aâ‚ + (n-1)Â·d</div>
            
            <div style="margin-top:15px">
              <div class="muted" style="margin-bottom:4px"><b>Î¤ÏÏ€Î¿Ï‚ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï:</b></div>
              <select id="ap-calc-type" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db">
                <option value="find_term">Î’ÏÎµÏ‚ aâ‚™ (n-Î¿ÏƒÏ„ÏŒÏ‚ ÏŒÏÎ¿Ï‚)</option>
                <option value="find_sum">Î’ÏÎµÏ‚ Sâ‚™ (Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± n ÏŒÏÏ‰Î½)</option>
                <option value="find_progression">Î’ÏÎµÏ‚ Ï€ÏÏŒÎ¿Î´Î¿ Î±Ï€ÏŒ 2 ÏŒÏÎ¿Ï…Ï‚</option>
                <option value="arithmetic_mean">Î‘ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÏŒÏ‚ Î¼Î­ÏƒÎ¿Ï‚</option>
              </select>
            </div>

            <!-- find_term / find_sum -->
            <div id="ap-basic-inputs" style="margin-top:15px">
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>aâ‚ (Ï€ÏÏÏ„Î¿Ï‚ ÏŒÏÎ¿Ï‚):</b></div>
                <input type="number" id="ap-a1" step="any" placeholder="Ï€.Ï‡. 5" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>d (Î´Î¹Î±Ï†Î¿ÏÎ¬):</b></div>
                <input type="number" id="ap-d" step="any" placeholder="Ï€.Ï‡. 3" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>n (Î¸Î­ÏƒÎ· ÏŒÏÎ¿Ï…):</b></div>
                <input type="number" id="ap-n" min="1" placeholder="Ï€.Ï‡. 10" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
            </div>

            <!-- find_progression -->
            <div id="ap-progression-inputs" style="margin-top:15px; display:none">
              <div class="muted" style="margin-bottom:8px">Î”ÏÏƒÎµ Î´ÏÎ¿ ÏŒÏÎ¿Ï…Ï‚ Î³Î¹Î± Î½Î± Î²ÏÎµÎ¸ÎµÎ¯ Î· Ï€ÏÏŒÎ¿Î´Î¿Ï‚:</div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>aáµ¢ (Ï€ÏÏÏ„Î¿Ï‚ Î³Î½Ï‰ÏƒÏ„ÏŒÏ‚ ÏŒÏÎ¿Ï‚):</b></div>
                <input type="number" id="ap-ai" step="any" placeholder="Ï€.Ï‡. 8" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>i (Î¸Î­ÏƒÎ· Ï€ÏÏÏ„Î¿Ï… ÏŒÏÎ¿Ï…):</b></div>
                <input type="number" id="ap-i" min="1" placeholder="Ï€.Ï‡. 3" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>aâ±¼ (Î´ÎµÏÏ„ÎµÏÎ¿Ï‚ Î³Î½Ï‰ÏƒÏ„ÏŒÏ‚ ÏŒÏÎ¿Ï‚):</b></div>
                <input type="number" id="ap-aj" step="any" placeholder="Ï€.Ï‡. 20" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>j (Î¸Î­ÏƒÎ· Î´ÎµÏÏ„ÎµÏÎ¿Ï… ÏŒÏÎ¿Ï…):</b></div>
                <input type="number" id="ap-j" min="1" placeholder="Ï€.Ï‡. 7" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
            </div>

            <!-- arithmetic_mean -->
            <div id="ap-mean-inputs" style="margin-top:15px; display:none">
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>a (Ï€ÏÏÏ„Î¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚):</b></div>
                <input type="number" id="ap-mean-a" step="any" placeholder="Ï€.Ï‡. 10" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>b (Î´ÎµÏÏ„ÎµÏÎ¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚):</b></div>
                <input type="number" id="ap-mean-b" step="any" placeholder="Ï€.Ï‡. 20" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
            </div>

            <div class="row" style="margin-top:15px">
              <button class="btn primary" id="ap-calc-btn" type="button">Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚</button>
              <button class="btn ghost" id="ap-clear-btn" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
          </div>

          <div class="mini-card">
            <div class="mini-title">Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±</div>
            <div id="ap-results" class="result-box mono" style="min-height:200px; white-space:pre-wrap"></div>
          </div>
        </div>
      </div>

      <!-- Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¹ÎºÎ® Î ÏÏŒÎ¿Î´Î¿Ï‚ -->
      <div class="sequences-subpanel" id="sequences-geometric">
        <div class="two-col">
          <div class="mini-card">
            <div class="mini-title">Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¹ÎºÎ® Î ÏÏŒÎ¿Î´Î¿Ï‚ (Î“.Î .)</div>
            <div class="muted" style="margin-top:4px; font-size:0.8rem">aâ‚™ = aâ‚ Â· Î»^(n-1)</div>
            
            <div style="margin-top:15px">
              <div class="muted" style="margin-bottom:4px"><b>Î¤ÏÏ€Î¿Ï‚ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï:</b></div>
              <select id="gp-calc-type" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db">
                <option value="find_term">Î’ÏÎµÏ‚ aâ‚™ (n-Î¿ÏƒÏ„ÏŒÏ‚ ÏŒÏÎ¿Ï‚)</option>
                <option value="find_sum">Î’ÏÎµÏ‚ Sâ‚™ (Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± n ÏŒÏÏ‰Î½)</option>
                <option value="find_infinite_sum">Î’ÏÎµÏ‚ Sâˆ (Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î¬Ï€ÎµÎ¹ÏÏ‰Î½ ÏŒÏÏ‰Î½)</option>
                <option value="find_progression">Î’ÏÎµÏ‚ Ï€ÏÏŒÎ¿Î´Î¿ Î±Ï€ÏŒ 2 ÏŒÏÎ¿Ï…Ï‚</option>
                <option value="geometric_mean">Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¹ÎºÏŒÏ‚ Î¼Î­ÏƒÎ¿Ï‚</option>
              </select>
            </div>

            <!-- find_term / find_sum / find_infinite_sum -->
            <div id="gp-basic-inputs" style="margin-top:15px">
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>aâ‚ (Ï€ÏÏÏ„Î¿Ï‚ ÏŒÏÎ¿Ï‚):</b></div>
                <input type="number" id="gp-a1" step="any" placeholder="Ï€.Ï‡. 2" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>Î» (Î»ÏŒÎ³Î¿Ï‚):</b></div>
                <input type="number" id="gp-lamda" step="any" placeholder="Ï€.Ï‡. 0.5" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
              <div id="gp-n-input" style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>n (Î¸Î­ÏƒÎ· ÏŒÏÎ¿Ï…):</b></div>
                <input type="number" id="gp-n" min="1" placeholder="Ï€.Ï‡. 10" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
            </div>

            <!-- find_progression -->
            <div id="gp-progression-inputs" style="margin-top:15px; display:none">
              <div class="muted" style="margin-bottom:8px">Î”ÏÏƒÎµ Î´ÏÎ¿ ÏŒÏÎ¿Ï…Ï‚ Î³Î¹Î± Î½Î± Î²ÏÎµÎ¸ÎµÎ¯ Î· Ï€ÏÏŒÎ¿Î´Î¿Ï‚:</div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>aáµ¢ (Ï€ÏÏÏ„Î¿Ï‚ Î³Î½Ï‰ÏƒÏ„ÏŒÏ‚ ÏŒÏÎ¿Ï‚):</b></div>
                <input type="number" id="gp-ai" step="any" placeholder="Ï€.Ï‡. 4" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>i (Î¸Î­ÏƒÎ· Ï€ÏÏÏ„Î¿Ï… ÏŒÏÎ¿Ï…):</b></div>
                <input type="number" id="gp-i" min="1" placeholder="Ï€.Ï‡. 2" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>aâ±¼ (Î´ÎµÏÏ„ÎµÏÎ¿Ï‚ Î³Î½Ï‰ÏƒÏ„ÏŒÏ‚ ÏŒÏÎ¿Ï‚):</b></div>
                <input type="number" id="gp-aj" step="any" placeholder="Ï€.Ï‡. 32" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>j (Î¸Î­ÏƒÎ· Î´ÎµÏÏ„ÎµÏÎ¿Ï… ÏŒÏÎ¿Ï…):</b></div>
                <input type="number" id="gp-j" min="1" placeholder="Ï€.Ï‡. 5" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
            </div>

            <!-- geometric_mean -->
            <div id="gp-mean-inputs" style="margin-top:15px; display:none">
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>a (Ï€ÏÏÏ„Î¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚):</b></div>
                <input type="number" id="gp-mean-a" step="any" min="0" placeholder="Ï€.Ï‡. 9" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
              <div style="margin-top:10px">
                <div class="muted" style="margin-bottom:4px"><b>b (Î´ÎµÏÏ„ÎµÏÎ¿Ï‚ Î±ÏÎ¹Î¸Î¼ÏŒÏ‚):</b></div>
                <input type="number" id="gp-mean-b" step="any" min="0" placeholder="Ï€.Ï‡. 16" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
              </div>
            </div>

            <div class="row" style="margin-top:15px">
              <button class="btn primary" id="gp-calc-btn" type="button">Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚</button>
              <button class="btn ghost" id="gp-clear-btn" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
          </div>

          <div class="mini-card">
            <div class="mini-title">Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±</div>
            <div id="gp-results" class="result-box mono" style="min-height:200px; white-space:pre-wrap"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== STATS ===== -->
    <div class="tool-panel" id="tool-stats">
      <div style="margin-bottom:12px; padding:8px 12px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px; font-size:0.85rem; display:flex; align-items:center; gap:10px; flex-wrap:wrap">
        <span><b>Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±:</b> <span id="backend-mode">â€”</span></span>
        <span><b>Server:</b> <span id="stats-server-status">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚â€¦</span></span>
        <button class="btn ghost" id="stats-server-test" type="button" style="padding:4px 10px; font-size:0.8rem">Test</button>
      </div>
      <div class="stats-tabs" style="margin-bottom:10px; flex-wrap:wrap">
        <button class="stats-tab active" data-stats-tool="variables" type="button">ÎœÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚</button>
        <button class="stats-tab" data-stats-tool="descriptive" type="button">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î¹ÎºÎ® Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®</button>
        <button class="stats-tab" data-stats-tool="normal" type="button">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÎšÎ±Î½Î¿Î½Î¹ÎºÏŒÏ„Î·Ï„Î±Ï‚</button>
        <button class="stats-tab" data-stats-tool="ci" type="button">Î”.Î•.</button>
        <button class="stats-tab" data-stats-tool="ttest" type="button">T-Test</button>
        <button class="stats-tab" data-stats-tool="anova" type="button">ANOVA</button>
        <button class="stats-tab" data-stats-tool="chisquare" type="button">Ï‡Â²</button>
        <button class="stats-tab" data-stats-tool="regression" type="button">Î Î±Î»Î¹Î½Î´ÏÏŒÎ¼Î·ÏƒÎ·</button>
        <button class="stats-tab" data-stats-tool="excel" type="button">Excel</button>
        <button class="stats-tab" data-stats-tool="ai" type="button">AI Assistant</button>
      </div>
      <div class="two-col">
        <div class="mini-card">
          <div id="stats-panel-variables" class="stats-subpanel active">
            <div class="mini-title">ÎœÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚ (Data View)</div>
            <div class="muted" style="margin-top:4px; font-size:0.8rem">ÎšÎ¬Î¸Îµ Î³ÏÎ±Î¼Î¼Î® = Î¬Ï„Î¿Î¼Î¿ Â· ÎºÎ¬Î¸Îµ ÏƒÏ„Î®Î»Î· = Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î®. Î•Ï€Î¹ÎºÏŒÎ»Î»Î·ÏƒÎ· Î±Ï€ÏŒ Excel: tab. Î Î»Î¿Î®Î³Î·ÏƒÎ·: Î²ÎµÎ»Î¬ÎºÎ¹Î± / Tab / Ï„ÏÎ¿Ï‡Î¬ÎºÎ¹.</div>
            <div class="variables-grid-wrap" id="variables-grid-wrap" style="margin-top:10px; overflow:auto; max-height:280px">
              <table class="variables-grid" id="variables-grid">
                <thead><tr id="variables-grid-head"></tr></thead>
                <tbody id="variables-grid-body"></tbody>
              </table>
            </div>
            <div class="row" style="margin-top:10px; gap:6px; flex-wrap:wrap">
              <button class="btn ghost" id="grid-add-row" type="button">+ Î“ÏÎ±Î¼Î¼Î®</button>
              <button class="btn ghost" id="grid-add-col" type="button">+ Î£Ï„Î®Î»Î·</button>
              <button class="btn ghost" id="grid-paste" type="button">Î•Ï€Î¹ÎºÏŒÎ»Î»Î·ÏƒÎ· Î±Ï€ÏŒ Excel</button>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn ghost" id="stats-insert-btn" type="button">Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
              <button class="btn ghost" id="stats-clear-btn" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
          </div>
          <div id="stats-panel-descriptive" class="stats-subpanel" style="display:none">
            <div class="mini-title">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î¹ÎºÎ® Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®</div>
            <div class="muted" style="margin-top:4px; font-size:0.8rem">Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® (Î® Î´ÏÎ¿). Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ® Î³Î¹Î± Î±Î½Î¬Î»Ï…ÏƒÎ· Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±.</div>
            <div style="margin-top:10px">
              <div class="muted" style="margin-bottom:4px"><b>ÎœÎµÏ„Î±Î²Î»Î·Ï„Î® 1:</b></div>
              <select id="descriptive-var1" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ â€”</option></select>
            </div>
            <div style="margin-top:10px">
              <div class="muted" style="margin-bottom:4px"><b>ÎœÎµÏ„Î±Î²Î»Î·Ï„Î® 2 (Ï€ÏÎ¿Î±Î¹Ï.):</b></div>
              <select id="descriptive-var2" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” ÎšÎ±Î¼Î¯Î± â€”</option></select>
            </div>
            <div style="margin-top:10px">
              <div class="muted" style="margin-bottom:4px"><b>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ® (Ï€ÏÎ¿Î±Î¹Ï. â€“ Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±):</b></div>
              <select id="descriptive-cat" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” ÎšÎ±Î¼Î¯Î± â€”</option></select>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="descriptive-btn" type="button">Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ</button>
              <button class="btn ghost" id="descriptive-clear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
          </div>
          <div id="stats-panel-normal" class="stats-subpanel" style="display:none">
            <div class="mini-title">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÎšÎ±Î½Î¿Î½Î¹ÎºÏŒÏ„Î·Ï„Î±Ï‚</div>
            <div class="muted" style="margin-top:4px; font-size:0.8rem">Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® Î±Ï€ÏŒ Ï„Î¿ Ï€Î»Î­Î³Î¼Î±. Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ® Î³Î¹Î± Î±Î½Î¬Î»Ï…ÏƒÎ· Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±.</div>
            <div style="margin-top:10px">
              <div class="muted" style="margin-bottom:4px"><b>ÎœÎµÏ„Î±Î²Î»Î·Ï„Î®:</b></div>
              <select id="normal-var" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® â€”</option></select>
            </div>
            <div style="margin-top:10px">
              <div class="muted" style="margin-bottom:4px"><b>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ® (Ï€ÏÎ¿Î±Î¹Ï.):</b></div>
              <select id="normal-cat" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” ÎšÎ±Î¼Î¯Î± â€”</option></select>
            </div>
            <div class="muted" style="margin-top:10px"><b>ÎœÎ­Î¸Î¿Î´Î¿Ï‚:</b></div>
            <div class="row">
              <label><input type="radio" name="normal-method" value="shapiro" checked> Shapiro-Wilk</label>
              <label><input type="radio" name="normal-method" value="ks"> Kolmogorov-Smirnov</label>
              <label><input type="radio" name="normal-method" value="normaltest"> D'Agostino-Pearson</label>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="normal-btn" type="button">Î•ÎºÏ„Î­Î»ÎµÏƒÎ· Î•Î»Î­Î³Ï‡Î¿Ï…</button>
              <button class="btn ghost" id="normal-clear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
          </div>
          <div id="stats-panel-ci" class="stats-subpanel" style="display:none">
            <div class="mini-title">Î”Î¹Î¬ÏƒÏ„Î·Î¼Î± Î•Î¼Ï€Î¹ÏƒÏ„Î¿ÏƒÏÎ½Î·Ï‚</div>
            <div class="muted" style="margin-top:4px; font-size:0.8rem">Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î®. Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ®.</div>
            <div style="margin-top:10px">
              <div class="muted" style="margin-bottom:4px"><b>ÎœÎµÏ„Î±Î²Î»Î·Ï„Î®:</b></div>
              <select id="ci-var" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ â€”</option></select>
            </div>
            <div style="margin-top:10px">
              <div class="muted" style="margin-bottom:4px"><b>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ® (Ï€ÏÎ¿Î±Î¹Ï.):</b></div>
              <select id="ci-cat" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” ÎšÎ±Î¼Î¯Î± â€”</option></select>
            </div>
            <div class="inline-inputs" style="margin-top:10px">
              <div><div class="muted"><b>Î•Ï€Î¯Ï€ÎµÎ´Î¿ (%)</b></div><input type="number" id="ci-level" value="95" min="1" max="99" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" /></div>
              <div><div class="muted"><b>Ïƒ Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï (Ï€ÏÎ¿Î±Î¹Ï.)</b></div><input type="number" id="ci-sigma" placeholder="Î¬Î´ÎµÎ¹Î¿ Î³Î¹Î± t" step="any" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" /></div>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="ci-btn" type="button">Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚</button>
              <button class="btn ghost" id="ci-clear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
          </div>
          <div id="stats-panel-ttest" class="stats-subpanel" style="display:none">
            <div class="mini-title">T-Test</div>
            <div class="muted" style="margin-top:4px; font-size:0.8rem">Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚. Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ®.</div>
            <div class="muted" style="margin-top:10px"><b>Î¤ÏÏ€Î¿Ï‚:</b></div>
            <div class="row">
              <label><input type="radio" name="ttest-type" value="onesample" checked> One-Sample</label>
              <label><input type="radio" name="ttest-type" value="twosample"> Two-Sample</label>
              <label><input type="radio" name="ttest-type" value="paired"> Paired</label>
            </div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>ÎœÎµÏ„Î±Î²Î»Î·Ï„Î® 1:</b></div><select id="ttest-var1" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ â€”</option></select></div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>ÎœÎµÏ„Î±Î²Î»Î·Ï„Î® 2 (two/paired):</b></div><select id="ttest-var2" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ â€”</option></select></div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ® (Ï€ÏÎ¿Î±Î¹Ï.):</b></div><select id="ttest-cat" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” ÎšÎ±Î¼Î¯Î± â€”</option></select></div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>Î¼â‚€ (one-sample):</b></div><input type="number" id="ttest-mu0" value="0" step="any" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" /></div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>Alternative:</b></div><select id="ttest-alt" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="two-sided">two-sided</option><option value="less">less</option><option value="greater">greater</option></select></div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="ttest-btn" type="button">Î•ÎºÏ„Î­Î»ÎµÏƒÎ· T-Test</button>
              <button class="btn ghost" id="ttest-clear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
          </div>
          <div id="stats-panel-anova" class="stats-subpanel" style="display:none">
            <div class="mini-title">ANOVA</div>
            <div class="muted" style="margin-top:4px; font-size:0.8rem">Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® ÎºÎ±Î¹ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ®.</div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>ÎœÎµÏ„Î±Î²Î»Î·Ï„Î®:</b></div><select id="anova-var" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ â€”</option></select></div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ® Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î®:</b></div><select id="anova-cat" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ â€”</option></select></div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="anova-btn" type="button">Î•ÎºÏ„Î­Î»ÎµÏƒÎ· ANOVA</button>
              <button class="btn ghost" id="anova-clear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
          </div>
          <div id="stats-panel-chisquare" class="stats-subpanel" style="display:none">
            <div class="mini-title">Chi-Square</div>
            <div class="muted" style="margin-top:4px; font-size:0.8rem">Î”ÏÎ¿ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ­Ï‚ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚ â†’ Ï€Î¯Î½Î±ÎºÎ±Ï‚ ÏƒÏ…Ï‡Î½Î¿Ï„Î®Ï„Ï‰Î½.</div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>ÎœÎµÏ„Î±Î²Î»Î·Ï„Î® 1 (Î³ÏÎ±Î¼Î¼Î­Ï‚):</b></div><select id="chi-var1" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ â€”</option></select></div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>ÎœÎµÏ„Î±Î²Î»Î·Ï„Î® 2 (ÏƒÏ„Î®Î»ÎµÏ‚):</b></div><select id="chi-var2" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ â€”</option></select></div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="chi-btn" type="button">Î•ÎºÏ„Î­Î»ÎµÏƒÎ· Ï‡Â²</button>
              <button class="btn ghost" id="chi-clear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
          </div>
          <div id="stats-panel-regression" class="stats-subpanel" style="display:none">
            <div class="mini-title">Î“ÏÎ±Î¼Î¼Î¹ÎºÎ® Î Î±Î»Î¹Î½Î´ÏÏŒÎ¼Î·ÏƒÎ·</div>
            <div class="muted" style="margin-top:4px; font-size:0.8rem">Î•Ï€Î¯Î»ÎµÎ¾Îµ X, Y. Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ®.</div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>X (Î±Î½ÎµÎ¾Î¬ÏÏ„Î·Ï„Î·):</b></div><select id="reg-x" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ â€”</option></select></div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>Y (ÎµÎ¾Î±ÏÏ„Î·Î¼Î­Î½Î·):</b></div><select id="reg-y" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ â€”</option></select></div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ® (Ï€ÏÎ¿Î±Î¹Ï.):</b></div><select id="reg-cat" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db"><option value="">â€” ÎšÎ±Î¼Î¯Î± â€”</option></select></div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="reg-btn" type="button">Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚</button>
              <button class="btn ghost" id="reg-clear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
          </div>
          <div id="stats-panel-excel" class="stats-subpanel" style="display:none">
            <div class="mini-title">Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Î±Ï€ÏŒ Excel</div>
            <div class="muted" style="margin-top:4px">Î•Ï€Î¯Î»ÎµÎ¾Îµ .xlsx Î® .xls. Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î¸Î± Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸Î¿ÏÎ½ ÏƒÏ„Î¿ Ï€Î»Î­Î³Î¼Î± ÎœÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚.</div>
            <input type="file" id="excel-file" accept=".xlsx,.xls" style="margin-top:8px; width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db" />
            <div style="margin-top:8px"><div class="muted"><b>Sheet (Ï€ÏÎ¿Î±Î¹Ï.):</b></div><input type="text" id="excel-sheet" placeholder="ÎšÎµÎ½ÏŒ = Ï€ÏÏÏ„Î¿" style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db; margin-top:4px" /></div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="excel-btn" type="button">Î•Î¹ÏƒÎ±Î³Ï‰Î³Î®</button>
              <button class="btn ghost" id="excel-clear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
          </div>
          <div id="stats-panel-ai" class="stats-subpanel" style="display:none">
            <div class="mini-title">AI Assistant Î³Î¹Î± Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®</div>
            <div class="muted" style="margin-top:4px">Î”ÎµÎ´Î¿Î¼Î­Î½Î± (JSON) ÎºÎ±Î¹ ÎµÏÏÏ„Î·ÏƒÎ·. Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï„Î¿Ï… Ï€Î»Î­Î³Î¼Î±Ï„Î¿Ï‚ Î±Î½ Î±Ï†ÎµÎ¸ÎµÎ¯ ÎºÎµÎ½ÏŒ.</div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>Î”ÎµÎ´Î¿Î¼Î­Î½Î± (JSON, Ï€ÏÎ¿Î±Î¹Ï.):</b></div><textarea id="ai-stats-data" placeholder='{"var1":[1,2,3],"var2":[4,5,6]}' style="width:100%; min-height:60px; padding:8px; border-radius:8px; border:1px solid #d1d5db; font-family:monospace; resize:vertical"></textarea></div>
            <div style="margin-top:10px"><div class="muted" style="margin-bottom:4px"><b>Î•ÏÏÏ„Î·ÏƒÎ·:</b></div><textarea id="ai-stats-query" placeholder="Î•Î»Î­Î³Î¾Ï‰ ÎºÎ±Î½Î¿Î½Î¹ÎºÏŒÏ„Î·Ï„Î± ÎºÎ±Î¹ ÎºÎ¬Î½Îµ t-test" style="width:100%; min-height:50px; padding:8px; border-radius:8px; border:1px solid #d1d5db; resize:vertical"></textarea></div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="ai-stats-btn" type="button">Î•ÎºÏ„Î­Î»ÎµÏƒÎ·</button>
              <button class="btn ghost" id="ai-stats-clear" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            </div>
          </div>
        </div>
        <div class="mini-card">
          <div class="mini-title">Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±</div>
          <div class="muted" style="font-size:0.8rem; margin-top:2px">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î¹ÎºÎ® Î±Ï€ÏŒ Â«Î ÎµÏÎ¹Î³ÏÎ±Ï†Î¹ÎºÎ® Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®Â» Â· Î­Î»ÎµÎ³Ï‡Î¿Î¹ Î±Ï€ÏŒ Ï„Î± Î±Î½Ï„Î¯ÏƒÏ„Î¿Î¹Ï‡Î± tabs.</div>
          <div id="stats-results" class="result-box mono" style="min-height:200px; white-space:pre-wrap"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- ===== ANSWER (RESTORED + save/pdf/print) ===== -->
  <div class="card" id="answer-card">
    <label>Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· AI</label>
    <div id="ai-answer" class="answer">Î ÎµÏÎ¹Î¼Î­Î½Ï‰ Ï„Î·Î½ Ï€ÏÏÏ„Î· ÏƒÎ¿Ï… ÎµÏÏÏ„Î·ÏƒÎ·â€¦</div>

    <div class="answer-actions">
      <button class="btn ghost" id="save-answer-btn" type="button">ğŸ’¾ Save</button>
      <button class="btn ghost" id="download-answer-btn" type="button">â¬‡ï¸ .txt</button>
      <button class="btn ghost" id="pdf-answer-btn" type="button">â¬‡ï¸ PDF</button>
      <button class="btn primary" id="print-answer-btn" type="button">ğŸ–¨ï¸ Print</button>
      <span class="pill" id="saved-info">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.</span>
    </div>

    <div id="continue-box" class="continue-box">
      <div class="continue-q">ÎÎ± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÏ‰;</div>
      <div class="row">
        <button class="btn dark" id="continue-yes" type="button">ÎÎ‘Î™</button>
        <button class="btn ghost" id="continue-no" type="button">ÎŸÎ§Î™</button>
        <span class="muted" id="continue-status"></span>
      </div>
    </div>
  </div>
</main>

<!-- ===== TOAST ===== -->
<div id="answer-toast" class="toast" role="status" aria-live="polite">
  <span>âœ… Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¿ ÎºÎ¬Ï„Ï‰.</span>
  <button id="toast-go" class="toast-btn" type="button">Î”ÎµÏ‚ Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·</button>
</div>

<!-- ===== INK MODAL ===== -->
<div id="ink-backdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Î Î¯Î½Î±ÎºÎ±Ï‚ Î“ÏÎ±Ï†Î®Ï‚">
    <div class="modal-head">
      <div class="modal-title">âœï¸ Î Î¯Î½Î±ÎºÎ±Ï‚ Î“ÏÎ±Ï†Î®Ï‚ â€” Î³ÏÎ¬ÏˆÎµ (ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ¬ / Î›ÎµÎºÏ„Î¹ÎºÎ¬) ÎºÎ±Î¹ Ï€Î­ÏÎ±ÏƒÎ­ Ï„Î± ÏƒÏ„Î± Ï€ÎµÎ´Î¯Î±</div>
      <button class="modal-close" id="ink-close" type="button">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ âœ•</button>
    </div>

    <div class="modal-body">
      <div class="ink-controls">
        <div class="ctrl">
          <label for="ink-color">Î§ÏÏÎ¼Î±</label>
          <input id="ink-color" type="color" value="#111827" />
        </div>
        <div class="ctrl">
          <label for="ink-size">Î Î¬Ï‡Î¿Ï‚</label>
          <input id="ink-size" type="range" min="1" max="16" step="1" value="4" />
          <span class="val" id="ink-size-val">4</span>
        </div>
        <span class="muted">Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î¼Îµ Ï€Î¿Î½Ï„Î¯ÎºÎ¹, touch ÎºÎ±Î¹ stylus.</span>
      </div>

      <div class="ink-split">
        <div class="ink-pane">
          <div class="ink-pane-title">ğŸ§® Î“ÏÎ¬ÏˆÎµ ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ— Î­ÎºÏ†ÏÎ±ÏƒÎ·</div>
          <div class="ink-wrap">
            <canvas id="ink-math-canvas" class="ink-canvas"></canvas>
          </div>
          <div class="ink-actions">
            <button class="btn primary" id="ink-math-to-main" type="button">â¡ï¸ Î Î­ÏÎ±ÏƒÎµ ÏƒÏ„Î· ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® ÎˆÎºÏ†ÏÎ±ÏƒÎ·</button>
            <button class="btn ghost" id="ink-math-clear" type="button">ğŸ§¼ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
          </div>
          <div class="ink-tip">Tip: Î³ÏÎ¬ÏˆÎµ ÎºÎ±Î¸Î±ÏÎ¬ (Ï€.Ï‡. ÎºÎ»Î¬ÏƒÎ¼Î±Ï„Î± ÏƒÎµ â€œÏ€Î¬Î½Ï‰/ÎºÎ¬Ï„Ï‰â€).</div>
        </div>

        <div class="ink-pane">
          <div class="ink-pane-title">ğŸ’¬ Î“ÏÎ¬ÏˆÎµ Î›Î•ÎšÎ¤Î™ÎšÎ— Î±Ï€Î¿ÏÎ¯Î±</div>
          <div class="ink-wrap">
            <canvas id="ink-text-canvas" class="ink-canvas"></canvas>
          </div>
          <div class="ink-actions">
            <button class="btn primary" id="ink-text-to-main" type="button">â¡ï¸ Î Î­ÏÎ±ÏƒÎµ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® Î‘Ï€Î¿ÏÎ¯Î±</button>
            <button class="btn ghost" id="ink-text-clear" type="button">ğŸ§¼ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
          </div>
          <div class="ink-tip">Tip: Î³ÏÎ¬ÏˆÎµ Î¼Î¹ÎºÏÎ­Ï‚ Ï€ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚/Î»Î­Î¾ÎµÎ¹Ï‚ (ÏŒÏ‡Î¹ Ï„ÎµÏÎ¬ÏƒÏ„Î¹Î¿ Ï€Î±ÏÎ¬Î³ÏÎ±Ï†Î¿).</div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="muted">
        Î Î±Ï„Î¬Ï‚ â€œÎ Î­ÏÎ±ÏƒÎµâ€¦â€ Î³Î¹Î± Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ· ÎºÎ±Î¹ Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬. ÎœÎµÏ„Î¬, Ï€Î±Ï„Î¬Ï‚ <b>â€œÎ¡ÏÏ„Î± Ï„Î¿ AIâ€</b> Î±Ï€ÏŒ Ï„Î·Î½ ÎºÏÏÎ¹Î± ÏƒÎµÎ»Î¯Î´Î±.
      </div>
      <div class="muted" id="ink-transfer-status"></div>
    </div>
  </div>
</div>
<script src="https://www.geogebra.org/apps/deployggb.js"></script>
<script>
  /* ===================== SERVER ===================== */
  // Auto-detect: local â†’ local API; staging hostname â†’ staging API; else â†’ production
  const isLocal = (typeof window !== "undefined" && (
    window.location.protocol === "file:" ||
    /^localhost$|^127\.0\.0\.1$/i.test(window.location.hostname)
  ));
  const isStaging = typeof window !== "undefined" && /staging/i.test(window.location.hostname);
  const BASE_URL = isLocal
    ? "http://127.0.0.1:8003"
    : isStaging
      ? "https://math-ai-server-staging.onrender.com"
      : "https://math-ai-server.onrender.com";
  const modeLabel = isLocal ? "Î¤Î¿Ï€Î¹ÎºÎ¬" : isStaging ? "Staging" : "Online";
  const elMode = document.getElementById("backend-mode");
  if (elMode) elMode.textContent = modeLabel;
  const ggbBadge = document.getElementById("ggb-backend-badge");
  if (ggbBadge) ggbBadge.textContent = modeLabel;
  const fileWarn = document.getElementById("file-protocol-warn");
  if (fileWarn && window.location.protocol === "file:") fileWarn.classList.remove("is-hidden");

  /* ===================== TOAST ===================== */
  const toast = document.getElementById("answer-toast");
  const toastGo = document.getElementById("toast-go");
  const answerCard = document.getElementById("answer-card");

  function showToast(){
    toast.style.display = "flex";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => hideToast(), 7000);
  }
  function hideToast(){ toast.style.display = "none"; }
  function isAnswerVisible(){
    const r = answerCard.getBoundingClientRect();
    const vh = window.innerHeight || document.documentElement.clientHeight;
    return (r.top < vh * 0.75) && (r.bottom > vh * 0.25);
  }
  function scrollToAnswer(){
    answerCard.scrollIntoView({ behavior: "smooth", block: "start" });
    hideToast();
  }
  toastGo.addEventListener("click", scrollToAnswer);
  window.addEventListener("scroll", () => {
    if (toast.style.display !== "none" && isAnswerVisible()) hideToast();
  }, { passive:true });

  /* ===================== LEVEL ===================== */
  let currentLevel = "lyceum";
  document.querySelectorAll(".level-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".level-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentLevel = btn.dataset.level;
    });
  });

  /* ===================== HELPERS ===================== */
  const mathInput = document.getElementById("math-input");
  const textInput = document.getElementById("text-input");

  function insertAtCursor(el, text){
    const start = el.selectionStart ?? el.value.length;
    const end = el.selectionEnd ?? el.value.length;
    el.setRangeText(text, start, end, "end");
    el.focus();
  }
  function replaceSelection(el, newText){
    const start = el.selectionStart ?? 0;
    const end = el.selectionEnd ?? 0;
    if (start === end){ insertAtCursor(el, newText); return; }
    el.setRangeText(newText, start, end, "end");
    el.focus();
  }
  function getSelectionText(el){
    const start = el.selectionStart ?? 0;
    const end = el.selectionEnd ?? 0;
    if (start === end) return "";
    return el.value.slice(start, end);
  }

  function addToolHeader(title){ return `=== ${title} ===`; }
  function appendToTextContext(block){
    const b = (block || "").trim();
    if (!b) return;
    if (textInput.value.includes(b)) return;
    const prefix = textInput.value.trim() ? "\n\n" : "";
    textInput.value = textInput.value.trim() + prefix + b;
  }

  /* Greekâ†’English math normalization */
  function greekToEnglishMath(s){
    let t = (s || "").toString();
    t = t.replace(/Ï‡/g, "x").replace(/Î§/g, "x");
    t = t.replace(/âˆ’/g,'-').replace(/Ã·/g,'/').replace(/Ã—/g,'*');
    t = t.replace(/Î·Î¼\s*/g, "sin ");
    t = t.replace(/ÏƒÏ…Î½\s*/g, "cos ");
    t = t.replace(/ÎµÏ†\s*/g, "tan ");
    t = t.replace(/ÏƒÏ†\s*/g, "cot ");
    t = t.replace(/sinx/g, "sin x").replace(/cosx/g, "cos x").replace(/tanx/g, "tan x").replace(/cotx/g, "cot x");
    t = t.replace(/Ï€/g, "\\pi ");
    t = t.replace(/[ \t]+/g, " ").trim();
    return t;
  }

  /* ===================== KEYBOARD ===================== */
  const keyboardLayouts = {
    num: [['x','y','z','Ï€','e','7','8','9','Ã—','Ã·'],['xÂ²','xâ¿','a/b','âˆš','â¿âˆš','4','5','6','+','âˆ’'],['1','2','3','0','â‰¤','â‰¥','<','>'],['=','|x|','âˆ','Î£',' ']],
    func: [['sin','cos','tan','ln','logâ‚â‚€','logâ‚bâ‚'],['sinâ»Â¹','cosâ»Â¹','tanâ»Â¹','d/dx','âˆ«','âˆ«_{a}^{b}'],['sec(x)','csc(x)','Ï€âˆ«','âˆ¬','âˆ¬_{D}','dx'],['lim','+âˆ','-âˆ','=',' ']],
    abc: [['q','w','e','r','t','y','u','i','o','p'],['a','s','d','f','g','h','j','k','l'],['z','x','c','v','b','n','m','(',')'],['=',' ']],
    sym: [['#','&','Â¬','â‰ˆ','â‰ ','âˆ'],['â‰¤','â‰¥','âˆˆ','âˆ‰','â‡’','â‡”'],['âŠ‚','âŠ†','âŠ„','âŠ‡','|','â€–'],['=',' ']]
  };
  const keyboardRows = document.getElementById("keyboard-rows");

  function insertFromKey(label){
    let insertText;
    if (label === ' ') insertText = ' ';
    else if (label === 'xÂ²') insertText = 'x^2';
    else if (label === 'xâ¿') insertText = 'x^';
    else if (label === 'a/b') insertText = '/';
    else if (label === 'ln') insertText = '\\ln(';
    else if (label === 'logâ‚â‚€') insertText = '\\log_{10}(';
    else if (label === 'logâ‚bâ‚') insertText = '\\log_{b}(';
    else if (label === 'âˆš') insertText = 'âˆš( )';
    else if (label === 'â¿âˆš') insertText = '3âˆš( )';
    else if (label === 'Ï€âˆ«') insertText = 'V = Ï€âˆ«_{a}^{b} f(x)^2 dx';
    else if (label === 'âˆ«_{a}^{b}') insertText = 'âˆ«_{a}^{b} f(x) dx';
    else if (label === 'âˆ¬') insertText = 'âˆ¬ f(x,y) dx dy';
    else if (label === 'âˆ¬_{D}') insertText = 'âˆ¬_{D} f(x,y) dx dy';
    else if (label === '|x|') insertText = '| |';
    else if (label === 'lim') insertText = '\\lim_{x \\to a} f(x)';
    else if (label === '+âˆ') insertText = '+\\infty';
    else if (label === '-âˆ') insertText = '-\\infty';
    else if (label === 'âˆ') insertText = '\\infty';
    else if (label === 'Î£') insertText = '\\sum_{a}^{b} a_n';
    else insertText = label;

    insertAtCursor(mathInput, insertText);
    updateMathPreview();
  }
  function loadKeyboard(name){
    keyboardRows.innerHTML = "";
    keyboardLayouts[name].forEach(row => {
      const wrap = document.createElement("div");
      row.forEach(label => {
        const b = document.createElement("button");
        b.className = "key"; b.type = "button";
        b.textContent = label === " " ? "ÎºÎµÎ½ÏŒ" : label;
        b.onclick = () => insertFromKey(label);
        wrap.appendChild(b);
      });
      keyboardRows.appendChild(wrap);
    });
  }
  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      loadKeyboard(btn.dataset.layout);
    });
  });
  loadKeyboard("num");

  /* ===================== MATH PREVIEW ===================== */
  const mathPreview = document.getElementById("math-preview");
  const mathPreviewPlaceholder = document.getElementById("math-preview-placeholder");

  function isProbablyLatex(s){ return /\\(frac|sqrt|int|sum|begin|pi|cdot|left|right|det|sin|cos|tan)/.test(s || ""); }

  function convertToLatex(text){
    let t = (text || "").trim();
    if (!t) return "";
    const alreadyLatex = isProbablyLatex(t);

    t = greekToEnglishMath(t);
    t = t.replace(/([0-9a-zA-Z\)\}])\s*:\s*([0-9a-zA-Z\\(\{])/g, '$1/$2');

    if (!alreadyLatex){
      t = t.replace(/âˆ/g,'\\infty');
      t = t.replace(/âˆ¬/g,'\\iint ');
      t = t.replace(/âˆ«/g,'\\int ');
      t = t.replace(/\s*dx\s*dy\b/g,'\\, dx \\, dy');
      t = t.replace(/\s*dx\b/g,'\\, dx');

      t = t.replace(/(\d+)\s*âˆš\s*\(([^)]*)\)/g,'\\sqrt[$1]{$2}');
      t = t.replace(/(\d+)\s*âˆš\s*([a-zA-Z0-9]+)/g,'\\sqrt[$1]{$2}');
      t = t.replace(/âˆš\s*\(([^)]*)\)/g,'\\sqrt{$1}');
      t = t.replace(/âˆš\s*([a-zA-Z0-9]+)/g,'\\sqrt{$1}');
      t = t.replace(/sqrt\s*\(([^)]*)\)/gi,'\\sqrt{$1}');

      t = t.replace(/([0-9a-zA-Z\\]+)\s*\^\s*\(([^)]+)\)/g,'$1^{ $2 }');
      t = t.replace(/([a-zA-Z0-9])\^(\d+)/g,'$1^{ $2 }');

      t = t.replace(/\(([^()]+)\)\s*\/\s*\(([^()]+)\)/g,'\\frac{$1}{$2}');
      t = t.replace(/([0-9a-zA-Z]+)\s*\/\s*\(([^()]+)\)/g,'\\frac{$1}{$2}');
      t = t.replace(/([0-9a-zA-Z])\s*\/\s*([0-9a-zA-Z])(?!\s*\^)/g,'\\frac{$1}{$2}');
    }
    t = t.replace(/\*/g,'\\cdot ');
    return t;
  }

  async function renderMathIn(el){
    if (window.MathJax && MathJax.typesetPromise){
      try { await MathJax.typesetPromise([el]); } catch(e){}
    }
  }

  async function updateMathPreview(){
    const raw = mathInput.value;
    if (!raw.trim()){
      mathPreview.innerHTML = "";
      mathPreviewPlaceholder.style.display = "inline";
      return;
    }
    mathPreviewPlaceholder.style.display = "none";
    const latex = convertToLatex(raw);
    mathPreview.innerHTML = `\\(${latex}\\)`;
    await renderMathIn(mathPreview);
  }
  mathInput.addEventListener("input", updateMathPreview);

  /* ===================== MAIN STATUS / ANSWER / CONTINUE ===================== */
  const answerEl = document.getElementById("ai-answer");
  const statusEl = document.getElementById("status");
  const setStatus = (t="") => statusEl.textContent = t;

  const continueBox = document.getElementById("continue-box");
  const continueYes = document.getElementById("continue-yes");
  const continueNo  = document.getElementById("continue-no");
  const continueStatus = document.getElementById("continue-status");

  let lastPromptSent = "";
  let lastAnswerText = "";

  function showContinueBox(show){
    continueBox.style.display = show ? "block" : "none";
    continueStatus.textContent = "";
    continueYes.disabled = false;
    continueNo.disabled = false;
  }

  async function renderAnswer(text){
    const t = (text || "");
    lastAnswerText = t;

    answerEl.innerHTML = t.replace(/\n/g,"<br>");
    await renderMathIn(answerEl);

    showContinueBox(true);
    if (!isAnswerVisible()) showToast();

    try{
      localStorage.setItem("mathAI:lastAnswer", t);
      localStorage.setItem("mathAI:lastAnswerAt", new Date().toISOString());
      updateSavedInfo();
    }catch(e){}
  }

  async function askAI(prompt){
    setStatus("Î¤Î¿ AI ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹â€¦");
    statusEl.classList.add("status-thinking");
    answerEl.innerHTML = "Î¤Î¿ AI ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹â€¦";
    await renderMathIn(answerEl);
    showContinueBox(false);

    try{
      const res = await fetch(`${BASE_URL}/ask`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ prompt })
      });
      const data = await res.json();
      const ans = data.answer || data.message || JSON.stringify(data, null, 2) || "Î”ÎµÎ½ Î®ÏÎ¸Îµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.";
      await renderAnswer(ans);
    }catch(e){
      await renderAnswer("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server (/ask).");
    }
    setStatus("");
    statusEl.classList.remove("status-thinking");
  }

  document.getElementById("ask-btn").addEventListener("click", async () => {
    hideToast();
    const mathRaw = mathInput.value.trim();
    const math = mathRaw ? greekToEnglishMath(mathRaw) : "";
    const text = textInput.value.trim();

    let bodyParts = [];
    if (math) bodyParts.push("ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® Î­ÎºÏ†ÏÎ±ÏƒÎ·:\n" + math);
    if (text) bodyParts.push("Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±:\n" + text);
    const mainPrompt = bodyParts.join("\n\n") || "Î›ÏÏƒÎµ Ï„Î¿ 1+1.";

    const levelPrefix = currentLevel === "lyceum"
      ? "ÎÎ± Î»Ï…Î¸ÎµÎ¯ Î¼Îµ Î¼Î±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ¬ ÎµÏ€Î¹Ï€Î­Î´Î¿Ï… Î›Ï…ÎºÎµÎ¯Î¿Ï…. Î‘Ï€ÏŒÏ†Ï…Î³Îµ Ï€Î±Î½ÎµÏ€Î¹ÏƒÏ„Î·Î¼Î¹Î±ÎºÎ­Ï‚ Î¼ÎµÎ¸ÏŒÎ´Î¿Ï…Ï‚.\n\n"
      : "ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ­Ï‚ Ï€Î±Î½ÎµÏ€Î¹ÏƒÏ„Î·Î¼Î¹Î±ÎºÎ¿Ï ÎµÏ€Î¹Ï€Î­Î´Î¿Ï….\n\n";

    lastPromptSent = levelPrefix + mainPrompt;
    await askAI(lastPromptSent);
  });

  /* âœ… clear buttons */
  document.getElementById("clear-math-btn").addEventListener("click", async () => {
    mathInput.value = "";
    await updateMathPreview();
    mathInput.focus();
  });
  document.getElementById("clear-text-btn").addEventListener("click", () => {
    textInput.value = "";
    textInput.focus();
  });

  continueYes.addEventListener("click", async () => {
    hideToast();
    continueYes.disabled = true;
    continueNo.disabled = true;
    continueStatus.textContent = "Î£Ï…Î½ÎµÏ‡Î¯Î¶Ï‰â€¦";

    const followUp =
      "Î£Ï…Î½Î­Ï‡Î¹ÏƒÎµ Ï„Î·Î½ ÎµÎ¾Î®Î³Î·ÏƒÎ·/Î»ÏÏƒÎ· Î±Ï€ÏŒ Ï„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿ Ï€Î¿Ï… Î­Î¼ÎµÎ¹Î½ÎµÏ‚. " +
      "Î”ÏÏƒÎµ Ï„Î± ÎµÏ€ÏŒÎ¼ÎµÎ½Î± Î²Î®Î¼Î±Ï„Î±, Ï€Î¹Î¿ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬, Î¼Îµ ÎºÎ±Î¸Î±ÏÎ® Î´Î¿Î¼Î®.\n\n" +
      "Î Î¡ÎŸÎ—Î“ÎŸÎ¥ÎœÎ•ÎÎŸ PROMPT:\n" + (lastPromptSent || "(ÎºÎµÎ½ÏŒ)") + "\n\n" +
      "Î Î¡ÎŸÎ—Î“ÎŸÎ¥ÎœÎ•ÎÎ— Î‘Î Î‘ÎÎ¤Î—Î£Î—:\n" + (lastAnswerText || "(ÎºÎµÎ½ÏŒ)");

    lastPromptSent = followUp;
    await askAI(followUp);
  });

  continueNo.addEventListener("click", () => {
    continueStatus.textContent = "ÎŸÎš â€” Î´ÎµÎ½ ÏƒÏ…Î½ÎµÏ‡Î¯Î¶Ï‰.";
    setTimeout(() => showContinueBox(false), 800);
  });

  /* ===================== SAVE / TXT / PDF / PRINT ===================== */
  const saveBtn = document.getElementById("save-answer-btn");
  const downloadBtn = document.getElementById("download-answer-btn");
  const pdfBtn = document.getElementById("pdf-answer-btn");
  const printBtn = document.getElementById("print-answer-btn");
  const savedInfo = document.getElementById("saved-info");

  function getAnswerTextRaw(){
    const t = (lastAnswerText || "").toString().replace(/\r/g, "").trim();
    return t || "â€”";
  }
  function updateSavedInfo(){
    try{
      const at = localStorage.getItem("mathAI:lastAnswerAt");
      const txt = localStorage.getItem("mathAI:lastAnswer") || "";
      if(!at || !txt.trim()){
        savedInfo.textContent = "Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.";
        return;
      }
      const d = new Date(at);
      savedInfo.textContent = `Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ: ${d.toLocaleString()}`;
    }catch(e){
      savedInfo.textContent = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·: Î¼Î· Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î·.";
    }
  }
  function saveAnswerNow(){
    const t = getAnswerTextRaw();
    try{
      localStorage.setItem("mathAI:lastAnswer", t);
      localStorage.setItem("mathAI:lastAnswerAt", new Date().toISOString());
      updateSavedInfo();
      alert("âœ… Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.");
    }catch(e){
      alert("âŒ Î”ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ± Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÏ‰ (Î¯ÏƒÏ‰Ï‚ private mode).");
    }
  }
  function downloadAnswerTxt(){
    const t = getAnswerTextRaw();
    const when = new Date();
    const filename = `AI_answer_${when.getFullYear()}-${String(when.getMonth()+1).padStart(2,"0")}-${String(when.getDate()).padStart(2,"0")}_${String(when.getHours()).padStart(2,"0")}${String(when.getMinutes()).padStart(2,"0")}.txt`;

    const blob = new Blob([t], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 400);
  }
  function escHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function formatForPrint(rawText){
    const t = (rawText || "").replace(/\r/g,"");
    const parts = t.split("```");
    let html = "";
    for(let i=0;i<parts.length;i++){
      if(i % 2 === 1){
        html += `<pre class="code"><code>${escHtml(parts[i].trim())}</code></pre>`;
      }else{
        const safe = escHtml(parts[i]);
        const paras = safe.split(/\n{2,}/).map(p => p.trim()).filter(Boolean);
        for(const p of paras){
          html += `<p>${p.replace(/\n/g,"<br>")}</p>`;
        }
      }
    }
    return html || "<p>â€”</p>";
  }
  function openPrintWindow({autoPrint=true, title="Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·"} = {}){
    const raw = getAnswerTextRaw();
    const when = new Date().toLocaleString();
    const htmlBody = formatForPrint(raw);

    const w = window.open("", "_blank", "width=980,height=760");
    if (!w) {
      alert("ÎŸ browser Î¼Ï€Î»ÏŒÎºÎ±ÏÎµ Ï„Î¿ popup. Î•Ï€Î¯Ï„ÏÎµÏˆÎµ popups ÎºÎ±Î¹ Î¾Î±Î½Î¬.");
      return;
    }

    w.document.open();
    w.document.write(`
<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>${escHtml(title)}</title>

  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\\\(','\\\\)'], ['$', '$']], displayMath: [['\\\\[','\\\\]']] },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  <\/script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>

  <style>
    @page { margin: 12mm; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",sans-serif;
      color:#111827;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      background:#fff;
    }
    .wrap{ max-width: 900px; margin: 0 auto; }
    .header{ border-bottom: 1px solid #e5e7eb; padding: 0 0 10px 0; margin: 0 0 12px 0; }
    h1{ margin:0 0 6px 0; font-size: 18px; font-weight: 900; letter-spacing:.2px; }
    .meta{ color:#6b7280; font-size:12px; }
    .content{ font-size: 13px; line-height:1.6; }
    p{ margin: 0 0 10px 0; }
    .code{
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 12px;
      background: #fafafa;
      overflow:auto;
      font-family: ui-monospace, Menlo, Consolas, "JetBrains Mono", monospace;
      font-size: 12.5px;
      line-height: 1.5;
      margin: 0 0 12px 0;
      white-space: pre-wrap;
    }
    @media print{ .wrap{ max-width: none; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI â€” ${escHtml(title)}</h1>
      <div class="meta">${escHtml(when)}</div>
    </div>

    <div class="content" id="content">
      ${htmlBody}
    </div>

    <div class="meta" style="margin-top:12px">
      Tip: Î£Ï„Î¿ Chrome ÎºÎ»ÎµÎ¯ÏƒÎµ â€œHeaders and footersâ€ Î³Î¹Î± Î½Î± Ï†ÏÎ³Î¿Ï…Î½ Î±ÏÎ¹Î¸Î¼Î¿Î¯ ÏƒÎµÎ»Î¯Î´Ï‰Î½/URL.
    </div>
  </div>

  <script>
    function go(){
      ${autoPrint ? "window.focus(); window.print();" : ""}
    }
    window.addEventListener('load', () => setTimeout(go, 450));
  <\/script>
</body>
</html>
    `);
    w.document.close();
  }
  function printAnswer(){ openPrintWindow({autoPrint:true, title:"Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·"}); }
  function exportPdf(){ openPrintWindow({autoPrint:true, title:"Export PDF"}); }

  saveBtn.addEventListener("click", saveAnswerNow);
  downloadBtn.addEventListener("click", downloadAnswerTxt);
  printBtn.addEventListener("click", printAnswer);
  pdfBtn.addEventListener("click", exportPdf);

  /* ===================== PHOTO CHECK ===================== */
  const imgInput = document.getElementById("image-input");
  const imgPreview = document.getElementById("img-preview");
  const checkBtn = document.getElementById("check-image-btn");
  const removeBtn = document.getElementById("remove-img-btn");

  function resetImageUI(){
    imgPreview.removeAttribute("src");
    checkBtn.disabled = true;
    removeBtn.disabled = true;
  }

  imgInput.addEventListener("change", () => {
    const file = imgInput.files && imgInput.files[0];
    if(!file){ resetImageUI(); return; }
    const url = URL.createObjectURL(file);
    imgPreview.src = url;
    checkBtn.disabled = false;
    removeBtn.disabled = false;
  });

  removeBtn.addEventListener("click", () => {
    imgInput.value = "";
    resetImageUI();
  });

  checkBtn.addEventListener("click", async () => {
    hideToast();
    const file = imgInput.files && imgInput.files[0];
    if (!file) { await renderAnswer("Î”ÎµÎ½ ÎµÏ€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±."); return; }

    setStatus("Î¤Î¿ AI Î±Î½Î±Î»ÏÎµÎ¹ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±â€¦");
    statusEl.classList.add("status-thinking");
    answerEl.innerHTML = "Î¤Î¿ AI Î±Î½Î±Î»ÏÎµÎ¹ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±â€¦";
    await renderMathIn(answerEl);
    showContinueBox(false);

    const formData = new FormData();
    formData.append("image", file);
    formData.append("question", textInput.value.trim());
    formData.append("level", currentLevel);

    try{
      const res = await fetch(`${BASE_URL}/check-image`, { method:"POST", body: formData });
      const data = await res.json();
      await renderAnswer(data.answer || "Î”ÎµÎ½ Î®ÏÎ¸Îµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î±Ï€ÏŒ Ï„Î¿Î½ server.");
    }catch(e){
      await renderAnswer("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server (/check-image).");
    }
    setStatus("");
    statusEl.classList.remove("status-thinking");
  });

  /* ===================== TOOL TABS ===================== */
  const toolTabs = document.querySelectorAll(".tool-tab");
  const toolPanels = {
    matrix: document.getElementById("tool-matrix"),
    sequences: document.getElementById("tool-sequences"),
    stats: document.getElementById("tool-stats")
  };

  toolTabs.forEach(t => {
    t.addEventListener("click", () => {
      toolTabs.forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      Object.values(toolPanels).forEach(p => p?.classList.remove("active"));
      toolPanels[t.dataset.tool]?.classList.add("active");
    });
  });

  /* ===================== GEOGEBRA ===================== */
  const ggbAxesToggle = document.getElementById("geogebra-axes-toggle");
  const ggbGridToggle = document.getElementById("geogebra-grid-toggle");
  const ggbOpenBtn = document.getElementById("geogebra-open-btn");
  const ggbContainerId = "geogebra-container";
  const ggbContainerEl = document.getElementById(ggbContainerId);
  let ggbInitialized = false;

  function applyGgbAxesVisibility(){
    if (!window.ggbApplet) return;
    const showAxes = ggbAxesToggle ? ggbAxesToggle.checked : true;
    try {
      window.ggbApplet.setAxesVisible(showAxes, showAxes);
    } catch (e) {
      // ignore if applet not ready yet
    }
  }

  function applyGgbGridVisibility(){
    if (!window.ggbApplet) return;
    const showGrid = ggbGridToggle ? ggbGridToggle.checked : true;
    try {
      window.ggbApplet.setGridVisible(showGrid);
    } catch (e) {
      // ignore if applet not ready yet
    }
  }

  function resizeGeoGebra(){
    const container = document.getElementById(ggbContainerId);
    if (!container || !window.ggbApplet) return;
    const width = Math.max(window.innerWidth || 0, 600);
    const height = Math.max(container.getBoundingClientRect().height || 0, 500);
    if (typeof window.ggbApplet.setWidth === "function") window.ggbApplet.setWidth(width);
    if (typeof window.ggbApplet.setHeight === "function") window.ggbApplet.setHeight(height);
  }

  window.ggbOnInit = function(){
    applyGgbAxesVisibility();
    applyGgbGridVisibility();
    resizeGeoGebra();
  };

  function initGeoGebra(){
    if (typeof GGBApplet === "undefined") return;
    const container = ggbContainerEl;
    const width = Math.max(window.innerWidth || 0, 600);
    const height = Math.max(container?.getBoundingClientRect().height || 0, 800);
    const params = {
      id: "ggbApplet",
      appName: "classic",
      width,
      height,
      showToolBar: true,
      showAlgebraInput: true,
      showMenuBar: true,
      showResetIcon: true
    };
    const applet = new GGBApplet(params, true);
    applet.inject(ggbContainerId);
    ggbInitialized = true;
  }

  if (ggbAxesToggle){
    ggbAxesToggle.addEventListener("change", applyGgbAxesVisibility);
  }
  if (ggbGridToggle){
    ggbGridToggle.addEventListener("change", applyGgbGridVisibility);
  }
  function setGeoGebraVisible(show){
    if (!ggbContainerEl) return;
    ggbContainerEl.classList.toggle("is-hidden", !show);
    if (ggbOpenBtn) ggbOpenBtn.classList.toggle("active", show);
    if (show){
      if (!ggbInitialized) initGeoGebra();
      setTimeout(() => { resizeGeoGebra(); applyGgbAxesVisibility(); applyGgbGridVisibility(); }, 50);
    }
  }

  if (ggbOpenBtn){
    ggbOpenBtn.addEventListener("click", () => {
      const isHidden = ggbContainerEl?.classList.contains("is-hidden");
      setGeoGebraVisible(Boolean(isHidden));
    });
  }
  window.addEventListener("resize", resizeGeoGebra);

  /* ===================== GEOGEBRA AI ASSISTANT ===================== */
  const ggbAiPrompt = document.getElementById("ggb-ai-prompt");
  const ggbAiHelpBtn = document.getElementById("ggb-ai-help-btn");
  const ggbAiCreateBtn = document.getElementById("ggb-ai-create-btn");
  const ggbAiResponse = document.getElementById("ggb-ai-response");
  const ggbAiExplanation = document.getElementById("ggb-ai-explanation");
  const ggbAiCommands = document.getElementById("ggb-ai-commands");
  const ggbAiCommandsWrap = document.getElementById("ggb-ai-commands-wrap");
  const ggbAiNotes = document.getElementById("ggb-ai-notes");
  const ggbAiExecuteBtn = document.getElementById("ggb-ai-execute-btn");
  const ggbAiClearBtn = document.getElementById("ggb-ai-clear-btn");
  const ggbAiActionBtns = document.getElementById("ggb-ai-action-btns");
  const ggbAiLoading = document.getElementById("ggb-ai-loading");

  let currentGgbCommands = [];

  async function askGeoGebraAI(mode){
    const prompt = (ggbAiPrompt?.value || "").trim();
    if (!prompt){
      alert("Î“ÏÎ¬ÏˆÎµ Ï„Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± ÎºÎ±Ï„Î±ÏƒÎºÎµÏ…Î¬ÏƒÎµÎ¹Ï‚!");
      return;
    }
    // Show loading, hide response
    ggbAiLoading?.classList.remove("is-hidden");
    ggbAiResponse?.classList.add("is-hidden");
    currentGgbCommands = [];

    try {
      const res = await fetch(BASE_URL + "/geogebra/assist", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({prompt, mode})
      });
      if (!res.ok){
        if (res.status === 404){
          throw new Error("404: Î¤Î¿ GeoGebra AI Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ. ÎŸ server (Render) Ï„ÏÎ­Ï‡ÎµÎ¹ Ï€Î±Î»Î¹ÏŒ ÎºÏÎ´Î¹ÎºÎ±. Î†Î½Î¿Î¹Î¾Îµ " + BASE_URL + "/geogebra ÏƒÏ„Î¿ browser â€” Î±Î½ Î´ÎµÎ½ Î´ÎµÎ¹Ï‚ {\"status\":\"ok\"}, ÎºÎ¬Î½Îµ Redeploy ÏƒÏ„Î¿ Render.");
        }
        throw new Error("Server error: " + res.status);
      }
      const data = await res.json();
      
      // Show response
      ggbAiLoading?.classList.add("is-hidden");
      ggbAiResponse?.classList.remove("is-hidden");
      
      // Explanation
      if (ggbAiExplanation){
        ggbAiExplanation.textContent = data.explanation || "";
      }
      
      // Commands
      currentGgbCommands = data.commands || [];
      if (ggbAiCommands){
        ggbAiCommands.textContent = currentGgbCommands.join("\n");
      }
      
      // Show/hide commands section based on mode
      if (ggbAiCommandsWrap){
        ggbAiCommandsWrap.style.display = currentGgbCommands.length ? "block" : "none";
      }
      if (ggbAiActionBtns){
        ggbAiActionBtns.style.display = currentGgbCommands.length ? "flex" : "none";
      }
      
      // Notes
      if (ggbAiNotes){
        ggbAiNotes.textContent = data.notes || "";
      }

      // Automatically open GeoGebra if hidden
      if (ggbContainerEl?.classList.contains("is-hidden")){
        setGeoGebraVisible(true);
      }

      // If "create" mode, automatically execute the commands
      if (mode === "create" && currentGgbCommands.length > 0){
        // Small delay to ensure GeoGebra is ready
        setTimeout(() => {
          executeGgbCommands();
        }, 500);
      }

    } catch (err){
      ggbAiLoading?.classList.add("is-hidden");
      let msg = "Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server: " + err.message;
      if (typeof isLocal !== "undefined" && isLocal && /fetch|network|Failed/i.test(String(err.message)))
        msg += "\n\nÎˆÎ»ÎµÎ³Î¾Îµ: Ï„ÏÎ­Ï‡ÎµÎ¹ Ï„Î¿ API (start-server.bat ÏƒÏ„Î¿ math-ai-server); Î‰ Ï„ÏÎ­Î¾Îµ run-all.bat ÏƒÏ„Î¿ Ï†Î¬ÎºÎµÎ»Î¿ Project.";
      alert(msg);
    }
  }

  function executeGgbCommands(){
    if (!window.ggbApplet){
      alert("Î ÎµÏÎ¯Î¼ÎµÎ½Îµ Î½Î± Ï†Î¿ÏÏ„Ï‰Î¸ÎµÎ¯ Ï„Î¿ GeoGebra...");
      // Try again after delay
      setTimeout(executeGgbCommands, 1000);
      return;
    }
    if (!currentGgbCommands.length){
      return;
    }
    // Execute each command in order
    for (const cmd of currentGgbCommands){
      try {
        window.ggbApplet.evalCommand(cmd);
      } catch (e){
        console.error("GeoGebra command error:", cmd, e);
      }
    }
  }

  function clearGeoGebra(){
    if (!window.ggbApplet){
      alert("Î†Î½Î¿Î¹Î¾Îµ Ï€ÏÏÏ„Î± Ï„Î¿ GeoGebra!");
      return;
    }
    // 1) Clear GeoGebra (try best available method)
    try {
      if (typeof window.ggbApplet.reset === "function"){
        window.ggbApplet.reset();
      } else if (typeof window.ggbApplet.newConstruction === "function"){
        window.ggbApplet.newConstruction();
      } else if (typeof window.ggbApplet.evalCommand === "function"){
        // GeoGebra command that clears construction
        window.ggbApplet.evalCommand("Delete[]");
      }
    } catch (e){
      console.warn("GeoGebra clear failed", e);
    }

    // 2) Clear AI output UI too
    currentGgbCommands = [];
    if (ggbAiCommands) ggbAiCommands.textContent = "";
    if (ggbAiExplanation) ggbAiExplanation.textContent = "";
    if (ggbAiNotes) ggbAiNotes.textContent = "";
    if (ggbAiResponse) ggbAiResponse.classList.add("is-hidden");
    if (ggbAiLoading) ggbAiLoading.classList.add("is-hidden");
    if (ggbAiCommandsWrap) ggbAiCommandsWrap.style.display = "none";
    if (ggbAiActionBtns) ggbAiActionBtns.style.display = "none";
    if (ggbAiPrompt) ggbAiPrompt.value = "";
  }

  if (ggbAiHelpBtn){
    ggbAiHelpBtn.addEventListener("click", () => askGeoGebraAI("help"));
  }
  if (ggbAiCreateBtn){
    ggbAiCreateBtn.addEventListener("click", () => askGeoGebraAI("create"));
  }
  if (ggbAiPrompt){
    ggbAiPrompt.addEventListener("keydown", (e) => {
      if (e.key === "Enter"){
        askGeoGebraAI("create"); // Default to create on Enter
      }
    });
  }
  if (ggbAiExecuteBtn){
    ggbAiExecuteBtn.addEventListener("click", executeGgbCommands);
  }
  if (ggbAiClearBtn){
    ggbAiClearBtn.addEventListener("click", clearGeoGebra);
  }

  const ggbCursorToggle = document.getElementById("ggb-cursor-toggle");
  const ggbCursorContent = document.getElementById("ggb-cursor-content");
  if (ggbCursorToggle && ggbCursorContent){
    ggbCursorToggle.addEventListener("click", () => {
      const open = ggbCursorToggle.getAttribute("aria-expanded") === "true";
      ggbCursorToggle.setAttribute("aria-expanded", !open);
      ggbCursorContent.classList.toggle("is-hidden", open);
    });
  }

  /* ===================== MATRICES ===================== */
  const matrixRaw = document.getElementById("matrix-raw");
  const matrixPreview = document.getElementById("matrix-preview");
  let lastMatrixLatex = "";

  function parseMatrix(raw){
    const txt = (raw || "").trim();
    if (!txt) return null;
    const normalized = txt.replace(/\n+/g, ';');
    const rows = normalized.split(';').map(r => r.trim()).filter(Boolean);
    if (!rows.length) return null;
    const data = rows.map(r => r.split(',').map(c => c.trim()).filter(Boolean));
    const cols = data[0]?.length || 0;
    if (!cols) return null;
    return data;
  }
  function matrixToLatex(mat){
    const rows = mat.map(row => row.join(' & ')).join(' \\\\ ');
    return `\\begin{bmatrix} ${rows} \\end{bmatrix}`;
  }
  async function updateMatrixPreview(){
    const mat = parseMatrix(matrixRaw.value);
    if (!mat){ matrixPreview.innerHTML = ""; return; }
    const latex = matrixToLatex(mat);
    matrixPreview.innerHTML = `\\(${latex}\\)`;
    await renderMathIn(matrixPreview);
  }
  matrixRaw.addEventListener("input", updateMatrixPreview);

  function pushMatrixContext(matLatex, raw){
    lastMatrixLatex = matLatex || lastMatrixLatex;
    appendToTextContext(
      `${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\n` +
      `Î Î¯Î½Î±ÎºÎ±Ï‚ A (raw): ${raw}\n` +
      `Î Î¯Î½Î±ÎºÎ±Ï‚ A (LaTeX): ${matLatex}\n`
    );
  }
  function ensureMatrixInContext(){
    if (!lastMatrixLatex){
      appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nâš ï¸ Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¿ÏÎ¹ÏƒÏ„ÎµÎ¯ Ï€Î¯Î½Î±ÎºÎ±Ï‚ A. Î’Î¬Î»Îµ Ï€ÏÏÏ„Î± Ï€Î¯Î½Î±ÎºÎ± ÎºÎ±Î¹ Ï€Î¬Ï„Î·ÏƒÎµ â€œÎ’Î¬Î»Îµ Ï„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±â€.`);
      return false;
    }
    return true;
  }
  function diagonalizationChecklist(){
    const A = lastMatrixLatex || "A";
    return (
      `${addToolHeader("Î”Î™Î‘Î“Î©ÎÎŸÎ ÎŸÎ™Î—Î£Î— (Î£ÏÎ½Î¿ÏˆÎ·)")}\n` +
      `Î”Î¯Î½ÎµÏ„Î±Î¹ Î¿ Ï€Î¯Î½Î±ÎºÎ±Ï‚ A = ${A}\n\n` +
      `ğŸ‘‰ Î¤Ï…Ï€Î¹ÎºÎ® ÏƒÎµÎ¹ÏÎ¬:\n` +
      `1) Î™Î´Î¹Î¿Ï„Î¹Î¼Î­Ï‚ (det(A-\\lambda I)=0)\n` +
      `2) Î™Î´Î¹Î¿Î´Î¹Î±Î½ÏÏƒÎ¼Î±Ï„Î± ((A-\\lambda I)v=0)\n` +
      `3) ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹Î±Î³Ï‰Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚\n` +
      `4) P, D (Î¯Î´Î¹Î± ÏƒÎµÎ¹ÏÎ¬)\n` +
      `5) ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: A=PDP^{-1}\n\n` +
      `ÎœÎµÏ„Î¬: A^n, e^A, Î´Ï…Î½Î±Î¼Î¹ÎºÎ¬, Î”.Î•.\n`
    );
  }

  document.getElementById("matrix-insert-btn").addEventListener("click", async () => {
    const mat = parseMatrix(matrixRaw.value);
    if (!mat){ await renderAnswer("Î”ÏÏƒÎµ Ï€ÏÏÏ„Î± Î­Î½Î±Î½ Ï€Î¯Î½Î±ÎºÎ± Ï€.Ï‡. 1,2;3,4"); return; }
    const latex = matrixToLatex(mat);
    lastMatrixLatex = latex;
    insertAtCursor(mathInput, latex);
    updateMathPreview();
    pushMatrixContext(latex, matrixRaw.value.trim());
    textInput.focus();
  });
  document.getElementById("matrix-to-text-btn").addEventListener("click", () => {
    const mat = parseMatrix(matrixRaw.value);
    if (!mat) return;
    const latex = matrixToLatex(mat);
    lastMatrixLatex = latex;
    pushMatrixContext(latex, matrixRaw.value.trim());
    textInput.focus();
  });
  document.getElementById("matrix-clear-btn").addEventListener("click", () => {
    matrixRaw.value = "";
    matrixPreview.innerHTML = "";
    lastMatrixLatex = "";
  });

  document.getElementById("matrix-det-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ–Î·Ï„Î¿ÏÎ¼ÎµÎ½Î¿: Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ det(A) Î¼Îµ Î²Î®Î¼Î±Ï„Î±.`); textInput.focus(); });
  document.getElementById("matrix-inv-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ–Î·Ï„Î¿ÏÎ¼ÎµÎ½Î¿: Î’ÏÎµÏ‚ A^{-1} (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹).`); textInput.focus(); });
  document.getElementById("matrix-solve-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ–Î·Ï„Î¿ÏÎ¼ÎµÎ½Î¿: Î›ÏÏƒÎµ Ax=b.`); textInput.focus(); });

  document.getElementById("eigvals-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ’ÏÎµÏ‚ Î¹Î´Î¹Î¿Ï„Î¹Î¼Î­Ï‚.`); textInput.focus(); });
  document.getElementById("eigvecs-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ’ÏÎµÏ‚ Î¹Î´Î¹Î¿Î´Î¹Î±Î½ÏÏƒÎ¼Î±Ï„Î±.`); textInput.focus(); });
  document.getElementById("diag-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎˆÎ»ÎµÎ³Î¾Îµ Î±Î½ Î´Î¹Î±Î³Ï‰Î½Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹.`); textInput.focus(); });
  document.getElementById("pd-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ¦Ï„Î¹Î¬Î¾Îµ P, D (Î¯Î´Î¹Î± ÏƒÎµÎ¹ÏÎ¬).`); textInput.focus(); });
  document.getElementById("verify-pdp-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎˆÎ»ÎµÎ³Î¾Îµ A=PDP^{-1}.`); textInput.focus(); });
  document.getElementById("an-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ A^n.`); textInput.focus(); });
  document.getElementById("eA-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ e^A.`); textInput.focus(); });
  document.getElementById("dynsys-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î•Î¦Î‘Î¡ÎœÎŸÎ“Î—")}\nx_{k+1}=Ax_k Î¼Îµ A=${lastMatrixLatex}.`); textInput.focus(); });
  document.getElementById("ode-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î•Î¦Î‘Î¡ÎœÎŸÎ“Î—")}\nx'(t)=Ax(t) Î¼Îµ A=${lastMatrixLatex}.`); textInput.focus(); });


  /* ===================== SEQUENCES ===================== */
  // Sequences tabs
  const sequencesTabs = document.querySelectorAll("[data-sequences-type]");
  const sequencesSubpanels = {
    arithmetic: document.getElementById("sequences-arithmetic"),
    geometric: document.getElementById("sequences-geometric")
  };

  sequencesTabs.forEach(tab => {
    tab.addEventListener("click", () => {
      sequencesTabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      Object.values(sequencesSubpanels).forEach(p => p?.classList.remove("active"));
      sequencesSubpanels[tab.dataset.sequencesType]?.classList.add("active");
    });
  });

  // Î‘ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÎ® Î ÏÏŒÎ¿Î´Î¿Ï‚
  const apCalcType = document.getElementById("ap-calc-type");
  const apBasicInputs = document.getElementById("ap-basic-inputs");
  const apProgressionInputs = document.getElementById("ap-progression-inputs");
  const apMeanInputs = document.getElementById("ap-mean-inputs");
  const apCalcBtn = document.getElementById("ap-calc-btn");
  const apClearBtn = document.getElementById("ap-clear-btn");
  const apResults = document.getElementById("ap-results");

  apCalcType.addEventListener("change", () => {
    const type = apCalcType.value;
    apBasicInputs.style.display = (type === "find_term" || type === "find_sum") ? "block" : "none";
    apProgressionInputs.style.display = type === "find_progression" ? "block" : "none";
    apMeanInputs.style.display = type === "arithmetic_mean" ? "block" : "none";
  });

  apCalcBtn.addEventListener("click", async () => {
    const type = apCalcType.value;
    let payload = { calc_type: type };

    if (type === "find_term" || type === "find_sum") {
      const a1 = parseFloat(document.getElementById("ap-a1").value);
      const d = parseFloat(document.getElementById("ap-d").value);
      const n = parseInt(document.getElementById("ap-n").value);
      if (!a1 || !d || !n) {
        apResults.textContent = "Î£Ï†Î¬Î»Î¼Î±: Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î± (aâ‚, d, n)";
        return;
      }
      payload = { calc_type: type, a1, d, n };
    } else if (type === "find_progression") {
      const ai = parseFloat(document.getElementById("ap-ai").value);
      const aj = parseFloat(document.getElementById("ap-aj").value);
      const i = parseInt(document.getElementById("ap-i").value);
      const j = parseInt(document.getElementById("ap-j").value);
      if (!ai || !aj || !i || !j) {
        apResults.textContent = "Î£Ï†Î¬Î»Î¼Î±: Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î± (aáµ¢, aâ±¼, i, j)";
        return;
      }
      payload = { calc_type: type, a_i: ai, a_j: aj, i, j };
    } else if (type === "arithmetic_mean") {
      const a = parseFloat(document.getElementById("ap-mean-a").value);
      const b = parseFloat(document.getElementById("ap-mean-b").value);
      if (!a || !b) {
        apResults.textContent = "Î£Ï†Î¬Î»Î¼Î±: Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÎºÎ±Î¹ Ï„Î¿Ï…Ï‚ Î´ÏÎ¿ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚";
        return;
      }
      payload = { calc_type: type, a_i: a, a_j: b };
    }

    try {
      apResults.textContent = "Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚...";
      const res = await fetch(`${BASE_URL}/sequences/arithmetic`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || "Î£Ï†Î¬Î»Î¼Î±");
      
      let output = data.formula + "\n\n";
      if (data.result !== undefined) output += `Î‘Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±: ${data.result}\n`;
      if (data.a1 !== undefined) output += `aâ‚ = ${data.a1}\n`;
      if (data.d !== undefined) output += `d = ${data.d}\n`;
      if (data.a_n !== undefined) output += `aâ‚™ = ${data.a_n}\n`;
      if (data.S_n !== undefined) output += `Sâ‚™ = ${data.S_n}\n`;
      if (data.mean !== undefined) output += `ÎœÎ­ÏƒÎ¿Ï‚ = ${data.mean}\n`;
      
      apResults.textContent = output;
    } catch (e) {
      apResults.textContent = `Î£Ï†Î¬Î»Î¼Î±: ${e.message}`;
    }
  });

  apClearBtn.addEventListener("click", () => {
    document.getElementById("ap-a1").value = "";
    document.getElementById("ap-d").value = "";
    document.getElementById("ap-n").value = "";
    document.getElementById("ap-ai").value = "";
    document.getElementById("ap-aj").value = "";
    document.getElementById("ap-i").value = "";
    document.getElementById("ap-j").value = "";
    document.getElementById("ap-mean-a").value = "";
    document.getElementById("ap-mean-b").value = "";
    apResults.textContent = "";
  });

  // Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¹ÎºÎ® Î ÏÏŒÎ¿Î´Î¿Ï‚
  const gpCalcType = document.getElementById("gp-calc-type");
  const gpBasicInputs = document.getElementById("gp-basic-inputs");
  const gpNInput = document.getElementById("gp-n-input");
  const gpProgressionInputs = document.getElementById("gp-progression-inputs");
  const gpMeanInputs = document.getElementById("gp-mean-inputs");
  const gpCalcBtn = document.getElementById("gp-calc-btn");
  const gpClearBtn = document.getElementById("gp-clear-btn");
  const gpResults = document.getElementById("gp-results");

  gpCalcType.addEventListener("change", () => {
    const type = gpCalcType.value;
    gpBasicInputs.style.display = (type === "find_term" || type === "find_sum" || type === "find_infinite_sum") ? "block" : "none";
    gpNInput.style.display = type === "find_infinite_sum" ? "none" : "block";
    gpProgressionInputs.style.display = type === "find_progression" ? "block" : "none";
    gpMeanInputs.style.display = type === "geometric_mean" ? "block" : "none";
  });

  gpCalcBtn.addEventListener("click", async () => {
    const type = gpCalcType.value;
    let payload = { calc_type: type };

    if (type === "find_term" || type === "find_sum") {
      const a1 = parseFloat(document.getElementById("gp-a1").value);
      const lamda = parseFloat(document.getElementById("gp-lamda").value);
      const n = parseInt(document.getElementById("gp-n").value);
      if (!a1 || !lamda || !n) {
        gpResults.textContent = "Î£Ï†Î¬Î»Î¼Î±: Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î± (aâ‚, Î», n)";
        return;
      }
      payload = { calc_type: type, a1, lamda, n };
    } else if (type === "find_infinite_sum") {
      const a1 = parseFloat(document.getElementById("gp-a1").value);
      const lamda = parseFloat(document.getElementById("gp-lamda").value);
      if (!a1 || !lamda) {
        gpResults.textContent = "Î£Ï†Î¬Î»Î¼Î±: Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ aâ‚ ÎºÎ±Î¹ Î»";
        return;
      }
      payload = { calc_type: type, a1, lamda };
    } else if (type === "find_progression") {
      const ai = parseFloat(document.getElementById("gp-ai").value);
      const aj = parseFloat(document.getElementById("gp-aj").value);
      const i = parseInt(document.getElementById("gp-i").value);
      const j = parseInt(document.getElementById("gp-j").value);
      if (!ai || !aj || !i || !j) {
        gpResults.textContent = "Î£Ï†Î¬Î»Î¼Î±: Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î± (aáµ¢, aâ±¼, i, j)";
        return;
      }
      payload = { calc_type: type, a_i: ai, a_j: aj, i, j };
    } else if (type === "geometric_mean") {
      const a = parseFloat(document.getElementById("gp-mean-a").value);
      const b = parseFloat(document.getElementById("gp-mean-b").value);
      if (!a || !b || a < 0 || b < 0) {
        gpResults.textContent = "Î£Ï†Î¬Î»Î¼Î±: Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î´ÏÎ¿ Î¸ÎµÏ„Î¹ÎºÎ¿ÏÏ‚ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚";
        return;
      }
      payload = { calc_type: type, a_i: a, a_j: b };
    }

    try {
      gpResults.textContent = "Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚...";
      const res = await fetch(`${BASE_URL}/sequences/geometric`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || "Î£Ï†Î¬Î»Î¼Î±");
      
      let output = data.formula + "\n\n";
      if (data.result !== undefined) output += `Î‘Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±: ${data.result}\n`;
      if (data.a1 !== undefined) output += `aâ‚ = ${data.a1}\n`;
      if (data.lamda !== undefined) output += `Î» = ${data.lamda}\n`;
      if (data.a_n !== undefined) output += `aâ‚™ = ${data.a_n}\n`;
      if (data.S_n !== undefined) output += `Sâ‚™ = ${data.S_n}\n`;
      if (data.S_inf !== undefined) output += `Sâˆ = ${data.S_inf}\n`;
      if (data.mean !== undefined) output += `ÎœÎ­ÏƒÎ¿Ï‚ = ${data.mean}\n`;
      if (data.converges !== undefined) output += `Î£ÏÎ³ÎºÎ»Î¹ÏƒÎ·: ${data.converges ? "ÎÎ±Î¹" : "ÎŒÏ‡Î¹"}\n`;
      
      gpResults.textContent = output;
    } catch (e) {
      gpResults.textContent = `Î£Ï†Î¬Î»Î¼Î±: ${e.message}`;
    }
  });

  gpClearBtn.addEventListener("click", () => {
    document.getElementById("gp-a1").value = "";
    document.getElementById("gp-lamda").value = "";
    document.getElementById("gp-n").value = "";
    document.getElementById("gp-ai").value = "";
    document.getElementById("gp-aj").value = "";
    document.getElementById("gp-i").value = "";
    document.getElementById("gp-j").value = "";
    document.getElementById("gp-mean-a").value = "";
    document.getElementById("gp-mean-b").value = "";
    gpResults.textContent = "";
  });

  /* ===================== STATS ===================== */
  const statsResults = document.getElementById("stats-results");
  const gridHead = document.getElementById("variables-grid-head");
  const gridBody = document.getElementById("variables-grid-body");

  function getGridData(){
    const data = {};
    const headers = [];
    const ths = gridHead.querySelectorAll("th");
    for(let i=1;i<ths.length;i++){ const n = ths[i].querySelector("input"); headers.push(n ? n.value.trim() || `var${i}` : `var${i}`); }
    headers.forEach(h=>{ data[h] = []; });
    gridBody.querySelectorAll("tr").forEach(tr=>{
      const cells = tr.querySelectorAll("td");
      headers.forEach((h,j)=>{ const inp = cells[j+1]?.querySelector("input"); data[h].push(inp ? inp.value : ""); });
    });
    return data;
  }
  function addGridRow(){
    const nVar = gridHead.querySelectorAll("th").length - 1;
    const rowNum = gridBody.querySelectorAll("tr").length + 1;
    const tr = document.createElement("tr");
    const tdi = document.createElement("td");
    tdi.className = "grid-index";
    tdi.textContent = String(rowNum);
    tr.appendChild(tdi);
    for(let i=0;i<nVar;i++){
      const td = document.createElement("td");
      const inp = document.createElement("input"); inp.type="text"; inp.placeholder=""; td.appendChild(inp);
      tr.appendChild(td);
    }
    gridBody.appendChild(tr);
  }
  function addGridCol(){
    const nVar = gridHead.querySelectorAll("th").length - 1;
    const name = `var${nVar+1}`;
    const th = document.createElement("th");
    const inp = document.createElement("input"); inp.type="text"; inp.value = name; inp.placeholder="ÏŒÎ½Î¿Î¼Î±"; th.appendChild(inp);
    gridHead.appendChild(th);
    gridBody.querySelectorAll("tr").forEach(tr=>{
      const td = document.createElement("td");
      const i = document.createElement("input"); i.type="text"; td.appendChild(i);
      tr.appendChild(td);
    });
  }
  function initGrid(){
    gridHead.innerHTML=""; gridBody.innerHTML="";
    const thi = document.createElement("th");
    thi.className = "grid-index";
    thi.textContent = "â„–";
    gridHead.appendChild(thi);
    addGridCol(); addGridCol();
    for(let r=0;r<5;r++) addGridRow();
  }
  initGrid();

  function getFocusedGridCell(){
    const el = document.activeElement;
    const grid = document.getElementById("variables-grid");
    if(!el || !el.matches("input") || !grid || !grid.contains(el)) return null;
    const th = el.closest("th");
    if(th && grid.querySelector("thead")?.contains(th)){
      const thr = th.closest("tr");
      const ths = thr?.querySelectorAll("th");
      const col = ths ? [...ths].indexOf(th) : -1;
      if(col <= 0) return null;
      return { row: 0, col: col - 1 };
    }
    const td = el.closest("td");
    if(!td) return null;
    const tr = td.closest("tr");
    if(!tr || !gridBody.contains(tr)) return null;
    const trs = gridBody.querySelectorAll("tr");
    const row = [...trs].indexOf(tr) + 1;
    const tds = tr.querySelectorAll("td");
    const col = [...tds].indexOf(td);
    if(col <= 0) return null;
    return { row, col: col - 1 };
  }
  function parsePasteText(t){
    const raw = (t||"").trim().replace(/\r\n/g,"\n").replace(/\r/g,"\n");
    if(!raw) return [];
    return raw.split("\n").map(l=> l.split(/\t/));
  }
  function doPaste(originRow, originCol, text){
    const rows = parsePasteText(text);
    if(!rows.length) return;
    const maxC = Math.max(...rows.map(r=>r.length), 1);
    const nVar = gridHead.querySelectorAll("th").length - 1;
    let nBody = gridBody.querySelectorAll("tr").length;
    for(let c = nVar; c < originCol + maxC; c++) addGridCol();
    const needBody = Math.max(0, originRow + rows.length - 1);
    for(let r = nBody; r < needBody; r++) addGridRow();
    const ths = gridHead.querySelectorAll("th");
    const trs = gridBody.querySelectorAll("tr");
    rows.forEach((row, i)=>{
      const r = originRow + i;
      row.forEach((v, j)=>{
        const c = originCol + j + 1;
        let inp = null;
        if(r === 0 && ths[c]) inp = ths[c].querySelector("input");
        else if(r >= 1 && trs[r - 1]){ const tds = trs[r - 1].querySelectorAll("td"); if(tds[c]) inp = tds[c].querySelector("input"); }
        if(inp) inp.value = v;
      });
    });
    populateStatsDropdowns();
  }

  document.getElementById("grid-add-row").addEventListener("click", addGridRow);
  document.getElementById("grid-add-col").addEventListener("click", addGridCol);
  document.getElementById("grid-paste").addEventListener("click", ()=>{
    navigator.clipboard.readText().then(t=>{
      const pos = getFocusedGridCell();
      const r0 = pos ? pos.row : 0, c0 = pos ? pos.col : 0;
      doPaste(r0, c0, t);
    }).catch(()=>{ statsResults.textContent="Î”ÎµÎ½ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ clipboard."; });
  });

  const gridWrap = document.getElementById("variables-grid-wrap");
  if(gridWrap){
    gridWrap.addEventListener("paste", (e)=>{
      const pos = getFocusedGridCell();
      if(!pos) return;
      e.preventDefault();
      const t = (e.clipboardData || window.clipboardData)?.getData("text/plain");
      if(!t) return;
      doPaste(pos.row, pos.col, t);
    });
  }

  const statVarIds = ["descriptive-var1","descriptive-var2","descriptive-cat","normal-var","normal-cat","ci-var","ci-cat","ttest-var1","ttest-var2","ttest-cat","anova-var","anova-cat","chi-var1","chi-var2","reg-x","reg-y","reg-cat"];
  function populateStatsDropdowns(){
    const d = getGridData();
    const cols = Object.keys(d).filter(Boolean);
    const opt = (v,l)=> { const o = document.createElement("option"); o.value=v; o.textContent=l||v; return o; };
    const catIds = ["descriptive-cat","normal-cat","ci-cat","ttest-cat","reg-cat"];
    const noneIds = ["descriptive-var2"];
    statVarIds.forEach(id=>{
      const sel = document.getElementById(id);
      if(!sel) return;
      const prev = sel.value;
      sel.innerHTML = "";
      if(catIds.includes(id) || noneIds.includes(id)) sel.appendChild(opt("", "â€” ÎšÎ±Î¼Î¯Î± â€”"));
      else sel.appendChild(opt("", "â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ â€”"));
      cols.forEach(c=> sel.appendChild(opt(c)));
      if(cols.includes(prev)) sel.value = prev;
    });
  }
  populateStatsDropdowns();
  gridHead.addEventListener("input", ()=> setTimeout(populateStatsDropdowns, 0));
  gridBody.addEventListener("input", ()=> setTimeout(populateStatsDropdowns, 0));

  (function gridNav(){
    const grid = document.getElementById("variables-grid");
    const wrap = document.getElementById("variables-grid-wrap");
    if(!grid || !wrap) return;
    function getInputs(){ return grid.querySelectorAll("input"); }
    function getCols(){ const n = grid.querySelector("#variables-grid-head")?.querySelectorAll("th").length || 0; return Math.max(0, n - 1); }
    function focusedIndex(){
      const inputs = getInputs(), el = document.activeElement;
      if(!el || !el.matches("input") || !grid.contains(el)) return -1;
      return [...inputs].indexOf(el);
    }
    function moveFocus(deltaRow, deltaCol){
      const inputs = getInputs(), cols = getCols();
      if(!cols || !inputs.length) return;
      const i = focusedIndex();
      if(i < 0) return;
      const row = Math.floor(i / cols), col = i % cols;
      let r = row + deltaRow, c = col + deltaCol;
      if(deltaCol !== 0 && c >= cols){ r++; c = 0; }
      else if(deltaCol !== 0 && c < 0){ r--; c = cols - 1; }
      r = Math.max(0, Math.min(r, Math.ceil(inputs.length / cols) - 1));
      c = Math.max(0, Math.min(c, cols - 1));
      const ni = r * cols + c;
      if(ni >= 0 && ni < inputs.length){ inputs[ni].focus(); }
    }
    function moveNext(back){
      const inputs = getInputs(), i = focusedIndex();
      if(i < 0) return;
      let ni = back ? i - 1 : i + 1;
      if(ni < 0) ni = inputs.length - 1;
      else if(ni >= inputs.length) ni = 0;
      inputs[ni].focus();
    }
    wrap.addEventListener("keydown", (e)=>{
      if(!grid.contains(e.target) || !e.target.matches("input")) return;
      const k = e.key;
      if(k==="ArrowLeft"){ e.preventDefault(); moveFocus(0,-1); }
      else if(k==="ArrowRight"){ e.preventDefault(); moveFocus(0,1); }
      else if(k==="ArrowUp"){ e.preventDefault(); moveFocus(-1,0); }
      else if(k==="ArrowDown"){ e.preventDefault(); moveFocus(1,0); }
      else if(k==="Tab" && !e.shiftKey){ e.preventDefault(); moveNext(false); }
      else if(k==="Tab" && e.shiftKey){ e.preventDefault(); moveNext(true); }
    });
    wrap.addEventListener("wheel", (e)=>{
      const el = document.activeElement;
      if(!el || !el.matches("input") || !grid.contains(el)) return;
      e.preventDefault();
      moveFocus(e.deltaY > 0 ? 1 : -1, 0);
    }, { passive: false });
  })();

  document.querySelectorAll("[data-stats-tool]").forEach(tab=>{
    tab.addEventListener("click", ()=>{
      document.querySelectorAll("[data-stats-tool]").forEach(t=>t.classList.remove("active"));
      tab.classList.add("active");
      document.querySelectorAll(".stats-subpanel").forEach(p=>{ p.classList.remove("active"); p.style.display="none"; });
      const pid = "stats-panel-" + tab.dataset.statsTool;
      const pan = document.getElementById(pid);
      if(pan){ pan.classList.add("active"); pan.style.display="block"; }
    });
  });

  async function checkStatsServer(){
    const el = document.getElementById("stats-server-status");
    try {
      const r = await fetch(`${BASE_URL}/`);
      const ok = r.ok;
      el.textContent = ok ? "âœ… Î£Ï…Î½Î´Î­Î¸Î·ÎºÎµ (" + BASE_URL + ")" : "âŒ Not connected (" + BASE_URL + ")";
      el.style.color = ok ? "#0f766e" : "#dc2626";
    } catch(e) {
      el.textContent = "âŒ Not connected (" + BASE_URL + ")";
      el.style.color = "#dc2626";
    }
  }
  checkStatsServer();
  document.getElementById("stats-server-test").addEventListener("click", checkStatsServer);

  function mean(arr){ const a = arr.filter(x=>Number.isFinite(+x)); return a.length ? a.reduce((s,x)=>s+Number(x),0)/a.length : NaN; }
  function fmt(x){ if(!Number.isFinite(x)) return String(x); const a=Math.abs(x); return (a>=1000||a<0.001) ? x.toExponential(4) : x.toFixed(4).replace(/\.?0+$/,""); }
  function quantile(sorted, p){
    const n = sorted.length; if(!n) return NaN;
    const i = (n-1)*p, lo = Math.floor(i), hi = Math.ceil(i);
    if(lo===hi) return sorted[lo];
    return sorted[lo] + (i-lo)*(sorted[hi]-sorted[lo]);
  }
  function modeNumeric(arr){
    const m = new Map();
    arr.forEach(x=> m.set(x, (m.get(x)||0)+1));
    let best = [], maxC = 0;
    m.forEach((c,v)=>{ if(c>maxC){ maxC=c; best=[v]; } else if(c===maxC) best.push(v); });
    return maxC<=1 ? [] : best.sort((a,b)=>a-b);
  }
  function variance(arr, sample){ const a=arr.filter(x=>Number.isFinite(+x)); const n=a.length; if(n<2) return NaN; const mu=mean(a), s=a.reduce((q,x)=>q+(x-mu)*(x-mu),0); return sample ? s/(n-1) : s/n; }
  function descriptiveBlock(name, raw){
    const out = [];
    if(!raw.length) return out;
    const nums = raw.map(x=>Number(x)).filter(Number.isFinite);
    const mostlyNumeric = nums.length >= raw.length * 0.5;
    if(mostlyNumeric && nums.length>=1){
      const n = nums.length, sorted = [...nums].sort((a,b)=>a-b);
      const mu = mean(nums), med = quantile(sorted, 0.5), q1 = quantile(sorted, 0.25), q3 = quantile(sorted, 0.75);
      const iqr = q3 - q1, rng = sorted[n-1] - sorted[0];
      const s2 = variance(nums, true), s = Math.sqrt(s2), s2p = variance(nums, false), sp = Math.sqrt(s2p);
      const mo = modeNumeric(nums);
      const zArr = s > 0 ? nums.map(x => (x - mu) / s) : [];
      const zMin = zArr.length ? Math.min(...zArr) : NaN, zMax = zArr.length ? Math.max(...zArr) : NaN;
      out.push(`â€”â€”â€” ${name} (Î±ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÎ®) â€”â€”â€”`);
      out.push(`n = ${n}   min = ${fmt(sorted[0])}   max = ${fmt(sorted[n-1])}   ÎµÏ…ÏÏŒÏ‚ = ${fmt(rng)}`);
      out.push(`Î¼Î­ÏƒÎ· Ï„Î¹Î¼Î® (xÌ„) = ${fmt(mu)}   Î´Î¹Î¬Î¼ÎµÏƒÎ¿Ï‚ = ${fmt(med)}   ÎµÏ€Î¹ÎºÏÎ±Ï„Î¿ÏÏƒÎ± = ${mo.length ? mo.map(fmt).join(", ") : "â€”"}`);
      out.push(`Qâ‚ = ${fmt(q1)}   Qâ‚ƒ = ${fmt(q3)}   IQR = ${fmt(iqr)}`);
      out.push(`sÂ² (Î´ÎµÎ¯Î³Î¼Î±) = ${fmt(s2)}   s (Ï„Ï…Ï€. Î±Ï€ÏŒÎºÎ».) = ${fmt(s)}`);
      out.push(`ÏƒÂ² (Ï€Î»Î·Î¸.) = ${fmt(s2p)}   Ïƒ = ${fmt(sp)}`);
      if (s > 0) out.push(`z-score: z = (x âˆ’ xÌ„)/s   â†’  z_min = ${fmt(zMin)}   z_max = ${fmt(zMax)}`);
      else out.push(`z-score: z = (x âˆ’ xÌ„)/s (s=0 â†’ Î±Ï€ÏÎ¿ÏƒÎ´Î¹ÏŒÏÎ¹ÏƒÏ„Î¿)`);
    } else {
      const freq = new Map();
      raw.forEach(x=> freq.set(x, (freq.get(x)||0)+1));
      const entries = [...freq.entries()].sort((a,b)=>b[1]-a[1]);
      const moda = entries.filter(([_,c])=> c===entries[0][1]).map(([v])=>v).join(", ");
      out.push(`â€”â€”â€” ${name} (ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ®) â€”â€”â€”`);
      out.push(`n = ${raw.length}   ÎµÏ€Î¹ÎºÏÎ±Ï„Î¿ÏÏƒÎ± = ${moda || "â€”"}`);
      entries.forEach(([v,c])=> out.push(`  ${v}: ${c}`));
    }
    return out;
  }
  function descriptiveGrid(){
    const var1 = document.getElementById("descriptive-var1")?.value?.trim();
    const var2 = (document.getElementById("descriptive-var2")?.value || "").trim() || null;
    const cat = (document.getElementById("descriptive-cat")?.value || "").trim() || null;
    if(!var1){ statsResults.textContent = "Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® 1."; return; }
    const d = getGridData();
    if(!d[var1] || !d[var1].length){ statsResults.textContent = "Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î· Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î®."; return; }
    const vars = [var1]; if(var2 && d[var2]) vars.push(var2);
    const lines = [];
    const n = d[var1].length;
    if(cat && d[cat]){
      const groups = new Map();
      for(let i = 0; i < n; i++){
        const g = String(d[cat][i] ?? "").trim();
        if(!g) continue;
        if(!groups.has(g)){ const o = {}; vars.forEach(v=>{ o[v]=[]; }); groups.set(g, o); }
        const row = groups.get(g);
        vars.forEach(v=> row[v].push(String(d[v][i] ?? "").trim()));
      }
      const sortedGroups = [...groups.entries()].sort((a,b)=>String(a[0]).localeCompare(String(b[0])));
      sortedGroups.forEach(([g, row], idx)=>{
        if(idx) lines.push("");
        lines.push(`====== ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±: ${g} ======`);
        vars.forEach(v=>{
          const raw = (row[v]||[]).filter(Boolean);
          lines.push(...descriptiveBlock(v, raw));
          if(raw.length) lines.push("");
        });
      });
    } else {
      vars.forEach(v=>{
        const raw = (d[v]||[]).map(x=>String(x).trim()).filter(Boolean);
        lines.push(...descriptiveBlock(v, raw));
        if(raw.length) lines.push("");
      });
    }
    statsResults.textContent = lines.length ? lines.join("\n").trim() : "Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±.";
  }

  document.getElementById("descriptive-btn").addEventListener("click", descriptiveGrid);
  document.getElementById("descriptive-clear").addEventListener("click", ()=>{
    document.getElementById("descriptive-var1").value = "";
    document.getElementById("descriptive-var2").value = "";
    document.getElementById("descriptive-cat").value = "";
    statsResults.textContent = "";
  });
  document.getElementById("stats-insert-btn").addEventListener("click", ()=>{
    appendToTextContext(`${addToolHeader("Î£Î¤Î‘Î¤Î™Î£Î¤Î™ÎšÎ—")}\n${statsResults.textContent || ""}\n`);
    textInput.focus();
  });
  document.getElementById("stats-clear-btn").addEventListener("click", ()=>{ initGrid(); populateStatsDropdowns(); statsResults.textContent=""; });

  async function postStats(path, body){
    const r = await fetch(`${BASE_URL}${path}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
    const j = await r.json();
    if(!r.ok) throw new Error(j.detail || "Î£Ï†Î¬Î»Î¼Î±");
    return j;
  }
  function showStatsJson(j){ statsResults.textContent = JSON.stringify(j, null, 2); }

  document.getElementById("normal-btn").addEventListener("click", async ()=>{
    const data = getGridData(), v = document.getElementById("normal-var").value, cat = document.getElementById("normal-cat").value || null;
    const method = document.querySelector("input[name=normal-method]:checked").value;
    if(!v){ statsResults.textContent="Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î®."; return; }
    statsResults.textContent="Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚â€¦";
    try{ const j = await postStats("/stats/normal", { data, var: v, method, category: cat }); showStatsJson(j); } catch(e){ statsResults.textContent="Î£Ï†Î¬Î»Î¼Î±: "+e.message; }
  });
  document.getElementById("normal-clear").addEventListener("click", ()=>{ document.getElementById("normal-var").value=""; document.getElementById("normal-cat").value=""; statsResults.textContent=""; });

  document.getElementById("ci-btn").addEventListener("click", async ()=>{
    const data = getGridData(), v = document.getElementById("ci-var").value, cat = document.getElementById("ci-cat").value || null;
    const level = parseFloat(document.getElementById("ci-level").value) || 95;
    const sig = document.getElementById("ci-sigma").value; const sigma = sig === "" ? null : parseFloat(sig);
    if(!v){ statsResults.textContent="Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î®."; return; }
    statsResults.textContent="Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚â€¦";
    try{ const j = await postStats("/stats/ci", { data, var: v, level, sigma, category: cat }); showStatsJson(j); } catch(e){ statsResults.textContent="Î£Ï†Î¬Î»Î¼Î±: "+e.message; }
  });
  document.getElementById("ci-clear").addEventListener("click", ()=>{ document.getElementById("ci-var").value=""; document.getElementById("ci-cat").value=""; statsResults.textContent=""; });

  document.getElementById("ttest-btn").addEventListener("click", async ()=>{
    const data = getGridData(), v1 = document.getElementById("ttest-var1").value, v2 = document.getElementById("ttest-var2").value || null, cat = document.getElementById("ttest-cat").value || null;
    const type_ = document.querySelector("input[name=ttest-type]:checked").value, mu0 = parseFloat(document.getElementById("ttest-mu0").value) || 0;
    const alt = document.getElementById("ttest-alt").value;
    if(!v1){ statsResults.textContent="Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® 1."; return; }
    statsResults.textContent="Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚â€¦";
    try{ const j = await postStats("/stats/ttest", { data, var1: v1, var2: v2, type: type_, mu0, alternative: alt, category: cat }); showStatsJson(j); } catch(e){ statsResults.textContent="Î£Ï†Î¬Î»Î¼Î±: "+e.message; }
  });
  document.getElementById("ttest-clear").addEventListener("click", ()=>{ document.getElementById("ttest-var1").value=""; document.getElementById("ttest-var2").value=""; document.getElementById("ttest-cat").value=""; statsResults.textContent=""; });

  document.getElementById("anova-btn").addEventListener("click", async ()=>{
    const data = getGridData(), v = document.getElementById("anova-var").value, cat = document.getElementById("anova-cat").value;
    if(!v || !cat){ statsResults.textContent="Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® ÎºÎ±Î¹ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÎºÎ®."; return; }
    statsResults.textContent="Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚â€¦";
    try{ const j = await postStats("/stats/anova", { data, var: v, category: cat }); showStatsJson(j); } catch(e){ statsResults.textContent="Î£Ï†Î¬Î»Î¼Î±: "+e.message; }
  });
  document.getElementById("anova-clear").addEventListener("click", ()=>{ document.getElementById("anova-var").value=""; document.getElementById("anova-cat").value=""; statsResults.textContent=""; });

  document.getElementById("chi-btn").addEventListener("click", async ()=>{
    const data = getGridData(), v1 = document.getElementById("chi-var1").value, v2 = document.getElementById("chi-var2").value;
    if(!v1 || !v2){ statsResults.textContent="Î•Ï€Î¯Î»ÎµÎ¾Îµ ÎºÎ±Î¹ Ï„Î¹Ï‚ Î´ÏÎ¿ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚."; return; }
    statsResults.textContent="Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚â€¦";
    try{ const j = await postStats("/stats/chisquare", { data, var1: v1, var2: v2 }); showStatsJson(j); } catch(e){ statsResults.textContent="Î£Ï†Î¬Î»Î¼Î±: "+e.message; }
  });
  document.getElementById("chi-clear").addEventListener("click", ()=>{ document.getElementById("chi-var1").value=""; document.getElementById("chi-var2").value=""; statsResults.textContent=""; });

  document.getElementById("reg-btn").addEventListener("click", async ()=>{
    const data = getGridData(), x = document.getElementById("reg-x").value, y = document.getElementById("reg-y").value, cat = document.getElementById("reg-cat").value || null;
    if(!x || !y){ statsResults.textContent="Î•Ï€Î¯Î»ÎµÎ¾Îµ X ÎºÎ±Î¹ Y."; return; }
    statsResults.textContent="Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚â€¦";
    try{ const j = await postStats("/stats/regression", { data, x, y, category: cat }); showStatsJson(j); } catch(e){ statsResults.textContent="Î£Ï†Î¬Î»Î¼Î±: "+e.message; }
  });
  document.getElementById("reg-clear").addEventListener("click", ()=>{ document.getElementById("reg-x").value=""; document.getElementById("reg-y").value=""; document.getElementById("reg-cat").value=""; statsResults.textContent=""; });

  document.getElementById("excel-btn").addEventListener("click", async ()=>{
    const f = document.getElementById("excel-file").files[0], sheet = document.getElementById("excel-sheet").value.trim() || null;
    if(!f){ statsResults.textContent="Î•Ï€Î¯Î»ÎµÎ¾Îµ Î±ÏÏ‡ÎµÎ¯Î¿ Excel."; return; }
    statsResults.textContent="Î•Î¹ÏƒÎ±Î³Ï‰Î³Î®â€¦";
    const fd = new FormData(); fd.append("file", f); if(sheet) fd.append("sheet", sheet);
    try {
      const r = await fetch(`${BASE_URL}/stats/excel`, { method: "POST", body: fd });
      const j = await r.json();
      if(!r.ok) throw new Error(j.detail || "Î£Ï†Î¬Î»Î¼Î±");
      const { data: cols, columns } = j;
      const curC = gridHead.querySelectorAll("th").length - 1;
      columns.forEach((c,i)=>{ if(i>=curC) addGridCol(); });
      const trs = gridBody.querySelectorAll("tr");
      const nRows = Math.max(...Object.values(cols).map(a=>a.length), 0);
      for(let r = trs.length; r < nRows; r++) addGridRow();
      const rows = gridBody.querySelectorAll("tr");
      columns.forEach((c,i)=>{ const inp = gridHead.querySelectorAll("th")[i+1]?.querySelector("input"); if(inp) inp.value = c; });
      Object.entries(cols).forEach(([col, vals])=>{
        const ci = columns.indexOf(col);
        if(ci===-1) return;
        vals.forEach((v,ri)=>{ const cell = rows[ri]?.querySelectorAll("td")[ci+1]?.querySelector("input"); if(cell) cell.value = v; });
      });
      populateStatsDropdowns();
      statsResults.textContent = `Î•Î¹ÏƒÎ®Ï‡Î¸Î·ÏƒÎ±Î½ ${j.n_rows} Î³ÏÎ±Î¼Î¼Î­Ï‚, ${columns.length} ÏƒÏ„Î®Î»ÎµÏ‚.`;
    } catch(e){ statsResults.textContent = "Î£Ï†Î¬Î»Î¼Î±: " + e.message; }
  });
  document.getElementById("excel-clear").addEventListener("click", ()=>{ document.getElementById("excel-file").value=""; document.getElementById("excel-sheet").value=""; statsResults.textContent=""; });

  document.getElementById("ai-stats-btn").addEventListener("click", async ()=>{
    let data = document.getElementById("ai-stats-data").value.trim();
    const q = document.getElementById("ai-stats-query").value.trim();
    if(!q){ statsResults.textContent="Î“ÏÎ¬ÏˆÎµ Î¼Î¹Î± ÎµÏÏÏ„Î·ÏƒÎ·."; return; }
    if(!data){ const d = getGridData(); data = JSON.stringify(d); }
    statsResults.textContent="Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· AIâ€¦";
    try {
      const r = await fetch(`${BASE_URL}/ask`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ prompt: `Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ® ÎµÏÏÏ„Î·ÏƒÎ·. Î”ÎµÎ´Î¿Î¼Î­Î½Î± (JSON):\n${data}\n\nÎ•ÏÏÏ„Î·ÏƒÎ·: ${q}\n\nÎ‘Ï€Î¬Î½Ï„Î·ÏƒÎµ ÏƒÏ„Î± ÎµÎ»Î»Î·Î½Î¹ÎºÎ¬.` }) });
      const j = await r.json();
      if(!r.ok) throw new Error(j.detail || "Î£Ï†Î¬Î»Î¼Î±");
      statsResults.textContent = j.answer || "â€”";
    } catch(e){ statsResults.textContent = "Î£Ï†Î¬Î»Î¼Î±: " + e.message; }
  });
  document.getElementById("ai-stats-clear").addEventListener("click", ()=>{ document.getElementById("ai-stats-data").value=""; document.getElementById("ai-stats-query").value=""; statsResults.textContent=""; });


  /* ===================== INK MODAL ===================== */
  (function(){
    const $ = (id) => document.getElementById(id);

    const bd = $("ink-backdrop");
    const btnOpen = $("open-ink-btn");
    const btnClose = $("ink-close");

    const cMath = $("ink-math-canvas");
    const cText = $("ink-text-canvas");

    const colorEl = $("ink-color");
    const sizeEl = $("ink-size");
    const sizeVal = $("ink-size-val");

    const btnMathToMain = $("ink-math-to-main");
    const btnTextToMain = $("ink-text-to-main");
    const btnMathClear = $("ink-math-clear");
    const btnTextClear = $("ink-text-clear");

    const inkTransferStatus = $("ink-transfer-status");

    let ctxMath = null;
    let ctxText = null;
    let inkBusy = false;

    function setInkMsg(msg="", ok=true){
      inkTransferStatus.textContent = msg;
      inkTransferStatus.style.color = ok ? "#065f46" : "#dc2626";
      inkTransferStatus.style.fontWeight = "950";
      inkTransferStatus.style.fontSize = "1rem";
    }

    function setInkStyle(ctx){
      if(!ctx) return;
      const color = colorEl?.value || "#111827";
      const size = Number(sizeEl?.value || 4);
      if(sizeVal) sizeVal.textContent = String(size);
      ctx.strokeStyle = color;
      ctx.lineWidth = size;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
    }

    function resizeCanvas(canvas){
      if(!canvas) return null;
      const wrap = canvas.closest(".ink-wrap");
      if(!wrap) return null;

      const rect = wrap.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      canvas.width  = Math.max(1, Math.floor(rect.width  * dpr));
      canvas.height = Math.max(1, Math.floor(rect.height * dpr));

      canvas.style.width  = rect.width + "px";
      canvas.style.height = rect.height + "px";

      const ctx = canvas.getContext("2d");
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      setInkStyle(ctx);
      return ctx;
    }

    function openInk(){
      setInkMsg("");
      bd.classList.add("show");
      bd.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
      ctxMath = resizeCanvas(cMath);
      ctxText = resizeCanvas(cText);
      setTimeout(() => btnClose?.focus(), 30);
    }

    function closeInk(){
      bd.classList.remove("show");
      bd.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      inkBusy = false;
      unlockInkButtons();
    }

    function lockInkButtons(){
      inkBusy = true;
      btnMathToMain.disabled = true;
      btnTextToMain.disabled = true;
      btnMathClear.disabled = true;
      btnTextClear.disabled = true;
      btnClose.disabled = true;
    }
    function unlockInkButtons(){
      inkBusy = false;
      btnMathToMain.disabled = false;
      btnTextToMain.disabled = false;
      btnMathClear.disabled = false;
      btnTextClear.disabled = false;
      btnClose.disabled = false;
    }

    function clearCanvas(canvas, ctx){
      if(!canvas || !ctx) return;
      ctx.save();
      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.restore();
    }

    function getPos(canvas, ev){
      const r = canvas.getBoundingClientRect();
      return { x: ev.clientX - r.left, y: ev.clientY - r.top };
    }

    function bindDraw(canvas, getCtx){
      let drawing = false;
      let activePointerId = null;
      let lastX = 0, lastY = 0;

      function start(ev){
        const ctx = getCtx();
        if(!ctx) return;
        if(activePointerId !== null && ev.pointerId !== activePointerId) return;
        activePointerId = ev.pointerId;
        drawing = true;
        setInkStyle(ctx);
        const p = getPos(canvas, ev);
        lastX = p.x; lastY = p.y;
        try{ canvas.setPointerCapture(ev.pointerId); }catch(e){}
        ev.preventDefault();
      }

      function move(ev){
        const ctx = getCtx();
        if(!ctx || !drawing || ev.pointerId !== activePointerId) return;
        const p = getPos(canvas, ev);
        const pressure = (typeof ev.pressure === "number" && ev.pressure > 0) ? ev.pressure : 0.5;
        const base = Number(sizeEl?.value || 4);
        ctx.lineWidth = base * (0.75 + pressure * 0.9);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        lastX = p.x; lastY = p.y;
        ev.preventDefault();
      }

      function end(ev){
        if(ev.pointerId !== activePointerId) return;
        drawing = false;
        try{ canvas.releasePointerCapture(ev.pointerId); }catch(e){}
        activePointerId = null;
        ev.preventDefault();
      }

      canvas.addEventListener("pointerdown", start, {passive:false});
      canvas.addEventListener("pointermove", move, {passive:false});
      canvas.addEventListener("pointerup", end, {passive:false});
      canvas.addEventListener("pointercancel", end, {passive:false});
      canvas.addEventListener("pointerleave", end, {passive:false});
    }

    async function canvasToBlob(canvas){
      return await new Promise(resolve => canvas.toBlob(b => resolve(b), "image/png", 0.92));
    }

    function cleanRecognitionText(txt){
      const t = (txt || "").replace(/\r/g,"").trim();
      if(!t) return "";
      return t.split("\n").map(x=>x.trim()).filter(Boolean).slice(0,10).join("\n");
    }

    async function recognizeFromCanvas(canvas, kind){
      const blob = await canvasToBlob(canvas);
      if(!blob) return "";

      setInkMsg(kind === "math" ? "â³ Î”Î¹Î±Î²Î¬Î¶Ï‰ Î¼Î±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ¬â€¦" : "â³ Î”Î¹Î±Î²Î¬Î¶Ï‰ ÎºÎµÎ¯Î¼ÎµÎ½Î¿â€¦", true);

      const prompt = (kind === "math")
        ? "Î‘Î½Î±Î³Î½ÏÏÎ¹ÏƒÎµ Ï„Î·Î½ ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ— Î•ÎšÎ¦Î¡Î‘Î£Î— Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Î³ÏÎ±Î¼Î¼Î­Î½Î· ÏƒÏ„Î·Î½ ÎµÎ¹ÎºÏŒÎ½Î±.\nÎ•Î Î™Î£Î¤Î¡Î•Î¨Î• ÎœÎŸÎÎŸ Ï„Î·Î½ Î­ÎºÏ†ÏÎ±ÏƒÎ· ÏƒÎµ Î±Ï€Î»ÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ (Ï‡Ï‰ÏÎ¯Ï‚ ÎµÎ¾Î·Î³Î®ÏƒÎµÎ¹Ï‚).\nÎœÎ·Î½ Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Ï€ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚."
        : "Î”Î¹Î¬Î²Î±ÏƒÎµ Ï„Î¿ Ï‡ÎµÎ¹ÏÏŒÎ³ÏÎ±Ï†Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ ÏƒÏ„Î·Î½ ÎµÎ¹ÎºÏŒÎ½Î± ÎºÎ±Î¹ ÎµÏ€Î­ÏƒÏ„ÏÎµÏˆÎµ Ï„Î¿ Ï‰Ï‚ Î±Ï€Î»ÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿.\nÎ•Î Î™Î£Î¤Î¡Î•Î¨Î• ÎœÎŸÎÎŸ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ (Ï‡Ï‰ÏÎ¯Ï‚ ÏƒÏ‡ÏŒÎ»Î¹Î±).\nÎ‘Î½ Î´ÎµÎ½ Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ Ï„Î¯Ï€Î¿Ï„Î±, ÎµÏ€Î­ÏƒÏ„ÏÎµÏˆÎµ ÎºÎµÎ½ÏŒ.";

      const formData = new FormData();
      formData.append("image", new File([blob], kind === "math" ? "ink_math.png" : "ink_text.png", {type:"image/png"}));
      formData.append("question", prompt);
      formData.append("level", currentLevel);

      try{
        const res = await fetch(`${BASE_URL}/check-image`, { method:"POST", body: formData });
        const data = await res.json();
        return cleanRecognitionText(data.answer || "");
      }catch(e){
        setInkMsg("âŒ Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ (/check-image).", false);
        return "";
      }
    }

    function appendMathOnce(text){
      const toAdd = (text || "").trim();
      if(!toAdd) return false;
      if(mathInput.value.includes(toAdd)) return false;
      const prefix = mathInput.value.trim() ? "\n" : "";
      mathInput.value = mathInput.value + prefix + toAdd;
      return true;
    }

    function appendTextOnce(text){
      const toAdd = (text || "").trim();
      if(!toAdd) return false;
      if(textInput.value.includes(toAdd)) return false;
      const prefix = textInput.value.trim() ? "\n\n" : "";
      textInput.value = textInput.value + prefix + toAdd;
      return true;
    }

    btnOpen.addEventListener("click", openInk);
    btnClose.addEventListener("click", () => { if(!inkBusy) closeInk(); });
    bd.addEventListener("click", (e) => { if(e.target === bd && !inkBusy) closeInk(); });

    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && bd.classList.contains("show") && !inkBusy) closeInk();
    });

    window.addEventListener("resize", () => {
      if(bd.classList.contains("show")){
        ctxMath = resizeCanvas(cMath);
        ctxText = resizeCanvas(cText);
      }
    }, {passive:true});

    sizeEl.addEventListener("input", () => { setInkStyle(ctxMath); setInkStyle(ctxText); });
    colorEl.addEventListener("input", () => { setInkStyle(ctxMath); setInkStyle(ctxText); });

    btnMathClear.addEventListener("click", () => { if(inkBusy) return; clearCanvas(cMath, ctxMath); setInkMsg(""); });
    btnTextClear.addEventListener("click", () => { if(inkBusy) return; clearCanvas(cText, ctxText); setInkMsg(""); });

    btnMathToMain.addEventListener("click", async () => {
      if(inkBusy) return;
      lockInkButtons();
      try{
        const recognized = (await recognizeFromCanvas(cMath, "math")).trim();
        if(!recognized){ setInkMsg("âŒ Î”ÎµÎ½ Î±Î½Î±Î³Î½Ï‰ÏÎ¯ÏƒÏ„Î·ÎºÎµ Ï„Î¯Ï€Î¿Ï„Î±.", false); return; }
        const finalText = greekToEnglishMath(recognized);
        const ok = appendMathOnce(finalText);
        await updateMathPreview();
        setInkMsg(ok ? "âœ… Î ÎµÏÎ¬ÏƒÏ„Î·ÎºÎµ ÏƒÏ„Î· ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® ÎˆÎºÏ†ÏÎ±ÏƒÎ·." : "â„¹ï¸ Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÏƒÏ„Î· ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ®.", ok);
        closeInk();
      } finally {
        unlockInkButtons();
      }
    });

    btnTextToMain.addEventListener("click", async () => {
      if(inkBusy) return;
      lockInkButtons();
      try{
        const recognized = (await recognizeFromCanvas(cText, "text")).trim();
        if(!recognized){ setInkMsg("âŒ Î”ÎµÎ½ Î±Î½Î±Î³Î½Ï‰ÏÎ¯ÏƒÏ„Î·ÎºÎµ Ï„Î¯Ï€Î¿Ï„Î±.", false); return; }
        const ok = appendTextOnce(recognized);
        setInkMsg(ok ? "âœ… Î ÎµÏÎ¬ÏƒÏ„Î·ÎºÎµ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® Î‘Ï€Î¿ÏÎ¯Î±." : "â„¹ï¸ Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®.", ok);
        closeInk();
      } finally {
        unlockInkButtons();
      }
    });

    bindDraw(cMath, () => ctxMath);
    bindDraw(cText, () => ctxText);
  })();

  /* ===================== INIT ===================== */
  resetImageUI();
  updateMathPreview();
  updateMatrixPreview();
  updateSavedInfo();
     resetImageUI();
     updateMathPreview();
     updateMatrixPreview();
     updateSavedInfo();
  
</script>

</body>
</html>


  


