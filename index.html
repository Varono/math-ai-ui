<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="format-detection" content="telephone=no" />
  <title>Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI â€“ Î”Ï. ÎœÎ±ÏÎ¯Î½Î¿Ï‚ Î•Ï…ÏƒÏ„Î±Î¸Î¯Î¿Ï…</title>

  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:#f5f7fb;color:#111827;font-size:14px}
    main{width:100%;max-width:none;margin:0;padding:12px}

    h1{margin:4px 0 2px 0;font-size:1.2rem}
    .subtitle{margin:0 0 6px 0;font-size:.8rem;color:#4b5563}
    .edu-note-small{font-size:.75rem;color:#6b7280;margin-bottom:8px}

    .top-grid{display:grid;gap:10px}
    @media(min-width:980px){ .top-grid{grid-template-columns:1.35fr .65fr} }

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 8px 20px rgba(15,23,42,.05);padding:10px;margin-bottom:10px}
    label{font-weight:800;font-size:.9rem}
    .muted{color:#64748b;font-size:.78rem}

    textarea,input[type="text"],input[type="number"]{
      width:100%;padding:8px 10px;border-radius:10px;border:1px solid #d1d5db;
      font-family:"JetBrains Mono",ui-monospace,monospace;font-size:.9rem
    }
    textarea{min-height:70px}
    textarea:focus,input:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.12);outline:none}
    @media(max-width:650px){ textarea,input[type="text"],input[type="number"]{font-size:16px} }

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}

    .btn{border:0;border-radius:999px;padding:6px 10px;font-weight:800;cursor:pointer;font-size:.8rem;touch-action:manipulation;white-space:nowrap}
    .btn.primary{background:#2563eb;color:#fff}
    .btn.ghost{background:#eef2ff;color:#1e3a8a}
    .btn.dark{background:#111827;color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .divider{height:1px;background:#e5e7eb;margin:10px 0}

    #math-preview-box{margin-top:6px;border-radius:10px;border:1px dashed #cbd5e1;padding:6px 8px;background:#f9fafb;min-height:34px;font-size:.9rem;color:#0f172a}
    #math-preview-placeholder{color:#94a3b8;font-size:.75rem}

    .level-btn.active{background:#2563eb;color:#fff}

    .kbd{background:#eef2ff;border:1px solid #e5e7eb;border-radius:14px;padding:8px;margin-top:10px}
    .tabs{display:flex;gap:4px;flex-wrap:wrap}
    .tab{border:0;border-radius:999px;padding:4px 10px;background:#e5e7eb;cursor:pointer;font-weight:800;font-size:.75rem;touch-action:manipulation}
    .tab.active{background:#2563eb;color:#fff}
    .keys{margin-top:6px}
    .key{
      border:0;border-radius:9px;padding:6px 8px;background:#fff;margin:2px;cursor:pointer;
      font-family:"JetBrains Mono",ui-monospace,monospace;font-size:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.12);
      touch-action:manipulation
    }

    .imgwrap{display:grid;gap:8px;margin-top:6px}
    .preview{width:100%;max-height:280px;object-fit:contain;border-radius:12px;border:1px dashed #cbd5e1;background:#fff}

    .answer{
      white-space:pre-wrap;border:1px solid #e5e7eb;border-radius:12px;padding:10px;min-height:80px;background:#fafafa;font-size:.9rem;
      word-break: normal; overflow-wrap: anywhere;
    }
    #answer-card{scroll-margin-top:14px}

    .continue-box{margin-top:10px;border-top:1px solid #e5e7eb;padding-top:10px;display:none}
    .continue-q{font-weight:900;font-size:.85rem;margin-bottom:6px;color:#0f172a}

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:14px;z-index:9999;
      background:rgba(17,24,39,.92);color:#fff;padding:10px 14px;border-radius:999px;
      box-shadow:0 12px 28px rgba(0,0,0,.22);display:none;align-items:center;gap:10px;
      max-width:92vw;font-size:.85rem;backdrop-filter: blur(6px);
    }
    .toast .toast-btn{
      border:0;background:#2563eb;color:#fff;font-weight:900;border-radius:999px;padding:8px 12px;
      cursor:pointer;touch-action:manipulation;white-space:nowrap;
    }

    .tools-header{display:flex;gap:10px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    .tool-tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tool-tab{border:0;border-radius:999px;padding:8px 14px;background:#e5e7eb;cursor:pointer;font-weight:900;font-size:.82rem;touch-action:manipulation}
    .tool-tab.active{background:#111827;color:#fff}
    .tool-panel{display:none;margin-top:10px}
    .tool-panel.active{display:block}

    .mini-card{border:1px solid #e5e7eb;border-radius:14px;padding:10px;background:#fafafa;height:100%}
    .mini-title{font-weight:950;font-size:.86rem;margin-bottom:8px;color:#0f172a}
    .result-box{border:1px dashed #cbd5e1;border-radius:12px;padding:8px 10px;background:#fff;min-height:52px}
    .mono{font-family:"JetBrains Mono",ui-monospace,monospace}

    .matrix-wide{display:grid;gap:10px}
    @media(min-width:1100px){ .matrix-wide{grid-template-columns:1fr 1fr 1.25fr} }
    @media(min-width:820px) and (max-width:1099px){ .matrix-wide{grid-template-columns:1fr 1fr} }

    .two-col{display:grid;gap:10px}
    @media(min-width:920px){ .two-col{grid-template-columns:1.1fr .9fr} }

    .inline-inputs{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:end}

    @media(max-width:650px){
      .btn{padding:10px 14px;font-size:14px}
      .tool-tab{padding:10px 14px}
      .tab{padding:8px 12px}
      .key{padding:10px 10px}
      .toast{font-size:14px}
      .toast .toast-btn{padding:10px 14px}
    }

    .footer-note{font-size:.78rem;color:#4b5563;line-height:1.4}

    /* ===== Export/Print controls (Î´Î¯Ï€Î»Î± ÏƒÏ„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·) ===== */
    .answer-actions{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .answer-actions .btn{padding:8px 12px;font-size:.8rem}
    .answer-actions .pill{
      font-size:.75rem; color:#64748b;
      border:1px solid #e5e7eb; background:#fff; padding:6px 10px; border-radius:999px;
    }

    /* ===== Ink Modal ===== */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      z-index:10000;
      padding:12px;
      overflow:auto;
    }
    .modal-backdrop.show{display:block;}
    .modal{
      width:min(1100px, 96vw);
      margin:24px auto;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:18px;
      box-shadow:0 20px 50px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;background:#0f172a;color:#fff;
    }
    .modal-title{font-weight:950; font-size:.92rem;}
    .modal-close{
      border:0;background:rgba(255,255,255,.14);color:#fff;border-radius:999px;
      padding:8px 12px;cursor:pointer;font-weight:900;
    }
    .modal-body{padding:10px 12px;}

    .ink-controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:8px 10px;border:1px solid #e5e7eb;border-radius:14px;background:#fafafa;margin:8px 0 10px 0;
    }
    .ink-controls label{font-weight:900;font-size:.78rem;margin-right:6px}
    .ink-controls .ctrl{display:flex;align-items:center;gap:8px}
    .ink-controls input[type="range"]{width:170px}
    .ink-controls input[type="color"]{width:42px;height:30px;padding:0;border:0;background:transparent;cursor:pointer}
    .ink-controls .val{font-family:"JetBrains Mono",ui-monospace,monospace;font-size:.78rem;color:#334155;min-width:38px;text-align:left}

    .ink-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:8px 0 10px 0}
    .ink-left{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .ink-right{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .ink-hint{font-size:.78rem;color:#475569}

    .ink-wrap{
      border:1px dashed #cbd5e1;border-radius:14px;background:#fff;
      height:min(62vh, 560px);width:100%;overflow:hidden;position:relative;
      touch-action:none;
    }
    canvas#ink-canvas{
      width:100%;height:100%;display:block;background:#fff;
      cursor:crosshair;user-select:none;-webkit-user-select:none;touch-action:none;
    }
    .ink-minirow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
    @media(max-width:650px){
      .modal{margin:10px auto;}
      .ink-wrap{height:68vh;}
      .modal-title{font-size:14px;}
    }

    /* ===== Print styling (Î±Î½ Ï„Ï…Ï€ÏÏƒÎµÎ¹ ÎŸÎ›Î— Ï„Î· ÏƒÎµÎ»Î¯Î´Î±) ===== */
    @media print{
      .toast, .kbd, .tool-tabs, .tools-header, .tool-panel, #open-ink-btn,
      #image-input, #check-image-btn, #remove-img-btn, #continue-box,
      .answer-actions, #status, .edu-note-small, .subtitle { display:none !important; }
      body{background:#fff}
      main{padding:0}
      .card{box-shadow:none;border:0;border-radius:0;margin:0;padding:0}
      #ai-answer{border:0;background:#fff;padding:0}
    }
  </style>
</head>

<body>
<main>
  <h1>Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI</h1>
  <p class="subtitle">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÏŒÏ‚: Î”Ï. ÎœÎ±ÏÎ¯Î½Î¿Ï‚ Î•Ï…ÏƒÏ„Î±Î¸Î¯Î¿Ï… â€“ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏŒÏ‚ (MSc) Î¼Îµ PhD ÏƒÏ„Î± Î Î±Î¹Î´Î±Î³Ï‰Î³Î¹ÎºÎ¬ / Î“Î½Ï‰ÏƒÏ„Î¹ÎºÎ® Î¨Ï…Ï‡Î¿Î»Î¿Î³Î¯Î±</p>
  <p class="edu-note-small">Î¤Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Î±Ï…Ï„ÏŒ Î­Ï‡ÎµÎ¹ Î±Î½Î±Ï€Ï„Ï…Ï‡Î¸ÎµÎ¯ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ Î³Î¹Î± ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿ÏÏ‚ ÏƒÎºÎ¿Ï€Î¿ÏÏ‚.</p>

  <div class="top-grid">
    <div class="card">
      <label for="math-input">ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® Î­ÎºÏ†ÏÎ±ÏƒÎ·</label>
      <textarea id="math-input" placeholder="Ï€.Ï‡. âˆ« x/(x+1) dx, ..."></textarea>

      <div id="math-preview-box">
        <span id="math-preview-placeholder">Î— Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ ÎµÎ´Ï ÎºÎ±Î¸ÏÏ‚ Î³ÏÎ¬Ï†ÎµÎ¹Ï‚â€¦</span>
        <div id="math-preview"></div>
      </div>

      <div style="margin-top:10px">
        <label for="text-input">Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±</label>
        <textarea id="text-input" placeholder="Î¡ÏÏ„Î± ÎµÎ´Ï Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ (ÎºÎ±Î¹ Î³Î¹Î± Î Î¯Î½Î±ÎºÎµÏ‚/Î£ÎµÎ¹ÏÎ­Ï‚/Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®)."></textarea>

        <div class="row" style="margin-top:4px">
          <span class="muted"><b>Î•Ï€Î¯Ï€ÎµÎ´Î¿ Î»ÏÏƒÎ·Ï‚:</b></span>
          <button class="btn ghost level-btn active" data-level="lyceum" type="button">Î›ÏÎºÎµÎ¹Î¿</button>
          <button class="btn ghost level-btn" data-level="university" type="button">Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿</button>
        </div>

        <div class="row">
          <button class="btn primary" id="ask-btn" type="button">Î¡ÏÏ„Î± Ï„Î¿ AI</button>
          <button class="btn ghost" id="clear-btn" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
          <span class="muted" id="status"></span>
        </div>
        <div class="muted">Endpoint: <b>/ask</b> (JSON) & <b>/check-image</b> (FormData).</div>
      </div>

      <div class="kbd">
        <div class="tabs">
          <button class="tab active" data-layout="num" type="button">123</button>
          <button class="tab" data-layout="func" type="button">f(x)</button>
          <button class="tab" data-layout="abc" type="button">ABC</button>
          <button class="tab" data-layout="sym" type="button">#&Â¬</button>
        </div>
        <div id="keyboard-rows" class="keys"></div>
      </div>
    </div>

    <div class="card">
      <label>ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î»ÏÏƒÎ·Ï‚ Î±Ï€ÏŒ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</label>
      <div class="imgwrap">
        <input type="file" id="image-input" accept="image/*">
        <img id="img-preview" class="preview" alt="Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚" />
      </div>
      <div class="row">
        <button class="btn primary" id="check-image-btn" disabled type="button">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚</button>
        <button class="btn ghost" id="remove-img-btn" disabled type="button">Î‘Ï†Î±Î¯ÏÎµÏƒÎ·</button>
      </div>
      <div class="muted">Î— Î¯Î´Î¹Î± Î»ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î± ÎºÎ±Î¹ Ï„Î¿ Î¯Î´Î¹Î¿ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ Î¸Î± ÏƒÏ„Î±Î»Î¿ÏÎ½ Î¼Î±Î¶Î¯ Î¼Îµ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±.</div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn dark" id="open-ink-btn" type="button">âœï¸ Î†Î½Î¿Î¹Î¾Îµ Î Î¯Î½Î±ÎºÎ± Î“ÏÎ±Ï†Î®Ï‚ (stylus)</button>
        <span class="muted">Î™Î´Î±Î½Î¹ÎºÏŒ Î³Î¹Î± tablet/iPad: Î³ÏÎ¬Ï†ÎµÎ¹Ï‚ Î¼Îµ Ï€Î­Î½Î± ÎºÎ±Î¹ Ï€Î±Î¯ÏÎ½ÎµÎ¹Ï‚ hint/Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎ·.</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="tools-header">
      <div>
        <label>Î•ÏÎ³Î±Î»ÎµÎ¯Î±</label>
        <div class="muted">ÎŒ,Ï„Î¹ Ï†Ï„Î¹Î¬Ï‡Î½ÎµÎ¹Ï‚ ÎµÎ´Ï Î¼Ï€Î±Î¯Î½ÎµÎ¹ ÏƒÎ±Î½ context ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±.</div>
      </div>
      <div class="tool-tabs">
        <button class="tool-tab active" data-tool="matrix" type="button">Î Î¯Î½Î±ÎºÎµÏ‚</button>
        <button class="tool-tab" data-tool="series" type="button">Î£ÎµÎ¹ÏÎ­Ï‚</button>
        <button class="tool-tab" data-tool="stats" type="button">Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®</button>
      </div>
    </div>

    <!-- ===== MATRICES ===== -->
    <div class="tool-panel active" id="tool-matrix">
      <div class="matrix-wide">
        <div class="mini-card">
          <div class="mini-title">Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Ï€Î¯Î½Î±ÎºÎ±</div>
          <div class="muted">ÎœÎ¿ÏÏ†Î®: <span class="mono">1,2;3,4</span></div>
          <textarea id="matrix-raw" placeholder="Ï€.Ï‡. 1,2;3,4" style="margin-top:8px"></textarea>
          <div class="row">
            <button class="btn primary" id="matrix-insert-btn" type="button">Î’Î¬Î»Îµ Ï„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±</button>
            <button class="btn ghost" id="matrix-clear-btn" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            <button class="btn ghost" id="matrix-to-text-btn" type="button">Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
          </div>
        </div>

        <div class="mini-card">
          <div class="mini-title">Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·</div>
          <div id="matrix-preview" class="result-box"></div>
          <div class="muted" style="margin-top:8px">Tip: Î²Î¬Î»Îµ Ï€ÏÏÏ„Î± Ï„Î¿Î½ A, Î¼ÎµÏ„Î¬ Ï€Î¬Ï„Î± Ï„Î¹Ï‚ ÎµÎ½Ï„Î¿Î»Î­Ï‚ Î´ÎµÎ¾Î¹Î¬.</div>
        </div>

        <div class="mini-card">
          <div class="mini-title">Î•Î½Ï„Î¿Î»Î­Ï‚ (Î¼Ï€Î±Î¯Î½Î¿Ï…Î½ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®)</div>

          <div class="mini-title" style="margin-top:6px">Î ÏÎ¬Î¾ÎµÎ¹Ï‚</div>
          <div class="row">
            <button class="btn ghost" id="matrix-det-btn" type="button">det(A)</button>
            <button class="btn ghost" id="matrix-inv-btn" type="button">A^{-1}</button>
            <button class="btn ghost" id="matrix-solve-btn" type="button">Ax=b</button>
          </div>

          <div class="divider"></div>

          <div class="mini-title">Î™Î´Î¹Î¿Ï„Î¹Î¼Î­Ï‚ / Î”Î¹Î±Î³Ï‰Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ·</div>
          <div class="row">
            <button class="btn ghost" id="eigvals-btn" type="button">Î™Î´Î¹Î¿Ï„Î¹Î¼Î­Ï‚</button>
            <button class="btn ghost" id="eigvecs-btn" type="button">Î™Î´Î¹Î¿Î´Î¹Î±Î½ÏÏƒÎ¼Î±Ï„Î±</button>
            <button class="btn ghost" id="diag-btn" type="button">Î”Î¹Î±Î³Ï‰Î½Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹;</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="pd-btn" type="button">P, D</button>
            <button class="btn ghost" id="verify-pdp-btn" type="button">A=PDP^{-1}</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="an-btn" type="button">A^n</button>
            <button class="btn ghost" id="eA-btn" type="button">e^A</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="dynsys-btn" type="button">Î”Ï…Î½Î±Î¼Î¹ÎºÏŒ</button>
            <button class="btn ghost" id="ode-btn" type="button">Î”.Î•.</button>
            <button class="btn ghost" id="exam-summary-btn" type="button">ğŸ§  Î£ÏÎ½Î¿ÏˆÎ·</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== SERIES ===== -->
    <div class="tool-panel" id="tool-series">
      <div class="two-col">
        <div class="mini-card">
          <div class="mini-title">Î†Î¸ÏÎ¿Î¹ÏƒÎ¼Î± (Î£)</div>
          <div class="muted">Î“ÏÎ¬ÏˆÎµ Ï„Î¿Î½ ÏŒÏÎ¿ Ï€Î¬Î½Ï‰. (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬) ÎºÎ¬Î½Îµ highlight.</div>

          <div class="inline-inputs" style="margin-top:10px">
            <div>
              <div class="muted"><b>Î‘Ï€ÏŒ (n = )</b></div>
              <input type="text" id="series-from" placeholder="1" inputmode="numeric" />
            </div>
            <div>
              <div class="muted"><b>ÎˆÏ‰Ï‚</b></div>
              <input type="text" id="series-to" placeholder="âˆ Î® 6" inputmode="numeric" />
            </div>
          </div>

          <div class="row">
            <button class="btn primary" id="series-wrap-btn" type="button">ÎšÎ¬Î½Îµ Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î±</button>
            <button class="btn ghost" id="series-clear-btn" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            <button class="btn ghost" id="series-to-text-btn" type="button">Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
          </div>
        </div>

        <div class="mini-card">
          <div class="mini-title">Î“ÏÎ®Î³Î¿ÏÎ± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬</div>
          <div class="muted">Î£Ï„Î®Î½Î¿Ï…Î½ ÎµÏÏÏ„Î·ÏƒÎ· ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±.</div>
          <div class="row" style="margin-top:10px">
            <button class="btn ghost" id="series-geo-btn" type="button">Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¹ÎºÎ®</button>
            <button class="btn ghost" id="series-taylor-btn" type="button">Taylor</button>
            <button class="btn ghost" id="series-test-btn" type="button">ÎšÏÎ¹Ï„Î®ÏÎ¹Î¿</button>
          </div>
          <div class="divider"></div>
          <div class="mini-title">Tip</div>
          <div class="muted">Î‘Î½ Î´ÎµÎ½ ÎºÎ¬Î½ÎµÎ¹Ï‚ highlight, Î¸Î± Î²Î¬Î»ÎµÎ¹ <b>a_n</b>.</div>
        </div>
      </div>
    </div>

    <!-- ===== STATS ===== -->
    <div class="tool-panel" id="tool-stats">
      <div class="two-col">
        <div class="mini-card">
          <div class="mini-title">Î”ÎµÎ´Î¿Î¼Î­Î½Î±</div>
          <div class="muted">Ï€.Ï‡. 12, 15, 18, 18, 20</div>
          <textarea id="stats-data" placeholder="Ï€.Ï‡. 12, 15, 18, 18, 20" style="margin-top:8px"></textarea>
          <div class="row">
            <button class="btn primary" id="stats-calc-btn" type="button">Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ</button>
            <button class="btn ghost" id="stats-insert-btn" type="button">Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
            <button class="btn ghost" id="stats-clear-btn" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
          </div>
        </div>

        <div class="mini-card">
          <div class="mini-title">Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±</div>
          <div id="stats-results" class="result-box mono"></div>
          <div class="divider"></div>
          <div class="mini-title">Templates</div>
          <div class="row">
            <button class="btn ghost" id="stats-ci-btn" type="button">Î”.Î•.</button>
            <button class="btn ghost" id="stats-z-btn" type="button">z-score</button>
            <button class="btn ghost" id="stats-test-btn" type="button">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ===== ANSWER ===== -->
  <div class="card" id="answer-card">
    <label>Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· AI</label>
    <div id="ai-answer" class="answer">Î ÎµÏÎ¹Î¼Î­Î½Ï‰ Ï„Î·Î½ Ï€ÏÏÏ„Î· ÏƒÎ¿Ï… ÎµÏÏÏ„Î·ÏƒÎ·â€¦</div>

    <!-- âœ… ÎÎ•ÎŸ: Save/Export/Print -->
    <div class="answer-actions">
      <button class="btn ghost" id="save-answer-btn" type="button">ğŸ’¾ Save Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·</button>
      <button class="btn ghost" id="download-answer-btn" type="button">â¬‡ï¸ Download .txt</button>
      <button class="btn primary" id="print-answer-btn" type="button">ğŸ–¨ï¸ Print (ÏŒÎ¼Î¿ÏÏ†Î¿)</button>
      <span class="pill" id="saved-info">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.</span>
    </div>

    <div id="continue-box" class="continue-box">
      <div class="continue-q">ÎÎ± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÏ‰;</div>
      <div class="row">
        <button class="btn dark" id="continue-yes" type="button">ÎÎ‘Î™</button>
        <button class="btn ghost" id="continue-no" type="button">ÎŸÎ§Î™</button>
        <span class="muted" id="continue-status"></span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="footer-note">
      <strong>Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ® ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·:</strong><br>
      Î¤Î¿ Ï€Î±ÏÏŒÎ½ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Ï€ÏÎ¿Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ <strong>Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ Î³Î¹Î± ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿ÏÏ‚ ÏƒÎºÎ¿Ï€Î¿ÏÏ‚</strong>.
    </div>
  </div>
</main>

<!-- ===== TOAST ===== -->
<div id="answer-toast" class="toast" role="status" aria-live="polite">
  <span>âœ… Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¿ ÎºÎ¬Ï„Ï‰.</span>
  <button id="toast-go" class="toast-btn" type="button">Î”ÎµÏ‚ Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·</button>
</div>

<!-- ===== INK MODAL (Ï€ÏÎ¹Î½ Ï„Î¿ script) ===== -->
<div id="ink-backdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Î Î¯Î½Î±ÎºÎ±Ï‚ Î“ÏÎ±Ï†Î®Ï‚">
    <div class="modal-head">
      <div class="modal-title">âœï¸ Î Î¯Î½Î±ÎºÎ±Ï‚ Î“ÏÎ±Ï†Î®Ï‚ â€“ Î³ÏÎ¬ÏˆÎµ Î¬Î½ÎµÏ„Î± Î¼Îµ Ï€Î­Î½Î±/Î´Î¬Ï‡Ï„Ï…Î»Î¿</div>
      <button class="modal-close" id="ink-close" type="button">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ âœ•</button>
    </div>

    <div class="modal-body">
      <label for="ink-question" style="font-weight:900;font-size:.85rem">Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î± Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ Î²Î®Î¼Î±</label>
      <textarea id="ink-question" placeholder="Ï€.Ï‡. Î³Î¹Î±Ï„Î¯ ÎµÎ´Ï Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï€ÏÏŒÏƒÎ·Î¼Î¿; / Î¼Ï€Î¿ÏÏ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ‰ Î±Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·;" style="min-height:60px;margin-top:6px"></textarea>

      <div class="row" style="margin-top:6px">
        <button class="btn ghost" id="ink-send-to-text" type="button">â• Î’Î¬Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±</button>
        <span class="muted">Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ: Ï„Î¿ Î¼ÎµÏ„Î±Ï†Î­ÏÎµÎ¹ ÎºÎ±Î¹ ÏƒÏ„Î¿ ÎºÏÏÎ¹Î¿ Ï€ÎµÎ´Î¯Î¿.</span>
      </div>

      <div class="divider"></div>

      <div class="ink-controls">
        <div class="ctrl">
          <label for="ink-color">Î§ÏÏÎ¼Î±</label>
          <input id="ink-color" type="color" value="#111827" />
        </div>
        <div class="ctrl">
          <label for="ink-size">Î Î¬Ï‡Î¿Ï‚</label>
          <input id="ink-size" type="range" min="1" max="16" step="1" value="4" />
          <span class="val" id="ink-size-val">4</span>
        </div>
        <span class="muted">Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î¼Îµ Ï€Î¿Î½Ï„Î¯ÎºÎ¹, touch ÎºÎ±Î¹ stylus.</span>
      </div>

      <div class="ink-toolbar">
        <div class="ink-left">
          <button class="btn primary" id="ink-check-step" type="button">âœ… ÎˆÎ»ÎµÎ³Î¾Îµ Î²Î®Î¼Î±</button>
          <button class="btn ghost" id="ink-hint" type="button">ğŸ§  Î”ÏÏƒÎµ hint</button>
          <button class="btn ghost" id="ink-clear" type="button">ğŸ”„ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
        </div>
        <div class="ink-right">
          <span class="ink-hint">Î£Ï„Î­Î»Î½ÎµÎ¹ ÏŒ,Ï„Î¹ Î­Î³ÏÎ±ÏˆÎµÏ‚ + Ï„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î± + Ï„Î¿ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ ÏƒÏ„Î¿ AI.</span>
        </div>
      </div>

      <div class="ink-wrap">
        <canvas id="ink-canvas"></canvas>
      </div>

      <div class="ink-minirow">
        <span class="muted">Tip: Î“ÏÎ¬ÏˆÎµ Î¼ÎµÎ³Î¬Î»Î±/ÎºÎ±Î¸Î±ÏÎ¬. Î‘Î½ ÎµÎ¯Î½Î±Î¹ Ï€Î¯Î½Î±ÎºÎµÏ‚/ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î±, Ï‡ÏÏÎ¹ÏƒÎµ ÏƒÎµ Î³ÏÎ±Î¼Î¼Î­Ï‚.</span>
      </div>
    </div>
  </div>
</div>

<script>
  /* ===================== Î¡Î¥Î˜ÎœÎ™Î£Î— SERVER ===================== */
  const BASE_URL = "https://math-ai-server.onrender.com";

  /* ===================== TOAST ===================== */
  const toast = document.getElementById("answer-toast");
  const toastGo = document.getElementById("toast-go");
  const answerCard = document.getElementById("answer-card");

  function showToast(){
    toast.style.display = "flex";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => hideToast(), 7000);
  }
  function hideToast(){ toast.style.display = "none"; }
  function isAnswerVisible(){
    const r = answerCard.getBoundingClientRect();
    const vh = window.innerHeight || document.documentElement.clientHeight;
    return (r.top < vh * 0.75) && (r.bottom > vh * 0.25);
  }
  function scrollToAnswer(){
    answerCard.scrollIntoView({ behavior: "smooth", block: "start" });
    hideToast();
  }
  toastGo.addEventListener("click", scrollToAnswer);
  window.addEventListener("scroll", () => {
    if (toast.style.display !== "none" && isAnswerVisible()) hideToast();
  }, { passive:true });

  /* ===================== Î•Î Î™Î Î•Î”ÎŸ ===================== */
  let currentLevel = "lyceum";
  document.querySelectorAll(".level-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".level-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentLevel = btn.dataset.level;
    });
  });

  /* ===================== HELPERS ===================== */
  const mathInput = document.getElementById("math-input");
  const textInput = document.getElementById("text-input");

  function insertAtCursor(el, text){
    const start = el.selectionStart ?? el.value.length;
    const end = el.selectionEnd ?? el.value.length;
    el.setRangeText(text, start, end, "end");
    el.focus();
  }
  function replaceSelection(el, newText){
    const start = el.selectionStart ?? 0;
    const end = el.selectionEnd ?? 0;
    if (start === end){ insertAtCursor(el, newText); return; }
    el.setRangeText(newText, start, end, "end");
    el.focus();
  }
  function getSelectionText(el){
    const start = el.selectionStart ?? 0;
    const end = el.selectionEnd ?? 0;
    if (start === end) return "";
    return el.value.slice(start, end);
  }
  function addToolHeader(title){ return `=== ${title} ===`; }
  function appendToTextContext(block){
    const b = (block || "").trim();
    if (!b) return;
    if (textInput.value.includes(b)) return;
    const prefix = textInput.value.trim() ? "\n\n" : "";
    textInput.value = textInput.value.trim() + prefix + b;
  }

  /* ===================== KEYBOARD ===================== */
  const keyboardLayouts = {
    num: [['x','y','z','Ï€','e','7','8','9','Ã—','Ã·'],['xÂ²','xâ¿','a/b','âˆš','â¿âˆš','4','5','6','+','âˆ’'],['1','2','3','0','â‰¤','â‰¥','<','>'],['=',' ']],
    func: [['sin','cos','tan','ln','logâ‚â‚€','logâ‚bâ‚'],['sinâ»Â¹','cosâ»Â¹','tanâ»Â¹','d/dx','âˆ«','dx'],['sec(x)','csc(x)','Ï€âˆ«','{','}','â‰¤','â‰¥'],['=',' ']],
    abc: [['q','w','e','r','t','y','u','i','o','p'],['a','s','d','f','g','h','j','k','l'],['z','x','c','v','b','n','m','(',')'],['=',' ']],
    sym: [['#','&','Â¬','â‰ˆ','â‰ ','âˆ'],['â‰¤','â‰¥','âˆˆ','âˆ‰','â‡’','â‡”'],['âŠ‚','âŠ†','âŠ„','âŠ‡','|','â€–'],['=',' ']]
  };
  const keyboardRows = document.getElementById("keyboard-rows");

  function insertFromKey(label){
    let insertText;
    if (label === ' ') insertText = ' ';
    else if (label === 'xÂ²') insertText = 'x^2';
    else if (label === 'xâ¿') insertText = 'x^';
    else if (label === 'a/b') insertText = '/';
    else if (label === 'ln') insertText = '\\ln(';
    else if (label === 'logâ‚â‚€') insertText = '\\log_{10}(';
    else if (label === 'logâ‚bâ‚') insertText = '\\log_{b}(';
    else if (label === 'âˆš') insertText = 'âˆš( )';
    else if (label === 'â¿âˆš') insertText = '3âˆš( )';
    else if (label === 'Ï€âˆ«') insertText = 'V = Ï€âˆ«_{a}^{b} f(x)^2 dx';
    else insertText = label;

    insertAtCursor(mathInput, insertText);
    updateMathPreview();
  }
  function loadKeyboard(name){
    keyboardRows.innerHTML = "";
    keyboardLayouts[name].forEach(row => {
      const wrap = document.createElement("div");
      row.forEach(label => {
        const b = document.createElement("button");
        b.className = "key"; b.type = "button";
        b.textContent = label === " " ? "ÎºÎµÎ½ÏŒ" : label;
        b.onclick = () => insertFromKey(label);
        wrap.appendChild(b);
      });
      keyboardRows.appendChild(wrap);
    });
  }
  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      loadKeyboard(btn.dataset.layout);
    });
  });
  loadKeyboard("num");

  /* ===================== MATH PREVIEW ===================== */
  const mathPreview = document.getElementById("math-preview");
  const mathPreviewPlaceholder = document.getElementById("math-preview-placeholder");

  function isProbablyLatex(s){ return /\\(frac|sqrt|int|sum|begin|pi|cdot|left|right|det)/.test(s || ""); }

  function convertToLatex(text){
    let t = (text || "").trim();
    if (!t) return "";
    const alreadyLatex = isProbablyLatex(t);

    t = t.replace(/âˆ’/g,'-').replace(/Ã·/g,'/').replace(/Ã—/g,'*');
    t = t.replace(/([0-9a-zA-Z\)\}])\s*:\s*([0-9a-zA-Z\\(\{])/g, '$1/$2');

    if (!alreadyLatex){
      t = t.replace(/Ï€/g,'\\pi ');
      t = t.replace(/âˆ«/g,'\\int ');
      t = t.replace(/\s*dx\b/g,'\\, dx');

      t = t.replace(/(\d+)\s*âˆš\s*\(([^)]*)\)/g,'\\sqrt[$1]{$2}');
      t = t.replace(/(\d+)\s*âˆš\s*([a-zA-Z0-9]+)/g,'\\sqrt[$1]{$2}');
      t = t.replace(/âˆš\s*\(([^)]*)\)/g,'\\sqrt{$1}');
      t = t.replace(/âˆš\s*([a-zA-Z0-9]+)/g,'\\sqrt{$1}');
      t = t.replace(/sqrt\s*\(([^)]*)\)/gi,'\\sqrt{$1}');

      t = t.replace(/([0-9a-zA-Z\\]+)\s*\^\s*\(([^)]+)\)/g,'$1^{ $2 }');
      t = t.replace(/([a-zA-Z0-9])\^(\d+)/g,'$1^{ $2 }');

      t = t.replace(/\(([^()]+)\)\s*\/\s*\(([^()]+)\)/g,'\\frac{$1}{$2}');
      t = t.replace(/([0-9a-zA-Z]+)\s*\/\s*\(([^()]+)\)/g,'\\frac{$1}{$2}');
      t = t.replace(/([0-9a-zA-Z])\s*\/\s*([0-9a-zA-Z])(?!\s*\^)/g,'\\frac{$1}{$2}');
    }
    t = t.replace(/\*/g,'\\cdot ');
    return t;
  }

  async function renderMathIn(el){
    if (window.MathJax && MathJax.typesetPromise){
      try { await MathJax.typesetPromise([el]); } catch(e){}
    }
  }

  async function updateMathPreview(){
    const raw = mathInput.value;
    if (!raw.trim()){
      mathPreview.innerHTML = "";
      mathPreviewPlaceholder.style.display = "inline";
      return;
    }
    mathPreviewPlaceholder.style.display = "none";
    const latex = convertToLatex(raw);
    mathPreview.innerHTML = `\\(${latex}\\)`;
    await renderMathIn(mathPreview);
  }
  mathInput.addEventListener("input", updateMathPreview);

  /* ===================== AI / ASK / CONTINUE ===================== */
  const answerEl = document.getElementById("ai-answer");
  const statusEl = document.getElementById("status");
  const setStatus = (t="") => statusEl.textContent = t;

  const continueBox = document.getElementById("continue-box");
  const continueYes = document.getElementById("continue-yes");
  const continueNo  = document.getElementById("continue-no");
  const continueStatus = document.getElementById("continue-status");

  let lastPromptSent = "";
  let lastAnswerText = "";

  function showContinueBox(show){
    continueBox.style.display = show ? "block" : "none";
    continueStatus.textContent = "";
    continueYes.disabled = false;
    continueNo.disabled = false;
  }

  async function renderAnswer(text){
    const t = (text || "");
    lastAnswerText = t;
    answerEl.innerHTML = t.replace(/\n/g,"<br>");
    await renderMathIn(answerEl);
    showContinueBox(true);

    if (!isAnswerVisible()) showToast();

    // âœ… auto-save last answer (localStorage)
    try{
      localStorage.setItem("mathAI:lastAnswer", t);
      localStorage.setItem("mathAI:lastAnswerAt", new Date().toISOString());
      updateSavedInfo();
    }catch(e){}
  }

  async function askAI(prompt){
    setStatus("Î¤Î¿ AI ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹â€¦");
    answerEl.innerHTML = "Î¤Î¿ AI ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹â€¦";
    await renderMathIn(answerEl);
    showContinueBox(false);

    try{
      const res = await fetch(`${BASE_URL}/ask`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ prompt })
      });
      const data = await res.json();
      const ans = data.answer || data.message || JSON.stringify(data, null, 2) || "Î”ÎµÎ½ Î®ÏÎ¸Îµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.";
      await renderAnswer(ans);
    }catch(e){
      await renderAnswer("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server (/ask).");
    }
    setStatus("");
  }

  document.getElementById("ask-btn").addEventListener("click", async () => {
    hideToast();
    const math = mathInput.value.trim();
    const text = textInput.value.trim();

    let bodyParts = [];
    if (math) bodyParts.push("ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® Î­ÎºÏ†ÏÎ±ÏƒÎ·:\n" + math);
    if (text) bodyParts.push("Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±:\n" + text);
    const mainPrompt = bodyParts.join("\n\n") || "Î›ÏÏƒÎµ Ï„Î¿ 1+1.";

    const levelPrefix = currentLevel === "lyceum"
      ? "ÎÎ± Î»Ï…Î¸ÎµÎ¯ Î¼Îµ Î¼Î±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ¬ ÎµÏ€Î¹Ï€Î­Î´Î¿Ï… Î›Ï…ÎºÎµÎ¯Î¿Ï…. Î‘Ï€ÏŒÏ†Ï…Î³Îµ Ï€Î±Î½ÎµÏ€Î¹ÏƒÏ„Î·Î¼Î¹Î±ÎºÎ­Ï‚ Î¼ÎµÎ¸ÏŒÎ´Î¿Ï…Ï‚.\n\n"
      : "ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ­Ï‚ Ï€Î±Î½ÎµÏ€Î¹ÏƒÏ„Î·Î¼Î¹Î±ÎºÎ¿Ï ÎµÏ€Î¹Ï€Î­Î´Î¿Ï….\n\n";

    lastPromptSent = levelPrefix + mainPrompt;
    await askAI(lastPromptSent);
  });

  document.getElementById("clear-btn").addEventListener("click", async () => {
    hideToast();
    mathInput.value = "";
    textInput.value = "";
    answerEl.innerHTML = "ÎˆÏ„Î¿Î¹Î¼Î¿Ï‚/Î·. Î“ÏÎ¬ÏˆÎµ Î½Î­Î± ÎµÏÏÏ„Î·ÏƒÎ·â€¦";
    await renderMathIn(answerEl);
    showContinueBox(false);
    updateMathPreview();
  });

  continueYes.addEventListener("click", async () => {
    hideToast();
    continueYes.disabled = true;
    continueNo.disabled = true;
    continueStatus.textContent = "Î£Ï…Î½ÎµÏ‡Î¯Î¶Ï‰â€¦";

    const followUp =
      "Î£Ï…Î½Î­Ï‡Î¹ÏƒÎµ Ï„Î·Î½ ÎµÎ¾Î®Î³Î·ÏƒÎ·/Î»ÏÏƒÎ· Î±Ï€ÏŒ Ï„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿ Ï€Î¿Ï… Î­Î¼ÎµÎ¹Î½ÎµÏ‚. " +
      "Î”ÏÏƒÎµ Ï„Î± ÎµÏ€ÏŒÎ¼ÎµÎ½Î± Î²Î®Î¼Î±Ï„Î±, Ï€Î¹Î¿ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬, Î¼Îµ ÎºÎ±Î¸Î±ÏÎ® Î´Î¿Î¼Î®.\n\n" +
      "Î Î¡ÎŸÎ—Î“ÎŸÎ¥ÎœÎ•ÎÎŸ PROMPT:\n" + (lastPromptSent || "(ÎºÎµÎ½ÏŒ)") + "\n\n" +
      "Î Î¡ÎŸÎ—Î“ÎŸÎ¥ÎœÎ•ÎÎ— Î‘Î Î‘ÎÎ¤Î—Î£Î—:\n" + (lastAnswerText || "(ÎºÎµÎ½ÏŒ)");

    lastPromptSent = followUp;
    await askAI(followUp);
  });

  continueNo.addEventListener("click", () => {
    continueStatus.textContent = "ÎŸÎš â€” Î´ÎµÎ½ ÏƒÏ…Î½ÎµÏ‡Î¯Î¶Ï‰.";
    setTimeout(() => showContinueBox(false), 800);
  });

  /* ===================== âœ… SAVE / EXPORT / PRINT ===================== */
  const saveBtn = document.getElementById("save-answer-btn");
  const downloadBtn = document.getElementById("download-answer-btn");
  const printBtn = document.getElementById("print-answer-btn");
  const savedInfo = document.getElementById("saved-info");

  function getAnswerTextClean(){
    // Ï€Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ text ÏŒÏ€Ï‰Ï‚ Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ (Ï‡Ï‰ÏÎ¯Ï‚ <br>)
    const t = (answerEl?.innerText || "").replace(/\n{3,}/g, "\n\n").trim();
    return t || "â€”";
  }

  function updateSavedInfo(){
    try{
      const at = localStorage.getItem("mathAI:lastAnswerAt");
      const txt = localStorage.getItem("mathAI:lastAnswer") || "";
      if(!at || !txt.trim()){
        savedInfo.textContent = "Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.";
        return;
      }
      const d = new Date(at);
      savedInfo.textContent = `Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ: ${d.toLocaleString()}`;
    }catch(e){
      savedInfo.textContent = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·: Î¼Î· Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î·.";
    }
  }

  function saveAnswerNow(){
    const t = getAnswerTextClean();
    try{
      localStorage.setItem("mathAI:lastAnswer", t);
      localStorage.setItem("mathAI:lastAnswerAt", new Date().toISOString());
      updateSavedInfo();
      alert("âœ… Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ (ÏƒÏ„Î¿Î½ browser).");
    }catch(e){
      alert("âŒ Î”ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ± Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÏ‰ (Î¯ÏƒÏ‰Ï‚ private mode).");
    }
  }

  function downloadAnswerTxt(){
    const t = getAnswerTextClean();
    const when = new Date();
    const filename = `AI_answer_${when.getFullYear()}-${String(when.getMonth()+1).padStart(2,"0")}-${String(when.getDate()).padStart(2,"0")}_${String(when.getHours()).padStart(2,"0")}${String(when.getMinutes()).padStart(2,"0")}.txt`;

    const blob = new Blob([t], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 400);
  }

  // âœ… ÎŒÎ¼Î¿ÏÏ†Î¿ print ÏƒÎµ Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„ÏŒ â€œprint pageâ€
  function printAnswerNice(){
    const text = getAnswerTextClean();
    const when = new Date().toLocaleString();

    const w = window.open("", "_blank", "width=950,height=720");
    if (!w) {
      alert("ÎŸ browser Î¼Ï€Î»ÏŒÎºÎ±ÏÎµ Ï„Î¿ popup Î³Î¹Î± ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·. Î•Ï€Î¯Ï„ÏÎµÏˆÎµ popups ÎºÎ±Î¹ Î¾Î±Î½Î¬.");
      return;
    }

    const esc = (s) => String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    w.document.open();
    w.document.write(`
<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· â€” Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· AI</title>
  <style>
    @page { margin: 12mm; }
    html, body { height: auto; }
    body {
      font-family: system-ui,-apple-system,"Segoe UI",sans-serif;
      margin: 0;
      color:#111827;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 0;
    }
    h1{
      margin: 0 0 6px 0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .meta{
      color:#6b7280;
      font-size: 12px;
      margin-bottom: 10px;
    }
    .box{
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px 14px;
      background: #fff;
    }
    .content{
      white-space: pre-wrap;
      word-break: normal;
      overflow-wrap: anywhere;
      font-size: 12.5px;
      line-height: 1.55;
      font-family: ui-monospace, Menlo, Consolas, "JetBrains Mono", monospace;
    }
    @media print{
      .wrap{ max-width: none; }
      .box{ border-color:#d1d5db; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI â€” Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·</h1>
    <div class="meta">${esc(when)}</div>
    <div class="box">
      <div class="content">${esc(text)}</div>
    </div>
    <div class="meta" style="margin-top:10px">
      Tip: Î£Ï„Î¿ Chrome ÎºÎ»ÎµÎ¯ÏƒÎµ â€œHeaders and footersâ€ Î³Î¹Î± Î½Î± Ï†ÏÎ³Î¿Ï…Î½ Î±ÏÎ¹Î¸Î¼Î¿Î¯/URLs.
    </div>
  </div>
  <script>
    window.onload = () => {
      window.focus();
      window.print();
      setTimeout(() => window.close(), 400);
    };
  <\/script>
</body>
</html>
    `);
    w.document.close();
  }

  saveBtn.addEventListener("click", saveAnswerNow);
  downloadBtn.addEventListener("click", downloadAnswerTxt);
  printBtn.addEventListener("click", printAnswerNice);

  /* ===================== PHOTO CHECK ===================== */
  const imgInput = document.getElementById("image-input");
  const imgPreview = document.getElementById("img-preview");
  const checkBtn = document.getElementById("check-image-btn");
  const removeBtn = document.getElementById("remove-img-btn");

  function resetImageUI(){
    imgPreview.removeAttribute("src");
    checkBtn.disabled = true;
    removeBtn.disabled = true;
  }

  imgInput.addEventListener("change", () => {
    const file = imgInput.files && imgInput.files[0];
    if(!file){ resetImageUI(); return; }
    const url = URL.createObjectURL(file);
    imgPreview.src = url;
    checkBtn.disabled = false;
    removeBtn.disabled = false;
  });

  removeBtn.addEventListener("click", () => {
    imgInput.value = "";
    resetImageUI();
  });

  checkBtn.addEventListener("click", async () => {
    hideToast();
    const file = imgInput.files && imgInput.files[0];
    if (!file) { await renderAnswer("Î”ÎµÎ½ ÎµÏ€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±."); return; }

    setStatus("Î¤Î¿ AI Î±Î½Î±Î»ÏÎµÎ¹ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±â€¦");
    answerEl.innerHTML = "Î¤Î¿ AI Î±Î½Î±Î»ÏÎµÎ¹ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±â€¦";
    await renderMathIn(answerEl);
    showContinueBox(false);

    const formData = new FormData();
    formData.append("image", file);
    formData.append("question", textInput.value.trim());
    formData.append("level", currentLevel);

    try{
      const res = await fetch(`${BASE_URL}/check-image`, { method:"POST", body: formData });
      const data = await res.json();
      await renderAnswer(data.answer || "Î”ÎµÎ½ Î®ÏÎ¸Îµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î±Ï€ÏŒ Ï„Î¿Î½ server.");
    }catch(e){
      await renderAnswer("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server (/check-image).");
    }
    setStatus("");
  });

  /* ===================== TOOL TABS ===================== */
  const toolTabs = document.querySelectorAll(".tool-tab");
  const toolPanels = {
    matrix: document.getElementById("tool-matrix"),
    series: document.getElementById("tool-series"),
    stats: document.getElementById("tool-stats")
  };
  toolTabs.forEach(t => {
    t.addEventListener("click", () => {
      toolTabs.forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      Object.values(toolPanels).forEach(p => p.classList.remove("active"));
      toolPanels[t.dataset.tool].classList.add("active");
    });
  });

  /* ===================== MATRICES ===================== */
  const matrixRaw = document.getElementById("matrix-raw");
  const matrixPreview = document.getElementById("matrix-preview");
  let lastMatrixLatex = "";

  function parseMatrix(raw){
    const txt = (raw || "").trim();
    if (!txt) return null;
    const normalized = txt.replace(/\n+/g, ';');
    const rows = normalized.split(';').map(r => r.trim()).filter(Boolean);
    if (!rows.length) return null;
    const data = rows.map(r => r.split(',').map(c => c.trim()).filter(Boolean));
    const cols = data[0]?.length || 0;
    if (!cols) return null;
    return data;
  }
  function matrixToLatex(mat){
    const rows = mat.map(row => row.join(' & ')).join(' \\\\ ');
    return `\\begin{bmatrix} ${rows} \\end{bmatrix}`;
  }
  async function updateMatrixPreview(){
    const mat = parseMatrix(matrixRaw.value);
    if (!mat){ matrixPreview.innerHTML = ""; return; }
    const latex = matrixToLatex(mat);
    matrixPreview.innerHTML = `\\(${latex}\\)`;
    await renderMathIn(matrixPreview);
  }
  matrixRaw.addEventListener("input", updateMatrixPreview);

  function pushMatrixContext(matLatex, raw){
    lastMatrixLatex = matLatex || lastMatrixLatex;
    appendToTextContext(
      `${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\n` +
      `Î Î¯Î½Î±ÎºÎ±Ï‚ A (raw): ${raw}\n` +
      `Î Î¯Î½Î±ÎºÎ±Ï‚ A (LaTeX): ${matLatex}\n`
    );
  }
  function ensureMatrixInContext(){
    if (!lastMatrixLatex){
      appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nâš ï¸ Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¿ÏÎ¹ÏƒÏ„ÎµÎ¯ Ï€Î¯Î½Î±ÎºÎ±Ï‚ A. Î’Î¬Î»Îµ Ï€ÏÏÏ„Î± Ï€Î¯Î½Î±ÎºÎ± ÎºÎ±Î¹ Ï€Î¬Ï„Î·ÏƒÎµ â€œÎ’Î¬Î»Îµ Ï„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±â€.`);
      return false;
    }
    return true;
  }
  function diagonalizationChecklist(){
    const A = lastMatrixLatex || "A";
    return (
      `${addToolHeader("Î”Î™Î‘Î“Î©ÎÎŸÎ ÎŸÎ™Î—Î£Î— (Î£ÏÎ½Î¿ÏˆÎ·)")}\n` +
      `Î”Î¯Î½ÎµÏ„Î±Î¹ Î¿ Ï€Î¯Î½Î±ÎºÎ±Ï‚ A = ${A}\n\n` +
      `ğŸ‘‰ Î¤Ï…Ï€Î¹ÎºÎ® ÏƒÎµÎ¹ÏÎ¬:\n` +
      `1) Î™Î´Î¹Î¿Ï„Î¹Î¼Î­Ï‚ (det(A-\\lambda I)=0)\n` +
      `2) Î™Î´Î¹Î¿Î´Î¹Î±Î½ÏÏƒÎ¼Î±Ï„Î± ((A-\\lambda I)v=0)\n` +
      `3) ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹Î±Î³Ï‰Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚\n` +
      `4) P, D (Î¯Î´Î¹Î± ÏƒÎµÎ¹ÏÎ¬)\n` +
      `5) ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: A=PDP^{-1}\n\n` +
      `ÎœÎµÏ„Î¬: A^n, e^A, Î´Ï…Î½Î±Î¼Î¹ÎºÎ¬, Î”.Î•.\n`
    );
  }

  document.getElementById("matrix-insert-btn").addEventListener("click", async () => {
    const mat = parseMatrix(matrixRaw.value);
    if (!mat){ await renderAnswer("Î”ÏÏƒÎµ Ï€ÏÏÏ„Î± Î­Î½Î±Î½ Ï€Î¯Î½Î±ÎºÎ± Ï€.Ï‡. 1,2;3,4"); return; }
    const latex = matrixToLatex(mat);
    lastMatrixLatex = latex;
    insertAtCursor(mathInput, latex);
    updateMathPreview();
    pushMatrixContext(latex, matrixRaw.value.trim());
    textInput.focus();
  });
  document.getElementById("matrix-to-text-btn").addEventListener("click", () => {
    const mat = parseMatrix(matrixRaw.value);
    if (!mat) return;
    const latex = matrixToLatex(mat);
    lastMatrixLatex = latex;
    pushMatrixContext(latex, matrixRaw.value.trim());
    textInput.focus();
  });
  document.getElementById("matrix-clear-btn").addEventListener("click", () => {
    matrixRaw.value = "";
    matrixPreview.innerHTML = "";
    lastMatrixLatex = "";
  });

  document.getElementById("matrix-det-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ–Î·Ï„Î¿ÏÎ¼ÎµÎ½Î¿: Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ det(A) Î¼Îµ Î²Î®Î¼Î±Ï„Î±.`); textInput.focus(); });
  document.getElementById("matrix-inv-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ–Î·Ï„Î¿ÏÎ¼ÎµÎ½Î¿: Î’ÏÎµÏ‚ A^{-1} (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹).`); textInput.focus(); });
  document.getElementById("matrix-solve-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ–Î·Ï„Î¿ÏÎ¼ÎµÎ½Î¿: Î›ÏÏƒÎµ Ax=b.`); textInput.focus(); });

  document.getElementById("eigvals-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ’ÏÎµÏ‚ Î¹Î´Î¹Î¿Ï„Î¹Î¼Î­Ï‚.`); textInput.focus(); });
  document.getElementById("eigvecs-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ’ÏÎµÏ‚ Î¹Î´Î¹Î¿Î´Î¹Î±Î½ÏÏƒÎ¼Î±Ï„Î±.`); textInput.focus(); });
  document.getElementById("diag-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎˆÎ»ÎµÎ³Î¾Îµ Î±Î½ Î´Î¹Î±Î³Ï‰Î½Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹.`); textInput.focus(); });
  document.getElementById("pd-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ¦Ï„Î¹Î¬Î¾Îµ P, D (Î¯Î´Î¹Î± ÏƒÎµÎ¹ÏÎ¬).`); textInput.focus(); });
  document.getElementById("verify-pdp-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎˆÎ»ÎµÎ³Î¾Îµ A=PDP^{-1}.`); textInput.focus(); });
  document.getElementById("an-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ A^n.`); textInput.focus(); });
  document.getElementById("eA-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ e^A.`); textInput.focus(); });
  document.getElementById("dynsys-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î•Î¦Î‘Î¡ÎœÎŸÎ“Î—")}\nx_{k+1}=Ax_k Î¼Îµ A=${lastMatrixLatex}.`); textInput.focus(); });
  document.getElementById("ode-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î•Î¦Î‘Î¡ÎœÎŸÎ“Î—")}\nx'(t)=Ax(t) Î¼Îµ A=${lastMatrixLatex}.`); textInput.focus(); });
  document.getElementById("exam-summary-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(diagonalizationChecklist()); textInput.focus(); });

  /* ===================== SERIES ===================== */
  const seriesFrom = document.getElementById("series-from");
  const seriesTo = document.getElementById("series-to");

  function seriesLatexFromTerm(term){
    const from = (seriesFrom.value || "").trim() || "1";
    let to = (seriesTo.value || "").trim() || "\\infty";
    if (to === "âˆ") to = "\\infty";
    const t = (term || "").trim() || "a_n";
    return `\\sum_{n=${from}}^{${to}} ${t}`;
  }
  function pushSeriesContext(latex){
    appendToTextContext(`${addToolHeader("Î£Î•Î™Î¡Î•Î£")}\nÎ£ÎµÎ¹ÏÎ¬: ${latex}\nÎ•ÏÏÏ„Î·ÏƒÎ·: Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î±/ÏƒÏÎ³ÎºÎ»Î¹ÏƒÎ·/ÎºÏÎ¹Ï„Î®ÏÎ¹Î¿/Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±.`);
  }
  document.getElementById("series-wrap-btn").addEventListener("click", () => {
    const selected = getSelectionText(mathInput).trim();
    const latex = seriesLatexFromTerm(selected || "a_n");
    if (selected) replaceSelection(mathInput, latex); else insertAtCursor(mathInput, latex);
    updateMathPreview();
    pushSeriesContext(latex);
    textInput.focus();
  });
  document.getElementById("series-clear-btn").addEventListener("click", () => { seriesFrom.value=""; seriesTo.value=""; });
  document.getElementById("series-to-text-btn").addEventListener("click", () => {
    const selected = getSelectionText(mathInput).trim();
    pushSeriesContext(seriesLatexFromTerm(selected || "a_n"));
    textInput.focus();
  });
  document.getElementById("series-geo-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î£Î•Î™Î¡Î•Î£")}\nÎ˜Î­Î»Ï‰ Î³ÎµÏ‰Î¼ÎµÏ„ÏÎ¹ÎºÎ® ÏƒÎµÎ¹ÏÎ¬: ÏƒÏÎ³ÎºÎ»Î¹ÏƒÎ·, Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î±, Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±.`); textInput.focus(); });
  document.getElementById("series-taylor-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î£Î•Î™Î¡Î•Î£")}\nÎ˜Î­Î»Ï‰ ÏƒÎµÎ¹ÏÎ¬ Taylor: Ï„ÏÏ€Î¿Ï‚, Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±, Ï€ÎµÏÎ¹Î¿Ï‡Î® ÏƒÏÎ³ÎºÎ»Î¹ÏƒÎ·Ï‚.`); textInput.focus(); });
  document.getElementById("series-test-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î£Î•Î™Î¡Î•Î£")}\nÎ”Î¹Î¬Î»ÎµÎ¾Îµ ÎºÎ±Ï„Î¬Î»Î»Î·Î»Î¿ ÎºÏÎ¹Ï„Î®ÏÎ¹Î¿ ÏƒÏÎ³ÎºÎ»Î¹ÏƒÎ·Ï‚ ÎºÎ±Î¹ Î´ÎµÎ¯Î¾Îµ Î²Î®Î¼Î±Ï„Î±.`); textInput.focus(); });

  /* ===================== STATS ===================== */
  const statsData = document.getElementById("stats-data");
  const statsResults = document.getElementById("stats-results");

  function parseNumbers(raw){
    const txt=(raw||"").replace(/\n/g,' ').replace(/;/g,' ').replace(/,/g,' ').trim();
    if(!txt) return [];
    const parts=txt.split(/\s+/).filter(Boolean);
    const nums=[];
    for(const p of parts){
      const v=Number(p.replace(',', '.'));
      if(Number.isFinite(v)) nums.push(v);
    }
    return nums;
  }
  function mean(arr){return arr.reduce((a,b)=>a+b,0)/arr.length}
  function median(arr){
    const a=[...arr].sort((x,y)=>x-y), n=a.length;
    return (n%2===1)?a[(n-1)/2]:(a[n/2-1]+a[n/2])/2;
  }
  function mode(arr){
    const m=new Map(); for(const x of arr) m.set(x,(m.get(x)||0)+1);
    let best=[], bestCount=0;
    for(const [k,c] of m.entries()){
      if(c>bestCount){bestCount=c; best=[k]}
      else if(c===bestCount){best.push(k)}
    }
    if(bestCount<=1) return [];
    return best.sort((a,b)=>a-b);
  }
  function variance(arr,sample=true){
    const mu=mean(arr), n=arr.length;
    const s=arr.reduce((acc,x)=>acc+(x-mu)*(x-mu),0);
    return sample?s/(n-1):s/n;
  }
  function fmt(x){
    if(!Number.isFinite(x)) return String(x);
    const abs=Math.abs(x);
    if(abs>=1000 || abs<0.001) return x.toExponential(4);
    return x.toFixed(4).replace(/\.?0+$/,'');
  }
  function statsSummary(nums){
    const n=nums.length, mu=mean(nums), med=median(nums), mo=mode(nums);
    const varP=variance(nums,false), sdP=Math.sqrt(varP);
    const varS=(n>=2)?variance(nums,true):NaN, sdS=(n>=2)?Math.sqrt(varS):NaN;
    const a=[...nums].sort((x,y)=>x-y);
    return {n,mu,med,mo,varP,sdP,varS,sdS,min:a[0],max:a[a.length-1],range:a[a.length-1]-a[0]};
  }
  function renderStatsBox(s){
    const lines=[];
    lines.push(`n = ${s.n}`);
    lines.push(`min = ${fmt(s.min)}, max = ${fmt(s.max)}, range = ${fmt(s.range)}`);
    lines.push(`Î¼Î­ÏƒÎ· Ï„Î¹Î¼Î® (xÌ„) = ${fmt(s.mu)}`);
    lines.push(`Î´Î¹Î¬Î¼ÎµÏƒÎ¿Ï‚ = ${fmt(s.med)}`);
    lines.push(`ÎµÏ€Î¹ÎºÏÎ±Ï„Î¿ÏÏƒÎ± = ${s.mo.length ? s.mo.map(fmt).join(', ') : 'â€”'}`);
    lines.push(`ÏƒÂ² (Ï€Î»Î·Î¸.) = ${fmt(s.varP)}   |   Ïƒ = ${fmt(s.sdP)}`);
    if(s.n>=2){ lines.push(`sÂ² (Î´ÎµÎ¯Î³Î¼Î±) = ${fmt(s.varS)} |   s = ${fmt(s.sdS)}`); }
    return lines.join("\n");
  }
  document.getElementById("stats-calc-btn").addEventListener("click", () => {
    const nums=parseNumbers(statsData.value);
    if(!nums.length){statsResults.textContent="Î”ÏÏƒÎµ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€ÏÏÏ„Î±.";return;}
    statsResults.textContent=renderStatsBox(statsSummary(nums));
  });
  document.getElementById("stats-insert-btn").addEventListener("click", () => {
    const nums=parseNumbers(statsData.value);
    if(!nums.length){statsResults.textContent="Î”ÏÏƒÎµ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€ÏÏÏ„Î±.";return;}
    const s=statsSummary(nums);
    appendToTextContext(`${addToolHeader("Î£Î¤Î‘Î¤Î™Î£Î¤Î™ÎšÎ—")}\nÎ”ÎµÎ´Î¿Î¼Î­Î½Î±: ${nums.join(", ")}\nÎ£ÏÎ½Î¿ÏˆÎ·:\n${renderStatsBox(s)}\n`);
    textInput.focus();
  });
  document.getElementById("stats-clear-btn").addEventListener("click", () => { statsData.value=""; statsResults.textContent=""; });
  document.getElementById("stats-ci-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î£Î¤Î‘Î¤Î™Î£Î¤Î™ÎšÎ—")}\nTemplate Î”Î¹Î¬ÏƒÏ„Î·Î¼Î± Î•Î¼Ï€Î¹ÏƒÏ„Î¿ÏƒÏÎ½Î·Ï‚: Î´ÏÏƒÎµ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ (Ï€.Ï‡. 95%), n, Ïƒ Î³Î½Ï‰ÏƒÏ„Î®/Î¬Î³Î½Ï‰ÏƒÏ„Î·.`); textInput.focus(); });
  document.getElementById("stats-z-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î£Î¤Î‘Î¤Î™Î£Î¤Î™ÎšÎ—")}\nTemplate z-score: z=(x-Î¼)/Ïƒ ÎºÎ±Î¹ ÎµÏÎ¼Î·Î½ÎµÎ¯Î±.`); textInput.focus(); });
  document.getElementById("stats-test-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î£Î¤Î‘Î¤Î™Î£Î¤Î™ÎšÎ—")}\nTemplate ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¥Ï€ÏŒÎ¸ÎµÏƒÎ·Ï‚: H0/H1, Î±, ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏŒ (z Î® t), ÏƒÏ…Î¼Ï€Î­ÏÎ±ÏƒÎ¼Î±.`); textInput.focus(); });

  /* ===================== INK (ROBUST) ===================== */
  (function(){
    function $(id){ return document.getElementById(id); }

    function openInk(){
      const bd = $("ink-backdrop");
      if(!bd){ alert("Î›ÎµÎ¯Ï€ÎµÎ¹ Ï„Î¿ ink-backdrop Î±Ï€ÏŒ Ï„Î¿ HTML."); return; }
      bd.classList.add("show");
      bd.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
      resizeInkCanvas();
      setInkStyle();
      setTimeout(() => $("ink-close")?.focus(), 30);
    }

    function closeInk(){
      const bd = $("ink-backdrop");
      if(!bd) return;
      bd.classList.remove("show");
      bd.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }

    let inkCtx = null;
    let drawing = false;
    let activePointerId = null;
    let lastX = 0, lastY = 0;

    function resizeInkCanvas(){
      const c = $("ink-canvas");
      if(!c) return;
      const wrap = c.closest(".ink-wrap");
      if(!wrap) return;

      const rect = wrap.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      c.width  = Math.max(1, Math.floor(rect.width  * dpr));
      c.height = Math.max(1, Math.floor(rect.height * dpr));

      c.style.width  = rect.width  + "px";
      c.style.height = rect.height + "px";

      inkCtx = c.getContext("2d");
      inkCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      inkCtx.lineCap = "round";
      inkCtx.lineJoin = "round";
    }

    function setInkStyle(){
      if(!inkCtx) return;
      const color = $("ink-color")?.value || "#111827";
      const size  = Number($("ink-size")?.value || 4);
      const valEl = $("ink-size-val");
      if(valEl) valEl.textContent = String(size);
      inkCtx.strokeStyle = color;
      inkCtx.lineWidth = size;
    }

    function getPos(ev){
      const c = $("ink-canvas");
      const r = c.getBoundingClientRect();
      return { x: ev.clientX - r.left, y: ev.clientY - r.top };
    }

    function startDraw(ev){
      const c = $("ink-canvas");
      if(!inkCtx) return;
      if(activePointerId !== null && ev.pointerId !== activePointerId) return;
      activePointerId = ev.pointerId;

      drawing = true;
      setInkStyle();

      const p = getPos(ev);
      lastX = p.x; lastY = p.y;

      try{ c.setPointerCapture(ev.pointerId); }catch(e){}
      ev.preventDefault();
    }

    function moveDraw(ev){
      if(!drawing || ev.pointerId !== activePointerId) return;
      if(!inkCtx) return;

      const p = getPos(ev);

      const pressure = (typeof ev.pressure === "number" && ev.pressure > 0) ? ev.pressure : 0.5;
      const base = Number($("ink-size")?.value || 4);
      inkCtx.lineWidth = base * (0.75 + pressure * 0.9);

      inkCtx.beginPath();
      inkCtx.moveTo(lastX, lastY);
      inkCtx.lineTo(p.x, p.y);
      inkCtx.stroke();

      lastX = p.x; lastY = p.y;
      ev.preventDefault();
    }

    function endDraw(ev){
      const c = $("ink-canvas");
      if(ev.pointerId !== activePointerId) return;
      drawing = false;
      try{ c.releasePointerCapture(ev.pointerId); }catch(e){}
      activePointerId = null;
      ev.preventDefault();
    }

    function clearInk(){
      const c = $("ink-canvas");
      if(!inkCtx || !c) return;
      inkCtx.save();
      inkCtx.setTransform(1,0,0,1,0,0);
      inkCtx.clearRect(0,0,c.width,c.height);
      inkCtx.restore();
    }

    async function canvasToBlob(){
      const c = $("ink-canvas");
      return await new Promise(resolve => c.toBlob(b => resolve(b), "image/png", 0.92));
    }

    async function sendInkToAI(mode){
      const blob = await canvasToBlob();
      if(!blob){ await renderAnswer("Î”ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ± Î½Î± Ï€Î¬ÏÏ‰ ÎµÎ¹ÎºÏŒÎ½Î± Î±Ï€ÏŒ Ï„Î¿Î½ ÎºÎ±Î¼Î²Î¬."); return; }

      const math = mathInput.value.trim();
      const text = textInput.value.trim();
      const inkExtra = ($("ink-question")?.value || "").trim();

      let userAsk = [];
      if (math) userAsk.push("ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® Î­ÎºÏ†ÏÎ±ÏƒÎ·:\n" + math);
      if (text) userAsk.push("Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±:\n" + text);
      if (inkExtra) userAsk.push("Î•Ï€Î¹Ï€Î»Î­Î¿Î½ Î±Ï€Î¿ÏÎ¯Î± Î³Î¹Î± Ï„Î¿ Î³ÏÎ±Î¼Î¼Î­Î½Î¿ Î²Î®Î¼Î±:\n" + inkExtra);

      const modeText = (mode === "hint")
        ? "Î–Î—Î¤ÎŸÎ¥ÎœÎ•ÎÎŸ: Î”ÏÏƒÎµ ÎœÎŸÎÎŸ hint/ÎºÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ· (ÏŒÏ‡Î¹ Ï€Î»Î®ÏÎ· Î»ÏÏƒÎ·). Î”ÏÏƒÎµ 1-3 Î¼Î¹ÎºÏÎ¬ hints ÎºÎ±Î¹ 1 ÎµÏÏÏ„Î·ÏƒÎ· Î³Î¹Î± Î½Î± ÏƒÎºÎµÏ†Ï„ÎµÎ¯ Î¿ Î¼Î±Î¸Î·Ï„Î®Ï‚."
        : "Î–Î—Î¤ÎŸÎ¥ÎœÎ•ÎÎŸ: ÎˆÎ»ÎµÎ³Î¾Îµ Ï„Î¿ Î“Î¡Î‘ÎœÎœÎ•ÎÎŸ Î²Î®Î¼Î±/Î»ÏÏƒÎ· ÏƒÏ„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±. Î ÎµÏ‚ Î±Î½ ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„ÏŒ, Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎµ Î»Î¬Î¸Î· ÎºÎ±Î¹ Î´ÎµÎ¯Î¾Îµ Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î²Î®Î¼Î±.";

      const questionForImage = (userAsk.join("\n\n") || " ") + "\n\n" + modeText;

      setStatus(mode === "hint" ? "Î¤Î¿ AI ÎµÏ„Î¿Î¹Î¼Î¬Î¶ÎµÎ¹ hintâ€¦" : "Î¤Î¿ AI ÎµÎ»Î­Î³Ï‡ÎµÎ¹ Ï„Î¿ Î²Î®Î¼Î±â€¦");
      answerEl.innerHTML = mode === "hint" ? "Î¤Î¿ AI ÎµÏ„Î¿Î¹Î¼Î¬Î¶ÎµÎ¹ hintâ€¦" : "Î¤Î¿ AI ÎµÎ»Î­Î³Ï‡ÎµÎ¹ Ï„Î¿ Î²Î®Î¼Î±â€¦";
      await renderMathIn(answerEl);
      showContinueBox(false);

      const formData = new FormData();
      formData.append("image", new File([blob], "ink.png", {type:"image/png"}));
      formData.append("question", questionForImage);
      formData.append("level", currentLevel);

      try{
        const res = await fetch(`${BASE_URL}/check-image`, { method:"POST", body: formData });
        const data = await res.json();
        await renderAnswer(data.answer || "Î”ÎµÎ½ Î®ÏÎ¸Îµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î±Ï€ÏŒ Ï„Î¿Î½ server.");
        if ($("ink-question")) $("ink-question").value = "";
        closeInk();
      }catch(e){
        await renderAnswer("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server (/check-image).");
      }
      setStatus("");
    }

    // Delegation clicks
    document.addEventListener("click", (e) => {
      if(e.target.closest("#open-ink-btn")) openInk();
      if(e.target.closest("#ink-close")) closeInk();

      const bd = $("ink-backdrop");
      if(bd && e.target === bd) closeInk();

      if(e.target.closest("#ink-clear")) clearInk();

      if(e.target.closest("#ink-send-to-text")){
        const q = ($("ink-question")?.value || "").trim();
        if(!q) return;
        const prefix = textInput.value.trim() ? "\n\n" : "";
        textInput.value = textInput.value.trim() + prefix + "Î‘Ï€Î¿ÏÎ¯Î± (Î±Ï€ÏŒ Î Î¯Î½Î±ÎºÎ± Î“ÏÎ±Ï†Î®Ï‚):\n" + q;
        if ($("ink-question")) $("ink-question").value = "";
        textInput.focus();
      }

      if(e.target.closest("#ink-hint")) sendInkToAI("hint");
      if(e.target.closest("#ink-check-step")) sendInkToAI("step");
    });

    document.addEventListener("input", (e) => {
      if(e.target && (e.target.id === "ink-size" || e.target.id === "ink-color")){
        setInkStyle();
      }
    });

    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        const bd = $("ink-backdrop");
        if(bd && bd.classList.contains("show")) closeInk();
      }
    });

    window.addEventListener("resize", () => {
      const bd = $("ink-backdrop");
      if(bd && bd.classList.contains("show")) resizeInkCanvas();
    }, {passive:true});

    function bindCanvas(){
      const c = $("ink-canvas");
      if(!c) return;
      c.addEventListener("pointerdown", startDraw, {passive:false});
      c.addEventListener("pointermove", moveDraw, {passive:false});
      c.addEventListener("pointerup", endDraw, {passive:false});
      c.addEventListener("pointercancel", endDraw, {passive:false});
      c.addEventListener("pointerleave", endDraw, {passive:false});
    }
    bindCanvas();
  })();

  /* ===================== INIT ===================== */
  resetImageUI();
  updateMathPreview();
  updateMatrixPreview();
  updateSavedInfo();

  // âœ… Tip ÏƒÏ„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· Î³Î¹Î± Chrome: Headers/Footers
  // (Î”ÎµÎ½ Î¼Ï€Î¿ÏÏ Î½Î± Ï„Î¿ Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÏ‰ Î±Ï€ÏŒ ÎºÏÎ´Î¹ÎºÎ± â€” ÎµÎ¯Î½Î±Î¹ ÏÏÎ¸Î¼Î¹ÏƒÎ· browser.)
</script>

</body>
</html>
