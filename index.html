<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="format-detection" content="telephone=no" />
  <title>Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI â€“ Î”Ï. ÎœÎ±ÏÎ¯Î½Î¿Ï‚ Î•Ï…ÏƒÏ„Î±Î¸Î¯Î¿Ï…</title>

  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:#f5f7fb;color:#111827;font-size:14px}
    main{width:100%;max-width:none;margin:0;padding:12px}

    h1{margin:4px 0 2px 0;font-size:1.2rem}
    .subtitle{margin:0 0 6px 0;font-size:.8rem;color:#4b5563}
    .edu-note-small{font-size:.75rem;color:#6b7280;margin-bottom:8px}

    .top-grid{display:grid;gap:10px}
    @media(min-width:980px){ .top-grid{grid-template-columns:1.35fr .65fr} }

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 8px 20px rgba(15,23,42,.05);padding:10px;margin-bottom:10px}
    label{font-weight:800;font-size:.9rem}
    .muted{color:#64748b;font-size:.78rem}

    textarea,input[type="text"],input[type="number"]{
      width:100%;padding:8px 10px;border-radius:10px;border:1px solid #d1d5db;
      font-family:"JetBrains Mono",ui-monospace,monospace;font-size:.9rem
    }
    textarea{min-height:70px}
    textarea:focus,input:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.12);outline:none}
    @media(max-width:650px){ textarea,input[type="text"],input[type="number"]{font-size:16px} }

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}

    .btn{border:0;border-radius:999px;padding:6px 10px;font-weight:800;cursor:pointer;font-size:.8rem;touch-action:manipulation;white-space:nowrap}
    .btn.primary{background:#2563eb;color:#fff}
    .btn.ghost{background:#eef2ff;color:#1e3a8a}
    .btn.dark{background:#111827;color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .divider{height:1px;background:#e5e7eb;margin:10px 0}

    #math-preview-box{margin-top:6px;border-radius:10px;border:1px dashed #cbd5e1;padding:6px 8px;background:#f9fafb;min-height:34px;font-size:.9rem;color:#0f172a}
    #math-preview-placeholder{color:#94a3b8;font-size:.75rem}

    .level-btn.active{background:#2563eb;color:#fff}

    .kbd{background:#eef2ff;border:1px solid #e5e7eb;border-radius:14px;padding:8px;margin-top:10px}
    .tabs{display:flex;gap:4px;flex-wrap:wrap}
    .tab{border:0;border-radius:999px;padding:4px 10px;background:#e5e7eb;cursor:pointer;font-weight:800;font-size:.75rem;touch-action:manipulation}
    .tab.active{background:#2563eb;color:#fff}
    .keys{margin-top:6px}
    .key{
      border:0;border-radius:9px;padding:6px 8px;background:#fff;margin:2px;cursor:pointer;
      font-family:"JetBrains Mono",ui-monospace,monospace;font-size:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.12);
      touch-action:manipulation
    }

    .imgwrap{display:grid;gap:8px;margin-top:6px}
    .preview{width:100%;max-height:280px;object-fit:contain;border-radius:12px;border:1px dashed #cbd5e1;background:#fff}

    .answer{
      white-space:pre-wrap;border:1px solid #e5e7eb;border-radius:12px;padding:10px;min-height:80px;background:#fafafa;font-size:.9rem;
      word-break: normal; overflow-wrap: anywhere;
    }
    #answer-card{scroll-margin-top:14px}

    .continue-box{margin-top:10px;border-top:1px solid #e5e7eb;padding-top:10px;display:none}
    .continue-q{font-weight:900;font-size:.85rem;margin-bottom:6px;color:#0f172a}

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:14px;z-index:9999;
      background:rgba(17,24,39,.92);color:#fff;padding:10px 14px;border-radius:999px;
      box-shadow:0 12px 28px rgba(0,0,0,.22);display:none;align-items:center;gap:10px;
      max-width:92vw;font-size:.85rem;backdrop-filter: blur(6px);
    }
    .toast .toast-btn{
      border:0;background:#2563eb;color:#fff;font-weight:900;border-radius:999px;padding:8px 12px;
      cursor:pointer;touch-action:manipulation;white-space:nowrap;
    }

    .tools-header{display:flex;gap:10px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    .tool-tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tool-tab{border:0;border-radius:999px;padding:8px 14px;background:#e5e7eb;cursor:pointer;font-weight:900;font-size:.82rem;touch-action:manipulation}
    .tool-tab.active{background:#111827;color:#fff}
    .tool-panel{display:none;margin-top:10px}
    .tool-panel.active{display:block}

    .mini-card{border:1px solid #e5e7eb;border-radius:14px;padding:10px;background:#fafafa;height:100%}
    .mini-title{font-weight:950;font-size:.86rem;margin-bottom:8px;color:#0f172a}
    .result-box{border:1px dashed #cbd5e1;border-radius:12px;padding:8px 10px;background:#fff;min-height:52px}
    .mono{font-family:"JetBrains Mono",ui-monospace,monospace}

    .matrix-wide{display:grid;gap:10px}
    @media(min-width:1100px){ .matrix-wide{grid-template-columns:1fr 1fr 1.25fr} }
    @media(min-width:820px) and (max-width:1099px){ .matrix-wide{grid-template-columns:1fr 1fr} }

    .two-col{display:grid;gap:10px}
    @media(min-width:920px){ .two-col{grid-template-columns:1.1fr .9fr} }

    .inline-inputs{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:end}

    @media(max-width:650px){
      .btn{padding:10px 14px;font-size:14px}
      .tool-tab{padding:10px 14px}
      .tab{padding:8px 12px}
      .key{padding:10px 10px}
      .toast{font-size:14px}
      .toast .toast-btn{padding:10px 14px}
    }

    .footer-note{font-size:.78rem;color:#4b5563;line-height:1.4}

    /* ===== Answer actions (RESTORED) ===== */
    .answer-actions{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .answer-actions .btn{padding:8px 12px;font-size:.8rem}
    .answer-actions .pill{
      font-size:.75rem; color:#64748b;
      border:1px solid #e5e7eb; background:#fff; padding:6px 10px; border-radius:999px;
    }

    /* Bigger + red thinking/status */
    .status-thinking{
      color:#dc2626 !important;
      font-weight:950;
      font-size:.92rem;
    }

    /* ===== Ink Modal ===== */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      z-index:10000;
      padding:12px;
      overflow:auto;
    }
    .modal-backdrop.show{display:block;}
    .modal{
      width:min(1200px, 96vw);
      margin:24px auto;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:18px;
      box-shadow:0 20px 50px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;background:#0f172a;color:#fff;
    }
    .modal-title{font-weight:950; font-size:.92rem;}
    .modal-close{
      border:0;background:rgba(255,255,255,.14);color:#fff;border-radius:999px;
      padding:8px 12px;cursor:pointer;font-weight:900;
    }
    .modal-body{padding:10px 12px;}

    .ink-controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:8px 10px;border:1px solid #e5e7eb;border-radius:14px;background:#fafafa;margin:8px 0 10px 0;
    }
    .ink-controls label{font-weight:900;font-size:.78rem;margin-right:6px}
    .ink-controls .ctrl{display:flex;align-items:center;gap:8px}
    .ink-controls input[type="range"]{width:170px}
    .ink-controls input[type="color"]{width:42px;height:30px;padding:0;border:0;background:transparent;cursor:pointer}
    .ink-controls .val{font-family:"JetBrains Mono",ui-monospace,monospace;font-size:.78rem;color:#334155;min-width:38px;text-align:left}

    .ink-split{display:grid;gap:12px;margin-top:10px}
    @media(min-width:980px){ .ink-split{ grid-template-columns:1fr 1fr; } }

    .ink-pane{
      border:1px solid #e5e7eb;
      border-radius:16px;
      background:#fafafa;
      padding:10px;
    }
    .ink-pane-title{
      font-weight:950;
      font-size:.88rem;
      color:#0f172a;
      margin-bottom:8px;
      display:flex; align-items:center; gap:8px;
    }

    .ink-wrap{
      border:1px dashed #cbd5e1;border-radius:14px;background:#fff;
      height:min(52vh, 520px);width:100%;overflow:hidden;position:relative;
      touch-action:none;
    }
    canvas.ink-canvas{
      width:100%;height:100%;display:block;background:#fff;
      cursor:crosshair;user-select:none;-webkit-user-select:none;touch-action:none;
    }

    .ink-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px}
    .ink-tip{font-size:.78rem;color:#475569;margin-top:8px}

    #ink-transfer-status{
      margin-top:8px;
      font-weight:950;
      font-size:1rem;
      color:#dc2626;
    }

    /* ====== EXAM GENERATOR (BETA) styles ====== */
    .exam-grid{display:grid;gap:10px}
    @media(min-width:980px){ .exam-grid{grid-template-columns:1fr 1fr} }

    .exam-cta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill-soft{display:inline-block;background:#eef2ff;color:#1e3a8a;border:1px solid #e5e7eb;padding:6px 10px;border-radius:999px;font-weight:900;font-size:.75rem}
    .danger{color:#b91c1c;font-weight:900}
    .ok{color:#065f46;font-weight:900}
    .exam-parts{display:grid;gap:10px;margin-top:10px}
    .part-row{border:1px solid #e5e7eb;border-radius:14px;padding:10px;background:#fff}
    .part-head{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
    .part-title{font-weight:950}
    .small{font-size:.78rem;color:#64748b}
    .inline3{display:grid;gap:8px;grid-template-columns:1fr 1fr 1fr;align-items:end}
    @media(max-width:760px){ .inline3{grid-template-columns:1fr} }

    .qpoints{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .qpoints input{width:92px}

    .badge{display:inline-block;border:1px solid #e5e7eb;background:#fafafa;border-radius:999px;padding:6px 10px;font-weight:900;font-size:.75rem}
    .bloom-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .tag{display:inline-block;background:#111827;color:#fff;border-radius:999px;padding:5px 10px;font-weight:900;font-size:.72rem}

    @media print{
      .toast, .kbd, .tool-tabs, .tools-header, .tool-panel, #open-ink-btn,
      #image-input, #check-image-btn, #remove-img-btn, #continue-box,
      .answer-actions, #status, .edu-note-small, .subtitle { display:none !important; }
      body{background:#fff}
      main{padding:0}
      .card{box-shadow:none;border:0;border-radius:0;margin:0;padding:0}
      #ai-answer{border:0;background:#fff;padding:0}
    }
  </style>
</head>

<body>
<main>
  <h1>Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI</h1>
  <p class="subtitle">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÏŒÏ‚: Î”Ï. ÎœÎ±ÏÎ¯Î½Î¿Ï‚ Î•Ï…ÏƒÏ„Î±Î¸Î¯Î¿Ï… â€“ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏŒÏ‚ (MSc) Î¼Îµ PhD ÏƒÏ„Î± Î Î±Î¹Î´Î±Î³Ï‰Î³Î¹ÎºÎ¬ / Î“Î½Ï‰ÏƒÏ„Î¹ÎºÎ® Î¨Ï…Ï‡Î¿Î»Î¿Î³Î¯Î±</p>
  <p class="edu-note-small">Î¤Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Î±Ï…Ï„ÏŒ Î­Ï‡ÎµÎ¹ Î±Î½Î±Ï€Ï„Ï…Ï‡Î¸ÎµÎ¯ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ Î³Î¹Î± ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿ÏÏ‚ ÏƒÎºÎ¿Ï€Î¿ÏÏ‚.</p>

  <!-- ===== TOP INPUTS ===== -->
  <div class="top-grid">
    <div class="card">
      <label for="math-input">ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® Î­ÎºÏ†ÏÎ±ÏƒÎ·</label>
      <textarea id="math-input" placeholder="Ï€.Ï‡. âˆ« x/(x+1) dx, ..."></textarea>

      <div id="math-preview-box">
        <span id="math-preview-placeholder">Î— Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ ÎµÎ´Ï ÎºÎ±Î¸ÏÏ‚ Î³ÏÎ¬Ï†ÎµÎ¹Ï‚â€¦</span>
        <div id="math-preview"></div>
      </div>

      <div style="margin-top:10px">
        <label for="text-input">Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±</label>
        <textarea id="text-input" placeholder="Î¡ÏÏ„Î± ÎµÎ´Ï Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ (ÎºÎ±Î¹ Î³Î¹Î± Î Î¯Î½Î±ÎºÎµÏ‚/Î£ÎµÎ¹ÏÎ­Ï‚/Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®)."></textarea>

        <div class="row" style="margin-top:4px">
          <span class="muted"><b>Î•Ï€Î¯Ï€ÎµÎ´Î¿ Î»ÏÏƒÎ·Ï‚:</b></span>
          <button class="btn ghost level-btn active" data-level="lyceum" type="button">Î›ÏÎºÎµÎ¹Î¿</button>
          <button class="btn ghost level-btn" data-level="university" type="button">Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿</button>
        </div>

        <div class="row">
          <button class="btn primary" id="ask-btn" type="button">Î¡ÏÏ„Î± Ï„Î¿ AI</button>

          <!-- âœ… 2 separate clear buttons -->
          <button class="btn ghost" id="clear-math-btn" type="button">ğŸ§¼ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ®</button>
          <button class="btn ghost" id="clear-text-btn" type="button">ğŸ§¼ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ Î›ÎµÎºÏ„Î¹ÎºÎ®</button>

          <span class="muted" id="status"></span>
        </div>

        <div class="muted">Endpoint: <b>/ask</b> (JSON) & <b>/check-image</b> (FormData).</div>
      </div>

      <div class="kbd">
        <div class="tabs">
          <button class="tab active" data-layout="num" type="button">123</button>
          <button class="tab" data-layout="func" type="button">f(x)</button>
          <button class="tab" data-layout="abc" type="button">ABC</button>
          <button class="tab" data-layout="sym" type="button">#&Â¬</button>
        </div>
        <div id="keyboard-rows" class="keys"></div>
      </div>
    </div>

    <div class="card">
      <label>ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î»ÏÏƒÎ·Ï‚ Î±Ï€ÏŒ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</label>
      <div class="imgwrap">
        <input type="file" id="image-input" accept="image/*">
        <img id="img-preview" class="preview" alt="Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚" />
      </div>
      <div class="row">
        <button class="btn primary" id="check-image-btn" disabled type="button">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚</button>
        <button class="btn ghost" id="remove-img-btn" disabled type="button">Î‘Ï†Î±Î¯ÏÎµÏƒÎ·</button>
      </div>
      <div class="muted">Î— Î¯Î´Î¹Î± Î»ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î± ÎºÎ±Î¹ Ï„Î¿ Î¯Î´Î¹Î¿ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ Î¸Î± ÏƒÏ„Î±Î»Î¿ÏÎ½ Î¼Î±Î¶Î¯ Î¼Îµ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±.</div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn dark" id="open-ink-btn" type="button">âœï¸ Î†Î½Î¿Î¹Î¾Îµ Î Î¯Î½Î±ÎºÎ± Î“ÏÎ±Ï†Î®Ï‚ (stylus)</button>
        <span class="muted">Î“ÏÎ¬Ï†ÎµÎ¹Ï‚ Î¼Îµ Ï€Î­Î½Î± ÎºÎ±Î¹ Ï€ÎµÏÎ½Î¬Ï‚ ÏƒÏ„Î± Ï€ÎµÎ´Î¯Î±.</span>
      </div>
    </div>
  </div>

  <!-- ===== TOOLS + EXAMS (BETA tab appears only with ?beta=1) ===== -->
  <div class="card">
    <div class="tools-header">
      <div>
        <label>Î•ÏÎ³Î±Î»ÎµÎ¯Î±</label>
        <div class="muted">ÎŒ,Ï„Î¹ Ï†Ï„Î¹Î¬Ï‡Î½ÎµÎ¹Ï‚ ÎµÎ´Ï Î¼Ï€Î±Î¯Î½ÎµÎ¹ ÏƒÎ±Î½ context ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±.</div>
      </div>
      <div class="tool-tabs" id="tool-tabs">
        <button class="tool-tab active" data-tool="matrix" type="button">Î Î¯Î½Î±ÎºÎµÏ‚</button>
        <button class="tool-tab" data-tool="series" type="button">Î£ÎµÎ¹ÏÎ­Ï‚</button>
        <button class="tool-tab" data-tool="stats" type="button">Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®</button>
        <button class="tool-tab" data-tool="exams" id="exam-tab-btn" type="button" style="display:none">Î”Î¹Î±Î³Ï‰Î½Î¯ÏƒÎ¼Î±Ï„Î± (BETA)</button>
      </div>
    </div>

    <!-- ===== MATRICES ===== -->
    <div class="tool-panel active" id="tool-matrix">
      <!-- (Î¯Î´Î¹Î¿ ÏŒÏ€Ï‰Ï‚ Ï€ÏÎ¹Î½) -->
      <div class="matrix-wide">
        <div class="mini-card">
          <div class="mini-title">Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Ï€Î¯Î½Î±ÎºÎ±</div>
          <div class="muted">ÎœÎ¿ÏÏ†Î®: <span class="mono">1,2;3,4</span></div>
          <textarea id="matrix-raw" placeholder="Ï€.Ï‡. 1,2;3,4" style="margin-top:8px"></textarea>
          <div class="row">
            <button class="btn primary" id="matrix-insert-btn" type="button">Î’Î¬Î»Îµ Ï„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±</button>
            <button class="btn ghost" id="matrix-clear-btn" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            <button class="btn ghost" id="matrix-to-text-btn" type="button">Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
          </div>
        </div>

        <div class="mini-card">
          <div class="mini-title">Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·</div>
          <div id="matrix-preview" class="result-box"></div>
          <div class="muted" style="margin-top:8px">Tip: Î²Î¬Î»Îµ Ï€ÏÏÏ„Î± Ï„Î¿Î½ A, Î¼ÎµÏ„Î¬ Ï€Î¬Ï„Î± Ï„Î¹Ï‚ ÎµÎ½Ï„Î¿Î»Î­Ï‚ Î´ÎµÎ¾Î¹Î¬.</div>
        </div>

        <div class="mini-card">
          <div class="mini-title">Î•Î½Ï„Î¿Î»Î­Ï‚ (Î¼Ï€Î±Î¯Î½Î¿Ï…Î½ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®)</div>

          <div class="mini-title" style="margin-top:6px">Î ÏÎ¬Î¾ÎµÎ¹Ï‚</div>
          <div class="row">
            <button class="btn ghost" id="matrix-det-btn" type="button">det(A)</button>
            <button class="btn ghost" id="matrix-inv-btn" type="button">A^{-1}</button>
            <button class="btn ghost" id="matrix-solve-btn" type="button">Ax=b</button>
          </div>

          <div class="divider"></div>

          <div class="mini-title">Î™Î´Î¹Î¿Ï„Î¹Î¼Î­Ï‚ / Î”Î¹Î±Î³Ï‰Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ·</div>
          <div class="row">
            <button class="btn ghost" id="eigvals-btn" type="button">Î™Î´Î¹Î¿Ï„Î¹Î¼Î­Ï‚</button>
            <button class="btn ghost" id="eigvecs-btn" type="button">Î™Î´Î¹Î¿Î´Î¹Î±Î½ÏÏƒÎ¼Î±Ï„Î±</button>
            <button class="btn ghost" id="diag-btn" type="button">Î”Î¹Î±Î³Ï‰Î½Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹;</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="pd-btn" type="button">P, D</button>
            <button class="btn ghost" id="verify-pdp-btn" type="button">A=PDP^{-1}</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="an-btn" type="button">A^n</button>
            <button class="btn ghost" id="eA-btn" type="button">e^A</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="dynsys-btn" type="button">Î”Ï…Î½Î±Î¼Î¹ÎºÏŒ</button>
            <button class="btn ghost" id="ode-btn" type="button">Î”.Î•.</button>
            <button class="btn ghost" id="exam-summary-btn" type="button">ğŸ§  Î£ÏÎ½Î¿ÏˆÎ·</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== SERIES ===== -->
    <div class="tool-panel" id="tool-series">
      <div class="two-col">
        <div class="mini-card">
          <div class="mini-title">Î†Î¸ÏÎ¿Î¹ÏƒÎ¼Î± (Î£)</div>
          <div class="muted">Î“ÏÎ¬ÏˆÎµ Ï„Î¿Î½ ÏŒÏÎ¿ Ï€Î¬Î½Ï‰. (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬) ÎºÎ¬Î½Îµ highlight.</div>

          <div class="inline-inputs" style="margin-top:10px">
            <div>
              <div class="muted"><b>Î‘Ï€ÏŒ (n = )</b></div>
              <input type="text" id="series-from" placeholder="1" inputmode="numeric" />
            </div>
            <div>
              <div class="muted"><b>ÎˆÏ‰Ï‚</b></div>
              <input type="text" id="series-to" placeholder="âˆ Î® 6" inputmode="numeric" />
            </div>
          </div>

          <div class="row">
            <button class="btn primary" id="series-wrap-btn" type="button">ÎšÎ¬Î½Îµ Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î±</button>
            <button class="btn ghost" id="series-clear-btn" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
            <button class="btn ghost" id="series-to-text-btn" type="button">Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
          </div>
        </div>

        <div class="mini-card">
          <div class="mini-title">Î“ÏÎ®Î³Î¿ÏÎ± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬</div>
          <div class="muted">Î£Ï„Î®Î½Î¿Ï…Î½ ÎµÏÏÏ„Î·ÏƒÎ· ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±.</div>
          <div class="row" style="margin-top:10px">
            <button class="btn ghost" id="series-geo-btn" type="button">Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¹ÎºÎ®</button>
            <button class="btn ghost" id="series-taylor-btn" type="button">Taylor</button>
            <button class="btn ghost" id="series-test-btn" type="button">ÎšÏÎ¹Ï„Î®ÏÎ¹Î¿</button>
          </div>
          <div class="divider"></div>
          <div class="mini-title">Tip</div>
          <div class="muted">Î‘Î½ Î´ÎµÎ½ ÎºÎ¬Î½ÎµÎ¹Ï‚ highlight, Î¸Î± Î²Î¬Î»ÎµÎ¹ <b>a_n</b>.</div>
        </div>
      </div>
    </div>

    <!-- ===== STATS ===== -->
    <div class="tool-panel" id="tool-stats">
      <div class="two-col">
        <div class="mini-card">
          <div class="mini-title">Î”ÎµÎ´Î¿Î¼Î­Î½Î±</div>
          <div class="muted">Ï€.Ï‡. 12, 15, 18, 18, 20</div>
          <textarea id="stats-data" placeholder="Ï€.Ï‡. 12, 15, 18, 18, 20" style="margin-top:8px"></textarea>
          <div class="row">
            <button class="btn primary" id="stats-calc-btn" type="button">Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ</button>
            <button class="btn ghost" id="stats-insert-btn" type="button">Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®</button>
            <button class="btn ghost" id="stats-clear-btn" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
          </div>
        </div>

        <div class="mini-card">
          <div class="mini-title">Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±</div>
          <div id="stats-results" class="result-box mono"></div>
          <div class="divider"></div>
          <div class="mini-title">Templates</div>
          <div class="row">
            <button class="btn ghost" id="stats-ci-btn" type="button">Î”.Î•.</button>
            <button class="btn ghost" id="stats-z-btn" type="button">z-score</button>
            <button class="btn ghost" id="stats-test-btn" type="button">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== EXAMS (BETA) ===== -->
    <div class="tool-panel" id="tool-exams">
      <div class="mini-card">
        <div class="mini-title">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î”Î¹Î±Î³Ï‰Î½Î¯ÏƒÎ¼Î±Ï„Î¿Ï‚ (BETA)</div>
        <div class="muted">
          Î”Î·Î»ÏÎ½ÎµÎ¹Ï‚ Î´Î¿Î¼Î® (ÎœÎ­ÏÎ¿Ï‚ Î‘/Î’/Î“...), Î¼Î¿Î½Î¬Î´ÎµÏ‚, Î²Î®Î¼Î±, Ï‡ÏÏŒÎ½Î¿ ÎºÎ±Î¹ ÏÎ»Î·. Î¤Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± ÎµÎ»Î­Î³Ï‡ÎµÎ¹ Ï„Î¿ Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± ÎºÎ±Î¹ Ï†Ï„Î¹Î¬Ï‡Î½ÎµÎ¹ payload Î³Î¹Î± AI.
        </div>

        <div class="divider"></div>

        <div class="exam-grid">
          <div class="mini-card">
            <div class="mini-title">Î’Î±ÏƒÎ¹ÎºÎ­Ï‚ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</div>

            <div class="inline3">
              <div>
                <div class="muted"><b>ÎšÎ»Î¯Î¼Î±ÎºÎ±</b></div>
                <select id="exam-scale">
                  <option value="10">10/10</option>
                  <option value="20">20/20</option>
                  <option value="40">40/40</option>
                  <option value="100" selected>100/100</option>
                </select>
              </div>

              <div>
                <div class="muted"><b>Min Î²Î®Î¼Î±</b></div>
                <select id="exam-step">
                  <option value="0.25">0.25</option>
                  <option value="0.5" selected>0.5 (Ï€ÏÎ¿Ï„ÎµÎ¹Î½ÏŒÎ¼ÎµÎ½Î¿)</option>
                  <option value="1">1</option>
                </select>
              </div>

              <div>
                <div class="muted"><b>Î§ÏÏŒÎ½Î¿Ï‚ (Î»ÎµÏ€Ï„Î¬) *</b></div>
                <input id="exam-time" type="number" placeholder="Ï€.Ï‡. 40, 60, 90" min="1" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <span class="badge">Î”Ï…ÏƒÎºÎ¿Î»Î¯Î±:</span>
              <input id="exam-difficulty" type="range" min="1" max="5" step="1" value="3" style="flex:1;min-width:200px">
              <span class="badge" id="exam-diff-label">3/5</span>
            </div>

            <div class="small" id="exam-diff-mix">â€”</div>

            <div class="divider"></div>

            <div class="mini-title">Bloom (Recommended)</div>
            <div class="bloom-tags" id="bloom-tags"></div>
            <div class="small">Î˜Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Ï‰Ï‚ â€œÎ¿Î´Î·Î³ÏŒÏ‚â€ Î³Î¹Î± Ï„Î¿ Î¼ÎµÎ¯Î³Î¼Î± ÎµÏÏ‰Ï„Î®ÏƒÎµÏ‰Î½.</div>
          </div>

          <div class="mini-card">
            <div class="mini-title">ÎÎ»Î· (ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·)</div>
            <div class="small">Î¦Î¿ÏÏ„ÏÎ½ÎµÎ¹ Î±Ï€ÏŒ <span class="mono">/v2/content/scope?grade=G_LYKEIO_MATH_KAT</span></div>

            <div style="margin-top:10px" class="inline3">
              <div>
                <div class="muted"><b>Î¤ÎµÏÏ‡Î¿Ï‚</b></div>
                <select id="exam-book"></select>
              </div>
              <div>
                <div class="muted"><b>ÎšÎµÏ†Î¬Î»Î±Î¹Î¿</b></div>
                <select id="exam-chapter"></select>
              </div>
              <div>
                <div class="muted"><b>Î£ÎµÎ»Î¯Î´ÎµÏ‚ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</b></div>
                <input id="exam-pages" type="text" placeholder="Ï€.Ï‡. 12-18" />
              </div>
            </div>

            <div class="divider"></div>

            <div class="mini-title">Î”Î¿Î¼Î® Î”Î¹Î±Î³Ï‰Î½Î¯ÏƒÎ¼Î±Ï„Î¿Ï‚ (ÎœÎ­ÏÎ·)</div>
            <div class="small">Î .Ï‡. ÎœÎ­ÏÎ¿Ï‚ Î‘: 10 Î¼Î¿Î½Î¬Î´ÎµÏ‚, 5 ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚ (2 Î¼Î¿Î½./ÎµÏÏÏ„Î·ÏƒÎ·)</div>

            <div class="exam-cta" style="margin-top:8px">
              <button class="btn primary" id="add-part-btn" type="button">â• Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ ÎœÎ­ÏÎ¿Ï‚</button>
              <button class="btn ghost" id="reset-parts-btn" type="button">â†©ï¸ Reset</button>
              <span class="pill-soft" id="exam-sum-pill">Î£ÏÎ½Î¿Î»Î¿: â€”</span>
            </div>

            <div id="exam-parts" class="exam-parts"></div>

            <div class="divider"></div>

            <div class="exam-cta">
              <button class="btn dark" id="exam-to-text-btn" type="button">ğŸ§¾ Î£Ï„ÎµÎ¯Î»Ï„Î¿ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® (Ï‰Ï‚ context)</button>
              <button class="btn primary" id="exam-generate-btn" type="button">âš™ï¸ Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ (BETA)</button>
              <span class="small" id="exam-status"></span>
            </div>

            <div class="small">
              * Î£Ï„Î¿ BETA, Î· â€œÎ”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµâ€ Ï†Ï„Î¹Î¬Ï‡Î½ÎµÎ¹ payload & prompt. Î£Ï„Î¿ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿ Î²Î®Î¼Î± Î¸Î± Î´Î­Î½ÎµÎ¹ Î¼Îµ endpoint generate-exam.
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- ===== ANSWER (RESTORED + save/pdf/print) ===== -->
  <div class="card" id="answer-card">
    <label>Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· AI</label>
    <div id="ai-answer" class="answer">Î ÎµÏÎ¹Î¼Î­Î½Ï‰ Ï„Î·Î½ Ï€ÏÏÏ„Î· ÏƒÎ¿Ï… ÎµÏÏÏ„Î·ÏƒÎ·â€¦</div>

    <div class="answer-actions">
      <button class="btn ghost" id="save-answer-btn" type="button">ğŸ’¾ Save</button>
      <button class="btn ghost" id="download-answer-btn" type="button">â¬‡ï¸ .txt</button>
      <button class="btn ghost" id="pdf-answer-btn" type="button">â¬‡ï¸ PDF</button>
      <button class="btn primary" id="print-answer-btn" type="button">ğŸ–¨ï¸ Print</button>
      <span class="pill" id="saved-info">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.</span>
    </div>

    <div id="continue-box" class="continue-box">
      <div class="continue-q">ÎÎ± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÏ‰;</div>
      <div class="row">
        <button class="btn dark" id="continue-yes" type="button">ÎÎ‘Î™</button>
        <button class="btn ghost" id="continue-no" type="button">ÎŸÎ§Î™</button>
        <span class="muted" id="continue-status"></span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="footer-note">
      <strong>Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ® ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·:</strong><br>
      Î¤Î¿ Ï€Î±ÏÏŒÎ½ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Ï€ÏÎ¿Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ <strong>Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ Î³Î¹Î± ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿ÏÏ‚ ÏƒÎºÎ¿Ï€Î¿ÏÏ‚</strong>.
    </div>
  </div>
</main>

<!-- ===== TOAST ===== -->
<div id="answer-toast" class="toast" role="status" aria-live="polite">
  <span>âœ… Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¿ ÎºÎ¬Ï„Ï‰.</span>
  <button id="toast-go" class="toast-btn" type="button">Î”ÎµÏ‚ Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·</button>
</div>

<!-- ===== INK MODAL ===== -->
<div id="ink-backdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Î Î¯Î½Î±ÎºÎ±Ï‚ Î“ÏÎ±Ï†Î®Ï‚">
    <div class="modal-head">
      <div class="modal-title">âœï¸ Î Î¯Î½Î±ÎºÎ±Ï‚ Î“ÏÎ±Ï†Î®Ï‚ â€” Î³ÏÎ¬ÏˆÎµ (ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ¬ / Î›ÎµÎºÏ„Î¹ÎºÎ¬) ÎºÎ±Î¹ Ï€Î­ÏÎ±ÏƒÎ­ Ï„Î± ÏƒÏ„Î± Ï€ÎµÎ´Î¯Î±</div>
      <button class="modal-close" id="ink-close" type="button">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ âœ•</button>
    </div>

    <div class="modal-body">
      <div class="ink-controls">
        <div class="ctrl">
          <label for="ink-color">Î§ÏÏÎ¼Î±</label>
          <input id="ink-color" type="color" value="#111827" />
        </div>
        <div class="ctrl">
          <label for="ink-size">Î Î¬Ï‡Î¿Ï‚</label>
          <input id="ink-size" type="range" min="1" max="16" step="1" value="4" />
          <span class="val" id="ink-size-val">4</span>
        </div>
        <span class="muted">Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î¼Îµ Ï€Î¿Î½Ï„Î¯ÎºÎ¹, touch ÎºÎ±Î¹ stylus.</span>
      </div>

      <div class="ink-split">
        <div class="ink-pane">
          <div class="ink-pane-title">ğŸ§® Î“ÏÎ¬ÏˆÎµ ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ— Î­ÎºÏ†ÏÎ±ÏƒÎ·</div>
          <div class="ink-wrap">
            <canvas id="ink-math-canvas" class="ink-canvas"></canvas>
          </div>
          <div class="ink-actions">
            <button class="btn primary" id="ink-math-to-main" type="button">â¡ï¸ Î Î­ÏÎ±ÏƒÎµ ÏƒÏ„Î· ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® ÎˆÎºÏ†ÏÎ±ÏƒÎ·</button>
            <button class="btn ghost" id="ink-math-clear" type="button">ğŸ§¼ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
          </div>
          <div class="ink-tip">Tip: Î³ÏÎ¬ÏˆÎµ ÎºÎ±Î¸Î±ÏÎ¬ (Ï€.Ï‡. ÎºÎ»Î¬ÏƒÎ¼Î±Ï„Î± ÏƒÎµ â€œÏ€Î¬Î½Ï‰/ÎºÎ¬Ï„Ï‰â€).</div>
        </div>

        <div class="ink-pane">
          <div class="ink-pane-title">ğŸ’¬ Î“ÏÎ¬ÏˆÎµ Î›Î•ÎšÎ¤Î™ÎšÎ— Î±Ï€Î¿ÏÎ¯Î±</div>
          <div class="ink-wrap">
            <canvas id="ink-text-canvas" class="ink-canvas"></canvas>
          </div>
          <div class="ink-actions">
            <button class="btn primary" id="ink-text-to-main" type="button">â¡ï¸ Î Î­ÏÎ±ÏƒÎµ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® Î‘Ï€Î¿ÏÎ¯Î±</button>
            <button class="btn ghost" id="ink-text-clear" type="button">ğŸ§¼ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
          </div>
          <div class="ink-tip">Tip: Î³ÏÎ¬ÏˆÎµ Î¼Î¹ÎºÏÎ­Ï‚ Ï€ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚/Î»Î­Î¾ÎµÎ¹Ï‚ (ÏŒÏ‡Î¹ Ï„ÎµÏÎ¬ÏƒÏ„Î¹Î¿ Ï€Î±ÏÎ¬Î³ÏÎ±Ï†Î¿).</div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="muted">
        Î Î±Ï„Î¬Ï‚ â€œÎ Î­ÏÎ±ÏƒÎµâ€¦â€ Î³Î¹Î± Î±Î½Î±Î³Î½ÏÏÎ¹ÏƒÎ· ÎºÎ±Î¹ Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬. ÎœÎµÏ„Î¬, Ï€Î±Ï„Î¬Ï‚ <b>â€œÎ¡ÏÏ„Î± Ï„Î¿ AIâ€</b> Î±Ï€ÏŒ Ï„Î·Î½ ÎºÏÏÎ¹Î± ÏƒÎµÎ»Î¯Î´Î±.
      </div>
      <div class="muted" id="ink-transfer-status"></div>
    </div>
  </div>
</div>
<script>
  /* ===================== SERVER ===================== */
  // Î‘Î½ Ï„Î¿ UI ÎµÎ¯Î½Î±Î¹ ÏƒÎµ Î¬Î»Î»Î¿ domain Î±Ï€ÏŒ Ï„Î¿ FastAPI, Î²Î¬Î»Îµ ÎµÎ´Ï Ï„Î¿ server URL ÏƒÎ¿Ï….
  // Î .Ï‡. "https://math-ai-server.onrender.com"
  const BASE_URL = "https://math-ai-server.onrender.com";

  /* ===================== TOAST ===================== */
  const toast = document.getElementById("answer-toast");
  const toastGo = document.getElementById("toast-go");
  const answerCard = document.getElementById("answer-card");

  function showToast(){
    toast.style.display = "flex";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => hideToast(), 7000);
  }
  function hideToast(){ toast.style.display = "none"; }
  function isAnswerVisible(){
    const r = answerCard.getBoundingClientRect();
    const vh = window.innerHeight || document.documentElement.clientHeight;
    return (r.top < vh * 0.75) && (r.bottom > vh * 0.25);
  }
  function scrollToAnswer(){
    answerCard.scrollIntoView({ behavior: "smooth", block: "start" });
    hideToast();
  }
  toastGo.addEventListener("click", scrollToAnswer);
  window.addEventListener("scroll", () => {
    if (toast.style.display !== "none" && isAnswerVisible()) hideToast();
  }, { passive:true });

  /* ===================== LEVEL ===================== */
  let currentLevel = "lyceum";
  document.querySelectorAll(".level-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".level-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentLevel = btn.dataset.level;
    });
  });

  /* ===================== HELPERS ===================== */
  const mathInput = document.getElementById("math-input");
  const textInput = document.getElementById("text-input");

  function insertAtCursor(el, text){
    const start = el.selectionStart ?? el.value.length;
    const end = el.selectionEnd ?? el.value.length;
    el.setRangeText(text, start, end, "end");
    el.focus();
  }
  function replaceSelection(el, newText){
    const start = el.selectionStart ?? 0;
    const end = el.selectionEnd ?? 0;
    if (start === end){ insertAtCursor(el, newText); return; }
    el.setRangeText(newText, start, end, "end");
    el.focus();
  }
  function getSelectionText(el){
    const start = el.selectionStart ?? 0;
    const end = el.selectionEnd ?? 0;
    if (start === end) return "";
    return el.value.slice(start, end);
  }

  function addToolHeader(title){ return `=== ${title} ===`; }
  function appendToTextContext(block){
    const b = (block || "").trim();
    if (!b) return;
    if (textInput.value.includes(b)) return;
    const prefix = textInput.value.trim() ? "\n\n" : "";
    textInput.value = textInput.value.trim() + prefix + b;
  }

  /* Greekâ†’English math normalization */
  function greekToEnglishMath(s){
    let t = (s || "").toString();
    t = t.replace(/Ï‡/g, "x").replace(/Î§/g, "x");
    t = t.replace(/âˆ’/g,'-').replace(/Ã·/g,'/').replace(/Ã—/g,'*');
    t = t.replace(/Î·Î¼\s*/g, "sin ");
    t = t.replace(/ÏƒÏ…Î½\s*/g, "cos ");
    t = t.replace(/ÎµÏ†\s*/g, "tan ");
    t = t.replace(/ÏƒÏ†\s*/g, "cot ");
    t = t.replace(/sinx/g, "sin x").replace(/cosx/g, "cos x").replace(/tanx/g, "tan x").replace(/cotx/g, "cot x");
    t = t.replace(/Ï€/g, "\\pi ");
    t = t.replace(/[ \t]+/g, " ").trim();
    return t;
  }

  /* ===================== KEYBOARD ===================== */
  const keyboardLayouts = {
    num: [['x','y','z','Ï€','e','7','8','9','Ã—','Ã·'],['xÂ²','xâ¿','a/b','âˆš','â¿âˆš','4','5','6','+','âˆ’'],['1','2','3','0','â‰¤','â‰¥','<','>'],['=',' ']],
    func: [['sin','cos','tan','ln','logâ‚â‚€','logâ‚bâ‚'],['sinâ»Â¹','cosâ»Â¹','tanâ»Â¹','d/dx','âˆ«','dx'],['sec(x)','csc(x)','Ï€âˆ«','{','}','â‰¤','â‰¥'],['=',' ']],
    abc: [['q','w','e','r','t','y','u','i','o','p'],['a','s','d','f','g','h','j','k','l'],['z','x','c','v','b','n','m','(',')'],['=',' ']],
    sym: [['#','&','Â¬','â‰ˆ','â‰ ','âˆ'],['â‰¤','â‰¥','âˆˆ','âˆ‰','â‡’','â‡”'],['âŠ‚','âŠ†','âŠ„','âŠ‡','|','â€–'],['=',' ']]
  };
  const keyboardRows = document.getElementById("keyboard-rows");

  function insertFromKey(label){
    let insertText;
    if (label === ' ') insertText = ' ';
    else if (label === 'xÂ²') insertText = 'x^2';
    else if (label === 'xâ¿') insertText = 'x^';
    else if (label === 'a/b') insertText = '/';
    else if (label === 'ln') insertText = '\\ln(';
    else if (label === 'logâ‚â‚€') insertText = '\\log_{10}(';
    else if (label === 'logâ‚bâ‚') insertText = '\\log_{b}(';
    else if (label === 'âˆš') insertText = 'âˆš( )';
    else if (label === 'â¿âˆš') insertText = '3âˆš( )';
    else if (label === 'Ï€âˆ«') insertText = 'V = Ï€âˆ«_{a}^{b} f(x)^2 dx';
    else insertText = label;

    insertAtCursor(mathInput, insertText);
    updateMathPreview();
  }
  function loadKeyboard(name){
    keyboardRows.innerHTML = "";
    keyboardLayouts[name].forEach(row => {
      const wrap = document.createElement("div");
      row.forEach(label => {
        const b = document.createElement("button");
        b.className = "key"; b.type = "button";
        b.textContent = label === " " ? "ÎºÎµÎ½ÏŒ" : label;
        b.onclick = () => insertFromKey(label);
        wrap.appendChild(b);
      });
      keyboardRows.appendChild(wrap);
    });
  }
  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      loadKeyboard(btn.dataset.layout);
    });
  });
  loadKeyboard("num");

  /* ===================== MATH PREVIEW ===================== */
  const mathPreview = document.getElementById("math-preview");
  const mathPreviewPlaceholder = document.getElementById("math-preview-placeholder");

  function isProbablyLatex(s){ return /\\(frac|sqrt|int|sum|begin|pi|cdot|left|right|det|sin|cos|tan)/.test(s || ""); }

  function convertToLatex(text){
    let t = (text || "").trim();
    if (!t) return "";
    const alreadyLatex = isProbablyLatex(t);

    t = greekToEnglishMath(t);
    t = t.replace(/([0-9a-zA-Z\)\}])\s*:\s*([0-9a-zA-Z\\(\{])/g, '$1/$2');

    if (!alreadyLatex){
      t = t.replace(/âˆ«/g,'\\int ');
      t = t.replace(/\s*dx\b/g,'\\, dx');

      t = t.replace(/(\d+)\s*âˆš\s*\(([^)]*)\)/g,'\\sqrt[$1]{$2}');
      t = t.replace(/(\d+)\s*âˆš\s*([a-zA-Z0-9]+)/g,'\\sqrt[$1]{$2}');
      t = t.replace(/âˆš\s*\(([^)]*)\)/g,'\\sqrt{$1}');
      t = t.replace(/âˆš\s*([a-zA-Z0-9]+)/g,'\\sqrt{$1}');
      t = t.replace(/sqrt\s*\(([^)]*)\)/gi,'\\sqrt{$1}');

      t = t.replace(/([0-9a-zA-Z\\]+)\s*\^\s*\(([^)]+)\)/g,'$1^{ $2 }');
      t = t.replace(/([a-zA-Z0-9])\^(\d+)/g,'$1^{ $2 }');

      t = t.replace(/\(([^()]+)\)\s*\/\s*\(([^()]+)\)/g,'\\frac{$1}{$2}');
      t = t.replace(/([0-9a-zA-Z]+)\s*\/\s*\(([^()]+)\)/g,'\\frac{$1}{$2}');
      t = t.replace(/([0-9a-zA-Z])\s*\/\s*([0-9a-zA-Z])(?!\s*\^)/g,'\\frac{$1}{$2}');
    }
    t = t.replace(/\*/g,'\\cdot ');
    return t;
  }

  async function renderMathIn(el){
    if (window.MathJax && MathJax.typesetPromise){
      try { await MathJax.typesetPromise([el]); } catch(e){}
    }
  }

  async function updateMathPreview(){
    const raw = mathInput.value;
    if (!raw.trim()){
      mathPreview.innerHTML = "";
      mathPreviewPlaceholder.style.display = "inline";
      return;
    }
    mathPreviewPlaceholder.style.display = "none";
    const latex = convertToLatex(raw);
    mathPreview.innerHTML = `\\(${latex}\\)`;
    await renderMathIn(mathPreview);
  }
  mathInput.addEventListener("input", updateMathPreview);

  /* ===================== MAIN STATUS / ANSWER / CONTINUE ===================== */
  const answerEl = document.getElementById("ai-answer");
  const statusEl = document.getElementById("status");
  const setStatus = (t="") => statusEl.textContent = t;

  const continueBox = document.getElementById("continue-box");
  const continueYes = document.getElementById("continue-yes");
  const continueNo  = document.getElementById("continue-no");
  const continueStatus = document.getElementById("continue-status");

  let lastPromptSent = "";
  let lastAnswerText = "";

  function showContinueBox(show){
    continueBox.style.display = show ? "block" : "none";
    continueStatus.textContent = "";
    continueYes.disabled = false;
    continueNo.disabled = false;
  }

  async function renderAnswer(text){
    const t = (text || "");
    lastAnswerText = t;

    answerEl.innerHTML = t.replace(/\n/g,"<br>");
    await renderMathIn(answerEl);

    showContinueBox(true);
    if (!isAnswerVisible()) showToast();

    try{
      localStorage.setItem("mathAI:lastAnswer", t);
      localStorage.setItem("mathAI:lastAnswerAt", new Date().toISOString());
      updateSavedInfo();
    }catch(e){}
  }

  async function askAI(prompt){
    setStatus("Î¤Î¿ AI ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹â€¦");
    statusEl.classList.add("status-thinking");
    answerEl.innerHTML = "Î¤Î¿ AI ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹â€¦";
    await renderMathIn(answerEl);
    showContinueBox(false);

    try{
      const res = await fetch(`${BASE_URL}/ask`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ prompt })
      });
      const data = await res.json();
      const ans = data.answer || data.message || JSON.stringify(data, null, 2) || "Î”ÎµÎ½ Î®ÏÎ¸Îµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.";
      await renderAnswer(ans);
    }catch(e){
      await renderAnswer("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server (/ask).");
    }
    setStatus("");
    statusEl.classList.remove("status-thinking");
  }

  document.getElementById("ask-btn").addEventListener("click", async () => {
    hideToast();
    const mathRaw = mathInput.value.trim();
    const math = mathRaw ? greekToEnglishMath(mathRaw) : "";
    const text = textInput.value.trim();

    let bodyParts = [];
    if (math) bodyParts.push("ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® Î­ÎºÏ†ÏÎ±ÏƒÎ·:\n" + math);
    if (text) bodyParts.push("Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±:\n" + text);
    const mainPrompt = bodyParts.join("\n\n") || "Î›ÏÏƒÎµ Ï„Î¿ 1+1.";

    const levelPrefix = currentLevel === "lyceum"
      ? "ÎÎ± Î»Ï…Î¸ÎµÎ¯ Î¼Îµ Î¼Î±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ¬ ÎµÏ€Î¹Ï€Î­Î´Î¿Ï… Î›Ï…ÎºÎµÎ¯Î¿Ï…. Î‘Ï€ÏŒÏ†Ï…Î³Îµ Ï€Î±Î½ÎµÏ€Î¹ÏƒÏ„Î·Î¼Î¹Î±ÎºÎ­Ï‚ Î¼ÎµÎ¸ÏŒÎ´Î¿Ï…Ï‚.\n\n"
      : "ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ­Ï‚ Ï€Î±Î½ÎµÏ€Î¹ÏƒÏ„Î·Î¼Î¹Î±ÎºÎ¿Ï ÎµÏ€Î¹Ï€Î­Î´Î¿Ï….\n\n";

    lastPromptSent = levelPrefix + mainPrompt;
    await askAI(lastPromptSent);
  });

  /* âœ… clear buttons */
  document.getElementById("clear-math-btn").addEventListener("click", async () => {
    mathInput.value = "";
    await updateMathPreview();
    mathInput.focus();
  });
  document.getElementById("clear-text-btn").addEventListener("click", () => {
    textInput.value = "";
    textInput.focus();
  });

  continueYes.addEventListener("click", async () => {
    hideToast();
    continueYes.disabled = true;
    continueNo.disabled = true;
    continueStatus.textContent = "Î£Ï…Î½ÎµÏ‡Î¯Î¶Ï‰â€¦";

    const followUp =
      "Î£Ï…Î½Î­Ï‡Î¹ÏƒÎµ Ï„Î·Î½ ÎµÎ¾Î®Î³Î·ÏƒÎ·/Î»ÏÏƒÎ· Î±Ï€ÏŒ Ï„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿ Ï€Î¿Ï… Î­Î¼ÎµÎ¹Î½ÎµÏ‚. " +
      "Î”ÏÏƒÎµ Ï„Î± ÎµÏ€ÏŒÎ¼ÎµÎ½Î± Î²Î®Î¼Î±Ï„Î±, Ï€Î¹Î¿ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬, Î¼Îµ ÎºÎ±Î¸Î±ÏÎ® Î´Î¿Î¼Î®.\n\n" +
      "Î Î¡ÎŸÎ—Î“ÎŸÎ¥ÎœÎ•ÎÎŸ PROMPT:\n" + (lastPromptSent || "(ÎºÎµÎ½ÏŒ)") + "\n\n" +
      "Î Î¡ÎŸÎ—Î“ÎŸÎ¥ÎœÎ•ÎÎ— Î‘Î Î‘ÎÎ¤Î—Î£Î—:\n" + (lastAnswerText || "(ÎºÎµÎ½ÏŒ)");

    lastPromptSent = followUp;
    await askAI(followUp);
  });

  continueNo.addEventListener("click", () => {
    continueStatus.textContent = "ÎŸÎš â€” Î´ÎµÎ½ ÏƒÏ…Î½ÎµÏ‡Î¯Î¶Ï‰.";
    setTimeout(() => showContinueBox(false), 800);
  });

  /* ===================== SAVE / TXT / PDF / PRINT ===================== */
  const saveBtn = document.getElementById("save-answer-btn");
  const downloadBtn = document.getElementById("download-answer-btn");
  const pdfBtn = document.getElementById("pdf-answer-btn");
  const printBtn = document.getElementById("print-answer-btn");
  const savedInfo = document.getElementById("saved-info");

  function getAnswerTextRaw(){
    const t = (lastAnswerText || "").toString().replace(/\r/g, "").trim();
    return t || "â€”";
  }
  function updateSavedInfo(){
    try{
      const at = localStorage.getItem("mathAI:lastAnswerAt");
      const txt = localStorage.getItem("mathAI:lastAnswer") || "";
      if(!at || !txt.trim()){
        savedInfo.textContent = "Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.";
        return;
      }
      const d = new Date(at);
      savedInfo.textContent = `Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ: ${d.toLocaleString()}`;
    }catch(e){
      savedInfo.textContent = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·: Î¼Î· Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î·.";
    }
  }
  function saveAnswerNow(){
    const t = getAnswerTextRaw();
    try{
      localStorage.setItem("mathAI:lastAnswer", t);
      localStorage.setItem("mathAI:lastAnswerAt", new Date().toISOString());
      updateSavedInfo();
      alert("âœ… Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.");
    }catch(e){
      alert("âŒ Î”ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎ± Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÏ‰ (Î¯ÏƒÏ‰Ï‚ private mode).");
    }
  }
  function downloadAnswerTxt(){
    const t = getAnswerTextRaw();
    const when = new Date();
    const filename = `AI_answer_${when.getFullYear()}-${String(when.getMonth()+1).padStart(2,"0")}-${String(when.getDate()).padStart(2,"0")}_${String(when.getHours()).padStart(2,"0")}${String(when.getMinutes()).padStart(2,"0")}.txt`;

    const blob = new Blob([t], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 400);
  }
  function escHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function formatForPrint(rawText){
    const t = (rawText || "").replace(/\r/g,"");
    const parts = t.split("```");
    let html = "";
    for(let i=0;i<parts.length;i++){
      if(i % 2 === 1){
        html += `<pre class="code"><code>${escHtml(parts[i].trim())}</code></pre>`;
      }else{
        const safe = escHtml(parts[i]);
        const paras = safe.split(/\n{2,}/).map(p => p.trim()).filter(Boolean);
        for(const p of paras){
          html += `<p>${p.replace(/\n/g,"<br>")}</p>`;
        }
      }
    }
    return html || "<p>â€”</p>";
  }
  function openPrintWindow({autoPrint=true, title="Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ·"} = {}){
    const raw = getAnswerTextRaw();
    const when = new Date().toLocaleString();
    const htmlBody = formatForPrint(raw);

    const w = window.open("", "_blank", "width=980,height=760");
    if (!w) {
      alert("ÎŸ browser Î¼Ï€Î»ÏŒÎºÎ±ÏÎµ Ï„Î¿ popup. Î•Ï€Î¯Ï„ÏÎµÏˆÎµ popups ÎºÎ±Î¹ Î¾Î±Î½Î¬.");
      return;
    }

    w.document.open();
    w.document.write(`
<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>${escHtml(title)}</title>

  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\\\(','\\\\)'], ['$', '$']], displayMath: [['\\\\[','\\\\]']] },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  <\/script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>

  <style>
    @page { margin: 12mm; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",sans-serif;
      color:#111827;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      background:#fff;
    }
    .wrap{ max-width: 900px; margin: 0 auto; }
    .header{ border-bottom: 1px solid #e5e7eb; padding: 0 0 10px 0; margin: 0 0 12px 0; }
    h1{ margin:0 0 6px 0; font-size: 18px; font-weight: 900; letter-spacing:.2px; }
    .meta{ color:#6b7280; font-size:12px; }
    .content{ font-size: 13px; line-height:1.6; }
    p{ margin: 0 0 10px 0; }
    .code{
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px 12px;
      background: #fafafa;
      overflow:auto;
      font-family: ui-monospace, Menlo, Consolas, "JetBrains Mono", monospace;
      font-size: 12.5px;
      line-height: 1.5;
      margin: 0 0 12px 0;
      white-space: pre-wrap;
    }
    @media print{ .wrap{ max-width: none; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI â€” ${escHtml(title)}</h1>
      <div class="meta">${escHtml(when)}</div>
    </div>

    <div class="content" id="content">
      ${htmlBody}
    </div>

    <div class="meta" style="margin-top:12px">
      Tip: Î£Ï„Î¿ Chrome ÎºÎ»ÎµÎ¯ÏƒÎµ â€œHeaders and footersâ€ Î³Î¹Î± Î½Î± Ï†ÏÎ³Î¿Ï…Î½ Î±ÏÎ¹Î¸Î¼Î¿Î¯ ÏƒÎµÎ»Î¯Î´Ï‰Î½/URL.
    </div>
  </div>

  <script>
    function go(){
      ${autoPrint ? "window.focus(); window.print();" : ""}
    }
    window.addEventListener('load', () => setTimeout(go, 450));
  <\/script>
</body>
</html>
    `);
    w.document.close();
  }
  function printAnswer(){ openPrintWindow({autoPrint:true, title:"Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·"}); }
  function exportPdf(){ openPrintWindow({autoPrint:true, title:"Export PDF"}); }

  saveBtn.addEventListener("click", saveAnswerNow);
  downloadBtn.addEventListener("click", downloadAnswerTxt);
  printBtn.addEventListener("click", printAnswer);
  pdfBtn.addEventListener("click", exportPdf);

  /* ===================== PHOTO CHECK ===================== */
  const imgInput = document.getElementById("image-input");
  const imgPreview = document.getElementById("img-preview");
  const checkBtn = document.getElementById("check-image-btn");
  const removeBtn = document.getElementById("remove-img-btn");

  function resetImageUI(){
    imgPreview.removeAttribute("src");
    checkBtn.disabled = true;
    removeBtn.disabled = true;
  }

  imgInput.addEventListener("change", () => {
    const file = imgInput.files && imgInput.files[0];
    if(!file){ resetImageUI(); return; }
    const url = URL.createObjectURL(file);
    imgPreview.src = url;
    checkBtn.disabled = false;
    removeBtn.disabled = false;
  });

  removeBtn.addEventListener("click", () => {
    imgInput.value = "";
    resetImageUI();
  });

  checkBtn.addEventListener("click", async () => {
    hideToast();
    const file = imgInput.files && imgInput.files[0];
    if (!file) { await renderAnswer("Î”ÎµÎ½ ÎµÏ€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±."); return; }

    setStatus("Î¤Î¿ AI Î±Î½Î±Î»ÏÎµÎ¹ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±â€¦");
    statusEl.classList.add("status-thinking");
    answerEl.innerHTML = "Î¤Î¿ AI Î±Î½Î±Î»ÏÎµÎ¹ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±â€¦";
    await renderMathIn(answerEl);
    showContinueBox(false);

    const formData = new FormData();
    formData.append("image", file);
    formData.append("question", textInput.value.trim());
    formData.append("level", currentLevel);

    try{
      const res = await fetch(`${BASE_URL}/check-image`, { method:"POST", body: formData });
      const data = await res.json();
      await renderAnswer(data.answer || "Î”ÎµÎ½ Î®ÏÎ¸Îµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î±Ï€ÏŒ Ï„Î¿Î½ server.");
    }catch(e){
      await renderAnswer("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server (/check-image).");
    }
    setStatus("");
    statusEl.classList.remove("status-thinking");
  });

  /* ===================== TOOL TABS ===================== */
  const toolTabs = document.querySelectorAll(".tool-tab");
  const toolPanels = {
    matrix: document.getElementById("tool-matrix"),
    series: document.getElementById("tool-series"),
    stats: document.getElementById("tool-stats"),
    exams: document.getElementById("tool-exams")
  };

  toolTabs.forEach(t => {
    t.addEventListener("click", () => {
      toolTabs.forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      Object.values(toolPanels).forEach(p => p?.classList.remove("active"));
      toolPanels[t.dataset.tool]?.classList.add("active");
    });
  });

  /* ===================== MATRICES ===================== */
  const matrixRaw = document.getElementById("matrix-raw");
  const matrixPreview = document.getElementById("matrix-preview");
  let lastMatrixLatex = "";

  function parseMatrix(raw){
    const txt = (raw || "").trim();
    if (!txt) return null;
    const normalized = txt.replace(/\n+/g, ';');
    const rows = normalized.split(';').map(r => r.trim()).filter(Boolean);
    if (!rows.length) return null;
    const data = rows.map(r => r.split(',').map(c => c.trim()).filter(Boolean));
    const cols = data[0]?.length || 0;
    if (!cols) return null;
    return data;
  }
  function matrixToLatex(mat){
    const rows = mat.map(row => row.join(' & ')).join(' \\\\ ');
    return `\\begin{bmatrix} ${rows} \\end{bmatrix}`;
  }
  async function updateMatrixPreview(){
    const mat = parseMatrix(matrixRaw.value);
    if (!mat){ matrixPreview.innerHTML = ""; return; }
    const latex = matrixToLatex(mat);
    matrixPreview.innerHTML = `\\(${latex}\\)`;
    await renderMathIn(matrixPreview);
  }
  matrixRaw.addEventListener("input", updateMatrixPreview);

  function pushMatrixContext(matLatex, raw){
    lastMatrixLatex = matLatex || lastMatrixLatex;
    appendToTextContext(
      `${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\n` +
      `Î Î¯Î½Î±ÎºÎ±Ï‚ A (raw): ${raw}\n` +
      `Î Î¯Î½Î±ÎºÎ±Ï‚ A (LaTeX): ${matLatex}\n`
    );
  }
  function ensureMatrixInContext(){
    if (!lastMatrixLatex){
      appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nâš ï¸ Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¿ÏÎ¹ÏƒÏ„ÎµÎ¯ Ï€Î¯Î½Î±ÎºÎ±Ï‚ A. Î’Î¬Î»Îµ Ï€ÏÏÏ„Î± Ï€Î¯Î½Î±ÎºÎ± ÎºÎ±Î¹ Ï€Î¬Ï„Î·ÏƒÎµ â€œÎ’Î¬Î»Îµ Ï„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ±â€.`);
      return false;
    }
    return true;
  }
  function diagonalizationChecklist(){
    const A = lastMatrixLatex || "A";
    return (
      `${addToolHeader("Î”Î™Î‘Î“Î©ÎÎŸÎ ÎŸÎ™Î—Î£Î— (Î£ÏÎ½Î¿ÏˆÎ·)")}\n` +
      `Î”Î¯Î½ÎµÏ„Î±Î¹ Î¿ Ï€Î¯Î½Î±ÎºÎ±Ï‚ A = ${A}\n\n` +
      `ğŸ‘‰ Î¤Ï…Ï€Î¹ÎºÎ® ÏƒÎµÎ¹ÏÎ¬:\n` +
      `1) Î™Î´Î¹Î¿Ï„Î¹Î¼Î­Ï‚ (det(A-\\lambda I)=0)\n` +
      `2) Î™Î´Î¹Î¿Î´Î¹Î±Î½ÏÏƒÎ¼Î±Ï„Î± ((A-\\lambda I)v=0)\n` +
      `3) ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹Î±Î³Ï‰Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚\n` +
      `4) P, D (Î¯Î´Î¹Î± ÏƒÎµÎ¹ÏÎ¬)\n` +
      `5) ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: A=PDP^{-1}\n\n` +
      `ÎœÎµÏ„Î¬: A^n, e^A, Î´Ï…Î½Î±Î¼Î¹ÎºÎ¬, Î”.Î•.\n`
    );
  }

  document.getElementById("matrix-insert-btn").addEventListener("click", async () => {
    const mat = parseMatrix(matrixRaw.value);
    if (!mat){ await renderAnswer("Î”ÏÏƒÎµ Ï€ÏÏÏ„Î± Î­Î½Î±Î½ Ï€Î¯Î½Î±ÎºÎ± Ï€.Ï‡. 1,2;3,4"); return; }
    const latex = matrixToLatex(mat);
    lastMatrixLatex = latex;
    insertAtCursor(mathInput, latex);
    updateMathPreview();
    pushMatrixContext(latex, matrixRaw.value.trim());
    textInput.focus();
  });
  document.getElementById("matrix-to-text-btn").addEventListener("click", () => {
    const mat = parseMatrix(matrixRaw.value);
    if (!mat) return;
    const latex = matrixToLatex(mat);
    lastMatrixLatex = latex;
    pushMatrixContext(latex, matrixRaw.value.trim());
    textInput.focus();
  });
  document.getElementById("matrix-clear-btn").addEventListener("click", () => {
    matrixRaw.value = "";
    matrixPreview.innerHTML = "";
    lastMatrixLatex = "";
  });

  document.getElementById("matrix-det-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ–Î·Ï„Î¿ÏÎ¼ÎµÎ½Î¿: Î¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ det(A) Î¼Îµ Î²Î®Î¼Î±Ï„Î±.`); textInput.focus(); });
  document.getElementById("matrix-inv-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ–Î·Ï„Î¿ÏÎ¼ÎµÎ½Î¿: Î’ÏÎµÏ‚ A^{-1} (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹).`); textInput.focus(); });
  document.getElementById("matrix-solve-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ–Î·Ï„Î¿ÏÎ¼ÎµÎ½Î¿: Î›ÏÏƒÎµ Ax=b.`); textInput.focus(); });

  document.getElementById("eigvals-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ’ÏÎµÏ‚ Î¹Î´Î¹Î¿Ï„Î¹Î¼Î­Ï‚.`); textInput.focus(); });
  document.getElementById("eigvecs-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ’ÏÎµÏ‚ Î¹Î´Î¹Î¿Î´Î¹Î±Î½ÏÏƒÎ¼Î±Ï„Î±.`); textInput.focus(); });
  document.getElementById("diag-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎˆÎ»ÎµÎ³Î¾Îµ Î±Î½ Î´Î¹Î±Î³Ï‰Î½Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹.`); textInput.focus(); });
  document.getElementById("pd-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ¦Ï„Î¹Î¬Î¾Îµ P, D (Î¯Î´Î¹Î± ÏƒÎµÎ¹ÏÎ¬).`); textInput.focus(); });
  document.getElementById("verify-pdp-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎˆÎ»ÎµÎ³Î¾Îµ A=PDP^{-1}.`); textInput.focus(); });
  document.getElementById("an-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ A^n.`); textInput.focus(); });
  document.getElementById("eA-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î Î™ÎÎ‘ÎšÎ•Î£")}\nÎ”Î¯Î½ÎµÏ„Î±Î¹ A=${lastMatrixLatex}\nÎ¥Ï€Î¿Î»ÏŒÎ³Î¹ÏƒÎµ e^A.`); textInput.focus(); });
  document.getElementById("dynsys-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î•Î¦Î‘Î¡ÎœÎŸÎ“Î—")}\nx_{k+1}=Ax_k Î¼Îµ A=${lastMatrixLatex}.`); textInput.focus(); });
  document.getElementById("ode-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(`${addToolHeader("Î•Î¦Î‘Î¡ÎœÎŸÎ“Î—")}\nx'(t)=Ax(t) Î¼Îµ A=${lastMatrixLatex}.`); textInput.focus(); });
  document.getElementById("exam-summary-btn").addEventListener("click", () => { if(!ensureMatrixInContext())return; appendToTextContext(diagonalizationChecklist()); textInput.focus(); });

  /* ===================== SERIES ===================== */
  const seriesFrom = document.getElementById("series-from");
  const seriesTo = document.getElementById("series-to");

  function seriesLatexFromTerm(term){
    const from = (seriesFrom.value || "").trim() || "1";
    let to = (seriesTo.value || "").trim() || "\\infty";
    if (to === "âˆ") to = "\\infty";
    const t = (term || "").trim() || "a_n";
    return `\\sum_{n=${from}}^{${to}} ${t}`;
  }
  function pushSeriesContext(latex){
    appendToTextContext(`${addToolHeader("Î£Î•Î™Î¡Î•Î£")}\nÎ£ÎµÎ¹ÏÎ¬: ${latex}\nÎ•ÏÏÏ„Î·ÏƒÎ·: Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î±/ÏƒÏÎ³ÎºÎ»Î¹ÏƒÎ·/ÎºÏÎ¹Ï„Î®ÏÎ¹Î¿/Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±.`);
  }
  document.getElementById("series-wrap-btn").addEventListener("click", () => {
    const selected = getSelectionText(mathInput).trim();
    const latex = seriesLatexFromTerm(selected || "a_n");
    if (selected) replaceSelection(mathInput, latex); else insertAtCursor(mathInput, latex);
    updateMathPreview();
    pushSeriesContext(latex);
    textInput.focus();
  });
  document.getElementById("series-clear-btn").addEventListener("click", () => { seriesFrom.value=""; seriesTo.value=""; });
  document.getElementById("series-to-text-btn").addEventListener("click", () => {
    const selected = getSelectionText(mathInput).trim();
    pushSeriesContext(seriesLatexFromTerm(selected || "a_n"));
    textInput.focus();
  });
  document.getElementById("series-geo-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î£Î•Î™Î¡Î•Î£")}\nÎ˜Î­Î»Ï‰ Î³ÎµÏ‰Î¼ÎµÏ„ÏÎ¹ÎºÎ® ÏƒÎµÎ¹ÏÎ¬: ÏƒÏÎ³ÎºÎ»Î¹ÏƒÎ·, Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î±, Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±.`); textInput.focus(); });
  document.getElementById("series-taylor-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î£Î•Î™Î¡Î•Î£")}\nÎ˜Î­Î»Ï‰ ÏƒÎµÎ¹ÏÎ¬ Taylor: Ï„ÏÏ€Î¿Ï‚, Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±, Ï€ÎµÏÎ¹Î¿Ï‡Î® ÏƒÏÎ³ÎºÎ»Î¹ÏƒÎ·Ï‚.`); textInput.focus(); });
  document.getElementById("series-test-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î£Î•Î™Î¡Î•Î£")}\nÎ”Î¹Î¬Î»ÎµÎ¾Îµ ÎºÎ±Ï„Î¬Î»Î»Î·Î»Î¿ ÎºÏÎ¹Ï„Î®ÏÎ¹Î¿ ÏƒÏÎ³ÎºÎ»Î¹ÏƒÎ·Ï‚ ÎºÎ±Î¹ Î´ÎµÎ¯Î¾Îµ Î²Î®Î¼Î±Ï„Î±.`); textInput.focus(); });

  /* ===================== STATS ===================== */
  const statsData = document.getElementById("stats-data");
  const statsResults = document.getElementById("stats-results");

  function parseNumbers(raw){
    const txt=(raw||"").replace(/\n/g,' ').replace(/;/g,' ').replace(/,/g,' ').trim();
    if(!txt) return [];
    const parts=txt.split(/\s+/).filter(Boolean);
    const nums=[];
    for(const p of parts){
      const v=Number(p.replace(',', '.'));
      if(Number.isFinite(v)) nums.push(v);
    }
    return nums;
  }
  function mean(arr){return arr.reduce((a,b)=>a+b,0)/arr.length}
  function median(arr){
    const a=[...arr].sort((x,y)=>x-y), n=a.length;
    return (n%2===1)?a[(n-1)/2]:(a[n/2-1]+a[n/2])/2;
  }
  function mode(arr){
    const m=new Map(); for(const x of arr) m.set(x,(m.get(x)||0)+1);
    let best=[], bestCount=0;
    for(const [k,c] of m.entries()){
      if(c>bestCount){bestCount=c; best=[k]}
      else if(c===bestCount){best.push(k)}
    }
    if(bestCount<=1) return [];
    return best.sort((a,b)=>a-b);
  }
  function variance(arr,sample=true){
    const mu=mean(arr), n=arr.length;
    const s=arr.reduce((acc,x)=>acc+(x-mu)*(x-mu),0);
    return sample?s/(n-1):s/n;
  }
  function fmt(x){
    if(!Number.isFinite(x)) return String(x);
    const abs=Math.abs(x);
    if(abs>=1000 || abs<0.001) return x.toExponential(4);
    return x.toFixed(4).replace(/\.?0+$/,'');
  }
  function statsSummary(nums){
    const n=nums.length, mu=mean(nums), med=median(nums), mo=mode(nums);
    const varP=variance(nums,false), sdP=Math.sqrt(varP);
    const varS=(n>=2)?variance(nums,true):NaN, sdS=(n>=2)?Math.sqrt(varS):NaN;
    const a=[...nums].sort((x,y)=>x-y);
    return {n,mu,med,mo,varP,sdP,varS,sdS,min:a[0],max:a[a.length-1],range:a[a.length-1]-a[0]};
  }
  function renderStatsBox(s){
    const lines=[];
    lines.push(`n = ${s.n}`);
    lines.push(`min = ${fmt(s.min)}, max = ${fmt(s.max)}, range = ${fmt(s.range)}`);
    lines.push(`Î¼Î­ÏƒÎ· Ï„Î¹Î¼Î® (xÌ„) = ${fmt(s.mu)}`);
    lines.push(`Î´Î¹Î¬Î¼ÎµÏƒÎ¿Ï‚ = ${fmt(s.med)}`);
    lines.push(`ÎµÏ€Î¹ÎºÏÎ±Ï„Î¿ÏÏƒÎ± = ${s.mo.length ? s.mo.map(fmt).join(', ') : 'â€”'}`);
    lines.push(`ÏƒÂ² (Ï€Î»Î·Î¸.) = ${fmt(s.varP)}   |   Ïƒ = ${fmt(s.sdP)}`);
    if(s.n>=2){ lines.push(`sÂ² (Î´ÎµÎ¯Î³Î¼Î±) = ${fmt(s.varS)} |   s = ${fmt(s.sdS)}`); }
    return lines.join("\n");
  }
  document.getElementById("stats-calc-btn").addEventListener("click", () => {
    const nums=parseNumbers(statsData.value);
    if(!nums.length){statsResults.textContent="Î”ÏÏƒÎµ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€ÏÏÏ„Î±.";return;}
    statsResults.textContent=renderStatsBox(statsSummary(nums));
  });
  document.getElementById("stats-insert-btn").addEventListener("click", () => {
    const nums=parseNumbers(statsData.value);
    if(!nums.length){statsResults.textContent="Î”ÏÏƒÎµ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€ÏÏÏ„Î±.";return;}
    const s=statsSummary(nums);
    appendToTextContext(`${addToolHeader("Î£Î¤Î‘Î¤Î™Î£Î¤Î™ÎšÎ—")}\nÎ”ÎµÎ´Î¿Î¼Î­Î½Î±: ${nums.join(", ")}\nÎ£ÏÎ½Î¿ÏˆÎ·:\n${renderStatsBox(s)}\n`);
    textInput.focus();
  });
  document.getElementById("stats-clear-btn").addEventListener("click", () => { statsData.value=""; statsResults.textContent=""; });
  document.getElementById("stats-ci-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î£Î¤Î‘Î¤Î™Î£Î¤Î™ÎšÎ—")}\nTemplate Î”Î¹Î¬ÏƒÏ„Î·Î¼Î± Î•Î¼Ï€Î¹ÏƒÏ„Î¿ÏƒÏÎ½Î·Ï‚: Î´ÏÏƒÎµ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ (Ï€.Ï‡. 95%), n, Ïƒ Î³Î½Ï‰ÏƒÏ„Î®/Î¬Î³Î½Ï‰ÏƒÏ„Î·.`); textInput.focus(); });
  document.getElementById("stats-z-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î£Î¤Î‘Î¤Î™Î£Î¤Î™ÎšÎ—")}\nTemplate z-score: z=(x-Î¼)/Ïƒ ÎºÎ±Î¹ ÎµÏÎ¼Î·Î½ÎµÎ¯Î±.`); textInput.focus(); });
  document.getElementById("stats-test-btn").addEventListener("click", () => { appendToTextContext(`${addToolHeader("Î£Î¤Î‘Î¤Î™Î£Î¤Î™ÎšÎ—")}\nTemplate ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¥Ï€ÏŒÎ¸ÎµÏƒÎ·Ï‚: H0/H1, Î±, ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏŒ (z Î® t), ÏƒÏ…Î¼Ï€Î­ÏÎ±ÏƒÎ¼Î±.`); textInput.focus(); });

  
    /* ===================== EXAMS (Generator) ===================== */
  // âœ… Î£Î¥ÎÎ”Î•Î•Î¤Î‘Î™ ÎœÎ• Î¤Î‘ IDs Î¤ÎŸÎ¥ Î”Î™ÎšÎŸÎ¥ Î£ÎŸÎ¥ HTML (exam-time, add-part-btn, ÎºÎ»Ï€)

  // Show BETA tab only with ?beta=1
  (function(){
    const beta = new URLSearchParams(location.search).get("beta");
    const tabBtn = document.getElementById("exam-tab-btn");
    if (tabBtn && beta === "1") tabBtn.style.display = "";
  })();

  const EX = {
    scale: document.getElementById("exam-scale"),
    step: document.getElementById("exam-step"),
    time: document.getElementById("exam-time"),
    diff: document.getElementById("exam-difficulty"),
    diffLabel: document.getElementById("exam-diff-label"),
    diffMix: document.getElementById("exam-diff-mix"),
    bloomTags: document.getElementById("bloom-tags"),

    book: document.getElementById("exam-book"),
    chapter: document.getElementById("exam-chapter"),
    pages: document.getElementById("exam-pages"),

    parts: document.getElementById("exam-parts"),
    sumPill: document.getElementById("exam-sum-pill"),
    addPart: document.getElementById("add-part-btn"),
    resetParts: document.getElementById("reset-parts-btn"),

    toText: document.getElementById("exam-to-text-btn"),
    gen: document.getElementById("exam-generate-btn"),
    status: document.getElementById("exam-status"),
  };

  const EX_GRADE = "G_LYKEIO_MATH_KAT";

  const BLOOM = [
    {key:"remember", label:"Î˜Ï…Î¼Î¬Î¼Î±Î¹"},
    {key:"understand", label:"ÎšÎ±Ï„Î±Î½Î¿Ï"},
    {key:"apply", label:"Î•Ï†Î±ÏÎ¼ÏŒÎ¶Ï‰"},
    {key:"analyze", label:"Î‘Î½Î±Î»ÏÏ‰"},
    {key:"evaluate", label:"Î‘Î¾Î¹Î¿Î»Î¿Î³Ï"},
    {key:"create", label:"Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Ï"},
  ];

  // Recommended distributions (ÏƒÎµ %), Î±Î½Î¬ Î´Ï…ÏƒÎºÎ¿Î»Î¯Î± 1..5
  const BLOOM_PRESETS = {
    1: [30, 35, 25,  8,  2,  0],
    2: [20, 30, 30, 15,  4,  1],
    3: [12, 25, 30, 20, 10,  3],
    4: [ 8, 18, 28, 24, 15,  7],
    5: [ 5, 12, 23, 27, 20, 13],
  };

  const DIFF_TEXT = {
    1: "1/5 â€¢ Î Î¿Î»Ï ÎµÏÎºÎ¿Î»Î¿",
    2: "2/5 â€¢ Î•ÏÎºÎ¿Î»Î¿",
    3: "3/5 â€¢ ÎœÎ­Ï„ÏÎ¹Î¿",
    4: "4/5 â€¢ Î”ÏÏƒÎºÎ¿Î»Î¿",
    5: "5/5 â€¢ Î Î¿Î»Ï Î´ÏÏƒÎºÎ¿Î»Î¿",
  };

  function exMsg(msg="", ok=true){
    if(!EX.status) return;
    EX.status.textContent = msg;
    EX.status.style.color = ok ? "#065f46" : "#dc2626";
    EX.status.style.fontWeight = "900";
  }

  function suggestedStep(scale){
    if (scale === 100) return 0.5;
    if (scale === 40) return 0.5;
    return 0.25; // 10/20
  }

  function isMultipleOfStep(x, step){
    const k = x / step;
    return Math.abs(k - Math.round(k)) < 1e-9;
  }

  function sum(arr){ return arr.reduce((a,b)=>a+b,0); }

  function renderBloom(diff){
    const p = BLOOM_PRESETS[diff] || BLOOM_PRESETS[3];
    EX.bloomTags.innerHTML = "";
    BLOOM.forEach((b, i) => {
      const s = document.createElement("span");
      s.className = "tag";
      s.textContent = `${b.label} ${p[i]}%`;
      EX.bloomTags.appendChild(s);
    });
    EX.diffLabel.textContent = DIFF_TEXT[diff] || `${diff}/5`;
    EX.diffMix.textContent =
      `Î ÏÏŒÏ„Î±ÏƒÎ· Î¼ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚: ${p[0]}% Î˜Ï…Î¼Î¬Î¼Î±Î¹ â€¢ ${p[1]}% ÎšÎ±Ï„Î±Î½Î¿Ï â€¢ ${p[2]}% Î•Ï†Î±ÏÎ¼ÏŒÎ¶Ï‰ â€¢ ${p[3]}% Î‘Î½Î±Î»ÏÏ‰ â€¢ ${p[4]}% Î‘Î¾Î¹Î¿Î»Î¿Î³Ï â€¢ ${p[5]}% Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Ï`;
  }

  function updateSumPill(){
    const scale = Number(EX.scale.value || 100);
    const step = Number(EX.step.value || 0.5);
    const parts = [...EX.parts.querySelectorAll(".part-row")];
    const pts = parts.map(r => Number(r.querySelector('[data-points]').value || 0));
    const total = sum(pts);

    let txt = `Î£ÏÎ½Î¿Î»Î¿: ${total}/${scale}`;
    let ok = true;

    if (!isMultipleOfStep(total, step)) { ok = false; txt += ` â€¢ âš  ÏŒÏ‡Î¹ Ï€Î¿Î»Î»Î±Ï€Î»Î¬ÏƒÎ¹Î¿ Ï„Î¿Ï… ${step}`; }
    if (Math.abs(total - scale) > 1e-9) { ok = false; txt += ` â€¢ âš  Î´ÎµÎ½ Î¹ÏƒÎ¿ÏÏ„Î±Î¹ Î¼Îµ ÎºÎ»Î¯Î¼Î±ÎºÎ±`; }

    EX.sumPill.textContent = txt;
    EX.sumPill.style.color = ok ? "#065f46" : "#b91c1c";
    return {total, ok};
  }

  function makePartName(idx){
    // Î‘, Î’, Î“, Î”, Î•...
    const letters = ["Î‘","Î’","Î“","Î”","Î•","Î–","Î—","Î˜","Î™","Îš","Î›","Îœ"];
    return (letters[idx] || `Îœ${idx+1}`) + " ÎœÎ­ÏÎ¿Ï‚";
  }

  function addPart({name, points, q} = {}){
    const idx = EX.parts.querySelectorAll(".part-row").length;
    const row = document.createElement("div");
    row.className = "part-row";
    row.innerHTML = `
      <div class="part-head">
        <div class="part-title">${(name || makePartName(idx)).replace(/</g,"&lt;")}</div>
        <button class="btn ghost" type="button" data-del>âœ• Î‘Ï†Î±Î¯ÏÎµÏƒÎ·</button>
      </div>

      <div class="inline3" style="margin-top:8px">
        <div>
          <div class="muted"><b>ÎŒÎ½Î¿Î¼Î± Î¼Î­ÏÎ¿Ï…Ï‚</b></div>
          <input type="text" data-name value="${(name || makePartName(idx)).replace(/"/g,"&quot;")}" />
        </div>
        <div>
          <div class="muted"><b>ÎœÎ¿Î½Î¬Î´ÎµÏ‚ Î¼Î­ÏÎ¿Ï…Ï‚</b></div>
          <input type="number" data-points min="0" step="0.25" value="${Number(points||0)}" />
        </div>
        <div>
          <div class="muted"><b>Î•ÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚</b></div>
          <input type="number" data-q min="0" step="1" value="${Number(q||0)}" />
        </div>
      </div>

      <div class="small" data-hint style="margin-top:6px"></div>
    `;

    const del = row.querySelector("[data-del]");
    const inName = row.querySelector("[data-name]");
    const inPts  = row.querySelector("[data-points]");
    const inQ    = row.querySelector("[data-q]");
    const hint   = row.querySelector("[data-hint]");

    function refresh(){
      const scale = Number(EX.scale.value || 100);
      const step = Number(EX.step.value || 0.5);
      const pts = Number(inPts.value || 0);
      const q = Number(inQ.value || 0);

      // enforce step
      if (pts && !isMultipleOfStep(pts, step)){
        hint.innerHTML = `<span class="danger">âš  ÎŸÎ¹ Î¼Î¿Î½Î¬Î´ÎµÏ‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Î»Î±Ï€Î»Î¬ÏƒÎ¹Î¿ Ï„Î¿Ï… ${step}.</span>`;
      } else {
        hint.textContent = "";
      }

      if (q > 0 && pts > 0){
        const per = pts / q;
        hint.textContent = `â‰ˆ ${per.toFixed(3)} Î¼Î¿Î½./ÎµÏÏÏ„Î·ÏƒÎ· (Î¸Î± Î¼Î¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯ ÏƒÏ„Î¿ Î²Î®Î¼Î± ${step})`;
      }

      updateSumPill();
      exMsg("");
    }

    del.addEventListener("click", () => { row.remove(); updateSumPill(); exMsg(""); });
    [inName, inPts, inQ].forEach(el => el.addEventListener("input", refresh));
    EX.parts.appendChild(row);
    refresh();
  }

  function resetParts(){
    EX.parts.innerHTML = "";
    const scale = Number(EX.scale.value || 100);
    // default: 2 Î¼Î­ÏÎ· Ï€Î¿Ï… â€œÎºÎ¬Î¸Î¿Î½Ï„Î±Î¹â€ ÏƒÏ„Î·Î½ ÎºÎ»Î¯Î¼Î±ÎºÎ±
    if (scale === 20){
      addPart({name:"Î‘ ÎœÎ­ÏÎ¿Ï‚", points:10, q:5});
      addPart({name:"Î’ ÎœÎ­ÏÎ¿Ï‚", points:10, q:3});
    } else if (scale === 10){
      addPart({name:"Î‘ ÎœÎ­ÏÎ¿Ï‚", points:5, q:3});
      addPart({name:"Î’ ÎœÎ­ÏÎ¿Ï‚", points:5, q:2});
    } else if (scale === 40){
      addPart({name:"Î‘ ÎœÎ­ÏÎ¿Ï‚", points:20, q:6});
      addPart({name:"Î’ ÎœÎ­ÏÎ¿Ï‚", points:20, q:4});
    } else {
      addPart({name:"Î‘ ÎœÎ­ÏÎ¿Ï‚", points:40, q:8});
      addPart({name:"Î’ ÎœÎ­ÏÎ¿Ï‚", points:60, q:6});
    }
    updateSumPill();
  }

  function getExamState(){
    const scale = Number(EX.scale.value || 100);
    const step = Number(EX.step.value || 0.5);
    const time = Number(EX.time.value || 0);
    const diff = Number(EX.diff.value || 3);
    const book_id = EX.book.value || "";
    const chapter_id = EX.chapter.value || "";
    const pages = (EX.pages.value || "").trim();

    const parts = [...EX.parts.querySelectorAll(".part-row")].map(r => ({
      name: (r.querySelector("[data-name]").value || "").trim(),
      points: Number(r.querySelector("[data-points]").value || 0),
      q: Number(r.querySelector("[data-q]").value || 0),
    }));

    return { grade: EX_GRADE, scale, step, time, diff, book_id, chapter_id, pages, parts };
  }

  function validateExam(st){
    const errs = [];
    if (!st.time || st.time <= 0) errs.push("Î’Î¬Î»Îµ Ï‰Ï†Î­Î»Î¹Î¼Î¿ Ï‡ÏÏŒÎ½Î¿ (Î»ÎµÏ€Ï„Î¬).");
    if (!st.parts.length) errs.push("Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 1 Î¼Î­ÏÎ¿Ï‚.");
    if (![0.25,0.5,1].includes(st.step)) errs.push("Î¤Î¿ min Î²Î®Î¼Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ 0.25 Î® 0.5 Î® 1.");

    const total = sum(st.parts.map(p => p.points));
    if (Math.abs(total - st.scale) > 1e-9) errs.push(`Î¤Î¿ Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î¼Î¿Î½Î¬Î´Ï‰Î½ (${total}) Î´ÎµÎ½ Î¹ÏƒÎ¿ÏÏ„Î±Î¹ Î¼Îµ ÎºÎ»Î¯Î¼Î±ÎºÎ± (${st.scale}).`);

    for (const p of st.parts){
      if (!p.name) errs.push("ÎšÎ¬Ï€Î¿Î¹Î¿ Î¼Î­ÏÎ¿Ï‚ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÏŒÎ½Î¿Î¼Î±.");
      if (!p.points || p.points <= 0) errs.push(`Î¤Î¿ Î¼Î­ÏÎ¿Ï‚ "${p.name || "?"}" Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ Î¼Î¿Î½Î¬Î´ÎµÏ‚ > 0.`);
      if (!isMultipleOfStep(p.points, st.step)) errs.push(`Î¤Î¿ Î¼Î­ÏÎ¿Ï‚ "${p.name}" Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ Î¼Î¿Î½Î¬Î´ÎµÏ‚ Ï€Î¿Î»Î»Î±Ï€Î»Î¬ÏƒÎ¹Î¿ Ï„Î¿Ï… ${st.step}.`);
      if (p.q < 0) errs.push(`Î¤Î¿ Î¼Î­ÏÎ¿Ï‚ "${p.name}" Î­Ï‡ÎµÎ¹ Î¬ÎºÏ…ÏÎ¿ Î±ÏÎ¹Î¸Î¼ÏŒ ÎµÏÏ‰Ï„Î®ÏƒÎµÏ‰Î½.`);
    }
    return errs;
  }

  function buildExamContext(st){
    const preset = BLOOM_PRESETS[st.diff] || BLOOM_PRESETS[3];
    const bloomLine = BLOOM.map((b,i)=>`${b.label}:${preset[i]}%`).join(" â€¢ ");
    const partsLine = st.parts.map(p => {
      const per = (p.q>0 && p.points>0) ? (p.points/p.q) : null;
      return `- ${p.name}: ${p.points}/${st.scale}` + (per ? ` (â‰ˆ ${per.toFixed(3)} Î¼Î¿Î½./ÎµÏÏÏ„Î·ÏƒÎ·, ${p.q} ÎµÏÏ‰Ï„.)` : "");
    }).join("\n");

    const scopeLine =
      `ÎÎ»Î· (source: scope.json):\n` +
      `- Î¤ÎµÏÏ‡Î¿Ï‚: ${st.book_id || "â€”"}\n` +
      `- ÎšÎµÏ†Î¬Î»Î±Î¹Î¿: ${st.chapter_id || "â€”"}\n` +
      (st.pages ? `- Î£ÎµÎ»Î¯Î´ÎµÏ‚: ${st.pages}\n` : "");

    return (
      `=== Î”Î™Î‘Î“Î©ÎÎ™Î£ÎœÎ‘ â€” Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£ ===\n` +
      `Grade: ${st.grade}\n` +
      `ÎšÎ»Î¯Î¼Î±ÎºÎ±: ${st.scale}/${st.scale}\n` +
      `Min Î²Î®Î¼Î±: ${st.step}\n` +
      `Î§ÏÏŒÎ½Î¿Ï‚: ${st.time} Î»ÎµÏ€Ï„Î¬\n` +
      `Î”Ï…ÏƒÎºÎ¿Î»Î¯Î±: ${DIFF_TEXT[st.diff] || st.diff}\n` +
      `Bloom (recommended): ${bloomLine}\n\n` +
      `${scopeLine}\n` +
      `Î”Î¿Î¼Î®:\n${partsLine}\n\n` +
      `ÎŸÎ´Î·Î³Î¯ÎµÏ‚:\n` +
      `- ÎÎ± Ï€Î±ÏÎ±Ï‡Î¸ÎµÎ¯ Î´Î¹Î±Î³ÏÎ½Î¹ÏƒÎ¼Î± Î­Ï„Î¿Î¹Î¼Î¿ Î³Î¹Î± ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ·.\n` +
      `- ÎÎ± Ï„Î·ÏÎ·Î¸Î¿ÏÎ½ Î±Ï…ÏƒÏ„Î·ÏÎ¬ Î¿Î¹ Î¼Î¿Î½Î¬Î´ÎµÏ‚ ÎºÎ±Î¹ Î· ÎºÎ»Î¯Î¼Î±ÎºÎ±.\n` +
      `- ÎÎ± Î³Î¯Î½ÎµÎ¹ Ï€Î¿Î¹ÎºÎ¹Î»Î¯Î± ÏƒÏÎ¼Ï†Ï‰Î½Î± Î¼Îµ Bloom.\n` +
      `- ÎÎ± ÎœÎ—Î Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½ ÏƒÎµÎ»Î¯Î´ÎµÏ‚/ÎµÎ½ÏŒÏ„Î·Ï„ÎµÏ‚ ÎµÎºÏ„ÏŒÏ‚ ÏÎ»Î·Ï‚.\n`
    );
  }

  async function loadScope(){
    // Î³ÎµÎ¼Î¯Î¶ÎµÎ¹ Î¤ÎµÏÏ‡Î¿Ï‚/ÎšÎµÏ†Î¬Î»Î±Î¹Î¿ Î±Ï€ÏŒ /v2/content/scope?grade=G_LYKEIO_MATH_KAT
    try{
      const res = await fetch(`${BASE_URL}/v2/content/scope?grade=${encodeURIComponent(EX_GRADE)}`);
      const data = await res.json();

      const books = Array.isArray(data.books) ? data.books : [];
      EX.book.innerHTML = "";
      books.forEach(b => {
        const opt = document.createElement("option");
        opt.value = b.book_id;
        opt.textContent = b.title || b.book_id;
        EX.book.appendChild(opt);
      });

      function fillChapters(){
        const bookId = EX.book.value;
        const book = books.find(x => x.book_id === bookId);
        const chapters = book?.chapters || [];
        EX.chapter.innerHTML = "";
        chapters.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.chapter_id;
          opt.textContent = `${c.chapter_id} â€¢ ${c.title}`;
          EX.chapter.appendChild(opt);
        });
      }

      EX.book.addEventListener("change", () => { fillChapters(); exMsg(""); });
      fillChapters();
    } catch(e){
      // Î±Î½ fail, Î´ÎµÎ½ ÏƒÏ€Î¬Î¼Îµ Ï„Î¯Ï€Î¿Ï„Î±
      exMsg("âš ï¸ Î”ÎµÎ½ Ï†ÏŒÏÏ„Ï‰ÏƒÎµ scope (Î´ÎµÏ‚ grade folder & endpoint).", false);
    }
  }

  function wireExam(){
    if (!EX.scale || !EX.step || !EX.time || !EX.diff || !EX.parts) return;

    // init defaults
    const s = Number(EX.scale.value || 100);
    EX.step.value = String(suggestedStep(s));
    renderBloom(Number(EX.diff.value || 3));
    resetParts();

    EX.scale.addEventListener("change", () => {
      const scale = Number(EX.scale.value || 100);
      EX.step.value = String(suggestedStep(scale));
      resetParts();
      exMsg("");
    });

    EX.step.addEventListener("change", () => { updateSumPill(); exMsg(""); });

    EX.diff.addEventListener("input", () => {
      renderBloom(Number(EX.diff.value || 3));
      exMsg("");
    });

    EX.addPart.addEventListener("click", () => {
      addPart({name: makePartName(EX.parts.querySelectorAll(".part-row").length), points: 0, q: 0});
      updateSumPill();
    });

    EX.resetParts.addEventListener("click", () => { resetParts(); exMsg(""); });

    EX.toText.addEventListener("click", () => {
      const st = getExamState();
      const errs = validateExam(st);
      if (errs.length){ exMsg("âŒ " + errs[0], false); return; }
      appendToTextContext(buildExamContext(st));
      exMsg("âœ… Î Î®Î³Î±Î½ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® Ï‰Ï‚ context.", true);
      textInput.focus();
    });

    EX.gen.addEventListener("click", async () => {
      const st = getExamState();
      const errs = validateExam(st);
      if (errs.length){ exMsg("âŒ " + errs[0], false); return; }

      const prompt = buildExamContext(st) + "\n\nÎ Î±ÏÎ®Î³Î±Î³Îµ Ï„Î¿ Î´Î¹Î±Î³ÏÎ½Î¹ÏƒÎ¼Î± Ï„ÏÏÎ±.";
      lastPromptSent =
        (currentLevel === "lyceum"
          ? "ÎÎ± Î³ÏÎ±Ï†Ï„ÎµÎ¯ Î¼Îµ Î¼Î±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ¬ ÎµÏ€Î¹Ï€Î­Î´Î¿Ï… Î›Ï…ÎºÎµÎ¯Î¿Ï…. Î‘Ï€ÏŒÏ†Ï…Î³Îµ Ï€Î±Î½ÎµÏ€Î¹ÏƒÏ„Î·Î¼Î¹Î±ÎºÎ­Ï‚ Î¼ÎµÎ¸ÏŒÎ´Î¿Ï…Ï‚.\n\n"
          : "ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ­Ï‚ Ï€Î±Î½ÎµÏ€Î¹ÏƒÏ„Î·Î¼Î¹Î±ÎºÎ¿Ï ÎµÏ€Î¹Ï€Î­Î´Î¿Ï…, Î±Î»Î»Î¬ ÎºÎ±Î¸Î±ÏÎ¬.\n\n"
        ) + prompt;

      await askAI(lastPromptSent);
      exMsg("âœ… Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î´Î¹Î±Î³ÏÎ½Î¹ÏƒÎ¼Î± ÏƒÏ„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.", true);
    });

    // update pill on inputs
    EX.parts.addEventListener("input", () => updateSumPill());
    updateSumPill();

    // scope
    loadScope();
  }

  wireExam();

  /* ===================== INK MODAL ===================== */
  (function(){
    const $ = (id) => document.getElementById(id);

    const bd = $("ink-backdrop");
    const btnOpen = $("open-ink-btn");
    const btnClose = $("ink-close");

    const cMath = $("ink-math-canvas");
    const cText = $("ink-text-canvas");

    const colorEl = $("ink-color");
    const sizeEl = $("ink-size");
    const sizeVal = $("ink-size-val");

    const btnMathToMain = $("ink-math-to-main");
    const btnTextToMain = $("ink-text-to-main");
    const btnMathClear = $("ink-math-clear");
    const btnTextClear = $("ink-text-clear");

    const inkTransferStatus = $("ink-transfer-status");

    let ctxMath = null;
    let ctxText = null;
    let inkBusy = false;

    function setInkMsg(msg="", ok=true){
      inkTransferStatus.textContent = msg;
      inkTransferStatus.style.color = ok ? "#065f46" : "#dc2626";
      inkTransferStatus.style.fontWeight = "950";
      inkTransferStatus.style.fontSize = "1rem";
    }

    function setInkStyle(ctx){
      if(!ctx) return;
      const color = colorEl?.value || "#111827";
      const size = Number(sizeEl?.value || 4);
      if(sizeVal) sizeVal.textContent = String(size);
      ctx.strokeStyle = color;
      ctx.lineWidth = size;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
    }

    function resizeCanvas(canvas){
      if(!canvas) return null;
      const wrap = canvas.closest(".ink-wrap");
      if(!wrap) return null;

      const rect = wrap.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      canvas.width  = Math.max(1, Math.floor(rect.width  * dpr));
      canvas.height = Math.max(1, Math.floor(rect.height * dpr));

      canvas.style.width  = rect.width + "px";
      canvas.style.height = rect.height + "px";

      const ctx = canvas.getContext("2d");
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      setInkStyle(ctx);
      return ctx;
    }

    function openInk(){
      setInkMsg("");
      bd.classList.add("show");
      bd.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
      ctxMath = resizeCanvas(cMath);
      ctxText = resizeCanvas(cText);
      setTimeout(() => btnClose?.focus(), 30);
    }

    function closeInk(){
      bd.classList.remove("show");
      bd.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
      inkBusy = false;
      unlockInkButtons();
    }

    function lockInkButtons(){
      inkBusy = true;
      btnMathToMain.disabled = true;
      btnTextToMain.disabled = true;
      btnMathClear.disabled = true;
      btnTextClear.disabled = true;
      btnClose.disabled = true;
    }
    function unlockInkButtons(){
      inkBusy = false;
      btnMathToMain.disabled = false;
      btnTextToMain.disabled = false;
      btnMathClear.disabled = false;
      btnTextClear.disabled = false;
      btnClose.disabled = false;
    }

    function clearCanvas(canvas, ctx){
      if(!canvas || !ctx) return;
      ctx.save();
      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.restore();
    }

    function getPos(canvas, ev){
      const r = canvas.getBoundingClientRect();
      return { x: ev.clientX - r.left, y: ev.clientY - r.top };
    }

    function bindDraw(canvas, getCtx){
      let drawing = false;
      let activePointerId = null;
      let lastX = 0, lastY = 0;

      function start(ev){
        const ctx = getCtx();
        if(!ctx) return;
        if(activePointerId !== null && ev.pointerId !== activePointerId) return;
        activePointerId = ev.pointerId;
        drawing = true;
        setInkStyle(ctx);
        const p = getPos(canvas, ev);
        lastX = p.x; lastY = p.y;
        try{ canvas.setPointerCapture(ev.pointerId); }catch(e){}
        ev.preventDefault();
      }

      function move(ev){
        const ctx = getCtx();
        if(!ctx || !drawing || ev.pointerId !== activePointerId) return;
        const p = getPos(canvas, ev);
        const pressure = (typeof ev.pressure === "number" && ev.pressure > 0) ? ev.pressure : 0.5;
        const base = Number(sizeEl?.value || 4);
        ctx.lineWidth = base * (0.75 + pressure * 0.9);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        lastX = p.x; lastY = p.y;
        ev.preventDefault();
      }

      function end(ev){
        if(ev.pointerId !== activePointerId) return;
        drawing = false;
        try{ canvas.releasePointerCapture(ev.pointerId); }catch(e){}
        activePointerId = null;
        ev.preventDefault();
      }

      canvas.addEventListener("pointerdown", start, {passive:false});
      canvas.addEventListener("pointermove", move, {passive:false});
      canvas.addEventListener("pointerup", end, {passive:false});
      canvas.addEventListener("pointercancel", end, {passive:false});
      canvas.addEventListener("pointerleave", end, {passive:false});
    }

    async function canvasToBlob(canvas){
      return await new Promise(resolve => canvas.toBlob(b => resolve(b), "image/png", 0.92));
    }

    function cleanRecognitionText(txt){
      const t = (txt || "").replace(/\r/g,"").trim();
      if(!t) return "";
      return t.split("\n").map(x=>x.trim()).filter(Boolean).slice(0,10).join("\n");
    }

    async function recognizeFromCanvas(canvas, kind){
      const blob = await canvasToBlob(canvas);
      if(!blob) return "";

      setInkMsg(kind === "math" ? "â³ Î”Î¹Î±Î²Î¬Î¶Ï‰ Î¼Î±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ¬â€¦" : "â³ Î”Î¹Î±Î²Î¬Î¶Ï‰ ÎºÎµÎ¯Î¼ÎµÎ½Î¿â€¦", true);

      const prompt = (kind === "math")
        ? "Î‘Î½Î±Î³Î½ÏÏÎ¹ÏƒÎµ Ï„Î·Î½ ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ— Î•ÎšÎ¦Î¡Î‘Î£Î— Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Î³ÏÎ±Î¼Î¼Î­Î½Î· ÏƒÏ„Î·Î½ ÎµÎ¹ÎºÏŒÎ½Î±.\nÎ•Î Î™Î£Î¤Î¡Î•Î¨Î• ÎœÎŸÎÎŸ Ï„Î·Î½ Î­ÎºÏ†ÏÎ±ÏƒÎ· ÏƒÎµ Î±Ï€Î»ÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ (Ï‡Ï‰ÏÎ¯Ï‚ ÎµÎ¾Î·Î³Î®ÏƒÎµÎ¹Ï‚).\nÎœÎ·Î½ Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Ï€ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚."
        : "Î”Î¹Î¬Î²Î±ÏƒÎµ Ï„Î¿ Ï‡ÎµÎ¹ÏÏŒÎ³ÏÎ±Ï†Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ ÏƒÏ„Î·Î½ ÎµÎ¹ÎºÏŒÎ½Î± ÎºÎ±Î¹ ÎµÏ€Î­ÏƒÏ„ÏÎµÏˆÎµ Ï„Î¿ Ï‰Ï‚ Î±Ï€Î»ÏŒ ÎºÎµÎ¯Î¼ÎµÎ½Î¿.\nÎ•Î Î™Î£Î¤Î¡Î•Î¨Î• ÎœÎŸÎÎŸ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ (Ï‡Ï‰ÏÎ¯Ï‚ ÏƒÏ‡ÏŒÎ»Î¹Î±).\nÎ‘Î½ Î´ÎµÎ½ Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ Ï„Î¯Ï€Î¿Ï„Î±, ÎµÏ€Î­ÏƒÏ„ÏÎµÏˆÎµ ÎºÎµÎ½ÏŒ.";

      const formData = new FormData();
      formData.append("image", new File([blob], kind === "math" ? "ink_math.png" : "ink_text.png", {type:"image/png"}));
      formData.append("question", prompt);
      formData.append("level", currentLevel);

      try{
        const res = await fetch(`${BASE_URL}/check-image`, { method:"POST", body: formData });
        const data = await res.json();
        return cleanRecognitionText(data.answer || "");
      }catch(e){
        setInkMsg("âŒ Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ (/check-image).", false);
        return "";
      }
    }

    function appendMathOnce(text){
      const toAdd = (text || "").trim();
      if(!toAdd) return false;
      if(mathInput.value.includes(toAdd)) return false;
      const prefix = mathInput.value.trim() ? "\n" : "";
      mathInput.value = mathInput.value + prefix + toAdd;
      return true;
    }

    function appendTextOnce(text){
      const toAdd = (text || "").trim();
      if(!toAdd) return false;
      if(textInput.value.includes(toAdd)) return false;
      const prefix = textInput.value.trim() ? "\n\n" : "";
      textInput.value = textInput.value + prefix + toAdd;
      return true;
    }

    btnOpen.addEventListener("click", openInk);
    btnClose.addEventListener("click", () => { if(!inkBusy) closeInk(); });
    bd.addEventListener("click", (e) => { if(e.target === bd && !inkBusy) closeInk(); });

    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && bd.classList.contains("show") && !inkBusy) closeInk();
    });

    window.addEventListener("resize", () => {
      if(bd.classList.contains("show")){
        ctxMath = resizeCanvas(cMath);
        ctxText = resizeCanvas(cText);
      }
    }, {passive:true});

    sizeEl.addEventListener("input", () => { setInkStyle(ctxMath); setInkStyle(ctxText); });
    colorEl.addEventListener("input", () => { setInkStyle(ctxMath); setInkStyle(ctxText); });

    btnMathClear.addEventListener("click", () => { if(inkBusy) return; clearCanvas(cMath, ctxMath); setInkMsg(""); });
    btnTextClear.addEventListener("click", () => { if(inkBusy) return; clearCanvas(cText, ctxText); setInkMsg(""); });

    btnMathToMain.addEventListener("click", async () => {
      if(inkBusy) return;
      lockInkButtons();
      try{
        const recognized = (await recognizeFromCanvas(cMath, "math")).trim();
        if(!recognized){ setInkMsg("âŒ Î”ÎµÎ½ Î±Î½Î±Î³Î½Ï‰ÏÎ¯ÏƒÏ„Î·ÎºÎµ Ï„Î¯Ï€Î¿Ï„Î±.", false); return; }
        const finalText = greekToEnglishMath(recognized);
        const ok = appendMathOnce(finalText);
        await updateMathPreview();
        setInkMsg(ok ? "âœ… Î ÎµÏÎ¬ÏƒÏ„Î·ÎºÎµ ÏƒÏ„Î· ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® ÎˆÎºÏ†ÏÎ±ÏƒÎ·." : "â„¹ï¸ Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÏƒÏ„Î· ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ®.", ok);
        closeInk();
      } finally {
        unlockInkButtons();
      }
    });

    btnTextToMain.addEventListener("click", async () => {
      if(inkBusy) return;
      lockInkButtons();
      try{
        const recognized = (await recognizeFromCanvas(cText, "text")).trim();
        if(!recognized){ setInkMsg("âŒ Î”ÎµÎ½ Î±Î½Î±Î³Î½Ï‰ÏÎ¯ÏƒÏ„Î·ÎºÎµ Ï„Î¯Ï€Î¿Ï„Î±.", false); return; }
        const ok = appendTextOnce(recognized);
        setInkMsg(ok ? "âœ… Î ÎµÏÎ¬ÏƒÏ„Î·ÎºÎµ ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ® Î‘Ï€Î¿ÏÎ¯Î±." : "â„¹ï¸ Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÏƒÏ„Î· Î›ÎµÎºÏ„Î¹ÎºÎ®.", ok);
        closeInk();
      } finally {
        unlockInkButtons();
      }
    });

    bindDraw(cMath, () => ctxMath);
    bindDraw(cText, () => ctxText);
  })();

  /* ===================== INIT ===================== */
  resetImageUI();
  updateMathPreview();
  updateMatrixPreview();
  updateSavedInfo();
     resetImageUI();
     updateMathPreview();
     updateMatrixPreview();
     updateSavedInfo();
  
</script>

</body>
</html>


  

