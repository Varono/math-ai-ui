<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="format-detection" content="telephone=no" />
  <title>Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI â€“ Î”Ï. ÎœÎ±ÏÎ¯Î½Î¿Ï‚ Î•Ï…ÏƒÏ„Î±Î¸Î¯Î¿Ï…</title>

  <!-- MathJax -->
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:#f5f7fb;color:#111827;font-size:14px}
    main{width:100%;max-width:none;margin:0;padding:12px}

    h1{margin:4px 0 2px 0;font-size:1.2rem}
    .subtitle{margin:0 0 6px 0;font-size:.8rem;color:#4b5563}
    .edu-note-small{font-size:.75rem;color:#6b7280;margin-bottom:8px}

    .top-grid{display:grid;gap:10px}
    @media(min-width:980px){ .top-grid{grid-template-columns:1.35fr .65fr} }

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 8px 20px rgba(15,23,42,.05);padding:10px;margin-bottom:10px}
    label{font-weight:800;font-size:.9rem}
    .muted{color:#64748b;font-size:.78rem}

    textarea,input[type="text"],input[type="number"]{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-family:"JetBrains Mono",ui-monospace,monospace;
      font-size:.9rem
    }
    textarea{min-height:70px}
    textarea:focus,input:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.12);outline:none}
    @media(max-width:650px){ textarea,input[type="text"],input[type="number"]{font-size:16px} }

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}

    /* Buttons (ÏƒÏ„Î±Î¸ÎµÏÏŒ naming) */
    .btn{
      border:0;border-radius:999px;
      padding:6px 10px;font-weight:800;
      cursor:pointer;font-size:.8rem;
      touch-action:manipulation;white-space:nowrap;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn-primary{background:#2563eb;color:#fff}
    .btn-ghost{background:#eef2ff;color:#1e3a8a}
    .btn-dark{background:#111827;color:#fff}
    .btn-soft{background:#f1f5f9;color:#0f172a}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .divider{height:1px;background:#e5e7eb;margin:10px 0}

    #math-preview-box{
      margin-top:6px;border-radius:10px;border:1px dashed #cbd5e1;
      padding:6px 8px;background:#f9fafb;min-height:34px;
      font-size:.9rem;color:#0f172a
    }
    #math-preview-placeholder{color:#94a3b8;font-size:.75rem}
    .level-btn.active{background:#2563eb;color:#fff}

    .kbd{background:#eef2ff;border:1px solid #e5e7eb;border-radius:14px;padding:8px;margin-top:10px}
    .tabs{display:flex;gap:4px;flex-wrap:wrap}
    .tab{border:0;border-radius:999px;padding:4px 10px;background:#e5e7eb;cursor:pointer;font-weight:800;font-size:.75rem;touch-action:manipulation}
    .tab.active{background:#2563eb;color:#fff}
    .keys{margin-top:6px}
    .key{
      border:0;border-radius:9px;padding:6px 8px;background:#fff;margin:2px;
      cursor:pointer;font-family:"JetBrains Mono",ui-monospace,monospace;
      font-size:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.12);
      touch-action:manipulation
    }

    .imgwrap{display:grid;gap:8px;margin-top:6px}
    .preview{width:100%;max-height:280px;object-fit:contain;border-radius:12px;border:1px dashed #cbd5e1;background:#fff}

    .answer{white-space:pre-wrap;border:1px solid #e5e7eb;border-radius:12px;padding:10px;min-height:80px;background:#fafafa;font-size:.9rem}
    #answer-card{scroll-margin-top:14px}

    .continue-box{margin-top:10px;border-top:1px solid #e5e7eb;padding-top:10px;display:none}
    .continue-q{font-weight:900;font-size:.85rem;margin-bottom:6px;color:#0f172a}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:14px;
      z-index:9999;
      background:rgba(17,24,39,.92);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      box-shadow:0 12px 28px rgba(0,0,0,.22);
      display:none;
      align-items:center;
      gap:10px;
      max-width:92vw;
      font-size:.85rem;
      backdrop-filter: blur(6px);
    }
    .toast .toast-btn{
      border:0;
      background:#2563eb;
      color:#fff;
      font-weight:900;
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      touch-action:manipulation;
      white-space:nowrap;
    }

    .tools-header{display:flex;gap:10px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    .tool-tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tool-tab{border:0;border-radius:999px;padding:8px 14px;background:#e5e7eb;cursor:pointer;font-weight:900;font-size:.82rem;touch-action:manipulation}
    .tool-tab.active{background:#111827;color:#fff}
    .tool-panel{display:none;margin-top:10px}
    .tool-panel.active{display:block}

    .mini-card{border:1px solid #e5e7eb;border-radius:14px;padding:10px;background:#fafafa;height:100%}
    .mini-title{font-weight:950;font-size:.86rem;margin-bottom:8px;color:#0f172a}
    .result-box{border:1px dashed #cbd5e1;border-radius:12px;padding:8px 10px;background:#fff;min-height:52px}
    .mono{font-family:"JetBrains Mono",ui-monospace,monospace}

    .matrix-wide{display:grid;gap:10px}
    @media(min-width:1100px){ .matrix-wide{grid-template-columns:1fr 1fr 1.25fr} }
    @media(min-width:820px) and (max-width:1099px){ .matrix-wide{grid-template-columns:1fr 1fr} }

    .two-col{display:grid;gap:10px}
    @media(min-width:920px){ .two-col{grid-template-columns:1.1fr .9fr} }

    .inline-inputs{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:end}

    @media(max-width:650px){
      .btn{padding:10px 14px;font-size:14px}
      .tool-tab{padding:10px 14px}
      .tab{padding:8px 12px}
      .key{padding:10px 10px}
      .toast{font-size:14px}
      .toast .toast-btn{padding:10px 14px}
    }

    .footer-note{font-size:.78rem;color:#4b5563;line-height:1.4}

    /* --- Ink modal (Render-stable) --- */
    .ink-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      z-index:9998;
      padding:18px;
    }
    .ink-backdrop.show{display:block;}
    .ink-modal{
      max-width:1100px; margin:0 auto;
      background:#fff; border-radius:16px;
      overflow:hidden;
      box-shadow:0 14px 40px rgba(0,0,0,.25);
      height:calc(100vh - 36px);
      display:flex; flex-direction:column;
      position:relative;
    }
    .ink-header{
      background:#0f172a; color:#fff;
      padding:14px 16px;
      display:flex; align-items:center; gap:12px;
    }
    .ink-title{font-weight:800;}
    .ink-close{
      margin-left:auto;
      border:0;
      background:rgba(255,255,255,.14);
      color:#fff;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
    }
    .ink-body{
      padding:14px 16px;
      overflow:auto;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .ink-row{display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap;}
    .ink-col{flex:1; min-width:280px;}
    .ink-col-right{flex:0 0 420px; max-width:420px;}

    .field-label{font-weight:900;font-size:.9rem;margin-bottom:6px;color:#0f172a}

    .ink-tools{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      border-radius:12px;
      padding:10px;
    }
    .tool{display:flex; align-items:center; gap:8px;}
    .tool-wide{flex:1; min-width:240px;}
    .tool input[type="range"]{width:100%;}
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:32px; height:28px; padding:0 8px;
      border-radius:999px; background:#fff;
      border:1px solid #dbeafe; font-weight:900;
    }

    .ink-actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .ink-canvas-wrap{
      flex:1;
      min-height:360px;               /* <- ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÏŒ Î³Î¹Î± desktop */
      height:min(62vh, 640px);        /* <- ÏƒÏ„Î±Î¸ÎµÏÎ®/Î¿ÏÎ±Ï„Î® Ï€ÎµÏÎ¹Î¿Ï‡Î® */
      border:1px dashed #cbd5e1;
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    #ink-canvas{
      width:100%;
      height:100%;
      display:block;
      touch-action:none;
      pointer-events:auto;
    }
    @media (max-width: 900px){
      .ink-col-right{flex:1; max-width:none;}
      .ink-modal{height:calc(100vh - 20px);}
      .ink-backdrop{padding:10px;}
      .ink-canvas-wrap{min-height:320px;}
    }
  </style>
</head>

<body>
<main>
  <h1>Î’Î¿Î·Î¸ÏŒÏ‚ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½ AI</h1>
  <p class="subtitle">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÏŒÏ‚: Î”Ï. ÎœÎ±ÏÎ¯Î½Î¿Ï‚ Î•Ï…ÏƒÏ„Î±Î¸Î¯Î¿Ï… â€“ ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏŒÏ‚ (MSc) Î¼Îµ PhD ÏƒÏ„Î± Î Î±Î¹Î´Î±Î³Ï‰Î³Î¹ÎºÎ¬ / Î“Î½Ï‰ÏƒÏ„Î¹ÎºÎ® Î¨Ï…Ï‡Î¿Î»Î¿Î³Î¯Î±</p>
  <p class="edu-note-small">Î¤Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Î±Ï…Ï„ÏŒ Î­Ï‡ÎµÎ¹ Î±Î½Î±Ï€Ï„Ï…Ï‡Î¸ÎµÎ¯ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ Î³Î¹Î± ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿ÏÏ‚ ÏƒÎºÎ¿Ï€Î¿ÏÏ‚.</p>

  <div class="top-grid">
    <div class="card">
      <label for="math-input">ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® Î­ÎºÏ†ÏÎ±ÏƒÎ·</label>
      <textarea id="math-input" placeholder="Ï€.Ï‡. âˆ« x/(x+1) dx, ..."></textarea>

      <div id="math-preview-box">
        <span id="math-preview-placeholder">Î— Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ ÎµÎ´Ï ÎºÎ±Î¸ÏÏ‚ Î³ÏÎ¬Ï†ÎµÎ¹Ï‚â€¦</span>
        <div id="math-preview"></div>
      </div>

      <div style="margin-top:10px">
        <label for="text-input">Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±</label>
        <textarea id="text-input" placeholder="Î¡ÏÏ„Î± ÎµÎ´Ï Î¿Ï„Î¹Î´Î®Ï€Î¿Ï„Îµ (ÎºÎ±Î¹ Î³Î¹Î± Î Î¯Î½Î±ÎºÎµÏ‚/Î£ÎµÎ¹ÏÎ­Ï‚/Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ®)."></textarea>

        <div class="row" style="margin-top:4px">
          <span class="muted"><b>Î•Ï€Î¯Ï€ÎµÎ´Î¿ Î»ÏÏƒÎ·Ï‚:</b></span>
          <button class="btn btn-ghost level-btn active" data-level="lyceum" type="button">Î›ÏÎºÎµÎ¹Î¿</button>
          <button class="btn btn-ghost level-btn" data-level="university" type="button">Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿</button>
        </div>

        <div class="row">
          <button class="btn btn-primary" id="ask-btn" type="button">Î¡ÏÏ„Î± Ï„Î¿ AI</button>
          <button class="btn btn-ghost" id="clear-btn" type="button">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
          <span class="muted" id="status"></span>
        </div>
        <div class="muted">Endpoint: <b>/ask</b> (JSON).</div>
      </div>

      <div class="kbd">
        <div class="tabs">
          <button class="tab active" data-layout="num" type="button">123</button>
          <button class="tab" data-layout="func" type="button">f(x)</button>
          <button class="tab" data-layout="abc" type="button">ABC</button>
          <button class="tab" data-layout="sym" type="button">#&Â¬</button>
        </div>
        <div id="keyboard-rows" class="keys"></div>
      </div>
    </div>

    <div class="card">
      <label>ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î»ÏÏƒÎ·Ï‚ Î±Ï€ÏŒ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</label>
      <div class="imgwrap">
        <input type="file" id="image-input" accept="image/*">
        <img id="img-preview" class="preview" alt="Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚" />
      </div>
      <div class="row">
        <button class="btn btn-primary" id="check-image-btn" disabled type="button">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚</button>
        <button class="btn btn-ghost" id="remove-img-btn" disabled type="button">Î‘Ï†Î±Î¯ÏÎµÏƒÎ·</button>
      </div>

      <!-- Ink button -->
      <div class="card" style="margin-top:14px;">
        <div class="mini-title">âœï¸ Î Î¯Î½Î±ÎºÎ±Ï‚ Î“ÏÎ±Ï†Î®Ï‚ (stylus / touch / mouse)</div>
        <div class="muted" style="margin:6px 0 10px;">
          Î™Î´Î±Î½Î¹ÎºÏŒ Î³Î¹Î± tablet/iPad Î±Î»Î»Î¬ Î´Î¿Ï…Î»ÎµÏÎµÎ¹ ÎºÎ±Î¹ ÏƒÎµ laptop Î¼Îµ Ï€Î¿Î½Ï„Î¯ÎºÎ¹. Î“ÏÎ¬Ï†ÎµÎ¹Ï‚ Î»ÏÏƒÎ· ÎºÎ±Î¹ Î¶Î·Ï„Î¬Ï‚ hint/Î´Î¹ÏŒÏÎ¸Ï‰ÏƒÎ·.
        </div>
        <button id="open-ink-btn" class="btn btn-dark" type="button">âœï¸ Î†Î½Î¿Î¹Î¾Îµ Î Î¯Î½Î±ÎºÎ± Î“ÏÎ±Ï†Î®Ï‚</button>
      </div>

      <div class="muted">Î— Î¯Î´Î¹Î± Î»ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î± ÎºÎ±Î¹ Ï„Î¿ Î¯Î´Î¹Î¿ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ Î¸Î± ÏƒÏ„Î±Î»Î¿ÏÎ½ Î¼Î±Î¶Î¯ Î¼Îµ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±.</div>
    </div>
  </div>

  <!-- Answer -->
  <div class="card" id="answer-card">
    <label>Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· AI</label>
    <div id="ai-answer" class="answer">Î ÎµÏÎ¹Î¼Î­Î½Ï‰ Ï„Î·Î½ Ï€ÏÏÏ„Î· ÏƒÎ¿Ï… ÎµÏÏÏ„Î·ÏƒÎ·â€¦</div>

    <div id="continue-box" class="continue-box">
      <div class="continue-q">ÎÎ± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÏ‰;</div>
      <div class="row">
        <button class="btn btn-dark" id="continue-yes" type="button">ÎÎ‘Î™</button>
        <button class="btn btn-ghost" id="continue-no" type="button">ÎŸÎ§Î™</button>
        <span class="muted" id="continue-status"></span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="footer-note">
      <strong>Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ® ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·:</strong><br>
      Î¤Î¿ Ï€Î±ÏÏŒÎ½ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ Ï€ÏÎ¿Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ <strong>Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ Î³Î¹Î± ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Ï„Î¹ÎºÎ¿ÏÏ‚ ÏƒÎºÎ¿Ï€Î¿ÏÏ‚</strong>.
    </div>
  </div>
</main>

<!-- Toast -->
<div id="answer-toast" class="toast" role="status" aria-live="polite">
  <span>âœ… Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¿ ÎºÎ¬Ï„Ï‰.</span>
  <button id="toast-go" class="toast-btn" type="button">Î”ÎµÏ‚ Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·</button>
</div>

<!-- INK MODAL -->
<div id="ink-backdrop" class="ink-backdrop" aria-hidden="true">
  <div id="ink-modal" class="ink-modal" role="dialog" aria-modal="true" aria-label="Î Î¯Î½Î±ÎºÎ±Ï‚ Î³ÏÎ±Ï†Î®Ï‚">
    <div class="ink-header">
      <div class="ink-title">âœï¸ Î Î¯Î½Î±ÎºÎ±Ï‚ Î“ÏÎ±Ï†Î®Ï‚ â€“ Î³ÏÎ¬ÏˆÎµ Î¬Î½ÎµÏ„Î± Î¼Îµ Ï€Î­Î½Î±/Î´Î¬Ï‡Ï„Ï…Î»Î¿/Ï€Î¿Î½Ï„Î¯ÎºÎ¹</div>
      <button id="ink-close" class="ink-close" type="button">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ âœ•</button>
    </div>

    <div class="ink-body">
      <div class="ink-row">
        <div class="ink-col">
          <div class="field-label">Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î± Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ Î²Î®Î¼Î±</div>
          <textarea id="ink-question" rows="2" placeholder="Ï€.Ï‡. Î³Î¹Î±Ï„Î¯ ÎµÎ´Ï Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï€ÏÏŒÏƒÎ·Î¼Î¿; / Î¼Ï€Î¿ÏÏ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ‰ Î±Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·;"></textarea>
        </div>

        <div class="ink-col ink-col-right">
          <div class="field-label">Î•ÏÎ³Î±Î»ÎµÎ¯Î± Î³ÏÎ±Ï†Î®Ï‚</div>
          <div class="ink-tools">
            <label class="tool">
              <span>Î§ÏÏÎ¼Î±</span>
              <input id="ink-color" type="color" value="#000000">
            </label>

            <label class="tool tool-wide">
              <span>Î Î¬Ï‡Î¿Ï‚</span>
              <input id="ink-size" type="range" min="1" max="18" value="4" step="1">
              <span id="ink-size-val" class="pill">4</span>
            </label>

            <button id="ink-clear" class="btn btn-ghost" type="button">ğŸ§½ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ</button>
          </div>
        </div>
      </div>

      <div class="ink-actions">
        <button id="ink-check" class="btn btn-primary" type="button">âœ… ÎˆÎ»ÎµÎ³Î¾Îµ Î²Î®Î¼Î±</button>
        <button id="ink-hint" class="btn btn-soft" type="button">ğŸ’­ Î”ÏÏƒÎµ hint</button>
        <div class="muted" style="margin-left:auto;">Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î¼Îµ Ï€Î¿Î½Ï„Î¯ÎºÎ¹, touch ÎºÎ±Î¹ stylus.</div>
      </div>

      <div class="ink-canvas-wrap">
        <canvas id="ink-canvas"></canvas>
      </div>

      <div id="ink-status" class="muted"></div>
    </div>
  </div>
</div>

<script>
  /* ==============================
     Config
  ============================== */
  const BASE_URL = "https://math-ai-server.onrender.com";

  /* ==============================
     Toast helpers
  ============================== */
  const toast = document.getElementById("answer-toast");
  const toastGo = document.getElementById("toast-go");
  const answerCard = document.getElementById("answer-card");

  function showToast(){
    toast.style.display = "flex";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => hideToast(), 7000);
  }
  function hideToast(){ toast.style.display = "none"; }
  function isAnswerVisible(){
    const r = answerCard.getBoundingClientRect();
    const vh = window.innerHeight || document.documentElement.clientHeight;
    return (r.top < vh * 0.75) && (r.bottom > vh * 0.25);
  }
  function scrollToAnswer(){
    answerCard.scrollIntoView({ behavior: "smooth", block: "start" });
    hideToast();
  }
  toastGo.addEventListener("click", scrollToAnswer);
  window.addEventListener("scroll", () => {
    if (toast.style.display !== "none" && isAnswerVisible()) hideToast();
  }, { passive:true });

  /* ==============================
     Level buttons
  ============================== */
  let currentLevel = "lyceum";
  document.querySelectorAll(".level-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".level-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentLevel = btn.dataset.level;
    });
  });

  /* ==============================
     Helpers
  ============================== */
  const mathInput = document.getElementById("math-input");
  const textInput = document.getElementById("text-input");

  function insertAtCursor(el, text){
    const start = el.selectionStart ?? el.value.length;
    const end = el.selectionEnd ?? el.value.length;
    el.setRangeText(text, start, end, "end");
    el.focus();
  }

  /* ==============================
     Keyboard
  ============================== */
  const keyboardLayouts = {
    num: [['x','y','z','Ï€','e','7','8','9','Ã—','Ã·'],['xÂ²','xâ¿','a/b','âˆš','â¿âˆš','4','5','6','+','âˆ’'],['1','2','3','0','â‰¤','â‰¥','<','>'],['=',' ']],
    func: [['sin','cos','tan','ln','logâ‚â‚€','logâ‚bâ‚'],['sinâ»Â¹','cosâ»Â¹','tanâ»Â¹','d/dx','âˆ«','dx'],['sec(x)','csc(x)','Ï€âˆ«','{','}','â‰¤','â‰¥'],['=',' ']],
    abc: [['q','w','e','r','t','y','u','i','o','p'],['a','s','d','f','g','h','j','k','l'],['z','x','c','v','b','n','m','(',')'],['=',' ']],
    sym: [['#','&','Â¬','â‰ˆ','â‰ ','âˆ'],['â‰¤','â‰¥','âˆˆ','âˆ‰','â‡’','â‡”'],['âŠ‚','âŠ†','âŠ„','âŠ‡','|','â€–'],['=',' ']]
  };
  const keyboardRows = document.getElementById("keyboard-rows");

  function insertFromKey(label){
    let insertText;
    if (label === ' ') insertText = ' ';
    else if (label === 'xÂ²') insertText = 'x^2';
    else if (label === 'xâ¿') insertText = 'x^';
    else if (label === 'a/b') insertText = '/';
    else if (label === 'ln') insertText = '\\ln(';
    else if (label === 'logâ‚â‚€') insertText = '\\log_{10}(';
    else if (label === 'logâ‚bâ‚') insertText = '\\log_{b}(';
    else if (label === 'âˆš') insertText = 'âˆš( )';
    else if (label === 'â¿âˆš') insertText = '3âˆš( )';
    else if (label === 'Ï€âˆ«') insertText = 'V = Ï€âˆ«_{a}^{b} f(x)^2 dx';
    else insertText = label;

    insertAtCursor(mathInput, insertText);
    updateMathPreview();
  }

  function loadKeyboard(name){
    keyboardRows.innerHTML = "";
    keyboardLayouts[name].forEach(row => {
      const wrap = document.createElement("div");
      row.forEach(label => {
        const b = document.createElement("button");
        b.className = "key"; b.type = "button";
        b.textContent = label === " " ? "ÎºÎµÎ½ÏŒ" : label;
        b.onclick = () => insertFromKey(label);
        wrap.appendChild(b);
      });
      keyboardRows.appendChild(wrap);
    });
  }

  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      loadKeyboard(btn.dataset.layout);
    });
  });
  loadKeyboard("num");

  /* ==============================
     Math Preview
  ============================== */
  const mathPreview = document.getElementById("math-preview");
  const mathPreviewPlaceholder = document.getElementById("math-preview-placeholder");

  function isProbablyLatex(s){ return /\\(frac|sqrt|int|sum|begin|pi|cdot|left|right|det)/.test(s || ""); }

  function convertToLatex(text){
    let t = (text || "").trim();
    if (!t) return "";
    const alreadyLatex = isProbablyLatex(t);

    t = t.replace(/âˆ’/g,'-').replace(/Ã·/g,'/').replace(/Ã—/g,'*');
    t = t.replace(/([0-9a-zA-Z\)\}])\s*:\s*([0-9a-zA-Z\\(\{])/g, '$1/$2');

    if (!alreadyLatex){
      t = t.replace(/Ï€/g,'\\pi ');
      t = t.replace(/âˆ«/g,'\\int ');
      t = t.replace(/\s*dx\b/g,'\\, dx');

      t = t.replace(/(\d+)\s*âˆš\s*\(([^)]*)\)/g,'\\sqrt[$1]{$2}');
      t = t.replace(/(\d+)\s*âˆš\s*([a-zA-Z0-9]+)/g,'\\sqrt[$1]{$2}');
      t = t.replace(/âˆš\s*\(([^)]*)\)/g,'\\sqrt{$1}');
      t = t.replace(/âˆš\s*([a-zA-Z0-9]+)/g,'\\sqrt{$1}');
      t = t.replace(/sqrt\s*\(([^)]*)\)/gi,'\\sqrt{$1}');

      t = t.replace(/([0-9a-zA-Z\\]+)\s*\^\s*\(([^)]+)\)/g,'$1^{ $2 }');
      t = t.replace(/([a-zA-Z0-9])\^(\d+)/g,'$1^{ $2 }');

      t = t.replace(/\(([^()]+)\)\s*\/\s*\(([^()]+)\)/g,'\\frac{$1}{$2}');
      t = t.replace(/([0-9a-zA-Z]+)\s*\/\s*\(([^()]+)\)/g,'\\frac{$1}{$2}');
      t = t.replace(/([0-9a-zA-Z])\s*\/\s*([0-9a-zA-Z])(?!\s*\^)/g,'\\frac{$1}{$2}');
    }
    t = t.replace(/\*/g,'\\cdot ');
    return t;
  }

  async function renderMathIn(el){
    if (window.MathJax && MathJax.typesetPromise){
      try { await MathJax.typesetPromise([el]); } catch(e){}
    }
  }

  async function updateMathPreview(){
    const raw = mathInput.value;
    if (!raw.trim()){
      mathPreview.innerHTML = "";
      mathPreviewPlaceholder.style.display = "inline";
      return;
    }
    mathPreviewPlaceholder.style.display = "none";
    const latex = convertToLatex(raw);
    mathPreview.innerHTML = `\\(${latex}\\)`;
    await renderMathIn(mathPreview);
  }
  mathInput.addEventListener("input", updateMathPreview);

  /* ==============================
     AI Answer
  ============================== */
  const answerEl = document.getElementById("ai-answer");
  const statusEl = document.getElementById("status");
  const setStatus = (t="") => statusEl.textContent = t;

  const continueBox = document.getElementById("continue-box");
  const continueYes = document.getElementById("continue-yes");
  const continueNo  = document.getElementById("continue-no");
  const continueStatus = document.getElementById("continue-status");

  let lastPromptSent = "";
  let lastAnswerText = "";

  function showContinueBox(show){
    continueBox.style.display = show ? "block" : "none";
    continueStatus.textContent = "";
    continueYes.disabled = false;
    continueNo.disabled = false;
  }

  async function renderAnswer(text){
    const t = (text || "");
    lastAnswerText = t;
    answerEl.innerHTML = t.replace(/\n/g,"<br>");
    await renderMathIn(answerEl);
    showContinueBox(true);
    if (!isAnswerVisible()) showToast();
  }

  async function askAI(prompt){
    setStatus("Î¤Î¿ AI ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹â€¦");
    answerEl.innerHTML = "Î¤Î¿ AI ÏƒÎºÎ­Ï†Ï„ÎµÏ„Î±Î¹â€¦";
    await renderMathIn(answerEl);
    showContinueBox(false);

    try{
      const res = await fetch(`${BASE_URL}/ask`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ prompt })
      });
      const data = await res.json();
      const ans = data.answer || data.message || JSON.stringify(data, null, 2) || "Î”ÎµÎ½ Î®ÏÎ¸Îµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·.";
      await renderAnswer(ans);
    }catch(e){
      await renderAnswer("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server (/ask).");
    }
    setStatus("");
  }

  document.getElementById("ask-btn").addEventListener("click", async () => {
    hideToast();
    const math = mathInput.value.trim();
    const text = textInput.value.trim();

    let bodyParts = [];
    if (math) bodyParts.push("ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ® Î­ÎºÏ†ÏÎ±ÏƒÎ·:\n" + math);
    if (text) bodyParts.push("Î›ÎµÎºÏ„Î¹ÎºÎ® Î±Ï€Î¿ÏÎ¯Î±:\n" + text);
    const mainPrompt = bodyParts.join("\n\n") || "Î›ÏÏƒÎµ Ï„Î¿ 1+1.";

    const levelPrefix = currentLevel === "lyceum"
      ? "ÎÎ± Î»Ï…Î¸ÎµÎ¯ Î¼Îµ Î¼Î±Î¸Î·Î¼Î±Ï„Î¹ÎºÎ¬ ÎµÏ€Î¹Ï€Î­Î´Î¿Ï… Î›Ï…ÎºÎµÎ¯Î¿Ï…. Î‘Ï€ÏŒÏ†Ï…Î³Îµ Ï€Î±Î½ÎµÏ€Î¹ÏƒÏ„Î·Î¼Î¹Î±ÎºÎ­Ï‚ Î¼ÎµÎ¸ÏŒÎ´Î¿Ï…Ï‚.\n\n"
      : "ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ­Ï‚ Ï€Î±Î½ÎµÏ€Î¹ÏƒÏ„Î·Î¼Î¹Î±ÎºÎ¿Ï ÎµÏ€Î¹Ï€Î­Î´Î¿Ï….\n\n";

    lastPromptSent = levelPrefix + mainPrompt;
    await askAI(lastPromptSent);
  });

  document.getElementById("clear-btn").addEventListener("click", async () => {
    hideToast();
    mathInput.value = "";
    textInput.value = "";
    answerEl.innerHTML = "ÎˆÏ„Î¿Î¹Î¼Î¿Ï‚/Î·. Î“ÏÎ¬ÏˆÎµ Î½Î­Î± ÎµÏÏÏ„Î·ÏƒÎ·â€¦";
    await renderMathIn(answerEl);
    showContinueBox(false);
    updateMathPreview();
  });

  continueYes.addEventListener("click", async () => {
    hideToast();
    continueYes.disabled = true;
    continueNo.disabled = true;
    continueStatus.textContent = "Î£Ï…Î½ÎµÏ‡Î¯Î¶Ï‰â€¦";

    const followUp =
      "Î£Ï…Î½Î­Ï‡Î¹ÏƒÎµ Ï„Î·Î½ ÎµÎ¾Î®Î³Î·ÏƒÎ·/Î»ÏÏƒÎ· Î±Ï€ÏŒ Ï„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿ Ï€Î¿Ï… Î­Î¼ÎµÎ¹Î½ÎµÏ‚. " +
      "Î”ÏÏƒÎµ Ï„Î± ÎµÏ€ÏŒÎ¼ÎµÎ½Î± Î²Î®Î¼Î±Ï„Î±, Ï€Î¹Î¿ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬, Î¼Îµ ÎºÎ±Î¸Î±ÏÎ® Î´Î¿Î¼Î®.\n\n" +
      "Î Î¡ÎŸÎ—Î“ÎŸÎ¥ÎœÎ•ÎÎŸ PROMPT:\n" + (lastPromptSent || "(ÎºÎµÎ½ÏŒ)") + "\n\n" +
      "Î Î¡ÎŸÎ—Î“ÎŸÎ¥ÎœÎ•ÎÎ— Î‘Î Î‘ÎÎ¤Î—Î£Î—:\n" + (lastAnswerText || "(ÎºÎµÎ½ÏŒ)");

    lastPromptSent = followUp;
    await askAI(followUp);
  });

  continueNo.addEventListener("click", () => {
    continueStatus.textContent = "ÎŸÎš â€” Î´ÎµÎ½ ÏƒÏ…Î½ÎµÏ‡Î¯Î¶Ï‰.";
    setTimeout(() => showContinueBox(false), 800);
  });

  /* ==============================
     Photo check (UI only)
  ============================== */
  const imgInput = document.getElementById("image-input");
  const imgPreview = document.getElementById("img-preview");
  const checkBtn = document.getElementById("check-image-btn");
  const removeBtn = document.getElementById("remove-img-btn");

  function resetImageUI(){
    imgPreview.removeAttribute("src");
    checkBtn.disabled = true;
    removeBtn.disabled = true;
  }
  resetImageUI();

  imgInput.addEventListener("change", () => {
    const file = imgInput.files && imgInput.files[0];
    if(!file){ resetImageUI(); return; }
    imgPreview.src = URL.createObjectURL(file);
    checkBtn.disabled = false;
    removeBtn.disabled = false;
  });

  removeBtn.addEventListener("click", () => {
    imgInput.value = "";
    resetImageUI();
  });

  checkBtn.addEventListener("click", async () => {
    hideToast();
    const file = imgInput.files && imgInput.files[0];
    if (!file) { await renderAnswer("Î”ÎµÎ½ ÎµÏ€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±."); return; }

    setStatus("Î¤Î¿ AI Î±Î½Î±Î»ÏÎµÎ¹ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±â€¦");
    answerEl.innerHTML = "Î¤Î¿ AI Î±Î½Î±Î»ÏÎµÎ¹ Ï„Î· Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±â€¦";
    await renderMathIn(answerEl);
    showContinueBox(false);

    const formData = new FormData();
    formData.append("image", file);
    formData.append("question", textInput.value.trim());
    formData.append("level", currentLevel);

    try{
      const res = await fetch(`${BASE_URL}/check-image`, { method:"POST", body: formData });
      const data = await res.json();
      await renderAnswer(data.answer || "Î”ÎµÎ½ Î®ÏÎ¸Îµ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î±Ï€ÏŒ Ï„Î¿Î½ server.");
    }catch(e){
      await renderAnswer("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server (/check-image).");
    }
    setStatus("");
  });

  /* init */
  updateMathPreview();
</script>

<script>
/* =======================================================
   INK MODAL (Mouse/Touch/Stylus) â€” Render Stable
   Fixes:
   - canvas 0x0 when modal hidden
   - thickness + color apply correctly
   - pointer events + mouse fallback
======================================================= */
(function(){
  const qs = (id) => document.getElementById(id);

  let inkCanvas = null;
  let ctx = null;
  let drawing = false;
  let activePointerId = null;

  function setInkStyle(){
    const colorEl = qs("ink-color");
    const sizeEl  = qs("ink-size");
    const valEl   = qs("ink-size-val");
    if(!colorEl || !sizeEl || !valEl || !ctx) return;

    const color = colorEl.value || "#000000";
    const size  = parseInt(sizeEl.value || "4", 10);

    valEl.textContent = String(size);

    ctx.strokeStyle = color;
    ctx.lineWidth = size;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
  }

  function getPos(ev){
    const rect = inkCanvas.getBoundingClientRect();
    return { x: ev.clientX - rect.left, y: ev.clientY - rect.top };
  }

  function resizeInkCanvas(){
    if(!inkCanvas) return;
    const wrap = inkCanvas.parentElement;
    if(!wrap) return;

    const r = wrap.getBoundingClientRect();
    const w = Math.floor(r.width);
    const h = Math.floor(r.height);

    // critical: do NOT resize when hidden
    if(w < 50 || h < 50) return;

    const dpr = window.devicePixelRatio || 1;

    inkCanvas.width  = Math.floor(w * dpr);
    inkCanvas.height = Math.floor(h * dpr);
    inkCanvas.style.width = w + "px";
    inkCanvas.style.height = h + "px";

    ctx = inkCanvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);

    setInkStyle();
  }

  function startDraw(ev){
    if(!ctx || !inkCanvas) return;
    drawing = true;
    activePointerId = (ev.pointerId != null) ? ev.pointerId : 1;

    try{ inkCanvas.setPointerCapture(activePointerId); }catch(e){}
    try{ ev.preventDefault(); }catch(e){}

    setInkStyle();
    const p = getPos(ev);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  }

  function moveDraw(ev){
    if(!drawing || !ctx) return;
    if(activePointerId != null && ev.pointerId != null && ev.pointerId !== activePointerId) return;
    try{ ev.preventDefault(); }catch(e){}

    const p = getPos(ev);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  }

  function endDraw(ev){
    if(!drawing) return;
    drawing = false;
    try{ ev.preventDefault(); }catch(e){}
    try{ if(activePointerId!=null) inkCanvas.releasePointerCapture(activePointerId); }catch(e){}
    activePointerId = null;
  }

  function clearInk(){
    if(!ctx || !inkCanvas) return;
    ctx.clearRect(0,0, inkCanvas.width, inkCanvas.height);
  }

  function openInk(){
    const bd = qs("ink-backdrop");
    if(!bd) return;

    bd.classList.add("show");
    bd.setAttribute("aria-hidden","false");

    // lazy init once
    if(!inkCanvas){
      inkCanvas = qs("ink-canvas");
      if(!inkCanvas) return;

      // pointer events (best)
      inkCanvas.addEventListener("pointerdown", startDraw, {passive:false});
      inkCanvas.addEventListener("pointermove", moveDraw, {passive:false});
      inkCanvas.addEventListener("pointerup", endDraw, {passive:false});
      inkCanvas.addEventListener("pointercancel", endDraw, {passive:false});
      inkCanvas.addEventListener("pointerleave", endDraw, {passive:false});

      // mouse fallback (some browsers)
      inkCanvas.addEventListener("mousedown", (e)=> startDraw(Object.assign(e,{pointerId:1})), {passive:false});
      window.addEventListener("mousemove", (e)=>{
        const bd2 = qs("ink-backdrop");
        if(!bd2 || !bd2.classList.contains("show")) return;
        moveDraw(Object.assign(e,{pointerId:1}));
      }, {passive:false});
      window.addEventListener("mouseup", (e)=> endDraw(Object.assign(e,{pointerId:1})), {passive:false});
    }

    // IMPORTANT: resize AFTER visible
    requestAnimationFrame(()=>{
      resizeInkCanvas();
      setTimeout(resizeInkCanvas, 60);
      setTimeout(resizeInkCanvas, 180);
    });
  }

  function closeInk(){
    const bd = qs("ink-backdrop");
    if(!bd) return;
    bd.classList.remove("show");
    bd.setAttribute("aria-hidden","true");
    drawing = false;
    activePointerId = null;
  }

  function bind(){
    const openBtn = qs("open-ink-btn");
    const closeBtn = qs("ink-close");
    const bd = qs("ink-backdrop");

    if(openBtn) openBtn.addEventListener("click", openInk);
    if(closeBtn) closeBtn.addEventListener("click", closeInk);

    // click outside to close
    if(bd){
      bd.addEventListener("click", (e)=>{
        if(e.target === bd) closeInk();
      });
    }

    const sizeEl = qs("ink-size");
    const colorEl = qs("ink-color");
    if(sizeEl) sizeEl.addEventListener("input", setInkStyle);
    if(colorEl) colorEl.addEventListener("input", setInkStyle);

    const clearBtn = qs("ink-clear");
    if(clearBtn) clearBtn.addEventListener("click", clearInk);

    window.addEventListener("resize", ()=>{
      const bd2 = qs("ink-backdrop");
      if(bd2 && bd2.classList.contains("show")) resizeInkCanvas();
    });
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bind);
  }else{
    bind();
  }
})();
</script>
</body>
</html>
